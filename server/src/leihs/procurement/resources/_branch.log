2023-12-17T08:28:21.992Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:122] - (-> bp (update :inspection_start_date set-date) (update :end_date set-date)) => {:id "bf6512b2-6ec7-4f7c-b7a5-68fc9363f686", :name "bp_1_new_name", :inspection_start_date "2024-06-01T00:00:00+00:00", :end_date "2024-12-01T00:00:00+00:00"}
2023-12-17T08:28:21.992Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:130] - (:id bp-with-dates) => bf6512b2-6ec7-4f7c-b7a5-68fc9363f686
2023-12-17T08:28:21.993Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:131] - bp-with-dates => {:id "bf6512b2-6ec7-4f7c-b7a5-68fc9363f686", :name "bp_1_new_name", :inspection_start_date "2024-06-01T00:00:00+00:00", :end_date "2024-12-01T00:00:00+00:00"}
2023-12-17T08:28:21.993Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:274] - bp => {:id "bf6512b2-6ec7-4f7c-b7a5-68fc9363f686", :name "bp_1_new_name", :inspection_start_date "2024-06-01T00:00:00+00:00", :end_date "2024-12-01T00:00:00+00:00"}
2023-12-17T08:28:21.995Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:278] - bp => {:id [[:cast "bf6512b2-6ec7-4f7c-b7a5-68fc9363f686" :uuid]], :name "bp_1_new_name", :inspection_start_date [[:cast "2024-06-01T00:00:00+00:00" :timestamp]], :end_date [[:cast "2024-12-01T00:00:00+00:00" :timestamp]]}

2023-12-17T08:28:22.044Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:276] -1 (jdbc/execute-one! tx (-> (sql/update :procurement_budget_periods) (sql/set (spy bp)) (sql/where [:= :procurement_budget_periods.id (:id bp)]) sql-format)) => {:next.jdbc/update-count 1}
2023-12-17T08:28:22.045Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:284] - result => {:next.jdbc/update-count 1}
2023-12-17T08:28:22.046Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:284] - (:next.jdbc/update-count (spy result)) => 1
2023-12-17T08:28:22.046Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:288] - (list result) => (1)
2023-12-17T08:28:22.047Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:131] - (budget-period/update-budget-period! tx (spy bp-with-dates)) => (1)
2023-12-17T08:28:22.047Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:137] - (:id bp-with-dates) => bf6512b2-6ec7-4f7c-b7a5-68fc9363f686
2023-12-17T08:28:22.048Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:122] - (-> bp (update :inspection_start_date set-date) (update :end_date set-date)) => {:id nil, :name "new_bp", :inspection_start_date "2025-06-01T00:00:00+00:00", :end_date "2025-12-01T00:00:00+00:00"}
2023-12-17T08:28:22.048Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:130] - (:id bp-with-dates) => nil
2023-12-17T08:28:22.048Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:300] - bp => {:name "new_bp", :inspection_start_date "2025-06-01T00:00:00+00:00", :end_date "2025-12-01T00:00:00+00:00"}
2023-12-17T08:28:22.049Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:304] - bp => {:name "new_bp", :inspection_start_date [[:cast "2025-06-01T00:00:00+00:00" :timestamp]], :end_date [[:cast "2025-12-01T00:00:00+00:00" :timestamp]]}

2023-12-17T08:28:22.054Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:302] -2 (jdbc/execute-one! tx (-> (sql/insert-into :procurement_budget_periods) (sql/values [(spy bp)]) sql-format)) => {:next.jdbc/update-count 1}
2023-12-17T08:28:22.054Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:310] - (:next.jdbc/update-count result) => 1
2023-12-17T08:28:22.055Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:313] - (list result) => (1)
2023-12-17T08:28:22.055Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:132] - (budget-period/insert-budget-period! tx (dissoc bp-with-dates :id)) => (1)
2023-12-17T08:28:22.055Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:137] - (:id bp-with-dates) => nil
2023-12-17T08:28:22.057Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:87] - (my-cast bp-map) => {:name "new_bp", :inspection_start_date [[:cast "2025-06-01T00:00:00+00:00" :timestamp]], :end_date [[:cast "2025-12-01T00:00:00+00:00" :timestamp]]}
2023-12-17T08:28:22.058Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:?] - (sql-format (sql/where budget-period-base-query where-clause)) => ["SELECT procurement_budget_periods.* FROM procurement_budget_periods WHERE (procurement_budget_periods.name = ?) AND (procurement_budget_periods.inspection_start_date IN (CAST(? AS TIMESTAMP))) AND (procurement_budget_periods.end_date IN (CAST(? AS TIMESTAMP)))" "new_bp" "2025-06-01T00:00:00+00:00" "2025-12-01T00:00:00+00:00"]

2023-12-17T08:28:22.060Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:88] -3 (jdbc/execute! tx (-> budget-period-base-query (sql/where where-clause) sql-format spy)) => [{:id #uuid "c3fbf0b2-a61f-4ab2-a401-6b87679eca66", :name "new_bp", :inspection_start_date #inst "2025-05-31T22:00:00.000000000-00:00", :end_date #inst "2025-11-30T23:00:00.000000000-00:00", :created_at #inst "2023-12-17T08:28:21.810361000-00:00", :updated_at #inst "2023-12-17T08:28:21.810361000-00:00"}]
2023-12-17T08:28:22.060Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:138] - (-> bp-with-dates (dissoc :id) (->> (budget-period/get-budget-period tx)) :id) => #uuid "c3fbf0b2-a61f-4ab2-a401-6b87679eca66"
2023-12-17T08:28:22.062Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:?] - (sql-format (sql/where (sql/delete-from :procurement_budget_periods :pbp) [:not-in :pbp.id (cast-uuids ids)])) => ["DELETE FROM procurement_budget_periods AS pbp WHERE pbp.id NOT IN (CAST(? AS UUID), CAST(? AS UUID))" #uuid "c3fbf0b2-a61f-4ab2-a401-6b87679eca66" "bf6512b2-6ec7-4f7c-b7a5-68fc9363f686"]

2023-12-17T08:28:22.087Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:90] -4 (jdbc/execute-one! tx (-> (sql/delete-from :procurement_budget_periods :pbp) (sql/where [:not-in :pbp.id (cast-uuids ids)]) sql-format spy)) => {:next.jdbc/update-count 1}
2023-12-17T08:28:22.087Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:90] - (-> (spy (jdbc/execute-one! tx (-> (sql/delete-from :procurement_budget_periods :pbp) (sql/where [:not-in :pbp.id (cast-uuids ids)]) sql-format spy))) :next.jdbc/update-count list) => (1)
2023-12-17T08:28:22.088Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:147] - (delete-budget-periods-not-in! tx bp-ids) => (1)
2023-12-17T08:28:22.155Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:65] - (= (:id args) []) => false
2023-12-17T08:28:22.156Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:69] - args => {:input_data [{:id "bf6512b2-6ec7-4f7c-b7a5-68fc9363f686", :name "bp_1_new_name", :inspection_start_date "2024-06-01T00:00:00+00:00", :end_date "2024-12-01T00:00:00+00:00"} {:id nil, :name "new_bp", :inspection_start_date "2025-06-01T00:00:00+00:00", :end_date "2025-12-01T00:00:00+00:00"}]}
2023-12-17T08:28:22.157Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:40] - (:id args) => nil
2023-12-17T08:28:22.157Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:44] - (-> args :whereRequestsCanBeMovedTo empty? not) => false
2023-12-17T08:28:22.157Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:39] - (let [ids (spy (:id args))] (cond-> budget-periods-base-query ids (sql/where [:in :procurement_budget_periods.id (cast-uuids ids)]) (spy (-> args :whereRequestsCanBeMovedTo empty? not)) (sql/where [:< :current_date :procurement_budget_periods.end_date]))) => {:select [:*], :from [:procurement_budget_periods], :order-by [[:end_date :desc]]}
2023-12-17T08:28:22.158Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:?] - (sql-format (budget-periods-query (spy args))) => ["SELECT * FROM procurement_budget_periods ORDER BY end_date DESC"]

2023-12-17T08:28:22.160Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:67] -5 (jdbc/execute! (-> context :request :tx-next) (-> (spy args) budget-periods-query sql-format spy)) =>
[{:id #uuid "c3fbf0b2-a61f-4ab2-a401-6b87679eca66", :name "new_bp", :inspection_start_date #inst "2025-05-31T22:00:00.000000000-00:00", :end_date #inst "2025-11-30T23:00:00.000000000-00:00", :created_at #inst "2023-12-17T08:28:21.810361000-00:00", :updated_at #inst "2023-12-17T08:28:21.810361000-00:00"} {:id #uuid "bf6512b2-6ec7-4f7c-b7a5-68fc9363f686", :name "bp_1_new_name", :inspection_start_date #inst "2024-05-31T22:00:00.000000000-00:00", :end_date #inst "2024-11-30T23:00:00.000000000-00:00", :created_at #inst "2023-12-17T08:28:19.304021000-00:00", :updated_at #inst "2023-12-17T08:28:19.304021000-00:00"}]
2023-12-17T08:28:22.160Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:149] - (get-budget-periods context args value) => [{:id #uuid "c3fbf0b2-a61f-4ab2-a401-6b87679eca66", :name "new_bp", :inspection_start_date #inst "2025-05-31T22:00:00.000000000-00:00", :end_date #inst "2025-11-30T23:00:00.000000000-00:00", :created_at #inst "2023-12-17T08:28:21.810361000-00:00", :updated_at #inst "2023-12-17T08:28:21.810361000-00:00"} {:id #uuid "bf6512b2-6ec7-4f7c-b7a5-68fc9363f686", :name "bp_1_new_name", :inspection_start_date #inst "2024-05-31T22:00:00.000000000-00:00", :end_date #inst "2024-11-30T23:00:00.000000000-00:00", :created_at #inst "2023-12-17T08:28:19.304021000-00:00", :updated_at #inst "2023-12-17T08:28:19.304021000-00:00"}]
2023-12-17T08:28:22.161Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:147] - (do (spy (delete-budget-periods-not-in! tx bp-ids)) (println ">>> ??? delete _> get-budget-periods" args value) (spy (get-budget-periods context args value))) => [{:id #uuid "c3fbf0b2-a61f-4ab2-a401-6b87679eca66", :name "new_bp", :inspection_start_date #inst "2025-05-31T22:00:00.000000000-00:00", :end_date #inst "2025-11-30T23:00:00.000000000-00:00", :created_at #inst "2023-12-17T08:28:21.810361000-00:00", :updated_at #inst "2023-12-17T08:28:21.810361000-00:00"} {:id #uuid "bf6512b2-6ec7-4f7c-b7a5-68fc9363f686", :name "bp_1_new_name", :inspection_start_date #inst "2024-05-31T22:00:00.000000000-00:00", :end_date #inst "2024-11-30T23:00:00.000000000-00:00", :created_at #inst "2023-12-17T08:28:19.304021000-00:00", :updated_at #inst "2023-12-17T08:28:19.304021000-00:00"}]
2023-12-17T08:28:22.161Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:116] - (loop [[bp & rest-bps] bps bp-ids []] (if bp (let [p (println ">oo> before bp-with-dates=" bp) bp-with-dates (spy (-> bp (update :inspection_start_date set-date) (update :end_date set-date))) p (println ">oo> after bp-with-dates=" bp-with-dates)] (do (if (spy (:id bp-with-dates)) (spy (budget-period/update-budget-period! tx (spy bp-with-dates))) (spy (budget-period/insert-budget-period! tx (dissoc bp-with-dates :id)))) (let [p (println ">oo> superorsch args=" args) p (println ">oo> superorsch value=" value) bp-id (or (spy (:id bp-with-dates)) (spy (-> bp-with-dates (dissoc :id) (->> (budget-period/get-budget-period tx)) :id)))] (recur rest-bps (conj bp-ids bp-id))))) (spy (do (spy (delete-budget-periods-not-in! tx bp-ids)) (println ">>> ??? delete _> get-budget-periods" args value) (spy (get-budget-periods context args value)))))) =>

[{:id #uuid "c3fbf0b2-a61f-4ab2-a401-6b87679eca66", :name "new_bp", :inspection_start_date #inst "2025-05-31T22:00:00.000000000-00:00", :end_date #inst "2025-11-30T23:00:00.000000000-00:00", :created_at #inst "2023-12-17T08:28:21.810361000-00:00", :updated_at #inst "2023-12-17T08:28:21.810361000-00:00"} {:id #uuid "bf6512b2-6ec7-4f7c-b7a5-68fc9363f686", :name "bp_1_new_name", :inspection_start_date #inst "2024-05-31T22:00:00.000000000-00:00", :end_date #inst "2024-11-30T23:00:00.000000000-00:00", :created_at #inst "2023-12-17T08:28:19.304021000-00:00", :updated_at #inst "2023-12-17T08:28:19.304021000-00:00"}]
