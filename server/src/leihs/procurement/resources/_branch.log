2023-12-17T08:01:48.488Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:118] - (-> bp (update :inspection_start_date set-date) (update :end_date set-date)) => {:id "affa3390-b2b9-4497-8240-6b236848ad09", :name "bp_1_new_name", :inspection_start_date "2024-06-01T00:00:00+00:00", :end_date "2024-12-01T00:00:00+00:00"}
2023-12-17T08:01:48.488Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:126] - (:!= (:id bp-with-dates) nil) => nil
2023-12-17T08:01:48.489Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:300] - bp => {:name "bp_1_new_name", :inspection_start_date "2024-06-01T00:00:00+00:00", :end_date "2024-12-01T00:00:00+00:00"}
2023-12-17T08:01:48.490Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:304] - bp => {:name "bp_1_new_name", :inspection_start_date [[:cast "2024-06-01T00:00:00+00:00" :timestamp]], :end_date [[:cast "2024-12-01T00:00:00+00:00" :timestamp]]}
2023-12-17T08:01:48.541Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:302] - (jdbc/execute! tx (-> (sql/insert-into :procurement_budget_periods) (sql/values [(spy bp)]) sql-format)) => [{:next.jdbc/update-count 1}]
2023-12-17T08:01:48.542Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:309] - (:update-count result) => nil
2023-12-17T08:01:48.542Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:312] - (list result) => (nil)
2023-12-17T08:01:48.542Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:128] - (budget-period/insert-budget-period! tx (dissoc bp-with-dates :id)) => (nil)
2023-12-17T08:01:48.542Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:133] - (:id bp-with-dates) => affa3390-b2b9-4497-8240-6b236848ad09
2023-12-17T08:01:48.543Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:118] - (-> bp (update :inspection_start_date set-date) (update :end_date set-date)) => {:id nil, :name "new_bp", :inspection_start_date "2025-06-01T00:00:00+00:00", :end_date "2025-12-01T00:00:00+00:00"}
2023-12-17T08:01:48.543Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:126] - (:!= (:id bp-with-dates) nil) => nil
2023-12-17T08:01:48.543Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:300] - bp => {:name "new_bp", :inspection_start_date "2025-06-01T00:00:00+00:00", :end_date "2025-12-01T00:00:00+00:00"}
2023-12-17T08:01:48.544Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:304] - bp => {:name "new_bp", :inspection_start_date [[:cast "2025-06-01T00:00:00+00:00" :timestamp]], :end_date [[:cast "2025-12-01T00:00:00+00:00" :timestamp]]}
2023-12-17T08:01:48.545Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:302] - (jdbc/execute! tx (-> (sql/insert-into :procurement_budget_periods) (sql/values [(spy bp)]) sql-format)) => [{:next.jdbc/update-count 1}]
2023-12-17T08:01:48.545Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:309] - (:update-count result) => nil
2023-12-17T08:01:48.545Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:312] - (list result) => (nil)
2023-12-17T08:01:48.545Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:128] - (budget-period/insert-budget-period! tx (dissoc bp-with-dates :id)) => (nil)
2023-12-17T08:01:48.545Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:133] - (:id bp-with-dates) => nil
2023-12-17T08:01:48.547Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:87] - (my-cast bp-map) => {:name "new_bp", :inspection_start_date [[:cast "2025-06-01T00:00:00+00:00" :timestamp]], :end_date [[:cast "2025-12-01T00:00:00+00:00" :timestamp]]}
2023-12-17T08:01:48.549Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:?] - (sql-format (sql/where budget-period-base-query where-clause)) => ["SELECT procurement_budget_periods.* FROM procurement_budget_periods WHERE (procurement_budget_periods.name = ?) AND (procurement_budget_periods.inspection_start_date IN (CAST(? AS TIMESTAMP))) AND (procurement_budget_periods.end_date IN (CAST(? AS TIMESTAMP)))" "new_bp" "2025-06-01T00:00:00+00:00" "2025-12-01T00:00:00+00:00"]
2023-12-17T08:01:48.551Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:88] - (jdbc/execute! tx (-> budget-period-base-query (sql/where where-clause) sql-format spy)) => [{:id #uuid "8265e62e-883d-42d6-935b-cc1312631d2d", :name "new_bp", :inspection_start_date #inst "2025-05-31T22:00:00.000000000-00:00", :end_date #inst "2025-11-30T23:00:00.000000000-00:00", :created_at #inst "2023-12-17T08:01:48.348612000-00:00", :updated_at #inst "2023-12-17T08:01:48.348612000-00:00"}]
2023-12-17T08:01:48.551Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:134] - (-> bp-with-dates (dissoc :id) (->> (budget-period/get-budget-period tx)) :id) => #uuid "8265e62e-883d-42d6-935b-cc1312631d2d"
2023-12-17T08:01:48.554Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:?] - (sql-format (sql/where (sql/delete-from :procurement_budget_periods :pbp) [:not-in :pbp.id (cast-uuids ids)])) => ["DELETE FROM procurement_budget_periods AS pbp WHERE pbp.id NOT IN (CAST(? AS UUID), CAST(? AS UUID))" #uuid "8265e62e-883d-42d6-935b-cc1312631d2d" "affa3390-b2b9-4497-8240-6b236848ad09"]
2023-12-17T08:01:48.576Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:90] - (-> (jdbc/execute! tx (-> (sql/delete-from :procurement_budget_periods :pbp) (sql/where [:not-in :pbp.id (cast-uuids ids)]) sql-format spy)) :update-count) => nil
2023-12-17T08:01:48.577Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:143] - (delete-budget-periods-not-in! tx bp-ids) => nil
2023-12-17T08:01:48.596Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:65] - (= (:id args) []) => false
2023-12-17T08:01:48.597Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:69] - args => {:input_data [{:id "affa3390-b2b9-4497-8240-6b236848ad09", :name "bp_1_new_name", :inspection_start_date "2024-06-01T00:00:00+00:00", :end_date "2024-12-01T00:00:00+00:00"} {:id nil, :name "new_bp", :inspection_start_date "2025-06-01T00:00:00+00:00", :end_date "2025-12-01T00:00:00+00:00"}]}
2023-12-17T08:01:48.597Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:40] - (:id args) => nil
2023-12-17T08:01:48.598Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:44] - (-> args :whereRequestsCanBeMovedTo empty? not) => false
2023-12-17T08:01:48.598Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:39] - (let [ids (spy (:id args))] (cond-> budget-periods-base-query ids (sql/where [:in :procurement_budget_periods.id (cast-uuids ids)]) (spy (-> args :whereRequestsCanBeMovedTo empty? not)) (sql/where [:< :current_date :procurement_budget_periods.end_date]))) => {:select [:*], :from [:procurement_budget_periods], :order-by [[:end_date :desc]]}
2023-12-17T08:01:48.599Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:?] - (sql-format (budget-periods-query (spy args))) => ["SELECT * FROM procurement_budget_periods ORDER BY end_date DESC"]
2023-12-17T08:01:48.600Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:67] - (jdbc/execute! (-> context :request :tx-next) (-> (spy args) budget-periods-query sql-format spy)) => [{:id #uuid "8265e62e-883d-42d6-935b-cc1312631d2d", :name "new_bp", :inspection_start_date #inst "2025-05-31T22:00:00.000000000-00:00", :end_date #inst "2025-11-30T23:00:00.000000000-00:00", :created_at #inst "2023-12-17T08:01:48.348612000-00:00", :updated_at #inst "2023-12-17T08:01:48.348612000-00:00"} {:id #uuid "affa3390-b2b9-4497-8240-6b236848ad09", :name "bp_1", :inspection_start_date #inst "2024-01-16T08:01:47.253335000-00:00", :end_date #inst "2024-03-16T08:01:47.253356000-00:00", :created_at #inst "2023-12-17T08:01:47.253426000-00:00", :updated_at #inst "2023-12-17T08:01:47.253426000-00:00"}]
2023-12-17T08:01:48.601Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:145] - (get-budget-periods context args value) => [{:id #uuid "8265e62e-883d-42d6-935b-cc1312631d2d", :name "new_bp", :inspection_start_date #inst "2025-05-31T22:00:00.000000000-00:00", :end_date #inst "2025-11-30T23:00:00.000000000-00:00", :created_at #inst "2023-12-17T08:01:48.348612000-00:00", :updated_at #inst "2023-12-17T08:01:48.348612000-00:00"} {:id #uuid "affa3390-b2b9-4497-8240-6b236848ad09", :name "bp_1", :inspection_start_date #inst "2024-01-16T08:01:47.253335000-00:00", :end_date #inst "2024-03-16T08:01:47.253356000-00:00", :created_at #inst "2023-12-17T08:01:47.253426000-00:00", :updated_at #inst "2023-12-17T08:01:47.253426000-00:00"}]
2023-12-17T08:01:48.601Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:143] - (do (spy (delete-budget-periods-not-in! tx bp-ids)) (println ">>> ??? delete _> get-budget-periods" args value) (spy (get-budget-periods context args value))) => [{:id #uuid "8265e62e-883d-42d6-935b-cc1312631d2d", :name "new_bp", :inspection_start_date #inst "2025-05-31T22:00:00.000000000-00:00", :end_date #inst "2025-11-30T23:00:00.000000000-00:00", :created_at #inst "2023-12-17T08:01:48.348612000-00:00", :updated_at #inst "2023-12-17T08:01:48.348612000-00:00"} {:id #uuid "affa3390-b2b9-4497-8240-6b236848ad09", :name "bp_1", :inspection_start_date #inst "2024-01-16T08:01:47.253335000-00:00", :end_date #inst "2024-03-16T08:01:47.253356000-00:00", :created_at #inst "2023-12-17T08:01:47.253426000-00:00", :updated_at #inst "2023-12-17T08:01:47.253426000-00:00"}]
2023-12-17T08:01:48.601Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:112] - (loop [[bp & rest-bps] bps bp-ids []] (if bp (let [p (println ">oo> before bp-with-dates=" bp) bp-with-dates (spy (-> bp (update :inspection_start_date set-date) (update :end_date set-date))) p (println ">oo> after bp-with-dates=" bp-with-dates)] (do (if (spy (:!= (:id bp-with-dates) nil)) (spy (budget-period/update-budget-period! tx (spy bp-with-dates))) (spy (budget-period/insert-budget-period! tx (dissoc bp-with-dates :id)))) (let [p (println ">oo> superorsch args=" args) p (println ">oo> superorsch value=" value) bp-id (or (spy (:id bp-with-dates)) (spy (-> bp-with-dates (dissoc :id) (->> (budget-period/get-budget-period tx)) :id)))] (recur rest-bps (conj bp-ids bp-id))))) (spy (do (spy (delete-budget-periods-not-in! tx bp-ids)) (println ">>> ??? delete _> get-budget-periods" args value) (spy (get-budget-periods context args value)))))) => [{:id #uuid "8265e62e-883d-42d6-935b-cc1312631d2d", :name "new_bp", :inspection_start_date #inst "2025-05-31T22:00:00.000000000-00:00", :end_date #inst "2025-11-30T23:00:00.000000000-00:00", :created_at #inst "2023-12-17T08:01:48.348612000-00:00", :updated_at #inst "2023-12-17T08:01:48.348612000-00:00"} {:id #uuid "affa3390-b2b9-4497-8240-6b236848ad09", :name "bp_1", :inspection_start_date #inst "2024-01-16T08:01:47.253335000-00:00", :end_date #inst "2024-03-16T08:01:47.253356000-00:00", :created_at #inst "2023-12-17T08:01:47.253426000-00:00", :updated_at #inst "2023-12-17T08:01:47.253426000-00:00"}]
