2023-12-17T08:05:04.721Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:112] - bps => [{:id "619c02a3-fa61-486a-8c06-69ab9b0c7e73", :name "bp_1_new_name", :inspection_start_date "2024-06-01T00:00:00+00:00", :end_date "2024-12-01T00:00:00+00:00"} {:id nil, :name "new_bp", :inspection_start_date "2025-06-01T00:00:00+00:00", :end_date "2025-12-01T00:00:00+00:00"}]
2023-12-17T08:05:04.722Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:115] - bp => {:id "619c02a3-fa61-486a-8c06-69ab9b0c7e73", :name "bp_1_new_name", :inspection_start_date "2024-06-01T00:00:00+00:00", :end_date "2024-12-01T00:00:00+00:00"}
2023-12-17T08:05:04.725Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:116] - (-> bp (update :inspection_start_date time-format/parse) (update :end_date time-format/parse)) => {:id "619c02a3-fa61-486a-8c06-69ab9b0c7e73", :name "bp_1_new_name", :inspection_start_date #clj-time/date-time "2024-06-01T00:00:00.000Z", :end_date #clj-time/date-time "2024-12-01T00:00:00.000Z"}
2023-12-17T08:05:04.726Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:120] - bp-with-dates => {:id "619c02a3-fa61-486a-8c06-69ab9b0c7e73", :name "bp_1_new_name", :inspection_start_date #clj-time/date-time "2024-06-01T00:00:00.000Z", :end_date #clj-time/date-time "2024-12-01T00:00:00.000Z"}
2023-12-17T08:05:04.726Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:123] - (:id bp-with-dates) => 619c02a3-fa61-486a-8c06-69ab9b0c7e73

2023-12-17T08:05:04.777Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:162] -1 (jdbc/execute! tx (-> (sql/update :procurement_budget_periods) (sql/sset bp) (sql/where [:= :procurement_budget_periods.id (:id bp)]) sql/format)) => (1)
2023-12-17T08:05:04.779Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:124] - (budget-period/update-budget-period! tx bp-with-dates) => (1)
2023-12-17T08:05:04.779Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:126] - (:id bp-with-dates) => 619c02a3-fa61-486a-8c06-69ab9b0c7e73
2023-12-17T08:05:04.779Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:115] - bp => {:id nil, :name "new_bp", :inspection_start_date "2025-06-01T00:00:00+00:00", :end_date "2025-12-01T00:00:00+00:00"}
2023-12-17T08:05:04.779Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:116] - (-> bp (update :inspection_start_date time-format/parse) (update :end_date time-format/parse)) => {:id nil, :name "new_bp", :inspection_start_date #clj-time/date-time "2025-06-01T00:00:00.000Z", :end_date #clj-time/date-time "2025-12-01T00:00:00.000Z"}
2023-12-17T08:05:04.780Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:120] - bp-with-dates => {:id nil, :name "new_bp", :inspection_start_date #clj-time/date-time "2025-06-01T00:00:00.000Z", :end_date #clj-time/date-time "2025-12-01T00:00:00.000Z"}
2023-12-17T08:05:04.780Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:123] - (:id bp-with-dates) => nil

2023-12-17T08:05:04.784Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:170] -2 (jdbc/execute! tx (-> (sql/insert-into :procurement_budget_periods) (sql/values [bp]) sql/format)) => (1)
2023-12-17T08:05:04.785Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:125] - (budget-period/insert-budget-period! tx (dissoc bp-with-dates :id)) => (1)
2023-12-17T08:05:04.785Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:126] - (:id bp-with-dates) => nil
2023-12-17T08:05:04.785Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:?] - (dissoc bp-with-dates :id) => {:name "new_bp", :inspection_start_date #clj-time/date-time "2025-06-01T00:00:00.000Z", :end_date #clj-time/date-time "2025-12-01T00:00:00.000Z"}

2023-12-17T08:05:04.794Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:39] -3 (jdbc/query tx (-> budget-period-base-query (sql/merge-where where-clause) sql/format)) => ({:id #uuid "9ab7cd6d-2af6-4088-8316-f1264ff4811c", :name "new_bp", :inspection_start_date #time/instant "2025-06-01T00:00:00Z", :end_date #time/instant "2025-12-01T00:00:00Z", :created_at #time/instant "2023-12-17T08:05:04.551321Z", :updated_at #time/instant "2023-12-17T08:05:04.551321Z"})
2023-12-17T08:05:04.794Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:39] - (first (spy (jdbc/query tx (-> budget-period-base-query (sql/merge-where where-clause) sql/format)))) => {:id #uuid "9ab7cd6d-2af6-4088-8316-f1264ff4811c", :name "new_bp", :inspection_start_date #time/instant "2025-06-01T00:00:00Z", :end_date #time/instant "2025-12-01T00:00:00Z", :created_at #time/instant "2023-12-17T08:05:04.551321Z", :updated_at #time/instant "2023-12-17T08:05:04.551321Z"}
2023-12-17T08:05:04.794Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:?] - (budget-period/get-budget-period tx (spy (dissoc bp-with-dates :id))) => {:id #uuid "9ab7cd6d-2af6-4088-8316-f1264ff4811c", :name "new_bp", :inspection_start_date #time/instant "2025-06-01T00:00:00Z", :end_date #time/instant "2025-12-01T00:00:00Z", :created_at #time/instant "2023-12-17T08:05:04.551321Z", :updated_at #time/instant "2023-12-17T08:05:04.551321Z"}
2023-12-17T08:05:04.795Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:127] - (-> bp-with-dates (dissoc :id) spy (->> (budget-period/get-budget-period tx) spy) :id) => #uuid "9ab7cd6d-2af6-4088-8316-f1264ff4811c"
2023-12-17T08:05:04.795Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:115] - bp => nil

2023-12-17T08:05:04.815Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:89] -4 (jdbc/execute! tx (-> (sql/delete-from [:procurement_budget_periods :pbp]) (sql/merge-where [:not-in :pbp.id ids]) sql/format)) => (1)
2023-12-17T08:05:04.816Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:137] - (delete-budget-periods-not-in! tx bp-ids) => (1)
2023-12-17T08:05:04.867Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:60] - (= (:id args) []) => false
2023-12-17T08:05:04.868Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:42] - (-> args :whereRequestsCanBeMovedTo empty? not) => false
2023-12-17T08:05:04.869Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:39] - (cond-> budget-periods-base-query (:id args) (sql/merge-where [:in :procurement_budget_periods.id (:id args)]) (spy (-> args :whereRequestsCanBeMovedTo empty? not)) (sql/merge-where [:< :current_date :procurement_budget_periods.end_date])) => {:select (:procurement_budget_periods.*), :from (:procurement_budget_periods), :order-by ([:end_date :desc])}
2023-12-17T08:05:04.871Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:62] - (->> args budget-periods-query sql/format (jdbc/query (-> context :request :tx))) => ({:id #uuid "9ab7cd6d-2af6-4088-8316-f1264ff4811c", :name "new_bp", :inspection_start_date #time/instant "2025-06-01T00:00:00Z", :end_date #time/instant "2025-12-01T00:00:00Z", :created_at #time/instant "2023-12-17T08:05:04.551321Z", :updated_at #time/instant "2023-12-17T08:05:04.551321Z"} {:id #uuid "619c02a3-fa61-486a-8c06-69ab9b0c7e73", :name "bp_1_new_name", :inspection_start_date #time/instant "2024-06-01T00:00:00Z", :end_date #time/instant "2024-12-01T00:00:00Z", :created_at #time/instant "2023-12-17T08:05:03.344216Z", :updated_at #time/instant "2023-12-17T08:05:03.344216Z"})
2023-12-17T08:05:04.872Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:60] - (if (spy (= (:id args) [])) (spy []) (spy (->> args budget-periods-query sql/format (jdbc/query (-> context :request :tx))))) =>

({:id #uuid "9ab7cd6d-2af6-4088-8316-f1264ff4811c", :name "new_bp", :inspection_start_date #time/instant "2025-06-01T00:00:00Z", :end_date #time/instant "2025-12-01T00:00:00Z", :created_at #time/instant "2023-12-17T08:05:04.551321Z", :updated_at #time/instant "2023-12-17T08:05:04.551321Z"} {:id #uuid "619c02a3-fa61-486a-8c06-69ab9b0c7e73", :name "bp_1_new_name", :inspection_start_date #time/instant "2024-06-01T00:00:00Z", :end_date #time/instant "2024-12-01T00:00:00Z", :created_at #time/instant "2023-12-17T08:05:03.344216Z", :updated_at #time/instant "2023-12-17T08:05:03.344216Z"})

2023-12-17T08:05:04.874Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:138] - (get-budget-periods context args value) => ({:id #uuid "9ab7cd6d-2af6-4088-8316-f1264ff4811c", :name "new_bp", :inspection_start_date #time/instant "2025-06-01T00:00:00Z", :end_date #time/instant "2025-12-01T00:00:00Z", :created_at #time/instant "2023-12-17T08:05:04.551321Z", :updated_at #time/instant "2023-12-17T08:05:04.551321Z"} {:id #uuid "619c02a3-fa61-486a-8c06-69ab9b0c7e73", :name "bp_1_new_name", :inspection_start_date #time/instant "2024-06-01T00:00:00Z", :end_date #time/instant "2024-12-01T00:00:00Z", :created_at #time/instant "2023-12-17T08:05:03.344216Z", :updated_at #time/instant "2023-12-17T08:05:03.344216Z"})
2023-12-17T08:05:04.875Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:112] - (loop [[bp & rest-bps] (spy bps) bp-ids []] (if (spy bp) (let [bp-with-dates (spy (-> bp (update :inspection_start_date time-format/parse) (update :end_date time-format/parse))) p (spy bp-with-dates)] (do (if (spy (:id bp-with-dates)) (spy (budget-period/update-budget-period! tx bp-with-dates)) (spy (budget-period/insert-budget-period! tx (dissoc bp-with-dates :id)))) (let [bp-id (or (spy (:id bp-with-dates)) (spy (-> bp-with-dates (dissoc :id) spy (->> (budget-period/get-budget-period tx) spy) :id)))] (recur rest-bps (conj bp-ids bp-id))))) (do (spy (delete-budget-periods-not-in! tx bp-ids)) (spy (get-budget-periods context args value))))) => ({:id #uuid "9ab7cd6d-2af6-4088-8316-f1264ff4811c", :name "new_bp", :inspection_start_date #time/instant "2025-06-01T00:00:00Z", :end_date #time/instant "2025-12-01T00:00:00Z", :created_at #time/instant "2023-12-17T08:05:04.551321Z", :updated_at #time/instant "2023-12-17T08:05:04.551321Z"} {:id #uuid "619c02a3-fa61-486a-8c06-69ab9b0c7e73", :name "bp_1_new_name", :inspection_start_date #time/instant "2024-06-01T00:00:00Z", :end_date #time/instant "2024-12-01T00:00:00Z", :created_at #time/instant "2023-12-17T08:05:03.344216Z", :updated_at #time/instant "2023-12-17T08:05:03.344216Z"})
2023-12-17T08:05:04.875Z NX-41294 DEBUG [leihs.procurement.resources.budget-periods:106] - (let [tx (-> context :request :tx) bps (:input_data args)] (spy (loop [[bp & rest-bps] (spy bps) bp-ids []] (if (spy bp) (let [bp-with-dates (spy (-> bp (update :inspection_start_date time-format/parse) (update :end_date time-format/parse))) p (spy bp-with-dates)] (do (if (spy (:id bp-with-dates)) (spy (budget-period/update-budget-period! tx bp-with-dates)) (spy (budget-period/insert-budget-period! tx (dissoc bp-with-dates :id)))) (let [bp-id (or (spy (:id bp-with-dates)) (spy (-> bp-with-dates (dissoc :id) spy (->> (budget-period/get-budget-period tx) spy) :id)))] (recur rest-bps (conj bp-ids bp-id))))) (do (spy (delete-budget-periods-not-in! tx bp-ids)) (spy (get-budget-periods context args value))))))) =>

({:id #uuid "9ab7cd6d-2af6-4088-8316-f1264ff4811c", :name "new_bp", :inspection_start_date #time/instant "2025-06-01T00:00:00Z", :end_date #time/instant "2025-12-01T00:00:00Z", :created_at #time/instant "2023-12-17T08:05:04.551321Z", :updated_at #time/instant "2023-12-17T08:05:04.551321Z"} {:id #uuid "619c02a3-fa61-486a-8c06-69ab9b0c7e73", :name "bp_1_new_name", :inspection_start_date #time/instant "2024-06-01T00:00:00Z", :end_date #time/instant "2024-12-01T00:00:00Z", :created_at #time/instant "2023-12-17T08:05:03.344216Z", :updated_at #time/instant "2023-12-17T08:05:03.344216Z"})
