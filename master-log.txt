>>> authenticate::skip= true  handler-key= :sign-in
>>> authenticate::authenticated-entity nil

>> authorize >

>> authorize::handler > #object[leihs.core.locale$wrap$fn__44318 0x4cb26645 leihs.core.locale$wrap$fn__44318@4cb26645]

>> authorize::request > {:cookies {}, :remote-addr 127.0.0.1, :start-time 489326629620000, :params {}, :settings {:email_sending_enabled false, :sessions_max_lifetime_secs 432000, :smtp_default_from_address your.lending.desk@example.com, :public_image_caching_enabled true, :sessions_force_secure false, :deliver_received_order_notifications false, :external_base_url nil, :sessions_force_uniqueness false, :email_signature Cheers,}, :tx-next #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x2e18c1e HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x4c858a34 next.jdbc.result_set$as_unqualified_lower_maps@4c858a34]}}, :query-params-raw {}, :route-params nil, :headers {sec-fetch-site none, host localhost:3230, user-agent Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/115.0, sec-fetch-user ?1, connection keep-alive, upgrade-insecure-requests 1, accept text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8, accept-language de,en-US;q=0.7,en;q=0.3, sec-fetch-dest document, accept-encoding gzip, deflate, br, sec-fetch-mode navigate}, :async-channel #object[org.httpkit.server.AsyncChannel 0x4d6e767d /127.0.0.1:3230<->/127.0.0.1:63580], :server-port 3230, :params-raw {}, :tx {:datasource #object[com.zaxxer.hikari.HikariDataSource 0x153deae HikariDataSource (db-pool)]}, :content-length 0, :form-params {}, :websocket? false, :query-params {}, :content-type nil, :form-params-raw {}, :character-encoding utf8, :uri /sign-in, :server-name localhost, :handler-key :sign-in, :query-string nil, :body nil, :graphql-schema #CompiledSchema<>, :handler #object[compojure.core$routes$fn__27950 0x65328d1b compojure.core$routes$fn__27950@65328d1b], :multipart-params {}, :scheme :http, :request-method :get, :accept {:mime :html, :charset nil, :encoding nil, :language nil}}

>> authorize::handler-key >> :sign-in
2023-11-24T14:02:17.031Z NX-41294 DEBUG [leihs.procurement.authorization:135] - (skip? (:handler-key request)) => true
2023-11-24T14:02:17.124Z NX-41294 DEBUG [leihs.procurement.authorization:150] - (authorize handler request) => {:status 200, :headers {"Content-Type" "text/html; charset=utf-8"}, :body "<!DOCTYPE html>\n<html><head><style>body { font-family: sans-serif; width: 400px; margin: 2rem auto; text-align: center; }\n             * { margin: 0.5rem; }\n             input { width: 15rem; }\n             .message { background-color: pink; padding: 1rem; }</style></head><body><h1>Leihs Simple Login</h1><p>For testing only</p><form action=\"/sign-in\" class=\"ui-form-signin\" method=\"POST\"><div><label>Username<input name=\"user\" type=\"text\"></label></div><div><label>Password<input name=\"password\" type=\"password\" value=\"\"></label></div><input name=\"csrf-token\" type=\"hidden\" value=\"85b2de76-3ecd-40fd-a936-2d92f39bd32b\"><div><button type=\"submit\">Continue</button></div></form></body></html>", :cookies {"leihs-anti-csrf-token" {:value "85b2de76-3ecd-40fd-a936-2d92f39bd32b", :http-only false, :path "/", :secure false}}}
>>> authenticate::skip= nil  handler-key= :not-found
>>> authenticate::authenticated-entity nil
>>> authenticate::skip= true  handler-key= :sign-in
>>> authenticate::authenticated-entity nil

>> authorize >

>> authorize::handler > #object[leihs.core.locale$wrap$fn__44318 0x4cb26645 leihs.core.locale$wrap$fn__44318@4cb26645]

>> authorize::request > {:cookies {leihs-anti-csrf-token {:value 85b2de76-3ecd-40fd-a936-2d92f39bd32b}}, :remote-addr 127.0.0.1, :start-time 489326843238458, :params {:return-to /favicon.ico}, :settings {:email_sending_enabled false, :sessions_max_lifetime_secs 432000, :smtp_default_from_address your.lending.desk@example.com, :public_image_caching_enabled true, :sessions_force_secure false, :deliver_received_order_notifications false, :external_base_url nil, :sessions_force_uniqueness false, :email_signature Cheers,}, :tx-next #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x2e18c1e HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x4c858a34 next.jdbc.result_set$as_unqualified_lower_maps@4c858a34]}}, :query-params-raw {:return-to /favicon.ico}, :route-params nil, :headers {sec-fetch-site same-origin, host localhost:3230, user-agent Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/115.0, cookie leihs-anti-csrf-token=85b2de76-3ecd-40fd-a936-2d92f39bd32b, referer http://localhost:3230/sign-in, connection keep-alive, accept image/avif,image/webp,*/*, accept-language de,en-US;q=0.7,en;q=0.3, sec-fetch-dest image, accept-encoding gzip, deflate, br, sec-fetch-mode no-cors}, :async-channel #object[org.httpkit.server.AsyncChannel 0xb82007d /127.0.0.1:3230<->/127.0.0.1:63580], :server-port 3230, :params-raw {:return-to /favicon.ico}, :tx {:datasource #object[com.zaxxer.hikari.HikariDataSource 0x153deae HikariDataSource (db-pool)]}, :content-length 0, :form-params {}, :websocket? false, :query-params {:return-to /favicon.ico}, :content-type nil, :form-params-raw {}, :character-encoding utf8, :uri /sign-in, :server-name localhost, :handler-key :sign-in, :query-string return-to=%2Ffavicon.ico, :body nil, :graphql-schema #CompiledSchema<>, :handler #object[compojure.core$routes$fn__27950 0x65328d1b compojure.core$routes$fn__27950@65328d1b], :multipart-params {}, :scheme :http, :request-method :get, :accept {:mime :html, :charset nil, :encoding nil, :language nil}}

>> authorize::handler-key >> :sign-in
2023-11-24T14:02:17.210Z NX-41294 DEBUG [leihs.procurement.authorization:135] - (skip? (:handler-key request)) => true
2023-11-24T14:02:17.221Z NX-41294 DEBUG [leihs.procurement.authorization:150] - (authorize handler request) => {:status 200, :headers {"Content-Type" "text/html; charset=utf-8"}, :body "<!DOCTYPE html>\n<html><head><style>body { font-family: sans-serif; width: 400px; margin: 2rem auto; text-align: center; }\n             * { margin: 0.5rem; }\n             input { width: 15rem; }\n             .message { background-color: pink; padding: 1rem; }</style></head><body><h1>Leihs Simple Login</h1><p>For testing only</p><form action=\"/sign-in\" class=\"ui-form-signin\" method=\"POST\"><div><label>Username<input name=\"user\" type=\"text\"></label></div><div><label>Password<input name=\"password\" type=\"password\" value=\"\"></label></div><input name=\"csrf-token\" type=\"hidden\" value=\"85b2de76-3ecd-40fd-a936-2d92f39bd32b\"><input name=\"return-to\" type=\"hidden\" value=\"/favicon.ico\"><div><button type=\"submit\">Continue</button></div></form></body></html>"}
>>> authenticate::skip= true  handler-key= :sign-in
>>> authenticate::authenticated-entity nil

>> authorize >

>> authorize::handler > #object[leihs.core.locale$wrap$fn__44318 0x4cb26645 leihs.core.locale$wrap$fn__44318@4cb26645]

>> authorize::request > {:cookies {leihs-anti-csrf-token {:value 85b2de76-3ecd-40fd-a936-2d92f39bd32b}}, :remote-addr 127.0.0.1, :start-time 489326955700791, :params {:user jimmie@goyette.com, :password nil, :csrf-token 85b2de76-3ecd-40fd-a936-2d92f39bd32b}, :settings {:email_sending_enabled false, :sessions_max_lifetime_secs 432000, :smtp_default_from_address your.lending.desk@example.com, :public_image_caching_enabled true, :sessions_force_secure false, :deliver_received_order_notifications false, :external_base_url nil, :sessions_force_uniqueness false, :email_signature Cheers,}, :tx-next #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.pool.HikariProxyConnection 0x6ea11885 HikariProxyConnection@1856051333 wrapping org.postgresql.jdbc.PgConnection@67447b0c], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x4c858a34 next.jdbc.result_set$as_unqualified_lower_maps@4c858a34]}}, :query-params-raw {}, :route-params nil, :headers {origin http://localhost:3230, sec-fetch-site same-origin, host localhost:3230, user-agent Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/115.0, content-type application/x-www-form-urlencoded, cookie leihs-anti-csrf-token=85b2de76-3ecd-40fd-a936-2d92f39bd32b, content-length 83, sec-fetch-user ?1, referer http://localhost:3230/sign-in, connection keep-alive, upgrade-insecure-requests 1, accept text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8, accept-language de,en-US;q=0.7,en;q=0.3, sec-fetch-dest document, accept-encoding gzip, deflate, br, sec-fetch-mode navigate}, :async-channel #object[org.httpkit.server.AsyncChannel 0x3659e54c /127.0.0.1:3230<->/127.0.0.1:63580], :server-port 3230, :params-raw {:user jimmie@goyette.com, :password , :csrf-token 85b2de76-3ecd-40fd-a936-2d92f39bd32b}, :tx {:datasource #object[com.zaxxer.hikari.HikariDataSource 0x153deae HikariDataSource (db-pool)], :connection #object[com.zaxxer.hikari.pool.HikariProxyConnection 0x30a8a8e4 HikariProxyConnection@816359652 wrapping org.postgresql.jdbc.PgConnection@5197d5af], :level 1, :rollback #object[clojure.lang.Atom 0x7052a13 {:status :ready, :val false}]}, :content-length 83, :form-params {:user jimmie@goyette.com, :password nil, :csrf-token 85b2de76-3ecd-40fd-a936-2d92f39bd32b}, :websocket? false, :query-params {}, :content-type application/x-www-form-urlencoded, :form-params-raw {:user jimmie@goyette.com, :password , :csrf-token 85b2de76-3ecd-40fd-a936-2d92f39bd32b}, :character-encoding utf8, :uri /sign-in, :server-name localhost, :handler-key :sign-in, :query-string nil, :body #object[org.httpkit.BytesInputStream 0x1595a3fd BytesInputStream[len=83]], :graphql-schema #CompiledSchema<>, :handler #object[compojure.core$routes$fn__27950 0x65328d1b compojure.core$routes$fn__27950@65328d1b], :multipart-params {}, :scheme :http, :request-method :post, :accept {:mime :html, :charset nil, :encoding nil, :language nil}}

>> authorize::handler-key >> :sign-in
2023-11-24T14:02:17.327Z NX-41294 DEBUG [leihs.procurement.authorization:135] - (skip? (:handler-key request)) => true
2023-11-24T14:02:17.348Z NX-41294 DEBUG [leihs.procurement.authorization:150] - (authorize handler request) => {:status 200, :headers {"Content-Type" "text/html; charset=utf-8"}, :body "<!DOCTYPE html>\n<html><head><style>body { font-family: sans-serif; width: 400px; margin: 2rem auto; text-align: center; }\n             * { margin: 0.5rem; }\n             input { width: 15rem; }\n             .message { background-color: pink; padding: 1rem; }</style></head><body><h1>Leihs Simple Login</h1><p>For testing only</p><form action=\"/sign-in\" class=\"ui-form-signin\" method=\"POST\"><div><label>Username<input name=\"user\" type=\"text\" value=\"jimmie@goyette.com\"></label></div><div><label>Password<input name=\"password\" type=\"password\" value=\"\"></label></div><input name=\"csrf-token\" type=\"hidden\" value=\"85b2de76-3ecd-40fd-a936-2d92f39bd32b\"><div><button type=\"submit\">Continue</button></div></form></body></html>"}
>>> authenticate::skip= true  handler-key= :sign-in
>>> authenticate::authenticated-entity nil

>> authorize >

>> authorize::handler > #object[leihs.core.locale$wrap$fn__44318 0x4cb26645 leihs.core.locale$wrap$fn__44318@4cb26645]

>> authorize::request > {:cookies {leihs-anti-csrf-token {:value 85b2de76-3ecd-40fd-a936-2d92f39bd32b}}, :remote-addr 127.0.0.1, :start-time 489327050916666, :params {:user jimmie@goyette.com, :password password, :csrf-token 85b2de76-3ecd-40fd-a936-2d92f39bd32b}, :settings {:email_sending_enabled false, :sessions_max_lifetime_secs 432000, :smtp_default_from_address your.lending.desk@example.com, :public_image_caching_enabled true, :sessions_force_secure false, :deliver_received_order_notifications false, :external_base_url nil, :sessions_force_uniqueness false, :email_signature Cheers,}, :tx-next #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.pool.HikariProxyConnection 0x5c91254e HikariProxyConnection@1553016142 wrapping org.postgresql.jdbc.PgConnection@67447b0c], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x4c858a34 next.jdbc.result_set$as_unqualified_lower_maps@4c858a34]}}, :query-params-raw {}, :route-params nil, :headers {origin http://localhost:3230, sec-fetch-site same-origin, host localhost:3230, user-agent Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/115.0, content-type application/x-www-form-urlencoded, cookie leihs-anti-csrf-token=85b2de76-3ecd-40fd-a936-2d92f39bd32b, content-length 91, sec-fetch-user ?1, referer http://localhost:3230/sign-in, connection keep-alive, upgrade-insecure-requests 1, accept text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8, accept-language de,en-US;q=0.7,en;q=0.3, sec-fetch-dest document, accept-encoding gzip, deflate, br, sec-fetch-mode navigate}, :async-channel #object[org.httpkit.server.AsyncChannel 0x1ffa620a /127.0.0.1:3230<->/127.0.0.1:63580], :server-port 3230, :params-raw {:user jimmie@goyette.com, :password password, :csrf-token 85b2de76-3ecd-40fd-a936-2d92f39bd32b}, :tx {:datasource #object[com.zaxxer.hikari.HikariDataSource 0x153deae HikariDataSource (db-pool)], :connection #object[com.zaxxer.hikari.pool.HikariProxyConnection 0x2cafa281 HikariProxyConnection@749707905 wrapping org.postgresql.jdbc.PgConnection@5197d5af], :level 1, :rollback #object[clojure.lang.Atom 0x6732d288 {:status :ready, :val false}]}, :content-length 91, :form-params {:user jimmie@goyette.com, :password password, :csrf-token 85b2de76-3ecd-40fd-a936-2d92f39bd32b}, :websocket? false, :query-params {}, :content-type application/x-www-form-urlencoded, :form-params-raw {:user jimmie@goyette.com, :password password, :csrf-token 85b2de76-3ecd-40fd-a936-2d92f39bd32b}, :character-encoding utf8, :uri /sign-in, :server-name localhost, :handler-key :sign-in, :query-string nil, :body #object[org.httpkit.BytesInputStream 0x32dc2075 BytesInputStream[len=91]], :graphql-schema #CompiledSchema<>, :handler #object[compojure.core$routes$fn__27950 0x65328d1b compojure.core$routes$fn__27950@65328d1b], :multipart-params {}, :scheme :http, :request-method :post, :accept {:mime :html, :charset nil, :encoding nil, :language nil}}

>> authorize::handler-key >> :sign-in
2023-11-24T14:02:17.413Z NX-41294 DEBUG [leihs.procurement.authorization:135] - (skip? (:handler-key request)) => true
2023-11-24T14:02:17.510Z NX-41294 DEBUG [leihs.procurement.authorization:150] - (authorize handler request) => {:status 302, :headers {"Location" "/procure"}, :body "", :cookies {"leihs-user-session" {:value "88ce2c7c-4075-46c2-80ca-82d865f9353e", :http-only true, :max-age 307584000, :path "/", :secure false}, "leihs-user-locale" {:value nil, :path "/", :max-age 0}}}
>>> authenticate::skip= nil  handler-key= :procurement
>>> authenticate::authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-24T14:02:17.415645Z", :id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :user_session_id #uuid "e25b9e9c-082c-43d7-8468-0c267e3212a7", :scope_system_admin_read false, :access-rights (), :user_id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}

>> authorize >

>> authorize::handler > #object[leihs.core.locale$wrap$fn__44318 0x4cb26645 leihs.core.locale$wrap$fn__44318@4cb26645]

>> authorize::request > {:authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-24T14:02:17.415645Z", :id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :user_session_id #uuid "e25b9e9c-082c-43d7-8468-0c267e3212a7", :scope_system_admin_read false, :access-rights (), :user_id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}, :cookies {leihs-anti-csrf-token {:value 85b2de76-3ecd-40fd-a936-2d92f39bd32b}, leihs-user-session {:value 88ce2c7c-4075-46c2-80ca-82d865f9353e}}, :remote-addr 127.0.0.1, :start-time 489327167014166, :params {}, :settings {:email_sending_enabled false, :sessions_max_lifetime_secs 432000, :smtp_default_from_address your.lending.desk@example.com, :public_image_caching_enabled true, :sessions_force_secure false, :deliver_received_order_notifications false, :external_base_url nil, :sessions_force_uniqueness false, :email_signature Cheers,}, :tx-next #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x2e18c1e HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x4c858a34 next.jdbc.result_set$as_unqualified_lower_maps@4c858a34]}}, :query-params-raw {}, :route-params nil, :headers {sec-fetch-site same-origin, host localhost:3230, user-agent Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/115.0, cookie leihs-anti-csrf-token=85b2de76-3ecd-40fd-a936-2d92f39bd32b; leihs-user-session=88ce2c7c-4075-46c2-80ca-82d865f9353e, sec-fetch-user ?1, referer http://localhost:3230/sign-in, connection keep-alive, upgrade-insecure-requests 1, accept text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8, accept-language de,en-US;q=0.7,en;q=0.3, sec-fetch-dest document, accept-encoding gzip, deflate, br, sec-fetch-mode navigate}, :async-channel #object[org.httpkit.server.AsyncChannel 0x58f7c9ee /127.0.0.1:3230<->/127.0.0.1:63580], :server-port 3230, :params-raw {}, :tx {:datasource #object[com.zaxxer.hikari.HikariDataSource 0x153deae HikariDataSource (db-pool)]}, :content-length 0, :form-params {}, :websocket? false, :query-params {}, :content-type nil, :form-params-raw {}, :character-encoding utf8, :uri /procure, :server-name localhost, :handler-key :procurement, :query-string nil, :body nil, :graphql-schema #CompiledSchema<>, :handler #object[leihs.procurement.backend.html$not_found_handler 0x71f50b1c leihs.procurement.backend.html$not_found_handler@71f50b1c], :multipart-params {}, :scheme :http, :request-method :get, :accept {:mime :html, :charset nil, :encoding nil, :language nil}}

>> authorize::handler-key >> :procurement
2023-11-24T14:02:17.551Z NX-41294 DEBUG [leihs.procurement.authorization:135] - (skip? (:handler-key request)) => nil
2023-11-24T14:02:17.554Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:17.558Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:17.562Z NX-41294 DEBUG [leihs.procurement.permissions.user:52] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_viewers) (sql/merge-where [:= :procurement_category_viewers.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_viewers.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:17.566Z NX-41294 DEBUG [leihs.procurement.permissions.user:72] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_requesters_organizations) (sql/where [:= :procurement_requesters_organizations.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:17.567Z NX-41294 DEBUG [leihs.procurement.authorization:136] - (->> [user-perms/admin? user-perms/inspector? user-perms/viewer? user-perms/requester?] (map (fn* [p1__39355#] (p1__39355# (:tx request) (:authenticated-entity request)))) (some true?)) => true
2023-11-24T14:02:17.571Z NX-41294 DEBUG [leihs.procurement.authorization:150] - (authorize handler request) => {:status 404, :headers {"Content-Length" "2299", "Last-Modified" "Fri, 24 Nov 2023 11:34:31 GMT", "Content-Type" "text/html"}, :body #object[java.io.File 0x584d87b "/Users/mradl/repos/leihs/procure/server/resources/public/procure/client/index.html"]}
>>> authenticate::skip= nil  handler-key= :not-found
>>> authenticate::authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-24T14:02:17.415645Z", :id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :user_session_id #uuid "e25b9e9c-082c-43d7-8468-0c267e3212a7", :scope_system_admin_read false, :access-rights (), :user_id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}

>> authorize >

>> authorize::handler > #object[leihs.core.locale$wrap$fn__44318 0x4cb26645 leihs.core.locale$wrap$fn__44318@4cb26645]

>> authorize::request > {:authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-24T14:02:17.415645Z", :id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :user_session_id #uuid "e25b9e9c-082c-43d7-8468-0c267e3212a7", :scope_system_admin_read false, :access-rights (), :user_id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}, :cookies {leihs-anti-csrf-token {:value 85b2de76-3ecd-40fd-a936-2d92f39bd32b}, leihs-user-session {:value 88ce2c7c-4075-46c2-80ca-82d865f9353e}}, :remote-addr 127.0.0.1, :start-time 489327428611250, :params {}, :settings {:email_sending_enabled false, :sessions_max_lifetime_secs 432000, :smtp_default_from_address your.lending.desk@example.com, :public_image_caching_enabled true, :sessions_force_secure false, :deliver_received_order_notifications false, :external_base_url nil, :sessions_force_uniqueness false, :email_signature Cheers,}, :tx-next #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x2e18c1e HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x4c858a34 next.jdbc.result_set$as_unqualified_lower_maps@4c858a34]}}, :query-params-raw {}, :route-params nil, :headers {sec-fetch-site same-origin, host localhost:3230, user-agent Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/115.0, cookie leihs-anti-csrf-token=85b2de76-3ecd-40fd-a936-2d92f39bd32b; leihs-user-session=88ce2c7c-4075-46c2-80ca-82d865f9353e, referer http://localhost:3230/procure, connection keep-alive, accept image/avif,image/webp,*/*, accept-language de,en-US;q=0.7,en;q=0.3, sec-fetch-dest image, accept-encoding gzip, deflate, br, sec-fetch-mode no-cors}, :async-channel #object[org.httpkit.server.AsyncChannel 0x1d376e97 /127.0.0.1:3230<->/127.0.0.1:63588], :server-port 3230, :params-raw {}, :tx {:datasource #object[com.zaxxer.hikari.HikariDataSource 0x153deae HikariDataSource (db-pool)]}, :content-length 0, :form-params {}, :websocket? false, :query-params {}, :content-type nil, :form-params-raw {}, :character-encoding utf8, :uri /procure/favicon.ico, :server-name localhost, :handler-key :not-found, :query-string nil, :body nil, :graphql-schema #CompiledSchema<>, :handler #object[leihs.procurement.backend.html$not_found_handler 0x71f50b1c leihs.procurement.backend.html$not_found_handler@71f50b1c], :multipart-params {}, :scheme :http, :request-method :get, :accept {:mime :html, :charset nil, :encoding nil, :language nil}}

>> authorize::handler-key >> :not-found
2023-11-24T14:02:17.798Z NX-41294 DEBUG [leihs.procurement.authorization:135] - (skip? (:handler-key request)) => nil
2023-11-24T14:02:17.799Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:17.800Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:17.801Z NX-41294 DEBUG [leihs.procurement.permissions.user:52] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_viewers) (sql/merge-where [:= :procurement_category_viewers.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_viewers.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:17.802Z NX-41294 DEBUG [leihs.procurement.permissions.user:72] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_requesters_organizations) (sql/where [:= :procurement_requesters_organizations.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:17.804Z NX-41294 DEBUG [leihs.procurement.authorization:136] - (->> [user-perms/admin? user-perms/inspector? user-perms/viewer? user-perms/requester?] (map (fn* [p1__39355#] (p1__39355# (:tx request) (:authenticated-entity request)))) (some true?)) => true
2023-11-24T14:02:17.806Z NX-41294 DEBUG [leihs.procurement.authorization:150] - (authorize handler request) => {:status 404, :headers {"Content-Length" "2299", "Last-Modified" "Fri, 24 Nov 2023 11:34:31 GMT", "Content-Type" "text/html"}, :body #object[java.io.File 0x421fd812 "/Users/mradl/repos/leihs/procure/server/resources/public/procure/client/index.html"]}
>>> authenticate::skip= nil  handler-key= :graphql
>>> authenticate::authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-24T14:02:17.415645Z", :id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :user_session_id #uuid "e25b9e9c-082c-43d7-8468-0c267e3212a7", :scope_system_admin_read false, :access-rights (), :user_id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}

>> authorize >

>> authorize::handler > #object[leihs.core.locale$wrap$fn__44318 0x4cb26645 leihs.core.locale$wrap$fn__44318@4cb26645]

>> authorize::request > {:authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-24T14:02:17.415645Z", :id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :user_session_id #uuid "e25b9e9c-082c-43d7-8468-0c267e3212a7", :scope_system_admin_read false, :access-rights (), :user_id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}, :cookies {leihs-anti-csrf-token {:value 85b2de76-3ecd-40fd-a936-2d92f39bd32b}, leihs-user-session {:value 88ce2c7c-4075-46c2-80ca-82d865f9353e}}, :remote-addr 127.0.0.1, :start-time 489327433541750, :params {}, :settings {:email_sending_enabled false, :sessions_max_lifetime_secs 432000, :smtp_default_from_address your.lending.desk@example.com, :public_image_caching_enabled true, :sessions_force_secure false, :deliver_received_order_notifications false, :external_base_url nil, :sessions_force_uniqueness false, :email_signature Cheers,}, :tx-next #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x2e18c1e HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x4c858a34 next.jdbc.result_set$as_unqualified_lower_maps@4c858a34]}}, :query-params-raw {}, :route-params nil, :headers {origin http://localhost:3230, sec-fetch-site same-origin, host localhost:3230, user-agent Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/115.0, content-type application/json, cookie leihs-anti-csrf-token=85b2de76-3ecd-40fd-a936-2d92f39bd32b; leihs-user-session=88ce2c7c-4075-46c2-80ca-82d865f9353e, content-length 502, referer http://localhost:3230/procure, connection keep-alive, x-csrf-token 85b2de76-3ecd-40fd-a936-2d92f39bd32b, accept application/json, accept-language de,en-US;q=0.7,en;q=0.3, sec-fetch-dest empty, accept-encoding gzip, deflate, br, sec-fetch-mode cors}, :async-channel #object[org.httpkit.server.AsyncChannel 0x52d75d93 /127.0.0.1:3230<->/127.0.0.1:63580], :server-port 3230, :params-raw {}, :tx {:datasource #object[com.zaxxer.hikari.HikariDataSource 0x153deae HikariDataSource (db-pool)]}, :content-length 502, :form-params {}, :websocket? false, :query-params {}, :content-type application/json, :form-params-raw {}, :character-encoding utf8, :uri /procure/graphql, :server-name localhost, :handler-key :graphql, :query-string nil, :body {:operationName me, :variables {}, :query query me {
  current_user {
    navbarProps
    user {
      id
      firstname
      lastname
      permissions {
        isAdmin
        isRequester
        isInspectorForCategories {
          id
          __typename
        }
        isViewerForCategories {
          id
          __typename
        }
        __typename
      }
      __typename
    }
    __typename
  }
  settings {
    contact_url
    __typename
  }
}
}, :graphql-schema #CompiledSchema<>, :handler #object[leihs.procurement.graphql$handler 0x1a4a1f6f leihs.procurement.graphql$handler@1a4a1f6f], :multipart-params {}, :scheme :http, :request-method :post, :accept {:mime :json, :charset nil, :encoding nil, :language nil}}

>> authorize::handler-key >> :graphql
2023-11-24T14:02:17.838Z NX-41294 DEBUG [leihs.procurement.authorization:135] - (skip? (:handler-key request)) => nil
2023-11-24T14:02:17.839Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:17.840Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:17.843Z NX-41294 DEBUG [leihs.procurement.permissions.user:52] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_viewers) (sql/merge-where [:= :procurement_category_viewers.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_viewers.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:17.844Z NX-41294 DEBUG [leihs.procurement.permissions.user:72] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_requesters_organizations) (sql/where [:= :procurement_requesters_organizations.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:17.844Z NX-41294 DEBUG [leihs.procurement.authorization:136] - (->> [user-perms/admin? user-perms/inspector? user-perms/viewer? user-perms/requester?] (map (fn* [p1__39355#] (p1__39355# (:tx request) (:authenticated-entity request)))) (some true?)) => true

>>>exec-query::variables {}
2023-11-24T14:02:17.888Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:17.889Z NX-41294 DEBUG [leihs.procurement.permissions.user:72] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_requesters_organizations) (sql/where [:= :procurement_requesters_organizations.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]

>>>pure-handler {:data #ordered/map ([:current_user #ordered/map ([:navbarProps {"csrfToken":{"value":"85b2de76-3ecd-40fd-a936-2d92f39bd32b","name":"csrf-token"},"config":{"appTitle":"leihs","appColor":"gray","me":{"user":{"id":"3b8e0ffa-8f85-46fd-8ea6-52eb2927015f","firstname":"Procurement","lastname":"Admin","login":null,"email":"jimmie@goyette.com"}},"subApps":{"borrow":false,"admin":false,"procure":false,"manage":[]},"locales":[{"name":"English (UK)","locale":"en-GB","active":true,"isDefault":true,"isSelected":true},{"name":"English (US)","locale":"en-US","active":true,"isDefault":false,"isSelected":false},{"name":"Deutsch","locale":"de-CH","active":true,"isDefault":false,"isSelected":false},{"name":"Züritüütsch","locale":"gsw-CH","active":true,"isDefault":false,"isSelected":false}]}}] [:user #ordered/map ([:id 3b8e0ffa-8f85-46fd-8ea6-52eb2927015f] [:firstname Procurement] [:lastname Admin] [:permissions #ordered/map ([:isAdmin true] [:isRequester false] [:isInspectorForCategories []] [:isViewerForCategories []] [:__typename :UserPermissions])] [:__typename :User])] [:__typename :CurrentUser])] [:settings #ordered/map ([:contact_url http://hartmann.io/rolf] [:__typename :ProcurementSettings])])}
2023-11-24T14:02:17.903Z NX-41294 DEBUG [leihs.procurement.graphql:64] - result => {:data #ordered/map ([:current_user #ordered/map ([:navbarProps "{\"csrfToken\":{\"value\":\"85b2de76-3ecd-40fd-a936-2d92f39bd32b\",\"name\":\"csrf-token\"},\"config\":{\"appTitle\":\"leihs\",\"appColor\":\"gray\",\"me\":{\"user\":{\"id\":\"3b8e0ffa-8f85-46fd-8ea6-52eb2927015f\",\"firstname\":\"Procurement\",\"lastname\":\"Admin\",\"login\":null,\"email\":\"jimmie@goyette.com\"}},\"subApps\":{\"borrow\":false,\"admin\":false,\"procure\":false,\"manage\":[]},\"locales\":[{\"name\":\"English (UK)\",\"locale\":\"en-GB\",\"active\":true,\"isDefault\":true,\"isSelected\":true},{\"name\":\"English (US)\",\"locale\":\"en-US\",\"active\":true,\"isDefault\":false,\"isSelected\":false},{\"name\":\"Deutsch\",\"locale\":\"de-CH\",\"active\":true,\"isDefault\":false,\"isSelected\":false},{\"name\":\"Züritüütsch\",\"locale\":\"gsw-CH\",\"active\":true,\"isDefault\":false,\"isSelected\":false}]}}"] [:user #ordered/map ([:id "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"] [:firstname "Procurement"] [:lastname "Admin"] [:permissions #ordered/map ([:isAdmin true] [:isRequester false] [:isInspectorForCategories []] [:isViewerForCategories []] [:__typename :UserPermissions])] [:__typename :User])] [:__typename :CurrentUser])] [:settings #ordered/map ([:contact_url "http://hartmann.io/rolf"] [:__typename :ProcurementSettings])])}
2023-11-24T14:02:17.904Z NX-41294 DEBUG [leihs.procurement.authorization:150] - (authorize handler request) => {:body {:data #ordered/map ([:current_user #ordered/map ([:navbarProps "{\"csrfToken\":{\"value\":\"85b2de76-3ecd-40fd-a936-2d92f39bd32b\",\"name\":\"csrf-token\"},\"config\":{\"appTitle\":\"leihs\",\"appColor\":\"gray\",\"me\":{\"user\":{\"id\":\"3b8e0ffa-8f85-46fd-8ea6-52eb2927015f\",\"firstname\":\"Procurement\",\"lastname\":\"Admin\",\"login\":null,\"email\":\"jimmie@goyette.com\"}},\"subApps\":{\"borrow\":false,\"admin\":false,\"procure\":false,\"manage\":[]},\"locales\":[{\"name\":\"English (UK)\",\"locale\":\"en-GB\",\"active\":true,\"isDefault\":true,\"isSelected\":true},{\"name\":\"English (US)\",\"locale\":\"en-US\",\"active\":true,\"isDefault\":false,\"isSelected\":false},{\"name\":\"Deutsch\",\"locale\":\"de-CH\",\"active\":true,\"isDefault\":false,\"isSelected\":false},{\"name\":\"Züritüütsch\",\"locale\":\"gsw-CH\",\"active\":true,\"isDefault\":false,\"isSelected\":false}]}}"] [:user #ordered/map ([:id "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"] [:firstname "Procurement"] [:lastname "Admin"] [:permissions #ordered/map ([:isAdmin true] [:isRequester false] [:isInspectorForCategories []] [:isViewerForCategories []] [:__typename :UserPermissions])] [:__typename :User])] [:__typename :CurrentUser])] [:settings #ordered/map ([:contact_url "http://hartmann.io/rolf"] [:__typename :ProcurementSettings])])}}
>>> authenticate::skip= nil  handler-key= :graphql
>>> authenticate::authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-24T14:02:17.415645Z", :id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :user_session_id #uuid "e25b9e9c-082c-43d7-8468-0c267e3212a7", :scope_system_admin_read false, :access-rights (), :user_id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}

>> authorize >

>> authorize::handler > #object[leihs.core.locale$wrap$fn__44318 0x4cb26645 leihs.core.locale$wrap$fn__44318@4cb26645]

>> authorize::request > {:authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-24T14:02:17.415645Z", :id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :user_session_id #uuid "e25b9e9c-082c-43d7-8468-0c267e3212a7", :scope_system_admin_read false, :access-rights (), :user_id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}, :cookies {leihs-anti-csrf-token {:value 85b2de76-3ecd-40fd-a936-2d92f39bd32b}, leihs-user-session {:value 88ce2c7c-4075-46c2-80ca-82d865f9353e}}, :remote-addr 127.0.0.1, :start-time 489327648871208, :params {}, :settings {:email_sending_enabled false, :sessions_max_lifetime_secs 432000, :smtp_default_from_address your.lending.desk@example.com, :public_image_caching_enabled true, :sessions_force_secure false, :deliver_received_order_notifications false, :external_base_url nil, :sessions_force_uniqueness false, :email_signature Cheers,}, :tx-next #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x2e18c1e HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x4c858a34 next.jdbc.result_set$as_unqualified_lower_maps@4c858a34]}}, :query-params-raw {}, :route-params nil, :headers {origin http://localhost:3230, sec-fetch-site same-origin, host localhost:3230, user-agent Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/115.0, content-type application/json, cookie leihs-anti-csrf-token=85b2de76-3ecd-40fd-a936-2d92f39bd32b; leihs-user-session=88ce2c7c-4075-46c2-80ca-82d865f9353e, content-length 502, referer http://localhost:3230/procure/requests, connection keep-alive, x-csrf-token 85b2de76-3ecd-40fd-a936-2d92f39bd32b, accept application/json, accept-language de,en-US;q=0.7,en;q=0.3, sec-fetch-dest empty, accept-encoding gzip, deflate, br, sec-fetch-mode cors}, :async-channel #object[org.httpkit.server.AsyncChannel 0x78dd20bb /127.0.0.1:3230<->/127.0.0.1:63590], :server-port 3230, :params-raw {}, :tx {:datasource #object[com.zaxxer.hikari.HikariDataSource 0x153deae HikariDataSource (db-pool)]}, :content-length 502, :form-params {}, :websocket? false, :query-params {}, :content-type application/json, :form-params-raw {}, :character-encoding utf8, :uri /procure/graphql, :server-name localhost, :handler-key :graphql, :query-string nil, :body {:operationName me, :variables {}, :query query me {
  current_user {
    navbarProps
    user {
      id
      firstname
      lastname
      permissions {
        isAdmin
        isRequester
        isInspectorForCategories {
          id
          __typename
        }
        isViewerForCategories {
          id
          __typename
        }
        __typename
      }
      __typename
    }
    __typename
  }
  settings {
    contact_url
    __typename
  }
}
}, :graphql-schema #CompiledSchema<>, :handler #object[leihs.procurement.graphql$handler 0x1a4a1f6f leihs.procurement.graphql$handler@1a4a1f6f], :multipart-params {}, :scheme :http, :request-method :post, :accept {:mime :json, :charset nil, :encoding nil, :language nil}}

>> authorize::handler-key >> :graphql
2023-11-24T14:02:18.034Z NX-41294 DEBUG [leihs.procurement.authorization:135] - (skip? (:handler-key request)) => nil
2023-11-24T14:02:18.035Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:18.037Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:18.043Z NX-41294 DEBUG [leihs.procurement.permissions.user:52] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_viewers) (sql/merge-where [:= :procurement_category_viewers.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_viewers.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
>>> authenticate::skip= nil  handler-key= :graphql
>>> authenticate::authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-24T14:02:17.415645Z", :id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :user_session_id #uuid "e25b9e9c-082c-43d7-8468-0c267e3212a7", :scope_system_admin_read false, :access-rights (), :user_id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}

>> authorize >

>> authorize::handler > #object[leihs.core.locale$wrap$fn__44318 0x4cb26645 leihs.core.locale$wrap$fn__44318@4cb26645]

>> authorize::request > {:authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-24T14:02:17.415645Z", :id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :user_session_id #uuid "e25b9e9c-082c-43d7-8468-0c267e3212a7", :scope_system_admin_read false, :access-rights (), :user_id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}, :cookies {leihs-anti-csrf-token {:value 85b2de76-3ecd-40fd-a936-2d92f39bd32b}, leihs-user-session {:value 88ce2c7c-4075-46c2-80ca-82d865f9353e}}, :remote-addr 127.0.0.1, :start-time 489327648125541, :params {}, :settings {:email_sending_enabled false, :sessions_max_lifetime_secs 432000, :smtp_default_from_address your.lending.desk@example.com, :public_image_caching_enabled true, :sessions_force_secure false, :deliver_received_order_notifications false, :external_base_url nil, :sessions_force_uniqueness false, :email_signature Cheers,}, :tx-next #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x2e18c1e HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x4c858a34 next.jdbc.result_set$as_unqualified_lower_maps@4c858a34]}}, :query-params-raw {}, :route-params nil, :headers {origin http://localhost:3230, sec-fetch-site same-origin, host localhost:3230, user-agent Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/115.0, content-type application/json, cookie leihs-anti-csrf-token=85b2de76-3ecd-40fd-a936-2d92f39bd32b; leihs-user-session=88ce2c7c-4075-46c2-80ca-82d865f9353e, content-length 3575, referer http://localhost:3230/procure/requests, connection keep-alive, x-csrf-token 85b2de76-3ecd-40fd-a936-2d92f39bd32b, accept application/json, accept-language de,en-US;q=0.7,en;q=0.3, sec-fetch-dest empty, accept-encoding gzip, deflate, br, sec-fetch-mode cors}, :async-channel #object[org.httpkit.server.AsyncChannel 0x490964ab /127.0.0.1:3230<->/127.0.0.1:63588], :server-port 3230, :params-raw {}, :tx {:datasource #object[com.zaxxer.hikari.HikariDataSource 0x153deae HikariDataSource (db-pool)]}, :content-length 3575, :form-params {}, :websocket? false, :query-params {}, :content-type application/json, :form-params-raw {}, :character-encoding utf8, :uri /procure/graphql, :server-name localhost, :handler-key :graphql, :query-string nil, :body {:operationName RequestsIndexFiltered, :variables {}, :query query RequestsIndexFiltered($budgetPeriods: [ID!], $categories: [ID!], $search: String, $state: [State!], $order_status: [OrderStatus], $organizations: [ID!], $priority: [Priority!], $inspector_priority: [InspectorPriority!], $onlyOwnRequests: Boolean) {
  dashboard(budget_period_id: $budgetPeriods, category_id: $categories, search: $search, state: $state, order_status: $order_status, organization_id: $organizations, priority: $priority, inspector_priority: $inspector_priority, requested_by_auth_user: $onlyOwnRequests) {
    cacheKey
    total_count
    budget_periods {
      id
      cacheKey
      name
      inspection_start_date
      end_date
      total_price_cents
      main_categories {
        id
        cacheKey
        name
        image_url
        total_price_cents
        categories {
          id
          cacheKey
          name
          total_price_cents
          requests {
            ...RequestFieldsForIndex
            total_price_cents
            actionPermissions {
              edit
              __typename
            }
            __typename
          }
          __typename
        }
        __typename
      }
      __typename
    }
    __typename
  }
}

fragment RequestFieldsForIndex on Request {
  id
  short_id
  user {
    value {
      id
      firstname
      lastname
      __typename
    }
    __typename
  }
  category {
    read
    write
    required
    value {
      id
      name
      main_category {
        id
        name
        __typename
      }
      __typename
    }
    __typename
  }
  budget_period {
    read
    write
    required
    value {
      name
      id
      __typename
    }
    __typename
  }
  article_name {
    value
    __typename
  }
  model {
    value {
      id
      product
      version
      __typename
    }
    __typename
  }
  receiver {
    value
    __typename
  }
  organization {
    value {
      id
      name
      shortname
      department {
        id
        name
        __typename
      }
      __typename
    }
    __typename
  }
  price_cents {
    value
    __typename
  }
  price_currency {
    value
    __typename
  }
  requested_quantity {
    read
    value
    __typename
  }
  approved_quantity {
    read
    value
    __typename
  }
  order_quantity {
    read
    value
    __typename
  }
  replacement {
    value
    __typename
  }
  priority {
    value
    __typename
  }
  state
  article_number {
    value
    __typename
  }
  supplier {
    value {
      name
      __typename
    }
    __typename
  }
  supplier_name {
    value
    __typename
  }
  receiver {
    value
    __typename
  }
  room {
    value {
      id
      name
      building {
        id
        name
        __typename
      }
      __typename
    }
    __typename
  }
  motivation {
    value
    __typename
  }
  inspection_comment {
    value
    __typename
  }
  inspector_priority {
    value
    __typename
  }
  accounting_type {
    value
    __typename
  }
  cost_center {
    value
    __typename
  }
  general_ledger_account {
    value
    __typename
  }
  procurement_account {
    value
    __typename
  }
  internal_order_number {
    value
    __typename
  }
  order_status {
    value
    __typename
  }
  order_comment {
    value
    __typename
  }
  __typename
}
}, :graphql-schema #CompiledSchema<>, :handler #object[leihs.procurement.graphql$handler 0x1a4a1f6f leihs.procurement.graphql$handler@1a4a1f6f], :multipart-params {}, :scheme :http, :request-method :post, :accept {:mime :json, :charset nil, :encoding nil, :language nil}}
2023-11-24T14:02:18.044Z NX-41294 DEBUG [leihs.procurement.permissions.user:72] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_requesters_organizations) (sql/where [:= :procurement_requesters_organizations.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]

>> authorize::handler-key >> :graphql
2023-11-24T14:02:18.056Z NX-41294 DEBUG [leihs.procurement.authorization:135] - (skip? (:handler-key request)) => nil
2023-11-24T14:02:18.058Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:18.058Z NX-41294 DEBUG [leihs.procurement.authorization:136] - (->> [user-perms/admin? user-perms/inspector? user-perms/viewer? user-perms/requester?] (map (fn* [p1__39355#] (p1__39355# (:tx request) (:authenticated-entity request)))) (some true?)) => true
2023-11-24T14:02:18.059Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:18.062Z NX-41294 DEBUG [leihs.procurement.permissions.user:52] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_viewers) (sql/merge-where [:= :procurement_category_viewers.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_viewers.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:18.063Z NX-41294 DEBUG [leihs.procurement.permissions.user:72] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_requesters_organizations) (sql/where [:= :procurement_requesters_organizations.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:18.064Z NX-41294 DEBUG [leihs.procurement.authorization:136] - (->> [user-perms/admin? user-perms/inspector? user-perms/viewer? user-perms/requester?] (map (fn* [p1__39355#] (p1__39355# (:tx request) (:authenticated-entity request)))) (some true?)) => true
>>> authenticate::skip= nil  handler-key= :graphql
>>> authenticate::authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-24T14:02:17.415645Z", :id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :user_session_id #uuid "e25b9e9c-082c-43d7-8468-0c267e3212a7", :scope_system_admin_read false, :access-rights (), :user_id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}

>> authorize >

>> authorize::handler > #object[leihs.core.locale$wrap$fn__44318 0x4cb26645 leihs.core.locale$wrap$fn__44318@4cb26645]

>> authorize::request > {:authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-24T14:02:17.415645Z", :id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :user_session_id #uuid "e25b9e9c-082c-43d7-8468-0c267e3212a7", :scope_system_admin_read false, :access-rights (), :user_id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}, :cookies {leihs-anti-csrf-token {:value 85b2de76-3ecd-40fd-a936-2d92f39bd32b}, leihs-user-session {:value 88ce2c7c-4075-46c2-80ca-82d865f9353e}}, :remote-addr 127.0.0.1, :start-time 489327648389791, :params {}, :settings {:email_sending_enabled false, :sessions_max_lifetime_secs 432000, :smtp_default_from_address your.lending.desk@example.com, :public_image_caching_enabled true, :sessions_force_secure false, :deliver_received_order_notifications false, :external_base_url nil, :sessions_force_uniqueness false, :email_signature Cheers,}, :tx-next #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x2e18c1e HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x4c858a34 next.jdbc.result_set$as_unqualified_lower_maps@4c858a34]}}, :query-params-raw {}, :route-params nil, :headers {origin http://localhost:3230, sec-fetch-site same-origin, host localhost:3230, user-agent Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/115.0, content-type application/json, cookie leihs-anti-csrf-token=85b2de76-3ecd-40fd-a936-2d92f39bd32b; leihs-user-session=88ce2c7c-4075-46c2-80ca-82d865f9353e, content-length 534, referer http://localhost:3230/procure/requests, connection keep-alive, x-csrf-token 85b2de76-3ecd-40fd-a936-2d92f39bd32b, accept application/json, accept-language de,en-US;q=0.7,en;q=0.3, sec-fetch-dest empty, accept-encoding gzip, deflate, br, sec-fetch-mode cors}, :async-channel #object[org.httpkit.server.AsyncChannel 0x2f80b387 /127.0.0.1:3230<->/127.0.0.1:63580], :server-port 3230, :params-raw {}, :tx {:datasource #object[com.zaxxer.hikari.HikariDataSource 0x153deae HikariDataSource (db-pool)]}, :content-length 534, :form-params {}, :websocket? false, :query-params {}, :content-type application/json, :form-params-raw {}, :character-encoding utf8, :uri /procure/graphql, :server-name localhost, :handler-key :graphql, :query-string nil, :body {:operationName RequestFilters, :variables {}, :query query RequestFilters {
  budget_periods {
    id
    name
    inspection_start_date
    end_date
    __typename
  }
  main_categories {
    id
    name
    categories {
      id
      name
      __typename
    }
    __typename
  }
  organizations(root_only: true) {
    ...OrgProps
    organizations {
      ...OrgProps
      __typename
    }
    __typename
  }
}

fragment OrgProps on Organization {
  id
  name
  shortname
  __typename
}
}, :graphql-schema #CompiledSchema<>, :handler #object[leihs.procurement.graphql$handler 0x1a4a1f6f leihs.procurement.graphql$handler@1a4a1f6f], :multipart-params {}, :scheme :http, :request-method :post, :accept {:mime :json, :charset nil, :encoding nil, :language nil}}

>> authorize::handler-key >> :graphql
2023-11-24T14:02:18.074Z NX-41294 DEBUG [leihs.procurement.authorization:135] - (skip? (:handler-key request)) => nil
2023-11-24T14:02:18.074Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:18.078Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:18.079Z NX-41294 DEBUG [leihs.procurement.permissions.user:52] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_viewers) (sql/merge-where [:= :procurement_category_viewers.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_viewers.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]

>>>exec-query::variables {}
2023-11-24T14:02:18.081Z NX-41294 DEBUG [leihs.procurement.permissions.user:72] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_requesters_organizations) (sql/where [:= :procurement_requesters_organizations.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:18.082Z NX-41294 DEBUG [leihs.procurement.authorization:136] - (->> [user-perms/admin? user-perms/inspector? user-perms/viewer? user-perms/requester?] (map (fn* [p1__39355#] (p1__39355# (:tx request) (:authenticated-entity request)))) (some true?)) => true

>>>exec-query::variables {}

>>>exec-query::variables {}

>>>get-dashboard
2023-11-24T14:02:18.094Z NX-41294 DEBUG [leihs.procurement.dashboard:33] - args => {}
2023-11-24T14:02:18.095Z NX-41294 DEBUG [leihs.procurement.dashboard:34] - value => nil
2023-11-24T14:02:18.096Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:18.106Z NX-41294 DEBUG [leihs.procurement.permissions.user:72] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_requesters_organizations) (sql/where [:= :procurement_requesters_organizations.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:18.114Z NX-41294 DEBUG [leihs.procurement.permissions.user:52] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_viewers) (sql/merge-where [:= :procurement_category_viewers.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_viewers.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:18.114Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:18.116Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:18.119Z NX-41294 DEBUG [leihs.procurement.permissions.user:85] - (->> [viewer? inspector? admin?] (map (fn* [p1__39296#] (p1__39296# tx auth-entity))) (some true?)) => true

>>a  {:NEW [:= :procurement_requests.approved_quantity nil], :APPROVED [:>= :procurement_requests.approved_quantity :procurement_requests.requested_quantity], :PARTIALLY_APPROVED [:and [:< :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:> :procurement_requests.approved_quantity 0]], :DENIED [:= :procurement_requests.approved_quantity 0]}

>>b  #sql/call [:case [:= :procurement_requests.approved_quantity nil] NEW [:>= :procurement_requests.approved_quantity :procurement_requests.requested_quantity] APPROVED [:and [:< :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:> :procurement_requests.approved_quantity 0]] PARTIALLY_APPROVED [:= :procurement_requests.approved_quantity 0] DENIED]
2023-11-24T14:02:18.120Z NX-41294 DEBUG [leihs.procurement.resources.request:157] - (-> requests-base-query (sql/merge-select [(state-sql advanced-user?) :state]) (sql/merge-join :procurement_budget_periods [:= :procurement_budget_periods.id :procurement_requests.budget_period_id])) => {:select (#sql/raw "DISTINCT ON (procurement_requests.id, concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))) procurement_requests.*" [#sql/call [:case [:= :procurement_requests.approved_quantity nil] "NEW" [:>= :procurement_requests.approved_quantity :procurement_requests.requested_quantity] "APPROVED" [:and [:< :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:> :procurement_requests.approved_quantity 0]] "PARTIALLY_APPROVED" [:= :procurement_requests.approved_quantity 0] "DENIED"] :state]), :from (:procurement_requests), :left-join (:models [:= :models.id :procurement_requests.model_id]), :order-by (#sql/raw "concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))"), :join (:procurement_budget_periods [:= :procurement_budget_periods.id :procurement_requests.budget_period_id])}
2023-11-24T14:02:18.124Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]

>>>pure-handler {:data #ordered/map ([:budget_periods [#ordered/map ([:id 48d8c363-6af4-4a49-91ad-1b701743155f] [:name Budget-Period-Past] [:inspection_start_date 2023-08-23T22:00:00Z] [:end_date 2023-11-22T23:00:00Z] [:__typename :BudgetPeriod])]] [:main_categories [#ordered/map ([:id 46d19a93-31da-4690-a45f-b11b525ca6ff] [:name Main Category MC1] [:categories [#ordered/map ([:id 535b5ca7-c430-4a63-b5bd-09337b01bb7a] [:name Category C1] [:__typename :Category])]] [:__typename :MainCategory])]] [:organizations [#ordered/map ([:id e20c5fdb-8997-43a6-bebb-133d1466c239] [:name Home, Jewelry & Computers] [:shortname nil] [:__typename :Organization] [:organizations [#ordered/map ([:id 7a59c4fa-a0ed-4abf-aeae-e9c3b3323e95] [:name Beauty & Kids] [:shortname nil] [:__typename :Organization])]])]])}
2023-11-24T14:02:18.130Z NX-41294 DEBUG [leihs.procurement.graphql:64] - result => {:data #ordered/map ([:budget_periods [#ordered/map ([:id "48d8c363-6af4-4a49-91ad-1b701743155f"] [:name "Budget-Period-Past"] [:inspection_start_date "2023-08-23T22:00:00Z"] [:end_date "2023-11-22T23:00:00Z"] [:__typename :BudgetPeriod])]] [:main_categories [#ordered/map ([:id "46d19a93-31da-4690-a45f-b11b525ca6ff"] [:name "Main Category MC1"] [:categories [#ordered/map ([:id "535b5ca7-c430-4a63-b5bd-09337b01bb7a"] [:name "Category C1"] [:__typename :Category])]] [:__typename :MainCategory])]] [:organizations [#ordered/map ([:id "e20c5fdb-8997-43a6-bebb-133d1466c239"] [:name "Home, Jewelry & Computers"] [:shortname nil] [:__typename :Organization] [:organizations [#ordered/map ([:id "7a59c4fa-a0ed-4abf-aeae-e9c3b3323e95"] [:name "Beauty & Kids"] [:shortname nil] [:__typename :Organization])]])]])}

>>>pure-handler {:data #ordered/map ([:current_user #ordered/map ([:navbarProps {"csrfToken":{"value":"85b2de76-3ecd-40fd-a936-2d92f39bd32b","name":"csrf-token"},"config":{"appTitle":"leihs","appColor":"gray","me":{"user":{"id":"3b8e0ffa-8f85-46fd-8ea6-52eb2927015f","firstname":"Procurement","lastname":"Admin","login":null,"email":"jimmie@goyette.com"}},"subApps":{"borrow":false,"admin":false,"procure":false,"manage":[]},"locales":[{"name":"English (UK)","locale":"en-GB","active":true,"isDefault":true,"isSelected":true},{"name":"English (US)","locale":"en-US","active":true,"isDefault":false,"isSelected":false},{"name":"Deutsch","locale":"de-CH","active":true,"isDefault":false,"isSelected":false},{"name":"Züritüütsch","locale":"gsw-CH","active":true,"isDefault":false,"isSelected":false}]}}] [:user #ordered/map ([:id 3b8e0ffa-8f85-46fd-8ea6-52eb2927015f] [:firstname Procurement] [:lastname Admin] [:permissions #ordered/map ([:isAdmin true] [:isRequester false] [:isInspectorForCategories []] [:isViewerForCategories []] [:__typename :UserPermissions])] [:__typename :User])] [:__typename :CurrentUser])] [:settings #ordered/map ([:contact_url http://hartmann.io/rolf] [:__typename :ProcurementSettings])])}2023-11-24T14:02:18.131Z NX-41294 DEBUG [leihs.procurement.authorization:150] - (authorize handler request) => {:body {:data #ordered/map ([:budget_periods [#ordered/map ([:id "48d8c363-6af4-4a49-91ad-1b701743155f"] [:name "Budget-Period-Past"] [:inspection_start_date "2023-08-23T22:00:00Z"] [:end_date "2023-11-22T23:00:00Z"] [:__typename :BudgetPeriod])]] [:main_categories [#ordered/map ([:id "46d19a93-31da-4690-a45f-b11b525ca6ff"] [:name "Main Category MC1"] [:categories [#ordered/map ([:id "535b5ca7-c430-4a63-b5bd-09337b01bb7a"] [:name "Category C1"] [:__typename :Category])]] [:__typename :MainCategory])]] [:organizations [#ordered/map ([:id "e20c5fdb-8997-43a6-bebb-133d1466c239"] [:name "Home, Jewelry & Computers"] [:shortname nil] [:__typename :Organization] [:organizations [#ordered/map ([:id "7a59c4fa-a0ed-4abf-aeae-e9c3b3323e95"] [:name "Beauty & Kids"] [:shortname nil] [:__typename :Organization])]])]])}}

2023-11-24T14:02:18.132Z NX-41294 DEBUG [leihs.procurement.resources.requests:108] - query => ["SELECT DISTINCT ON (procurement_requests.id, concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))) procurement_requests.*, CASE WHEN procurement_requests.approved_quantity IS NULL THEN ? WHEN procurement_requests.approved_quantity >= procurement_requests.requested_quantity THEN ? WHEN (procurement_requests.approved_quantity < procurement_requests.requested_quantity AND procurement_requests.approved_quantity > ?) THEN ? WHEN procurement_requests.approved_quantity = ? THEN ? END AS state, row_to_json(procurement_budget_periods_2) AS budget_period, row_to_json(procurement_categories)::jsonb || jsonb_build_object('main_category', row_to_json(procurement_main_categories)) AS category, row_to_json(models) AS model, row_to_json(procurement_organizations)::jsonb || jsonb_build_object('department', row_to_json(procurement_departments)) AS organization, row_to_json(procurement_templates) AS template, row_to_json(rooms)::jsonb || jsonb_build_object('building', row_to_json(buildings)) AS room, row_to_json(suppliers) AS supplier, row_to_json(users) AS user FROM procurement_requests INNER JOIN procurement_budget_periods ON procurement_budget_periods.id = procurement_requests.budget_period_id INNER JOIN (SELECT *, current_date > end_date AS is_past FROM procurement_budget_periods) procurement_budget_periods_2 ON procurement_budget_periods_2.id = procurement_requests.budget_period_id INNER JOIN procurement_categories ON procurement_categories.id = procurement_requests.category_id INNER JOIN procurement_main_categories ON procurement_main_categories.id = procurement_categories.main_category_id INNER JOIN procurement_organizations ON procurement_organizations.id = procurement_requests.organization_id INNER JOIN procurement_organizations procurement_departments ON procurement_departments.id = procurement_organizations.parent_id INNER JOIN rooms ON rooms.id = procurement_requests.room_id INNER JOIN buildings ON buildings.id = rooms.building_id LEFT JOIN models ON models.id = procurement_requests.model_id LEFT JOIN procurement_templates ON procurement_templates.id = procurement_requests.template_id LEFT JOIN suppliers ON suppliers.id = procurement_requests.supplier_id LEFT JOIN users ON users.id = procurement_requests.user_id ORDER BY concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))" "NEW" "APPROVED" 0 "PARTIALLY_APPROVED" 0 "DENIED"]
>>broken-query [SELECT DISTINCT ON (procurement_requests.id, concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))) procurement_requests.*, CASE WHEN procurement_requests.approved_quantity IS NULL THEN ? WHEN procurement_requests.approved_quantity >= procurement_requests.requested_quantity THEN ? WHEN (procurement_requests.approved_quantity < procurement_requests.requested_quantity AND procurement_requests.approved_quantity > ?) THEN ? WHEN procurement_requests.approved_quantity = ? THEN ? END AS state, row_to_json(procurement_budget_periods_2) AS budget_period, row_to_json(procurement_categories)::jsonb || jsonb_build_object('main_category', row_to_json(procurement_main_categories)) AS category, row_to_json(models) AS model, row_to_json(procurement_organizations)::jsonb || jsonb_build_object('department', row_to_json(procurement_departments)) AS organization, row_to_json(procurement_templates) AS template, row_to_json(rooms)::jsonb || jsonb_build_object('building', row_to_json(buildings)) AS room, row_to_json(suppliers) AS supplier, row_to_json(users) AS user FROM procurement_requests INNER JOIN procurement_budget_periods ON procurement_budget_periods.id = procurement_requests.budget_period_id INNER JOIN (SELECT *, current_date > end_date AS is_past FROM procurement_budget_periods) procurement_budget_periods_2 ON procurement_budget_periods_2.id = procurement_requests.budget_period_id INNER JOIN procurement_categories ON procurement_categories.id = procurement_requests.category_id INNER JOIN procurement_main_categories ON procurement_main_categories.id = procurement_categories.main_category_id INNER JOIN procurement_organizations ON procurement_organizations.id = procurement_requests.organization_id INNER JOIN procurement_organizations procurement_departments ON procurement_departments.id = procurement_organizations.parent_id INNER JOIN rooms ON rooms.id = procurement_requests.room_id INNER JOIN buildings ON buildings.id = rooms.building_id LEFT JOIN models ON models.id = procurement_requests.model_id LEFT JOIN procurement_templates ON procurement_templates.id = procurement_requests.template_id LEFT JOIN suppliers ON suppliers.id = procurement_requests.supplier_id LEFT JOIN users ON users.id = procurement_requests.user_id ORDER BY concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, ''))) NEW APPROVED 0 PARTIALLY_APPROVED 0 DENIED]
2023-11-24T14:02:18.141Z NX-41294 DEBUG [leihs.procurement.graphql:64] - result => {:data #ordered/map ([:current_user #ordered/map ([:navbarProps "{\"csrfToken\":{\"value\":\"85b2de76-3ecd-40fd-a936-2d92f39bd32b\",\"name\":\"csrf-token\"},\"config\":{\"appTitle\":\"leihs\",\"appColor\":\"gray\",\"me\":{\"user\":{\"id\":\"3b8e0ffa-8f85-46fd-8ea6-52eb2927015f\",\"firstname\":\"Procurement\",\"lastname\":\"Admin\",\"login\":null,\"email\":\"jimmie@goyette.com\"}},\"subApps\":{\"borrow\":false,\"admin\":false,\"procure\":false,\"manage\":[]},\"locales\":[{\"name\":\"English (UK)\",\"locale\":\"en-GB\",\"active\":true,\"isDefault\":true,\"isSelected\":true},{\"name\":\"English (US)\",\"locale\":\"en-US\",\"active\":true,\"isDefault\":false,\"isSelected\":false},{\"name\":\"Deutsch\",\"locale\":\"de-CH\",\"active\":true,\"isDefault\":false,\"isSelected\":false},{\"name\":\"Züritüütsch\",\"locale\":\"gsw-CH\",\"active\":true,\"isDefault\":false,\"isSelected\":false}]}}"] [:user #ordered/map ([:id "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"] [:firstname "Procurement"] [:lastname "Admin"] [:permissions #ordered/map ([:isAdmin true] [:isRequester false] [:isInspectorForCategories []] [:isViewerForCategories []] [:__typename :UserPermissions])] [:__typename :User])] [:__typename :CurrentUser])] [:settings #ordered/map ([:contact_url "http://hartmann.io/rolf"] [:__typename :ProcurementSettings])])}
2023-11-24T14:02:18.146Z NX-41294 DEBUG [leihs.procurement.permissions.user:52] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_viewers) (sql/merge-where [:= :procurement_category_viewers.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_viewers.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:18.147Z NX-41294 DEBUG [leihs.procurement.authorization:150] - (authorize handler request) => {:body {:data #ordered/map ([:current_user #ordered/map ([:navbarProps "{\"csrfToken\":{\"value\":\"85b2de76-3ecd-40fd-a936-2d92f39bd32b\",\"name\":\"csrf-token\"},\"config\":{\"appTitle\":\"leihs\",\"appColor\":\"gray\",\"me\":{\"user\":{\"id\":\"3b8e0ffa-8f85-46fd-8ea6-52eb2927015f\",\"firstname\":\"Procurement\",\"lastname\":\"Admin\",\"login\":null,\"email\":\"jimmie@goyette.com\"}},\"subApps\":{\"borrow\":false,\"admin\":false,\"procure\":false,\"manage\":[]},\"locales\":[{\"name\":\"English (UK)\",\"locale\":\"en-GB\",\"active\":true,\"isDefault\":true,\"isSelected\":true},{\"name\":\"English (US)\",\"locale\":\"en-US\",\"active\":true,\"isDefault\":false,\"isSelected\":false},{\"name\":\"Deutsch\",\"locale\":\"de-CH\",\"active\":true,\"isDefault\":false,\"isSelected\":false},{\"name\":\"Züritüütsch\",\"locale\":\"gsw-CH\",\"active\":true,\"isDefault\":false,\"isSelected\":false}]}}"] [:user #ordered/map ([:id "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"] [:firstname "Procurement"] [:lastname "Admin"] [:permissions #ordered/map ([:isAdmin true] [:isRequester false] [:isInspectorForCategories []] [:isViewerForCategories []] [:__typename :UserPermissions])] [:__typename :User])] [:__typename :CurrentUser])] [:settings #ordered/map ([:contact_url "http://hartmann.io/rolf"] [:__typename :ProcurementSettings])])}}
2023-11-24T14:02:18.148Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:18.150Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:18.166Z NX-41294 DEBUG [leihs.procurement.permissions.user:85] - (->> [viewer? inspector? admin?] (map (fn* [p1__39296#] (p1__39296# tx auth-entity))) (some true?)) => true
2023-11-24T14:02:18.201Z NX-41294 DEBUG [leihs.procurement.permissions.user:72] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_requesters_organizations) (sql/where [:= :procurement_requesters_organizations.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:18.202Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:18.203Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:18.208Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE (procurement_category_inspectors.user_id = ? AND procurement_category_inspectors.category_id = ?))) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f" "535b5ca7-c430-4a63-b5bd-09337b01bb7a"]
2023-11-24T14:02:18.209Z NX-41294 DEBUG [leihs.procurement.permissions.user:52] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_viewers) (sql/merge-where [:= :procurement_category_viewers.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_viewers.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_viewers WHERE (procurement_category_viewers.user_id = ? AND procurement_category_viewers.category_id = ?))) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f" "535b5ca7-c430-4a63-b5bd-09337b01bb7a"]
2023-11-24T14:02:18.194Z NX-41294 DEBUG [leihs.procurement.dashboard:50] - (requests/get-requests ctx args value) => ({:category {:read true, :write false, :default {:id #uuid "535b5ca7-c430-4a63-b5bd-09337b01bb7a", :name "Category C1", :main_category_id #uuid "46d19a93-31da-4690-a45f-b11b525ca6ff", :general_ledger_account nil, :cost_center nil, :procurement_account nil}, :required true, :value {:id "535b5ca7-c430-4a63-b5bd-09337b01bb7a", :name "Category C1", :cost_center nil, :main_category {:id "46d19a93-31da-4690-a45f-b11b525ca6ff", :name "Main Category MC1"}, :main_category_id "46d19a93-31da-4690-a45f-b11b525ca6ff", :procurement_account nil, :general_ledger_account nil}, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :supplier {:read true, :write false, :default nil, :required false, :value nil, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :motivation {:read true, :write false, :required true, :value "Corporis commodi provident nam.", :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :accounting_type {:read true, :write false, :default "aquisition", :required true, :value "aquisition", :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :actionPermissions {:edit true, :delete false, :moveBudgetPeriod false, :moveCategory false}, :article_number {:read true, :write false, :default nil, :required false, :value nil, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :inspector_priority {:read true, :write false, :default "MEDIUM", :required true, :value :MEDIUM, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :price_cents {:read true, :write false, :default 0, :required true, :value 0, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :budget_period {:read true, :write false, :default {:id #uuid "48d8c363-6af4-4a49-91ad-1b701743155f", :name "Budget-Period-Past", :inspection_start_date #time/instant "2023-08-23T22:00:00Z", :end_date #time/instant "2023-11-22T23:00:00Z", :created_at #time/instant "2023-11-24T14:02:16.844231Z", :updated_at #time/instant "2023-11-24T14:02:16.844231Z"}, :required true, :value {:id "48d8c363-6af4-4a49-91ad-1b701743155f", :name "Budget-Period-Past", :inspection_start_date "2023-08-24T00:00:00+02:00", :end_date "2023-11-23T00:00:00+01:00", :created_at "2023-11-24T15:02:16.844231", :updated_at "2023-11-24T15:02:16.844231", :is_past true}, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :article_name {:read true, :write false, :default nil, :required true, :value "Mediocre Aluminum Shoes", :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :replacement {:read true, :write false, :default nil, :required true, :value true, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :attachments {:read true, :write false, :required false, :value :unqueried, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :DELETE false, :template {:read true, :write false, :default nil, :required true, :value nil, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :state :NEW, :organization {:value {:id "7a59c4fa-a0ed-4abf-aeae-e9c3b3323e95", :name "Beauty & Kids", :parent_id "e20c5fdb-8997-43a6-bebb-133d1466c239", :shortname nil, :department {:id "e20c5fdb-8997-43a6-bebb-133d1466c239", :name "Home, Jewelry & Computers", :parent_id nil, :shortname nil}}, :read false, :write false, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :supplier_name {:read true, :write false, :default nil, :required false, :value nil, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :order_status {:read true, :write true, :default "NOT_PROCURED", :required true, :value :NOT_PROCESSED, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :requested_quantity {:read true, :write false, :required true, :value 1, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :general_ledger_account {:read true, :write false, :required false, :value nil, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :updated_at {:value #time/instant "2023-11-24T14:02:16.941919Z", :read false, :write false, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :priority {:read true, :write false, :default "NORMAL", :required true, :value :NORMAL, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc", :total_price_cents 0, :price_currency {:read true, :write false, :default "CHF", :required true, :value "CHF", :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :procurement_account {:read true, :write false, :value nil, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :room {:read true, :write false, :default {:id #uuid "b8927fd2-014c-48c2-b095-fa1d5620debe", :name "general room", :description nil, :building_id #uuid "abae04c5-d767-425e-acc2-7ce04df645d1", :general true, :building {:id #uuid "abae04c5-d767-425e-acc2-7ce04df645d1", :name "general building", :code nil}}, :required true, :value {:id "707541da-817b-402d-86a4-dbd6e72bee46", :name "reception room", :general false, :building {:id "d1f8159a-bf85-4dde-8e9f-5472b1deb309", :code nil, :name "9594 Beer Extension"}, :building_id "d1f8159a-bf85-4dde-8e9f-5472b1deb309", :description nil}, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :inspection_comment {:read true, :write false, :required false, :value nil, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :approved_quantity {:read true, :write false, :required false, :value nil, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :order_quantity {:read true, :write false, :required false, :value nil, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :cost_center {:read true, :write false, :required false, :value nil, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :user {:read true, :write false, :required true, :default {:id #uuid "1862f73f-33ba-415e-b3c2-5feb2074752d", :firstname "Lynsey", :lastname "Kertzmann"}, :value {:system_admin_protected false, :address nil, :email "chanda@ortiz.net", :pool_protected false, :last_sign_in_at nil, :img32_url nil, :account_enabled true, :lastname "Kertzmann", :phone nil, :img_digest nil, :org_id nil, :extended_info nil, :secondary_email nil, :city nil, :settings nil, :is_admin false, :organization "local", :login nil, :searchable "Lynsey Kertzmann chanda@ortiz.net    Kertzmann Lynsey", :updated_at "2023-11-24T15:02:16.902996+01:00", :firstname "Lynsey", :zip nil, :id "1862f73f-33ba-415e-b3c2-5feb2074752d", :url nil, :password_sign_in_enabled true, :account_disabled_at nil, :is_system_admin false, :badge_id nil, :language_locale nil, :img256_url nil, :country nil, :delegator_user_id nil, :created_at "2023-11-24T15:02:16.902996+01:00", :admin_protected false}, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :receiver {:read true, :write false, :required false, :value nil, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :internal_order_number {:read true, :write false, :required false, :value nil, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :created_at {:value #time/instant "2023-11-24T14:02:16.941919Z", :read false, :write false, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :order_comment {:read true, :write true, :required false, :value nil, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :short_id "Budget-Period-Past.001", :model {:read true, :write false, :default nil, :required false, :value nil, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}})

>>>pure-handler {:data #ordered/map ([:dashboard #ordered/map ([:cacheKey -15128758] [:total_count 1] [:budget_periods [#ordered/map ([:id 48d8c363-6af4-4a49-91ad-1b701743155f] [:cacheKey -15128758_48d8c363-6af4-4a49-91ad-1b701743155f] [:name Budget-Period-Past] [:inspection_start_date 2023-08-23T22:00:00Z] [:end_date 2023-11-22T23:00:00Z] [:total_price_cents 0] [:main_categories [#ordered/map ([:id 46d19a93-31da-4690-a45f-b11b525ca6ff] [:cacheKey -15128758_48d8c363-6af4-4a49-91ad-1b701743155f_46d19a93-31da-4690-a45f-b11b525ca6ff] [:name Main Category MC1] [:image_url nil] [:total_price_cents 0] [:categories [#ordered/map ([:id 535b5ca7-c430-4a63-b5bd-09337b01bb7a] [:cacheKey -15128758_48d8c363-6af4-4a49-91ad-1b701743155f_46d19a93-31da-4690-a45f-b11b525ca6ff_535b5ca7-c430-4a63-b5bd-09337b01bb7a] [:name Category C1] [:total_price_cents 0] [:requests [#ordered/map ([:id df6d3979-4323-4d7d-ae8e-078e0b162dcc] [:short_id Budget-Period-Past.001] [:user #ordered/map ([:value #ordered/map ([:id 1862f73f-33ba-415e-b3c2-5feb2074752d] [:firstname Lynsey] [:lastname Kertzmann] [:__typename :User])] [:__typename :RequestFieldUser])] [:category #ordered/map ([:read true] [:write false] [:required true] [:value #ordered/map ([:id 535b5ca7-c430-4a63-b5bd-09337b01bb7a] [:name Category C1] [:main_category #ordered/map ([:id 46d19a93-31da-4690-a45f-b11b525ca6ff] [:name Main Category MC1] [:__typename :MainCategory])] [:__typename :Category])] [:__typename :RequestFieldCategory])] [:budget_period #ordered/map ([:read true] [:write false] [:required true] [:value #ordered/map ([:name Budget-Period-Past] [:id 48d8c363-6af4-4a49-91ad-1b701743155f] [:__typename :BudgetPeriod])] [:__typename :RequestFieldBudgetPeriod])] [:article_name #ordered/map ([:value Mediocre Aluminum Shoes] [:__typename :RequestFieldString])] [:model #ordered/map ([:value nil] [:__typename :RequestFieldModel])] [:receiver #ordered/map ([:value nil] [:__typename :RequestFieldString])] [:organization #ordered/map ([:value #ordered/map ([:id 7a59c4fa-a0ed-4abf-aeae-e9c3b3323e95] [:name Beauty & Kids] [:shortname nil] [:department #ordered/map ([:id e20c5fdb-8997-43a6-bebb-133d1466c239] [:name Home, Jewelry & Computers] [:__typename :Organization])] [:__typename :Organization])] [:__typename :RequestFieldOrganization])] [:price_cents #ordered/map ([:value 0] [:__typename :RequestFieldInt])] [:price_currency #ordered/map ([:value CHF] [:__typename :RequestFieldString])] [:requested_quantity #ordered/map ([:read true] [:value 1] [:__typename :RequestFieldInt])] [:approved_quantity #ordered/map ([:read true] [:value nil] [:__typename :RequestFieldInt])] [:order_quantity #ordered/map ([:read true] [:value nil] [:__typename :RequestFieldInt])] [:replacement #ordered/map ([:value true] [:__typename :RequestFieldBoolean])] [:priority #ordered/map ([:value :NORMAL] [:__typename :RequestFieldPriority])] [:state :NEW] [:article_number #ordered/map ([:value nil] [:__typename :RequestFieldString])] [:supplier #ordered/map ([:value nil] [:__typename :RequestFieldSupplier])] [:supplier_name #ordered/map ([:value nil] [:__typename :RequestFieldString])] [:room #ordered/map ([:value #ordered/map ([:id 707541da-817b-402d-86a4-dbd6e72bee46] [:name reception room] [:building #ordered/map ([:id d1f8159a-bf85-4dde-8e9f-5472b1deb309] [:name 9594 Beer Extension] [:__typename :Building])] [:__typename :Room])] [:__typename :RequestFieldRoom])] [:motivation #ordered/map ([:value Corporis commodi provident nam.] [:__typename :RequestFieldString])] [:inspection_comment #ordered/map ([:value nil] [:__typename :RequestFieldString])] [:inspector_priority #ordered/map ([:value :MEDIUM] [:__typename :RequestFieldInspectorPriority])] [:accounting_type #ordered/map ([:value aquisition] [:__typename :RequestFieldString])] [:cost_center #ordered/map ([:value nil] [:__typename :RequestFieldCostCenter])] [:general_ledger_account #ordered/map ([:value nil] [:__typename :RequestFieldGeneralLedgerAccount])] [:procurement_account #ordered/map ([:value nil] [:__typename :RequestFieldProcurementAccount])] [:internal_order_number #ordered/map ([:value nil] [:__typename :RequestFieldString])] [:order_status #ordered/map ([:value :NOT_PROCESSED] [:__typename :RequestFieldOrderStatus])] [:order_comment #ordered/map ([:value nil] [:__typename :RequestFieldString])] [:__typename :Request] [:total_price_cents 0] [:actionPermissions #ordered/map ([:edit true] [:__typename :RequestActionPermissions])])]] [:__typename :Category])]] [:__typename :MainCategory])]] [:__typename :BudgetPeriod])]] [:__typename :Dashboard])])}
2023-11-24T14:02:18.248Z NX-41294 DEBUG [leihs.procurement.graphql:64] - result => {:data #ordered/map ([:dashboard #ordered/map ([:cacheKey "-15128758"] [:total_count 1] [:budget_periods [#ordered/map ([:id "48d8c363-6af4-4a49-91ad-1b701743155f"] [:cacheKey "-15128758_48d8c363-6af4-4a49-91ad-1b701743155f"] [:name "Budget-Period-Past"] [:inspection_start_date "2023-08-23T22:00:00Z"] [:end_date "2023-11-22T23:00:00Z"] [:total_price_cents "0"] [:main_categories [#ordered/map ([:id "46d19a93-31da-4690-a45f-b11b525ca6ff"] [:cacheKey "-15128758_48d8c363-6af4-4a49-91ad-1b701743155f_46d19a93-31da-4690-a45f-b11b525ca6ff"] [:name "Main Category MC1"] [:image_url nil] [:total_price_cents "0"] [:categories [#ordered/map ([:id "535b5ca7-c430-4a63-b5bd-09337b01bb7a"] [:cacheKey "-15128758_48d8c363-6af4-4a49-91ad-1b701743155f_46d19a93-31da-4690-a45f-b11b525ca6ff_535b5ca7-c430-4a63-b5bd-09337b01bb7a"] [:name "Category C1"] [:total_price_cents "0"] [:requests [#ordered/map ([:id "df6d3979-4323-4d7d-ae8e-078e0b162dcc"] [:short_id "Budget-Period-Past.001"] [:user #ordered/map ([:value #ordered/map ([:id "1862f73f-33ba-415e-b3c2-5feb2074752d"] [:firstname "Lynsey"] [:lastname "Kertzmann"] [:__typename :User])] [:__typename :RequestFieldUser])] [:category #ordered/map ([:read true] [:write false] [:required true] [:value #ordered/map ([:id "535b5ca7-c430-4a63-b5bd-09337b01bb7a"] [:name "Category C1"] [:main_category #ordered/map ([:id "46d19a93-31da-4690-a45f-b11b525ca6ff"] [:name "Main Category MC1"] [:__typename :MainCategory])] [:__typename :Category])] [:__typename :RequestFieldCategory])] [:budget_period #ordered/map ([:read true] [:write false] [:required true] [:value #ordered/map ([:name "Budget-Period-Past"] [:id "48d8c363-6af4-4a49-91ad-1b701743155f"] [:__typename :BudgetPeriod])] [:__typename :RequestFieldBudgetPeriod])] [:article_name #ordered/map ([:value "Mediocre Aluminum Shoes"] [:__typename :RequestFieldString])] [:model #ordered/map ([:value nil] [:__typename :RequestFieldModel])] [:receiver #ordered/map ([:value nil] [:__typename :RequestFieldString])] [:organization #ordered/map ([:value #ordered/map ([:id "7a59c4fa-a0ed-4abf-aeae-e9c3b3323e95"] [:name "Beauty & Kids"] [:shortname nil] [:department #ordered/map ([:id "e20c5fdb-8997-43a6-bebb-133d1466c239"] [:name "Home, Jewelry & Computers"] [:__typename :Organization])] [:__typename :Organization])] [:__typename :RequestFieldOrganization])] [:price_cents #ordered/map ([:value 0] [:__typename :RequestFieldInt])] [:price_currency #ordered/map ([:value "CHF"] [:__typename :RequestFieldString])] [:requested_quantity #ordered/map ([:read true] [:value 1] [:__typename :RequestFieldInt])] [:approved_quantity #ordered/map ([:read true] [:value nil] [:__typename :RequestFieldInt])] [:order_quantity #ordered/map ([:read true] [:value nil] [:__typename :RequestFieldInt])] [:replacement #ordered/map ([:value true] [:__typename :RequestFieldBoolean])] [:priority #ordered/map ([:value :NORMAL] [:__typename :RequestFieldPriority])] [:state :NEW] [:article_number #ordered/map ([:value nil] [:__typename :RequestFieldString])] [:supplier #ordered/map ([:value nil] [:__typename :RequestFieldSupplier])] [:supplier_name #ordered/map ([:value nil] [:__typename :RequestFieldString])] [:room #ordered/map ([:value #ordered/map ([:id "707541da-817b-402d-86a4-dbd6e72bee46"] [:name "reception room"] [:building #ordered/map ([:id "d1f8159a-bf85-4dde-8e9f-5472b1deb309"] [:name "9594 Beer Extension"] [:__typename :Building])] [:__typename :Room])] [:__typename :RequestFieldRoom])] [:motivation #ordered/map ([:value "Corporis commodi provident nam."] [:__typename :RequestFieldString])] [:inspection_comment #ordered/map ([:value nil] [:__typename :RequestFieldString])] [:inspector_priority #ordered/map ([:value :MEDIUM] [:__typename :RequestFieldInspectorPriority])] [:accounting_type #ordered/map ([:value "aquisition"] [:__typename :RequestFieldString])] [:cost_center #ordered/map ([:value nil] [:__typename :RequestFieldCostCenter])] [:general_ledger_account #ordered/map ([:value nil] [:__typename :RequestFieldGeneralLedgerAccount])] [:procurement_account #ordered/map ([:value nil] [:__typename :RequestFieldProcurementAccount])] [:internal_order_number #ordered/map ([:value nil] [:__typename :RequestFieldString])] [:order_status #ordered/map ([:value :NOT_PROCESSED] [:__typename :RequestFieldOrderStatus])] [:order_comment #ordered/map ([:value nil] [:__typename :RequestFieldString])] [:__typename :Request] [:total_price_cents "0"] [:actionPermissions #ordered/map ([:edit true] [:__typename :RequestActionPermissions])])]] [:__typename :Category])]] [:__typename :MainCategory])]] [:__typename :BudgetPeriod])]] [:__typename :Dashboard])])}
2023-11-24T14:02:18.261Z NX-41294 DEBUG [leihs.procurement.authorization:150] - (authorize handler request) => {:body {:data #ordered/map ([:dashboard #ordered/map ([:cacheKey "-15128758"] [:total_count 1] [:budget_periods [#ordered/map ([:id "48d8c363-6af4-4a49-91ad-1b701743155f"] [:cacheKey "-15128758_48d8c363-6af4-4a49-91ad-1b701743155f"] [:name "Budget-Period-Past"] [:inspection_start_date "2023-08-23T22:00:00Z"] [:end_date "2023-11-22T23:00:00Z"] [:total_price_cents "0"] [:main_categories [#ordered/map ([:id "46d19a93-31da-4690-a45f-b11b525ca6ff"] [:cacheKey "-15128758_48d8c363-6af4-4a49-91ad-1b701743155f_46d19a93-31da-4690-a45f-b11b525ca6ff"] [:name "Main Category MC1"] [:image_url nil] [:total_price_cents "0"] [:categories [#ordered/map ([:id "535b5ca7-c430-4a63-b5bd-09337b01bb7a"] [:cacheKey "-15128758_48d8c363-6af4-4a49-91ad-1b701743155f_46d19a93-31da-4690-a45f-b11b525ca6ff_535b5ca7-c430-4a63-b5bd-09337b01bb7a"] [:name "Category C1"] [:total_price_cents "0"] [:requests [#ordered/map ([:id "df6d3979-4323-4d7d-ae8e-078e0b162dcc"] [:short_id "Budget-Period-Past.001"] [:user #ordered/map ([:value #ordered/map ([:id "1862f73f-33ba-415e-b3c2-5feb2074752d"] [:firstname "Lynsey"] [:lastname "Kertzmann"] [:__typename :User])] [:__typename :RequestFieldUser])] [:category #ordered/map ([:read true] [:write false] [:required true] [:value #ordered/map ([:id "535b5ca7-c430-4a63-b5bd-09337b01bb7a"] [:name "Category C1"] [:main_category #ordered/map ([:id "46d19a93-31da-4690-a45f-b11b525ca6ff"] [:name "Main Category MC1"] [:__typename :MainCategory])] [:__typename :Category])] [:__typename :RequestFieldCategory])] [:budget_period #ordered/map ([:read true] [:write false] [:required true] [:value #ordered/map ([:name "Budget-Period-Past"] [:id "48d8c363-6af4-4a49-91ad-1b701743155f"] [:__typename :BudgetPeriod])] [:__typename :RequestFieldBudgetPeriod])] [:article_name #ordered/map ([:value "Mediocre Aluminum Shoes"] [:__typename :RequestFieldString])] [:model #ordered/map ([:value nil] [:__typename :RequestFieldModel])] [:receiver #ordered/map ([:value nil] [:__typename :RequestFieldString])] [:organization #ordered/map ([:value #ordered/map ([:id "7a59c4fa-a0ed-4abf-aeae-e9c3b3323e95"] [:name "Beauty & Kids"] [:shortname nil] [:department #ordered/map ([:id "e20c5fdb-8997-43a6-bebb-133d1466c239"] [:name "Home, Jewelry & Computers"] [:__typename :Organization])] [:__typename :Organization])] [:__typename :RequestFieldOrganization])] [:price_cents #ordered/map ([:value 0] [:__typename :RequestFieldInt])] [:price_currency #ordered/map ([:value "CHF"] [:__typename :RequestFieldString])] [:requested_quantity #ordered/map ([:read true] [:value 1] [:__typename :RequestFieldInt])] [:approved_quantity #ordered/map ([:read true] [:value nil] [:__typename :RequestFieldInt])] [:order_quantity #ordered/map ([:read true] [:value nil] [:__typename :RequestFieldInt])] [:replacement #ordered/map ([:value true] [:__typename :RequestFieldBoolean])] [:priority #ordered/map ([:value :NORMAL] [:__typename :RequestFieldPriority])] [:state :NEW] [:article_number #ordered/map ([:value nil] [:__typename :RequestFieldString])] [:supplier #ordered/map ([:value nil] [:__typename :RequestFieldSupplier])] [:supplier_name #ordered/map ([:value nil] [:__typename :RequestFieldString])] [:room #ordered/map ([:value #ordered/map ([:id "707541da-817b-402d-86a4-dbd6e72bee46"] [:name "reception room"] [:building #ordered/map ([:id "d1f8159a-bf85-4dde-8e9f-5472b1deb309"] [:name "9594 Beer Extension"] [:__typename :Building])] [:__typename :Room])] [:__typename :RequestFieldRoom])] [:motivation #ordered/map ([:value "Corporis commodi provident nam."] [:__typename :RequestFieldString])] [:inspection_comment #ordered/map ([:value nil] [:__typename :RequestFieldString])] [:inspector_priority #ordered/map ([:value :MEDIUM] [:__typename :RequestFieldInspectorPriority])] [:accounting_type #ordered/map ([:value "aquisition"] [:__typename :RequestFieldString])] [:cost_center #ordered/map ([:value nil] [:__typename :RequestFieldCostCenter])] [:general_ledger_account #ordered/map ([:value nil] [:__typename :RequestFieldGeneralLedgerAccount])] [:procurement_account #ordered/map ([:value nil] [:__typename :RequestFieldProcurementAccount])] [:internal_order_number #ordered/map ([:value nil] [:__typename :RequestFieldString])] [:order_status #ordered/map ([:value :NOT_PROCESSED] [:__typename :RequestFieldOrderStatus])] [:order_comment #ordered/map ([:value nil] [:__typename :RequestFieldString])] [:__typename :Request] [:total_price_cents "0"] [:actionPermissions #ordered/map ([:edit true] [:__typename :RequestActionPermissions])])]] [:__typename :Category])]] [:__typename :MainCategory])]] [:__typename :BudgetPeriod])]] [:__typename :Dashboard])])}}
>>> authenticate::skip= nil  handler-key= :graphql
>>> authenticate::authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-24T14:02:17.415645Z", :id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :user_session_id #uuid "e25b9e9c-082c-43d7-8468-0c267e3212a7", :scope_system_admin_read false, :access-rights (), :user_id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}

>> authorize >

>> authorize::handler > #object[leihs.core.locale$wrap$fn__44318 0x4cb26645 leihs.core.locale$wrap$fn__44318@4cb26645]

>> authorize::request > {:authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-24T14:02:17.415645Z", :id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :user_session_id #uuid "e25b9e9c-082c-43d7-8468-0c267e3212a7", :scope_system_admin_read false, :access-rights (), :user_id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}, :cookies {leihs-anti-csrf-token {:value 85b2de76-3ecd-40fd-a936-2d92f39bd32b}, leihs-user-session {:value 88ce2c7c-4075-46c2-80ca-82d865f9353e}}, :remote-addr 127.0.0.1, :start-time 489327903145833, :params {}, :settings {:email_sending_enabled false, :sessions_max_lifetime_secs 432000, :smtp_default_from_address your.lending.desk@example.com, :public_image_caching_enabled true, :sessions_force_secure false, :deliver_received_order_notifications false, :external_base_url nil, :sessions_force_uniqueness false, :email_signature Cheers,}, :tx-next #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x2e18c1e HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x4c858a34 next.jdbc.result_set$as_unqualified_lower_maps@4c858a34]}}, :query-params-raw {}, :route-params nil, :headers {origin http://localhost:3230, sec-fetch-site same-origin, host localhost:3230, user-agent Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/115.0, content-type application/json, cookie leihs-anti-csrf-token=85b2de76-3ecd-40fd-a936-2d92f39bd32b; leihs-user-session=88ce2c7c-4075-46c2-80ca-82d865f9353e, content-length 4019, referer http://localhost:3230/procure/requests, connection keep-alive, x-csrf-token 85b2de76-3ecd-40fd-a936-2d92f39bd32b, accept application/json, accept-language de,en-US;q=0.7,en;q=0.3, sec-fetch-dest empty, accept-encoding gzip, deflate, br, sec-fetch-mode cors}, :async-channel #object[org.httpkit.server.AsyncChannel 0x134abb03 /127.0.0.1:3230<->/127.0.0.1:63590], :server-port 3230, :params-raw {}, :tx {:datasource #object[com.zaxxer.hikari.HikariDataSource 0x153deae HikariDataSource (db-pool)]}, :content-length 4019, :form-params {}, :websocket? false, :query-params {}, :content-type application/json, :form-params-raw {}, :character-encoding utf8, :uri /procure/graphql, :server-name localhost, :handler-key :graphql, :query-string nil, :body {:operationName RequestsIndexFiltered, :variables {:inspector_priority [LOW MEDIUM HIGH MANDATORY], :onlyOwnRequests false, :state [NEW APPROVED PARTIALLY_APPROVED DENIED], :order_status [NOT_PROCESSED IN_PROGRESS PROCURED ALTERNATIVE_PROCURED NOT_PROCURED], :search nil, :organizations [7a59c4fa-a0ed-4abf-aeae-e9c3b3323e95], :categories [535b5ca7-c430-4a63-b5bd-09337b01bb7a], :priority [NORMAL HIGH], :budgetPeriods [48d8c363-6af4-4a49-91ad-1b701743155f]}, :query query RequestsIndexFiltered($budgetPeriods: [ID!], $categories: [ID!], $search: String, $state: [State!], $order_status: [OrderStatus], $organizations: [ID!], $priority: [Priority!], $inspector_priority: [InspectorPriority!], $onlyOwnRequests: Boolean) {
  dashboard(budget_period_id: $budgetPeriods, category_id: $categories, search: $search, state: $state, order_status: $order_status, organization_id: $organizations, priority: $priority, inspector_priority: $inspector_priority, requested_by_auth_user: $onlyOwnRequests) {
    cacheKey
    total_count
    budget_periods {
      id
      cacheKey
      name
      inspection_start_date
      end_date
      total_price_cents
      main_categories {
        id
        cacheKey
        name
        image_url
        total_price_cents
        categories {
          id
          cacheKey
          name
          total_price_cents
          requests {
            ...RequestFieldsForIndex
            total_price_cents
            actionPermissions {
              edit
              __typename
            }
            __typename
          }
          __typename
        }
        __typename
      }
      __typename
    }
    __typename
  }
}

fragment RequestFieldsForIndex on Request {
  id
  short_id
  user {
    value {
      id
      firstname
      lastname
      __typename
    }
    __typename
  }
  category {
    read
    write
    required
    value {
      id
      name
      main_category {
        id
        name
        __typename
      }
      __typename
    }
    __typename
  }
  budget_period {
    read
    write
    required
    value {
      name
      id
      __typename
    }
    __typename
  }
  article_name {
    value
    __typename
  }
  model {
    value {
      id
      product
      version
      __typename
    }
    __typename
  }
  receiver {
    value
    __typename
  }
  organization {
    value {
      id
      name
      shortname
      department {
        id
        name
        __typename
      }
      __typename
    }
    __typename
  }
  price_cents {
    value
    __typename
  }
  price_currency {
    value
    __typename
  }
  requested_quantity {
    read
    value
    __typename
  }
  approved_quantity {
    read
    value
    __typename
  }
  order_quantity {
    read
    value
    __typename
  }
  replacement {
    value
    __typename
  }
  priority {
    value
    __typename
  }
  state
  article_number {
    value
    __typename
  }
  supplier {
    value {
      name
      __typename
    }
    __typename
  }
  supplier_name {
    value
    __typename
  }
  receiver {
    value
    __typename
  }
  room {
    value {
      id
      name
      building {
        id
        name
        __typename
      }
      __typename
    }
    __typename
  }
  motivation {
    value
    __typename
  }
  inspection_comment {
    value
    __typename
  }
  inspector_priority {
    value
    __typename
  }
  accounting_type {
    value
    __typename
  }
  cost_center {
    value
    __typename
  }
  general_ledger_account {
    value
    __typename
  }
  procurement_account {
    value
    __typename
  }
  internal_order_number {
    value
    __typename
  }
  order_status {
    value
    __typename
  }
  order_comment {
    value
    __typename
  }
  __typename
}
}, :graphql-schema #CompiledSchema<>, :handler #object[leihs.procurement.graphql$handler 0x1a4a1f6f leihs.procurement.graphql$handler@1a4a1f6f], :multipart-params {}, :scheme :http, :request-method :post, :accept {:mime :json, :charset nil, :encoding nil, :language nil}}

>> authorize::handler-key >> :graphql
2023-11-24T14:02:18.306Z NX-41294 DEBUG [leihs.procurement.authorization:135] - (skip? (:handler-key request)) => nil
2023-11-24T14:02:18.307Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:18.309Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:18.310Z NX-41294 DEBUG [leihs.procurement.permissions.user:52] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_viewers) (sql/merge-where [:= :procurement_category_viewers.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_viewers.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:18.311Z NX-41294 DEBUG [leihs.procurement.permissions.user:72] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_requesters_organizations) (sql/where [:= :procurement_requesters_organizations.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:18.311Z NX-41294 DEBUG [leihs.procurement.authorization:136] - (->> [user-perms/admin? user-perms/inspector? user-perms/viewer? user-perms/requester?] (map (fn* [p1__39355#] (p1__39355# (:tx request) (:authenticated-entity request)))) (some true?)) => true

>>>exec-query::variables {:inspector_priority [LOW MEDIUM HIGH MANDATORY], :onlyOwnRequests false, :state [NEW APPROVED PARTIALLY_APPROVED DENIED], :order_status [NOT_PROCESSED IN_PROGRESS PROCURED ALTERNATIVE_PROCURED NOT_PROCURED], :search nil, :organizations [7a59c4fa-a0ed-4abf-aeae-e9c3b3323e95], :categories [535b5ca7-c430-4a63-b5bd-09337b01bb7a], :priority [NORMAL HIGH], :budgetPeriods [48d8c363-6af4-4a49-91ad-1b701743155f]}

>>>get-dashboard
2023-11-24T14:02:18.333Z NX-41294 DEBUG [leihs.procurement.dashboard:33] - args => {:inspector_priority [:LOW :MEDIUM :HIGH :MANDATORY], :organization_id ["7a59c4fa-a0ed-4abf-aeae-e9c3b3323e95"], :requested_by_auth_user false, :state [:NEW :APPROVED :PARTIALLY_APPROVED :DENIED], :order_status [:NOT_PROCESSED :IN_PROGRESS :PROCURED :ALTERNATIVE_PROCURED :NOT_PROCURED], :search nil, :priority [:NORMAL :HIGH], :budget_period_id ["48d8c363-6af4-4a49-91ad-1b701743155f"], :category_id ["535b5ca7-c430-4a63-b5bd-09337b01bb7a"]}
2023-11-24T14:02:18.333Z NX-41294 DEBUG [leihs.procurement.dashboard:34] - value => nil
2023-11-24T14:02:18.336Z NX-41294 DEBUG [leihs.procurement.permissions.user:52] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_viewers) (sql/merge-where [:= :procurement_category_viewers.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_viewers.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:18.337Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:18.337Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:18.338Z NX-41294 DEBUG [leihs.procurement.permissions.user:85] - (->> [viewer? inspector? admin?] (map (fn* [p1__39296#] (p1__39296# tx auth-entity))) (some true?)) => true
>>a  {:NEW [:= :procurement_requests.approved_quantity nil], :APPROVED [:>= :procurement_requests.approved_quantity :procurement_requests.requested_quantity], :PARTIALLY_APPROVED [:and [:< :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:> :procurement_requests.approved_quantity 0]], :DENIED [:= :procurement_requests.approved_quantity 0]}
>>b  #sql/call [:case [:= :procurement_requests.approved_quantity nil] NEW [:>= :procurement_requests.approved_quantity :procurement_requests.requested_quantity] APPROVED [:and [:< :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:> :procurement_requests.approved_quantity 0]] PARTIALLY_APPROVED [:= :procurement_requests.approved_quantity 0] DENIED]
2023-11-24T14:02:18.338Z NX-41294 DEBUG [leihs.procurement.resources.request:157] - (-> requests-base-query (sql/merge-select [(state-sql advanced-user?) :state]) (sql/merge-join :procurement_budget_periods [:= :procurement_budget_periods.id :procurement_requests.budget_period_id])) => {:select (#sql/raw "DISTINCT ON (procurement_requests.id, concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))) procurement_requests.*" [#sql/call [:case [:= :procurement_requests.approved_quantity nil] "NEW" [:>= :procurement_requests.approved_quantity :procurement_requests.requested_quantity] "APPROVED" [:and [:< :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:> :procurement_requests.approved_quantity 0]] "PARTIALLY_APPROVED" [:= :procurement_requests.approved_quantity 0] "DENIED"] :state]), :from (:procurement_requests), :left-join (:models [:= :models.id :procurement_requests.model_id]), :order-by (#sql/raw "concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))"), :join (:procurement_budget_periods [:= :procurement_budget_periods.id :procurement_requests.budget_period_id])}
2023-11-24T14:02:18.342Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:18.345Z NX-41294 DEBUG [leihs.procurement.resources.requests:108] - query => ["SELECT DISTINCT ON (procurement_requests.id, concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))) procurement_requests.*, CASE WHEN procurement_requests.approved_quantity IS NULL THEN ? WHEN procurement_requests.approved_quantity >= procurement_requests.requested_quantity THEN ? WHEN (procurement_requests.approved_quantity < procurement_requests.requested_quantity AND procurement_requests.approved_quantity > ?) THEN ? WHEN procurement_requests.approved_quantity = ? THEN ? END AS state, row_to_json(procurement_budget_periods_2) AS budget_period, row_to_json(procurement_categories)::jsonb || jsonb_build_object('main_category', row_to_json(procurement_main_categories)) AS category, row_to_json(models) AS model, row_to_json(procurement_organizations)::jsonb || jsonb_build_object('department', row_to_json(procurement_departments)) AS organization, row_to_json(procurement_templates) AS template, row_to_json(rooms)::jsonb || jsonb_build_object('building', row_to_json(buildings)) AS room, row_to_json(suppliers) AS supplier, row_to_json(users) AS user FROM procurement_requests INNER JOIN procurement_budget_periods ON procurement_budget_periods.id = procurement_requests.budget_period_id INNER JOIN (SELECT *, current_date > end_date AS is_past FROM procurement_budget_periods) procurement_budget_periods_2 ON procurement_budget_periods_2.id = procurement_requests.budget_period_id INNER JOIN procurement_categories ON procurement_categories.id = procurement_requests.category_id INNER JOIN procurement_main_categories ON procurement_main_categories.id = procurement_categories.main_category_id INNER JOIN procurement_organizations ON procurement_organizations.id = procurement_requests.organization_id INNER JOIN procurement_organizations procurement_departments ON procurement_departments.id = procurement_organizations.parent_id INNER JOIN rooms ON rooms.id = procurement_requests.room_id INNER JOIN buildings ON buildings.id = rooms.building_id LEFT JOIN models ON models.id = procurement_requests.model_id LEFT JOIN procurement_templates ON procurement_templates.id = procurement_requests.template_id LEFT JOIN suppliers ON suppliers.id = procurement_requests.supplier_id LEFT JOIN users ON users.id = procurement_requests.user_id WHERE ((procurement_requests.category_id in (?)) AND (procurement_requests.budget_period_id in (?)) AND (procurement_requests.organization_id in (?)) AND (procurement_requests.priority in (?, ?)) AND (procurement_requests.inspector_priority in (?, ?, ?, ?)) AND (procurement_requests.approved_quantity IS NULL OR procurement_requests.approved_quantity >= procurement_requests.requested_quantity OR (procurement_requests.approved_quantity < procurement_requests.requested_quantity AND procurement_requests.approved_quantity > ?) OR procurement_requests.approved_quantity = ?) AND (procurement_requests.order_status in (CAST(? AS order_status_enum), CAST(? AS order_status_enum), CAST(? AS order_status_enum), CAST(? AS order_status_enum), CAST(? AS order_status_enum)))) ORDER BY concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))" "NEW" "APPROVED" 0 "PARTIALLY_APPROVED" 0 "DENIED" "535b5ca7-c430-4a63-b5bd-09337b01bb7a" "48d8c363-6af4-4a49-91ad-1b701743155f" "7a59c4fa-a0ed-4abf-aeae-e9c3b3323e95" "normal" "high" "low" "medium" "high" "mandatory" 0 0 "not_processed" "in_progress" "procured" "alternative_procured" "not_procured"]
>>broken-query [SELECT DISTINCT ON (procurement_requests.id, concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))) procurement_requests.*, CASE WHEN procurement_requests.approved_quantity IS NULL THEN ? WHEN procurement_requests.approved_quantity >= procurement_requests.requested_quantity THEN ? WHEN (procurement_requests.approved_quantity < procurement_requests.requested_quantity AND procurement_requests.approved_quantity > ?) THEN ? WHEN procurement_requests.approved_quantity = ? THEN ? END AS state, row_to_json(procurement_budget_periods_2) AS budget_period, row_to_json(procurement_categories)::jsonb || jsonb_build_object('main_category', row_to_json(procurement_main_categories)) AS category, row_to_json(models) AS model, row_to_json(procurement_organizations)::jsonb || jsonb_build_object('department', row_to_json(procurement_departments)) AS organization, row_to_json(procurement_templates) AS template, row_to_json(rooms)::jsonb || jsonb_build_object('building', row_to_json(buildings)) AS room, row_to_json(suppliers) AS supplier, row_to_json(users) AS user FROM procurement_requests INNER JOIN procurement_budget_periods ON procurement_budget_periods.id = procurement_requests.budget_period_id INNER JOIN (SELECT *, current_date > end_date AS is_past FROM procurement_budget_periods) procurement_budget_periods_2 ON procurement_budget_periods_2.id = procurement_requests.budget_period_id INNER JOIN procurement_categories ON procurement_categories.id = procurement_requests.category_id INNER JOIN procurement_main_categories ON procurement_main_categories.id = procurement_categories.main_category_id INNER JOIN procurement_organizations ON procurement_organizations.id = procurement_requests.organization_id INNER JOIN procurement_organizations procurement_departments ON procurement_departments.id = procurement_organizations.parent_id INNER JOIN rooms ON rooms.id = procurement_requests.room_id INNER JOIN buildings ON buildings.id = rooms.building_id LEFT JOIN models ON models.id = procurement_requests.model_id LEFT JOIN procurement_templates ON procurement_templates.id = procurement_requests.template_id LEFT JOIN suppliers ON suppliers.id = procurement_requests.supplier_id LEFT JOIN users ON users.id = procurement_requests.user_id WHERE ((procurement_requests.category_id in (?)) AND (procurement_requests.budget_period_id in (?)) AND (procurement_requests.organization_id in (?)) AND (procurement_requests.priority in (?, ?)) AND (procurement_requests.inspector_priority in (?, ?, ?, ?)) AND (procurement_requests.approved_quantity IS NULL OR procurement_requests.approved_quantity >= procurement_requests.requested_quantity OR (procurement_requests.approved_quantity < procurement_requests.requested_quantity AND procurement_requests.approved_quantity > ?) OR procurement_requests.approved_quantity = ?) AND (procurement_requests.order_status in (CAST(? AS order_status_enum), CAST(? AS order_status_enum), CAST(? AS order_status_enum), CAST(? AS order_status_enum), CAST(? AS order_status_enum)))) ORDER BY concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, ''))) NEW APPROVED 0 PARTIALLY_APPROVED 0 DENIED 535b5ca7-c430-4a63-b5bd-09337b01bb7a 48d8c363-6af4-4a49-91ad-1b701743155f 7a59c4fa-a0ed-4abf-aeae-e9c3b3323e95 normal high low medium high mandatory 0 0 not_processed in_progress procured alternative_procured not_procured]
2023-11-24T14:02:18.354Z NX-41294 DEBUG [leihs.procurement.permissions.user:52] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_viewers) (sql/merge-where [:= :procurement_category_viewers.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_viewers.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:18.356Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:18.356Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:18.357Z NX-41294 DEBUG [leihs.procurement.permissions.user:85] - (->> [viewer? inspector? admin?] (map (fn* [p1__39296#] (p1__39296# tx auth-entity))) (some true?)) => true
2023-11-24T14:02:18.381Z NX-41294 DEBUG [leihs.procurement.permissions.user:72] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_requesters_organizations) (sql/where [:= :procurement_requesters_organizations.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:18.382Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:18.384Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:18.386Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE (procurement_category_inspectors.user_id = ? AND procurement_category_inspectors.category_id = ?))) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f" "535b5ca7-c430-4a63-b5bd-09337b01bb7a"]
2023-11-24T14:02:18.387Z NX-41294 DEBUG [leihs.procurement.permissions.user:52] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_viewers) (sql/merge-where [:= :procurement_category_viewers.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_viewers.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_viewers WHERE (procurement_category_viewers.user_id = ? AND procurement_category_viewers.category_id = ?))) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f" "535b5ca7-c430-4a63-b5bd-09337b01bb7a"]
2023-11-24T14:02:18.379Z NX-41294 DEBUG [leihs.procurement.dashboard:50] - (requests/get-requests ctx args value) => ({:category {:read true, :write false, :default {:id #uuid "535b5ca7-c430-4a63-b5bd-09337b01bb7a", :name "Category C1", :main_category_id #uuid "46d19a93-31da-4690-a45f-b11b525ca6ff", :general_ledger_account nil, :cost_center nil, :procurement_account nil}, :required true, :value {:id "535b5ca7-c430-4a63-b5bd-09337b01bb7a", :name "Category C1", :cost_center nil, :main_category {:id "46d19a93-31da-4690-a45f-b11b525ca6ff", :name "Main Category MC1"}, :main_category_id "46d19a93-31da-4690-a45f-b11b525ca6ff", :procurement_account nil, :general_ledger_account nil}, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :supplier {:read true, :write false, :default nil, :required false, :value nil, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :motivation {:read true, :write false, :required true, :value "Corporis commodi provident nam.", :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :accounting_type {:read true, :write false, :default "aquisition", :required true, :value "aquisition", :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :actionPermissions {:edit true, :delete false, :moveBudgetPeriod false, :moveCategory false}, :article_number {:read true, :write false, :default nil, :required false, :value nil, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :inspector_priority {:read true, :write false, :default "MEDIUM", :required true, :value :MEDIUM, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :price_cents {:read true, :write false, :default 0, :required true, :value 0, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :budget_period {:read true, :write false, :default {:id #uuid "48d8c363-6af4-4a49-91ad-1b701743155f", :name "Budget-Period-Past", :inspection_start_date #time/instant "2023-08-23T22:00:00Z", :end_date #time/instant "2023-11-22T23:00:00Z", :created_at #time/instant "2023-11-24T14:02:16.844231Z", :updated_at #time/instant "2023-11-24T14:02:16.844231Z"}, :required true, :value {:id "48d8c363-6af4-4a49-91ad-1b701743155f", :name "Budget-Period-Past", :inspection_start_date "2023-08-24T00:00:00+02:00", :end_date "2023-11-23T00:00:00+01:00", :created_at "2023-11-24T15:02:16.844231", :updated_at "2023-11-24T15:02:16.844231", :is_past true}, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :article_name {:read true, :write false, :default nil, :required true, :value "Mediocre Aluminum Shoes", :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :replacement {:read true, :write false, :default nil, :required true, :value true, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :attachments {:read true, :write false, :required false, :value :unqueried, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :DELETE false, :template {:read true, :write false, :default nil, :required true, :value nil, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :state :NEW, :organization {:value {:id "7a59c4fa-a0ed-4abf-aeae-e9c3b3323e95", :name "Beauty & Kids", :parent_id "e20c5fdb-8997-43a6-bebb-133d1466c239", :shortname nil, :department {:id "e20c5fdb-8997-43a6-bebb-133d1466c239", :name "Home, Jewelry & Computers", :parent_id nil, :shortname nil}}, :read false, :write false, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :supplier_name {:read true, :write false, :default nil, :required false, :value nil, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :order_status {:read true, :write true, :default "NOT_PROCURED", :required true, :value :NOT_PROCESSED, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :requested_quantity {:read true, :write false, :required true, :value 1, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :general_ledger_account {:read true, :write false, :required false, :value nil, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :updated_at {:value #time/instant "2023-11-24T14:02:16.941919Z", :read false, :write false, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :priority {:read true, :write false, :default "NORMAL", :required true, :value :NORMAL, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc", :total_price_cents 0, :price_currency {:read true, :write false, :default "CHF", :required true, :value "CHF", :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :procurement_account {:read true, :write false, :value nil, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :room {:read true, :write false, :default {:id #uuid "b8927fd2-014c-48c2-b095-fa1d5620debe", :name "general room", :description nil, :building_id #uuid "abae04c5-d767-425e-acc2-7ce04df645d1", :general true, :building {:id #uuid "abae04c5-d767-425e-acc2-7ce04df645d1", :name "general building", :code nil}}, :required true, :value {:id "707541da-817b-402d-86a4-dbd6e72bee46", :name "reception room", :general false, :building {:id "d1f8159a-bf85-4dde-8e9f-5472b1deb309", :code nil, :name "9594 Beer Extension"}, :building_id "d1f8159a-bf85-4dde-8e9f-5472b1deb309", :description nil}, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :inspection_comment {:read true, :write false, :required false, :value nil, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :approved_quantity {:read true, :write false, :required false, :value nil, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :order_quantity {:read true, :write false, :required false, :value nil, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :cost_center {:read true, :write false, :required false, :value nil, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :user {:read true, :write false, :required true, :default {:id #uuid "1862f73f-33ba-415e-b3c2-5feb2074752d", :firstname "Lynsey", :lastname "Kertzmann"}, :value {:system_admin_protected false, :address nil, :email "chanda@ortiz.net", :pool_protected false, :last_sign_in_at nil, :img32_url nil, :account_enabled true, :lastname "Kertzmann", :phone nil, :img_digest nil, :org_id nil, :extended_info nil, :secondary_email nil, :city nil, :settings nil, :is_admin false, :organization "local", :login nil, :searchable "Lynsey Kertzmann chanda@ortiz.net    Kertzmann Lynsey", :updated_at "2023-11-24T15:02:16.902996+01:00", :firstname "Lynsey", :zip nil, :id "1862f73f-33ba-415e-b3c2-5feb2074752d", :url nil, :password_sign_in_enabled true, :account_disabled_at nil, :is_system_admin false, :badge_id nil, :language_locale nil, :img256_url nil, :country nil, :delegator_user_id nil, :created_at "2023-11-24T15:02:16.902996+01:00", :admin_protected false}, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :receiver {:read true, :write false, :required false, :value nil, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :internal_order_number {:read true, :write false, :required false, :value nil, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :created_at {:value #time/instant "2023-11-24T14:02:16.941919Z", :read false, :write false, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :order_comment {:read true, :write true, :required false, :value nil, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :short_id "Budget-Period-Past.001", :model {:read true, :write false, :default nil, :required false, :value nil, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}})

>>>pure-handler {:data #ordered/map ([:dashboard #ordered/map ([:cacheKey 295803904] [:total_count 1] [:budget_periods [#ordered/map ([:id 48d8c363-6af4-4a49-91ad-1b701743155f] [:cacheKey 295803904_48d8c363-6af4-4a49-91ad-1b701743155f] [:name Budget-Period-Past] [:inspection_start_date 2023-08-23T22:00:00Z] [:end_date 2023-11-22T23:00:00Z] [:total_price_cents 0] [:main_categories [#ordered/map ([:id 46d19a93-31da-4690-a45f-b11b525ca6ff] [:cacheKey 295803904_48d8c363-6af4-4a49-91ad-1b701743155f_46d19a93-31da-4690-a45f-b11b525ca6ff] [:name Main Category MC1] [:image_url nil] [:total_price_cents 0] [:categories [#ordered/map ([:id 535b5ca7-c430-4a63-b5bd-09337b01bb7a] [:cacheKey 295803904_48d8c363-6af4-4a49-91ad-1b701743155f_46d19a93-31da-4690-a45f-b11b525ca6ff_535b5ca7-c430-4a63-b5bd-09337b01bb7a] [:name Category C1] [:total_price_cents 0] [:requests [#ordered/map ([:id df6d3979-4323-4d7d-ae8e-078e0b162dcc] [:short_id Budget-Period-Past.001] [:user #ordered/map ([:value #ordered/map ([:id 1862f73f-33ba-415e-b3c2-5feb2074752d] [:firstname Lynsey] [:lastname Kertzmann] [:__typename :User])] [:__typename :RequestFieldUser])] [:category #ordered/map ([:read true] [:write false] [:required true] [:value #ordered/map ([:id 535b5ca7-c430-4a63-b5bd-09337b01bb7a] [:name Category C1] [:main_category #ordered/map ([:id 46d19a93-31da-4690-a45f-b11b525ca6ff] [:name Main Category MC1] [:__typename :MainCategory])] [:__typename :Category])] [:__typename :RequestFieldCategory])] [:budget_period #ordered/map ([:read true] [:write false] [:required true] [:value #ordered/map ([:name Budget-Period-Past] [:id 48d8c363-6af4-4a49-91ad-1b701743155f] [:__typename :BudgetPeriod])] [:__typename :RequestFieldBudgetPeriod])] [:article_name #ordered/map ([:value Mediocre Aluminum Shoes] [:__typename :RequestFieldString])] [:model #ordered/map ([:value nil] [:__typename :RequestFieldModel])] [:receiver #ordered/map ([:value nil] [:__typename :RequestFieldString])] [:organization #ordered/map ([:value #ordered/map ([:id 7a59c4fa-a0ed-4abf-aeae-e9c3b3323e95] [:name Beauty & Kids] [:shortname nil] [:department #ordered/map ([:id e20c5fdb-8997-43a6-bebb-133d1466c239] [:name Home, Jewelry & Computers] [:__typename :Organization])] [:__typename :Organization])] [:__typename :RequestFieldOrganization])] [:price_cents #ordered/map ([:value 0] [:__typename :RequestFieldInt])] [:price_currency #ordered/map ([:value CHF] [:__typename :RequestFieldString])] [:requested_quantity #ordered/map ([:read true] [:value 1] [:__typename :RequestFieldInt])] [:approved_quantity #ordered/map ([:read true] [:value nil] [:__typename :RequestFieldInt])] [:order_quantity #ordered/map ([:read true] [:value nil] [:__typename :RequestFieldInt])] [:replacement #ordered/map ([:value true] [:__typename :RequestFieldBoolean])] [:priority #ordered/map ([:value :NORMAL] [:__typename :RequestFieldPriority])] [:state :NEW] [:article_number #ordered/map ([:value nil] [:__typename :RequestFieldString])] [:supplier #ordered/map ([:value nil] [:__typename :RequestFieldSupplier])] [:supplier_name #ordered/map ([:value nil] [:__typename :RequestFieldString])] [:room #ordered/map ([:value #ordered/map ([:id 707541da-817b-402d-86a4-dbd6e72bee46] [:name reception room] [:building #ordered/map ([:id d1f8159a-bf85-4dde-8e9f-5472b1deb309] [:name 9594 Beer Extension] [:__typename :Building])] [:__typename :Room])] [:__typename :RequestFieldRoom])] [:motivation #ordered/map ([:value Corporis commodi provident nam.] [:__typename :RequestFieldString])] [:inspection_comment #ordered/map ([:value nil] [:__typename :RequestFieldString])] [:inspector_priority #ordered/map ([:value :MEDIUM] [:__typename :RequestFieldInspectorPriority])] [:accounting_type #ordered/map ([:value aquisition] [:__typename :RequestFieldString])] [:cost_center #ordered/map ([:value nil] [:__typename :RequestFieldCostCenter])] [:general_ledger_account #ordered/map ([:value nil] [:__typename :RequestFieldGeneralLedgerAccount])] [:procurement_account #ordered/map ([:value nil] [:__typename :RequestFieldProcurementAccount])] [:internal_order_number #ordered/map ([:value nil] [:__typename :RequestFieldString])] [:order_status #ordered/map ([:value :NOT_PROCESSED] [:__typename :RequestFieldOrderStatus])] [:order_comment #ordered/map ([:value nil] [:__typename :RequestFieldString])] [:__typename :Request] [:total_price_cents 0] [:actionPermissions #ordered/map ([:edit true] [:__typename :RequestActionPermissions])])]] [:__typename :Category])]] [:__typename :MainCategory])]] [:__typename :BudgetPeriod])]] [:__typename :Dashboard])])}
2023-11-24T14:02:18.410Z NX-41294 DEBUG [leihs.procurement.graphql:64] - result => {:data #ordered/map ([:dashboard #ordered/map ([:cacheKey "295803904"] [:total_count 1] [:budget_periods [#ordered/map ([:id "48d8c363-6af4-4a49-91ad-1b701743155f"] [:cacheKey "295803904_48d8c363-6af4-4a49-91ad-1b701743155f"] [:name "Budget-Period-Past"] [:inspection_start_date "2023-08-23T22:00:00Z"] [:end_date "2023-11-22T23:00:00Z"] [:total_price_cents "0"] [:main_categories [#ordered/map ([:id "46d19a93-31da-4690-a45f-b11b525ca6ff"] [:cacheKey "295803904_48d8c363-6af4-4a49-91ad-1b701743155f_46d19a93-31da-4690-a45f-b11b525ca6ff"] [:name "Main Category MC1"] [:image_url nil] [:total_price_cents "0"] [:categories [#ordered/map ([:id "535b5ca7-c430-4a63-b5bd-09337b01bb7a"] [:cacheKey "295803904_48d8c363-6af4-4a49-91ad-1b701743155f_46d19a93-31da-4690-a45f-b11b525ca6ff_535b5ca7-c430-4a63-b5bd-09337b01bb7a"] [:name "Category C1"] [:total_price_cents "0"] [:requests [#ordered/map ([:id "df6d3979-4323-4d7d-ae8e-078e0b162dcc"] [:short_id "Budget-Period-Past.001"] [:user #ordered/map ([:value #ordered/map ([:id "1862f73f-33ba-415e-b3c2-5feb2074752d"] [:firstname "Lynsey"] [:lastname "Kertzmann"] [:__typename :User])] [:__typename :RequestFieldUser])] [:category #ordered/map ([:read true] [:write false] [:required true] [:value #ordered/map ([:id "535b5ca7-c430-4a63-b5bd-09337b01bb7a"] [:name "Category C1"] [:main_category #ordered/map ([:id "46d19a93-31da-4690-a45f-b11b525ca6ff"] [:name "Main Category MC1"] [:__typename :MainCategory])] [:__typename :Category])] [:__typename :RequestFieldCategory])] [:budget_period #ordered/map ([:read true] [:write false] [:required true] [:value #ordered/map ([:name "Budget-Period-Past"] [:id "48d8c363-6af4-4a49-91ad-1b701743155f"] [:__typename :BudgetPeriod])] [:__typename :RequestFieldBudgetPeriod])] [:article_name #ordered/map ([:value "Mediocre Aluminum Shoes"] [:__typename :RequestFieldString])] [:model #ordered/map ([:value nil] [:__typename :RequestFieldModel])] [:receiver #ordered/map ([:value nil] [:__typename :RequestFieldString])] [:organization #ordered/map ([:value #ordered/map ([:id "7a59c4fa-a0ed-4abf-aeae-e9c3b3323e95"] [:name "Beauty & Kids"] [:shortname nil] [:department #ordered/map ([:id "e20c5fdb-8997-43a6-bebb-133d1466c239"] [:name "Home, Jewelry & Computers"] [:__typename :Organization])] [:__typename :Organization])] [:__typename :RequestFieldOrganization])] [:price_cents #ordered/map ([:value 0] [:__typename :RequestFieldInt])] [:price_currency #ordered/map ([:value "CHF"] [:__typename :RequestFieldString])] [:requested_quantity #ordered/map ([:read true] [:value 1] [:__typename :RequestFieldInt])] [:approved_quantity #ordered/map ([:read true] [:value nil] [:__typename :RequestFieldInt])] [:order_quantity #ordered/map ([:read true] [:value nil] [:__typename :RequestFieldInt])] [:replacement #ordered/map ([:value true] [:__typename :RequestFieldBoolean])] [:priority #ordered/map ([:value :NORMAL] [:__typename :RequestFieldPriority])] [:state :NEW] [:article_number #ordered/map ([:value nil] [:__typename :RequestFieldString])] [:supplier #ordered/map ([:value nil] [:__typename :RequestFieldSupplier])] [:supplier_name #ordered/map ([:value nil] [:__typename :RequestFieldString])] [:room #ordered/map ([:value #ordered/map ([:id "707541da-817b-402d-86a4-dbd6e72bee46"] [:name "reception room"] [:building #ordered/map ([:id "d1f8159a-bf85-4dde-8e9f-5472b1deb309"] [:name "9594 Beer Extension"] [:__typename :Building])] [:__typename :Room])] [:__typename :RequestFieldRoom])] [:motivation #ordered/map ([:value "Corporis commodi provident nam."] [:__typename :RequestFieldString])] [:inspection_comment #ordered/map ([:value nil] [:__typename :RequestFieldString])] [:inspector_priority #ordered/map ([:value :MEDIUM] [:__typename :RequestFieldInspectorPriority])] [:accounting_type #ordered/map ([:value "aquisition"] [:__typename :RequestFieldString])] [:cost_center #ordered/map ([:value nil] [:__typename :RequestFieldCostCenter])] [:general_ledger_account #ordered/map ([:value nil] [:__typename :RequestFieldGeneralLedgerAccount])] [:procurement_account #ordered/map ([:value nil] [:__typename :RequestFieldProcurementAccount])] [:internal_order_number #ordered/map ([:value nil] [:__typename :RequestFieldString])] [:order_status #ordered/map ([:value :NOT_PROCESSED] [:__typename :RequestFieldOrderStatus])] [:order_comment #ordered/map ([:value nil] [:__typename :RequestFieldString])] [:__typename :Request] [:total_price_cents "0"] [:actionPermissions #ordered/map ([:edit true] [:__typename :RequestActionPermissions])])]] [:__typename :Category])]] [:__typename :MainCategory])]] [:__typename :BudgetPeriod])]] [:__typename :Dashboard])])}
2023-11-24T14:02:18.423Z NX-41294 DEBUG [leihs.procurement.authorization:150] - (authorize handler request) => {:body {:data #ordered/map ([:dashboard #ordered/map ([:cacheKey "295803904"] [:total_count 1] [:budget_periods [#ordered/map ([:id "48d8c363-6af4-4a49-91ad-1b701743155f"] [:cacheKey "295803904_48d8c363-6af4-4a49-91ad-1b701743155f"] [:name "Budget-Period-Past"] [:inspection_start_date "2023-08-23T22:00:00Z"] [:end_date "2023-11-22T23:00:00Z"] [:total_price_cents "0"] [:main_categories [#ordered/map ([:id "46d19a93-31da-4690-a45f-b11b525ca6ff"] [:cacheKey "295803904_48d8c363-6af4-4a49-91ad-1b701743155f_46d19a93-31da-4690-a45f-b11b525ca6ff"] [:name "Main Category MC1"] [:image_url nil] [:total_price_cents "0"] [:categories [#ordered/map ([:id "535b5ca7-c430-4a63-b5bd-09337b01bb7a"] [:cacheKey "295803904_48d8c363-6af4-4a49-91ad-1b701743155f_46d19a93-31da-4690-a45f-b11b525ca6ff_535b5ca7-c430-4a63-b5bd-09337b01bb7a"] [:name "Category C1"] [:total_price_cents "0"] [:requests [#ordered/map ([:id "df6d3979-4323-4d7d-ae8e-078e0b162dcc"] [:short_id "Budget-Period-Past.001"] [:user #ordered/map ([:value #ordered/map ([:id "1862f73f-33ba-415e-b3c2-5feb2074752d"] [:firstname "Lynsey"] [:lastname "Kertzmann"] [:__typename :User])] [:__typename :RequestFieldUser])] [:category #ordered/map ([:read true] [:write false] [:required true] [:value #ordered/map ([:id "535b5ca7-c430-4a63-b5bd-09337b01bb7a"] [:name "Category C1"] [:main_category #ordered/map ([:id "46d19a93-31da-4690-a45f-b11b525ca6ff"] [:name "Main Category MC1"] [:__typename :MainCategory])] [:__typename :Category])] [:__typename :RequestFieldCategory])] [:budget_period #ordered/map ([:read true] [:write false] [:required true] [:value #ordered/map ([:name "Budget-Period-Past"] [:id "48d8c363-6af4-4a49-91ad-1b701743155f"] [:__typename :BudgetPeriod])] [:__typename :RequestFieldBudgetPeriod])] [:article_name #ordered/map ([:value "Mediocre Aluminum Shoes"] [:__typename :RequestFieldString])] [:model #ordered/map ([:value nil] [:__typename :RequestFieldModel])] [:receiver #ordered/map ([:value nil] [:__typename :RequestFieldString])] [:organization #ordered/map ([:value #ordered/map ([:id "7a59c4fa-a0ed-4abf-aeae-e9c3b3323e95"] [:name "Beauty & Kids"] [:shortname nil] [:department #ordered/map ([:id "e20c5fdb-8997-43a6-bebb-133d1466c239"] [:name "Home, Jewelry & Computers"] [:__typename :Organization])] [:__typename :Organization])] [:__typename :RequestFieldOrganization])] [:price_cents #ordered/map ([:value 0] [:__typename :RequestFieldInt])] [:price_currency #ordered/map ([:value "CHF"] [:__typename :RequestFieldString])] [:requested_quantity #ordered/map ([:read true] [:value 1] [:__typename :RequestFieldInt])] [:approved_quantity #ordered/map ([:read true] [:value nil] [:__typename :RequestFieldInt])] [:order_quantity #ordered/map ([:read true] [:value nil] [:__typename :RequestFieldInt])] [:replacement #ordered/map ([:value true] [:__typename :RequestFieldBoolean])] [:priority #ordered/map ([:value :NORMAL] [:__typename :RequestFieldPriority])] [:state :NEW] [:article_number #ordered/map ([:value nil] [:__typename :RequestFieldString])] [:supplier #ordered/map ([:value nil] [:__typename :RequestFieldSupplier])] [:supplier_name #ordered/map ([:value nil] [:__typename :RequestFieldString])] [:room #ordered/map ([:value #ordered/map ([:id "707541da-817b-402d-86a4-dbd6e72bee46"] [:name "reception room"] [:building #ordered/map ([:id "d1f8159a-bf85-4dde-8e9f-5472b1deb309"] [:name "9594 Beer Extension"] [:__typename :Building])] [:__typename :Room])] [:__typename :RequestFieldRoom])] [:motivation #ordered/map ([:value "Corporis commodi provident nam."] [:__typename :RequestFieldString])] [:inspection_comment #ordered/map ([:value nil] [:__typename :RequestFieldString])] [:inspector_priority #ordered/map ([:value :MEDIUM] [:__typename :RequestFieldInspectorPriority])] [:accounting_type #ordered/map ([:value "aquisition"] [:__typename :RequestFieldString])] [:cost_center #ordered/map ([:value nil] [:__typename :RequestFieldCostCenter])] [:general_ledger_account #ordered/map ([:value nil] [:__typename :RequestFieldGeneralLedgerAccount])] [:procurement_account #ordered/map ([:value nil] [:__typename :RequestFieldProcurementAccount])] [:internal_order_number #ordered/map ([:value nil] [:__typename :RequestFieldString])] [:order_status #ordered/map ([:value :NOT_PROCESSED] [:__typename :RequestFieldOrderStatus])] [:order_comment #ordered/map ([:value nil] [:__typename :RequestFieldString])] [:__typename :Request] [:total_price_cents "0"] [:actionPermissions #ordered/map ([:edit true] [:__typename :RequestActionPermissions])])]] [:__typename :Category])]] [:__typename :MainCategory])]] [:__typename :BudgetPeriod])]] [:__typename :Dashboard])])}}
>>> authenticate::skip= nil  handler-key= :graphql
>>> authenticate::authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-24T14:02:17.415645Z", :id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :user_session_id #uuid "e25b9e9c-082c-43d7-8468-0c267e3212a7", :scope_system_admin_read false, :access-rights (), :user_id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}

>> authorize >

>> authorize::handler > #object[leihs.core.locale$wrap$fn__44318 0x4cb26645 leihs.core.locale$wrap$fn__44318@4cb26645]

>> authorize::request > {:authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-24T14:02:17.415645Z", :id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :user_session_id #uuid "e25b9e9c-082c-43d7-8468-0c267e3212a7", :scope_system_admin_read false, :access-rights (), :user_id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}, :cookies {leihs-anti-csrf-token {:value 85b2de76-3ecd-40fd-a936-2d92f39bd32b}, leihs-user-session {:value 88ce2c7c-4075-46c2-80ca-82d865f9353e}}, :remote-addr 127.0.0.1, :start-time 489328718163125, :params {}, :settings {:email_sending_enabled false, :sessions_max_lifetime_secs 432000, :smtp_default_from_address your.lending.desk@example.com, :public_image_caching_enabled true, :sessions_force_secure false, :deliver_received_order_notifications false, :external_base_url nil, :sessions_force_uniqueness false, :email_signature Cheers,}, :tx-next #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x2e18c1e HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x4c858a34 next.jdbc.result_set$as_unqualified_lower_maps@4c858a34]}}, :query-params-raw {}, :route-params nil, :headers {origin http://localhost:3230, sec-fetch-site same-origin, host localhost:3230, user-agent Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/115.0, content-type application/json, cookie leihs-anti-csrf-token=85b2de76-3ecd-40fd-a936-2d92f39bd32b; leihs-user-session=88ce2c7c-4075-46c2-80ca-82d865f9353e, content-length 5678, referer http://localhost:3230/procure/requests, connection keep-alive, x-csrf-token 85b2de76-3ecd-40fd-a936-2d92f39bd32b, accept application/json, accept-language de,en-US;q=0.7,en;q=0.3, sec-fetch-dest empty, accept-encoding gzip, deflate, br, sec-fetch-mode cors}, :async-channel #object[org.httpkit.server.AsyncChannel 0x2d727f52 /127.0.0.1:3230<->/127.0.0.1:63590], :server-port 3230, :params-raw {}, :tx {:datasource #object[com.zaxxer.hikari.HikariDataSource 0x153deae HikariDataSource (db-pool)]}, :content-length 5678, :form-params {}, :websocket? false, :query-params {}, :content-type application/json, :form-params-raw {}, :character-encoding utf8, :uri /procure/graphql, :server-name localhost, :handler-key :graphql, :query-string nil, :body {:operationName RequestForEdit, :variables {:id [df6d3979-4323-4d7d-ae8e-078e0b162dcc]}, :query query RequestForEdit($id: [ID!]!) {
  requests(id: $id) {
    ...RequestFieldsForEdit
    actionPermissions {
      delete
      edit
      moveBudgetPeriod
      moveCategory
      __typename
    }
    __typename
  }
  main_categories {
    id
    name
    categories {
      id
      name
      __typename
    }
    __typename
  }
  budget_periods(whereRequestsCanBeMovedTo: $id) {
    id
    name
    __typename
  }
  settings {
    inspection_comments
    __typename
  }
}

fragment RequestFieldsForEdit on Request {
  ...RequestFieldsForIndex
  template {
    value {
      id
      article_name
      __typename
    }
    __typename
  }
  user {
    read
    write
    required
    value {
      id
      firstname
      lastname
      __typename
    }
    __typename
  }
  article_name {
    ...RequestFieldString
    __typename
  }
  model {
    read
    write
    required
    value {
      id
      product
      version
      __typename
    }
    __typename
  }
  supplier_name {
    ...RequestFieldString
    __typename
  }
  supplier {
    read
    write
    required
    value {
      id
      name
      __typename
    }
    __typename
  }
  receiver {
    ...RequestFieldString
    __typename
  }
  price_cents {
    ...RequestFieldInt
    __typename
  }
  price_currency {
    ...RequestFieldString
    __typename
  }
  requested_quantity {
    ...RequestFieldInt
    __typename
  }
  approved_quantity {
    ...RequestFieldInt
    __typename
  }
  order_quantity {
    ...RequestFieldInt
    __typename
  }
  order_status {
    read
    write
    required
    value
    __typename
  }
  order_comment {
    ...RequestFieldString
    __typename
  }
  priority {
    read
    write
    required
    value
    __typename
  }
  inspector_priority {
    read
    write
    required
    value
    __typename
  }
  state
  article_number {
    ...RequestFieldString
    __typename
  }
  motivation {
    ...RequestFieldString
    __typename
  }
  replacement {
    ...RequestFieldBoolean
    __typename
  }
  room {
    read
    write
    required
    value {
      id
      name
      building {
        id
        name
        __typename
      }
      __typename
    }
    __typename
  }
  inspection_comment {
    ...RequestFieldString
    __typename
  }
  attachments {
    read
    write
    required
    value {
      id
      filename
      url
      __typename
    }
    __typename
  }
  accounting_type {
    ...RequestFieldString
    __typename
  }
  cost_center {
    read
    write
    required
    value
    __typename
  }
  procurement_account {
    read
    write
    value
    __typename
  }
  general_ledger_account {
    read
    value
    __typename
  }
  internal_order_number {
    ...RequestFieldString
    __typename
  }
  __typename
}

fragment RequestFieldsForIndex on Request {
  id
  short_id
  user {
    value {
      id
      firstname
      lastname
      __typename
    }
    __typename
  }
  category {
    read
    write
    required
    value {
      id
      name
      main_category {
        id
        name
        __typename
      }
      __typename
    }
    __typename
  }
  budget_period {
    read
    write
    required
    value {
      name
      id
      __typename
    }
    __typename
  }
  article_name {
    value
    __typename
  }
  model {
    value {
      id
      product
      version
      __typename
    }
    __typename
  }
  receiver {
    value
    __typename
  }
  organization {
    value {
      id
      name
      shortname
      department {
        id
        name
        __typename
      }
      __typename
    }
    __typename
  }
  price_cents {
    value
    __typename
  }
  price_currency {
    value
    __typename
  }
  requested_quantity {
    read
    value
    __typename
  }
  approved_quantity {
    read
    value
    __typename
  }
  order_quantity {
    read
    value
    __typename
  }
  replacement {
    value
    __typename
  }
  priority {
    value
    __typename
  }
  state
  article_number {
    value
    __typename
  }
  supplier {
    value {
      name
      __typename
    }
    __typename
  }
  supplier_name {
    value
    __typename
  }
  receiver {
    value
    __typename
  }
  room {
    value {
      id
      name
      building {
        id
        name
        __typename
      }
      __typename
    }
    __typename
  }
  motivation {
    value
    __typename
  }
  inspection_comment {
    value
    __typename
  }
  inspector_priority {
    value
    __typename
  }
  accounting_type {
    value
    __typename
  }
  cost_center {
    value
    __typename
  }
  general_ledger_account {
    value
    __typename
  }
  procurement_account {
    value
    __typename
  }
  internal_order_number {
    value
    __typename
  }
  order_status {
    value
    __typename
  }
  order_comment {
    value
    __typename
  }
  __typename
}

fragment RequestFieldString on RequestFieldString {
  value
  read
  write
  required
  __typename
}

fragment RequestFieldInt on RequestFieldInt {
  value
  read
  write
  required
  __typename
}

fragment RequestFieldBoolean on RequestFieldBoolean {
  value
  read
  write
  required
  __typename
}
}, :graphql-schema #CompiledSchema<>, :handler #object[leihs.procurement.graphql$handler 0x1a4a1f6f leihs.procurement.graphql$handler@1a4a1f6f], :multipart-params {}, :scheme :http, :request-method :post, :accept {:mime :json, :charset nil, :encoding nil, :language nil}}

>> authorize::handler-key >> :graphql
2023-11-24T14:02:19.105Z NX-41294 DEBUG [leihs.procurement.authorization:135] - (skip? (:handler-key request)) => nil
2023-11-24T14:02:19.106Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:19.107Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:19.109Z NX-41294 DEBUG [leihs.procurement.permissions.user:52] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_viewers) (sql/merge-where [:= :procurement_category_viewers.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_viewers.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:19.109Z NX-41294 DEBUG [leihs.procurement.permissions.user:72] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_requesters_organizations) (sql/where [:= :procurement_requesters_organizations.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:19.110Z NX-41294 DEBUG [leihs.procurement.authorization:136] - (->> [user-perms/admin? user-perms/inspector? user-perms/viewer? user-perms/requester?] (map (fn* [p1__39355#] (p1__39355# (:tx request) (:authenticated-entity request)))) (some true?)) => true

>>>exec-query::variables {:id [df6d3979-4323-4d7d-ae8e-078e0b162dcc]}
2023-11-24T14:02:19.127Z NX-41294 DEBUG [leihs.procurement.permissions.user:52] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_viewers) (sql/merge-where [:= :procurement_category_viewers.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_viewers.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:19.129Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:19.130Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:19.131Z NX-41294 DEBUG [leihs.procurement.permissions.user:85] - (->> [viewer? inspector? admin?] (map (fn* [p1__39296#] (p1__39296# tx auth-entity))) (some true?)) => true
>>a  {:NEW [:= :procurement_requests.approved_quantity nil], :APPROVED [:>= :procurement_requests.approved_quantity :procurement_requests.requested_quantity], :PARTIALLY_APPROVED [:and [:< :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:> :procurement_requests.approved_quantity 0]], :DENIED [:= :procurement_requests.approved_quantity 0]}
>>b  #sql/call [:case [:= :procurement_requests.approved_quantity nil] NEW [:>= :procurement_requests.approved_quantity :procurement_requests.requested_quantity] APPROVED [:and [:< :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:> :procurement_requests.approved_quantity 0]] PARTIALLY_APPROVED [:= :procurement_requests.approved_quantity 0] DENIED]
2023-11-24T14:02:19.132Z NX-41294 DEBUG [leihs.procurement.resources.request:157] - (-> requests-base-query (sql/merge-select [(state-sql advanced-user?) :state]) (sql/merge-join :procurement_budget_periods [:= :procurement_budget_periods.id :procurement_requests.budget_period_id])) => {:select (#sql/raw "DISTINCT ON (procurement_requests.id, concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))) procurement_requests.*" [#sql/call [:case [:= :procurement_requests.approved_quantity nil] "NEW" [:>= :procurement_requests.approved_quantity :procurement_requests.requested_quantity] "APPROVED" [:and [:< :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:> :procurement_requests.approved_quantity 0]] "PARTIALLY_APPROVED" [:= :procurement_requests.approved_quantity 0] "DENIED"] :state]), :from (:procurement_requests), :left-join (:models [:= :models.id :procurement_requests.model_id]), :order-by (#sql/raw "concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))"), :join (:procurement_budget_periods [:= :procurement_budget_periods.id :procurement_requests.budget_period_id])}
2023-11-24T14:02:19.134Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:19.137Z NX-41294 DEBUG [leihs.procurement.resources.requests:108] - query => ["SELECT DISTINCT ON (procurement_requests.id, concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))) procurement_requests.*, CASE WHEN procurement_requests.approved_quantity IS NULL THEN ? WHEN procurement_requests.approved_quantity >= procurement_requests.requested_quantity THEN ? WHEN (procurement_requests.approved_quantity < procurement_requests.requested_quantity AND procurement_requests.approved_quantity > ?) THEN ? WHEN procurement_requests.approved_quantity = ? THEN ? END AS state, row_to_json(procurement_budget_periods_2) AS budget_period, row_to_json(procurement_categories)::jsonb || jsonb_build_object('main_category', row_to_json(procurement_main_categories)) AS category, row_to_json(models) AS model, row_to_json(procurement_organizations)::jsonb || jsonb_build_object('department', row_to_json(procurement_departments)) AS organization, row_to_json(procurement_templates) AS template, row_to_json(rooms)::jsonb || jsonb_build_object('building', row_to_json(buildings)) AS room, row_to_json(suppliers) AS supplier, row_to_json(users) AS user FROM procurement_requests INNER JOIN procurement_budget_periods ON procurement_budget_periods.id = procurement_requests.budget_period_id INNER JOIN (SELECT *, current_date > end_date AS is_past FROM procurement_budget_periods) procurement_budget_periods_2 ON procurement_budget_periods_2.id = procurement_requests.budget_period_id INNER JOIN procurement_categories ON procurement_categories.id = procurement_requests.category_id INNER JOIN procurement_main_categories ON procurement_main_categories.id = procurement_categories.main_category_id INNER JOIN procurement_organizations ON procurement_organizations.id = procurement_requests.organization_id INNER JOIN procurement_organizations procurement_departments ON procurement_departments.id = procurement_organizations.parent_id INNER JOIN rooms ON rooms.id = procurement_requests.room_id INNER JOIN buildings ON buildings.id = rooms.building_id LEFT JOIN models ON models.id = procurement_requests.model_id LEFT JOIN procurement_templates ON procurement_templates.id = procurement_requests.template_id LEFT JOIN suppliers ON suppliers.id = procurement_requests.supplier_id LEFT JOIN users ON users.id = procurement_requests.user_id WHERE (procurement_requests.id in (?)) ORDER BY concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))" "NEW" "APPROVED" 0 "PARTIALLY_APPROVED" 0 "DENIED" "df6d3979-4323-4d7d-ae8e-078e0b162dcc"]
>>broken-query [SELECT DISTINCT ON (procurement_requests.id, concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))) procurement_requests.*, CASE WHEN procurement_requests.approved_quantity IS NULL THEN ? WHEN procurement_requests.approved_quantity >= procurement_requests.requested_quantity THEN ? WHEN (procurement_requests.approved_quantity < procurement_requests.requested_quantity AND procurement_requests.approved_quantity > ?) THEN ? WHEN procurement_requests.approved_quantity = ? THEN ? END AS state, row_to_json(procurement_budget_periods_2) AS budget_period, row_to_json(procurement_categories)::jsonb || jsonb_build_object('main_category', row_to_json(procurement_main_categories)) AS category, row_to_json(models) AS model, row_to_json(procurement_organizations)::jsonb || jsonb_build_object('department', row_to_json(procurement_departments)) AS organization, row_to_json(procurement_templates) AS template, row_to_json(rooms)::jsonb || jsonb_build_object('building', row_to_json(buildings)) AS room, row_to_json(suppliers) AS supplier, row_to_json(users) AS user FROM procurement_requests INNER JOIN procurement_budget_periods ON procurement_budget_periods.id = procurement_requests.budget_period_id INNER JOIN (SELECT *, current_date > end_date AS is_past FROM procurement_budget_periods) procurement_budget_periods_2 ON procurement_budget_periods_2.id = procurement_requests.budget_period_id INNER JOIN procurement_categories ON procurement_categories.id = procurement_requests.category_id INNER JOIN procurement_main_categories ON procurement_main_categories.id = procurement_categories.main_category_id INNER JOIN procurement_organizations ON procurement_organizations.id = procurement_requests.organization_id INNER JOIN procurement_organizations procurement_departments ON procurement_departments.id = procurement_organizations.parent_id INNER JOIN rooms ON rooms.id = procurement_requests.room_id INNER JOIN buildings ON buildings.id = rooms.building_id LEFT JOIN models ON models.id = procurement_requests.model_id LEFT JOIN procurement_templates ON procurement_templates.id = procurement_requests.template_id LEFT JOIN suppliers ON suppliers.id = procurement_requests.supplier_id LEFT JOIN users ON users.id = procurement_requests.user_id WHERE (procurement_requests.id in (?)) ORDER BY concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, ''))) NEW APPROVED 0 PARTIALLY_APPROVED 0 DENIED df6d3979-4323-4d7d-ae8e-078e0b162dcc]
2023-11-24T14:02:19.146Z NX-41294 DEBUG [leihs.procurement.permissions.user:52] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_viewers) (sql/merge-where [:= :procurement_category_viewers.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_viewers.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:19.147Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:19.148Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:19.149Z NX-41294 DEBUG [leihs.procurement.permissions.user:85] - (->> [viewer? inspector? admin?] (map (fn* [p1__39296#] (p1__39296# tx auth-entity))) (some true?)) => true
2023-11-24T14:02:19.165Z NX-41294 DEBUG [leihs.procurement.permissions.user:72] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_requesters_organizations) (sql/where [:= :procurement_requesters_organizations.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:19.166Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:19.167Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:19.171Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE (procurement_category_inspectors.user_id = ? AND procurement_category_inspectors.category_id = ?))) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f" "535b5ca7-c430-4a63-b5bd-09337b01bb7a"]
2023-11-24T14:02:19.172Z NX-41294 DEBUG [leihs.procurement.permissions.user:52] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_viewers) (sql/merge-where [:= :procurement_category_viewers.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_viewers.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_viewers WHERE (procurement_category_viewers.user_id = ? AND procurement_category_viewers.category_id = ?))) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f" "535b5ca7-c430-4a63-b5bd-09337b01bb7a"]

>>>pure-handler {:data #ordered/map ([:requests [#ordered/map ([:id df6d3979-4323-4d7d-ae8e-078e0b162dcc] [:short_id Budget-Period-Past.001] [:user #ordered/map ([:value #ordered/map ([:id 1862f73f-33ba-415e-b3c2-5feb2074752d] [:firstname Lynsey] [:lastname Kertzmann] [:__typename :User])] [:__typename :RequestFieldUser] [:read true] [:write false] [:required true])] [:category #ordered/map ([:read true] [:write false] [:required true] [:value #ordered/map ([:id 535b5ca7-c430-4a63-b5bd-09337b01bb7a] [:name Category C1] [:main_category #ordered/map ([:id 46d19a93-31da-4690-a45f-b11b525ca6ff] [:name Main Category MC1] [:__typename :MainCategory])] [:__typename :Category])] [:__typename :RequestFieldCategory])] [:budget_period #ordered/map ([:read true] [:write false] [:required true] [:value #ordered/map ([:name Budget-Period-Past] [:id 48d8c363-6af4-4a49-91ad-1b701743155f] [:__typename :BudgetPeriod])] [:__typename :RequestFieldBudgetPeriod])] [:article_name #ordered/map ([:value Mediocre Aluminum Shoes] [:__typename :RequestFieldString] [:read true] [:write false] [:required true])] [:model #ordered/map ([:value nil] [:__typename :RequestFieldModel] [:read true] [:write false] [:required false])] [:receiver #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:organization #ordered/map ([:value #ordered/map ([:id 7a59c4fa-a0ed-4abf-aeae-e9c3b3323e95] [:name Beauty & Kids] [:shortname nil] [:department #ordered/map ([:id e20c5fdb-8997-43a6-bebb-133d1466c239] [:name Home, Jewelry & Computers] [:__typename :Organization])] [:__typename :Organization])] [:__typename :RequestFieldOrganization])] [:price_cents #ordered/map ([:value 0] [:__typename :RequestFieldInt] [:read true] [:write false] [:required true])] [:price_currency #ordered/map ([:value CHF] [:__typename :RequestFieldString] [:read true] [:write false] [:required true])] [:requested_quantity #ordered/map ([:read true] [:value 1] [:__typename :RequestFieldInt] [:write false] [:required true])] [:approved_quantity #ordered/map ([:read true] [:value nil] [:__typename :RequestFieldInt] [:write false] [:required false])] [:order_quantity #ordered/map ([:read true] [:value nil] [:__typename :RequestFieldInt] [:write false] [:required false])] [:replacement #ordered/map ([:value true] [:__typename :RequestFieldBoolean] [:read true] [:write false] [:required true])] [:priority #ordered/map ([:value :NORMAL] [:__typename :RequestFieldPriority] [:read true] [:write false] [:required true])] [:state :NEW] [:article_number #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:supplier #ordered/map ([:value nil] [:__typename :RequestFieldSupplier] [:read true] [:write false] [:required false])] [:supplier_name #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:room #ordered/map ([:value #ordered/map ([:id 707541da-817b-402d-86a4-dbd6e72bee46] [:name reception room] [:building #ordered/map ([:id d1f8159a-bf85-4dde-8e9f-5472b1deb309] [:name 9594 Beer Extension] [:__typename :Building])] [:__typename :Room])] [:__typename :RequestFieldRoom] [:read true] [:write false] [:required true])] [:motivation #ordered/map ([:value Corporis commodi provident nam.] [:__typename :RequestFieldString] [:read true] [:write false] [:required true])] [:inspection_comment #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:inspector_priority #ordered/map ([:value :MEDIUM] [:__typename :RequestFieldInspectorPriority] [:read true] [:write false] [:required true])] [:accounting_type #ordered/map ([:value aquisition] [:__typename :RequestFieldString] [:read true] [:write false] [:required true])] [:cost_center #ordered/map ([:value nil] [:__typename :RequestFieldCostCenter] [:read true] [:write false] [:required false])] [:general_ledger_account #ordered/map ([:value nil] [:__typename :RequestFieldGeneralLedgerAccount] [:read true])] [:procurement_account #ordered/map ([:value nil] [:__typename :RequestFieldProcurementAccount] [:read true] [:write false])] [:internal_order_number #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:order_status #ordered/map ([:value :NOT_PROCESSED] [:__typename :RequestFieldOrderStatus] [:read true] [:write true] [:required true])] [:order_comment #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write true] [:required false])] [:__typename :Request] [:template #ordered/map ([:value nil] [:__typename :RequestFieldTemplate])] [:attachments #ordered/map ([:read true] [:write false] [:required false] [:value []] [:__typename :RequestFieldAttachments])] [:actionPermissions #ordered/map ([:delete false] [:edit true] [:moveBudgetPeriod false] [:moveCategory false] [:__typename :RequestActionPermissions])])]] [:main_categories [#ordered/map ([:id 46d19a93-31da-4690-a45f-b11b525ca6ff] [:name Main Category MC1] [:categories [#ordered/map ([:id 535b5ca7-c430-4a63-b5bd-09337b01bb7a] [:name Category C1] [:__typename :Category])]] [:__typename :MainCategory])]] [:budget_periods []] [:settings #ordered/map ([:inspection_comments [Eum architecto minus magnam.]] [:__typename :ProcurementSettings])])}
2023-11-24T14:02:19.214Z NX-41294 DEBUG [leihs.procurement.graphql:64] - result => {:data #ordered/map ([:requests [#ordered/map ([:id "df6d3979-4323-4d7d-ae8e-078e0b162dcc"] [:short_id "Budget-Period-Past.001"] [:user #ordered/map ([:value #ordered/map ([:id "1862f73f-33ba-415e-b3c2-5feb2074752d"] [:firstname "Lynsey"] [:lastname "Kertzmann"] [:__typename :User])] [:__typename :RequestFieldUser] [:read true] [:write false] [:required true])] [:category #ordered/map ([:read true] [:write false] [:required true] [:value #ordered/map ([:id "535b5ca7-c430-4a63-b5bd-09337b01bb7a"] [:name "Category C1"] [:main_category #ordered/map ([:id "46d19a93-31da-4690-a45f-b11b525ca6ff"] [:name "Main Category MC1"] [:__typename :MainCategory])] [:__typename :Category])] [:__typename :RequestFieldCategory])] [:budget_period #ordered/map ([:read true] [:write false] [:required true] [:value #ordered/map ([:name "Budget-Period-Past"] [:id "48d8c363-6af4-4a49-91ad-1b701743155f"] [:__typename :BudgetPeriod])] [:__typename :RequestFieldBudgetPeriod])] [:article_name #ordered/map ([:value "Mediocre Aluminum Shoes"] [:__typename :RequestFieldString] [:read true] [:write false] [:required true])] [:model #ordered/map ([:value nil] [:__typename :RequestFieldModel] [:read true] [:write false] [:required false])] [:receiver #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:organization #ordered/map ([:value #ordered/map ([:id "7a59c4fa-a0ed-4abf-aeae-e9c3b3323e95"] [:name "Beauty & Kids"] [:shortname nil] [:department #ordered/map ([:id "e20c5fdb-8997-43a6-bebb-133d1466c239"] [:name "Home, Jewelry & Computers"] [:__typename :Organization])] [:__typename :Organization])] [:__typename :RequestFieldOrganization])] [:price_cents #ordered/map ([:value 0] [:__typename :RequestFieldInt] [:read true] [:write false] [:required true])] [:price_currency #ordered/map ([:value "CHF"] [:__typename :RequestFieldString] [:read true] [:write false] [:required true])] [:requested_quantity #ordered/map ([:read true] [:value 1] [:__typename :RequestFieldInt] [:write false] [:required true])] [:approved_quantity #ordered/map ([:read true] [:value nil] [:__typename :RequestFieldInt] [:write false] [:required false])] [:order_quantity #ordered/map ([:read true] [:value nil] [:__typename :RequestFieldInt] [:write false] [:required false])] [:replacement #ordered/map ([:value true] [:__typename :RequestFieldBoolean] [:read true] [:write false] [:required true])] [:priority #ordered/map ([:value :NORMAL] [:__typename :RequestFieldPriority] [:read true] [:write false] [:required true])] [:state :NEW] [:article_number #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:supplier #ordered/map ([:value nil] [:__typename :RequestFieldSupplier] [:read true] [:write false] [:required false])] [:supplier_name #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:room #ordered/map ([:value #ordered/map ([:id "707541da-817b-402d-86a4-dbd6e72bee46"] [:name "reception room"] [:building #ordered/map ([:id "d1f8159a-bf85-4dde-8e9f-5472b1deb309"] [:name "9594 Beer Extension"] [:__typename :Building])] [:__typename :Room])] [:__typename :RequestFieldRoom] [:read true] [:write false] [:required true])] [:motivation #ordered/map ([:value "Corporis commodi provident nam."] [:__typename :RequestFieldString] [:read true] [:write false] [:required true])] [:inspection_comment #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:inspector_priority #ordered/map ([:value :MEDIUM] [:__typename :RequestFieldInspectorPriority] [:read true] [:write false] [:required true])] [:accounting_type #ordered/map ([:value "aquisition"] [:__typename :RequestFieldString] [:read true] [:write false] [:required true])] [:cost_center #ordered/map ([:value nil] [:__typename :RequestFieldCostCenter] [:read true] [:write false] [:required false])] [:general_ledger_account #ordered/map ([:value nil] [:__typename :RequestFieldGeneralLedgerAccount] [:read true])] [:procurement_account #ordered/map ([:value nil] [:__typename :RequestFieldProcurementAccount] [:read true] [:write false])] [:internal_order_number #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:order_status #ordered/map ([:value :NOT_PROCESSED] [:__typename :RequestFieldOrderStatus] [:read true] [:write true] [:required true])] [:order_comment #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write true] [:required false])] [:__typename :Request] [:template #ordered/map ([:value nil] [:__typename :RequestFieldTemplate])] [:attachments #ordered/map ([:read true] [:write false] [:required false] [:value []] [:__typename :RequestFieldAttachments])] [:actionPermissions #ordered/map ([:delete false] [:edit true] [:moveBudgetPeriod false] [:moveCategory false] [:__typename :RequestActionPermissions])])]] [:main_categories [#ordered/map ([:id "46d19a93-31da-4690-a45f-b11b525ca6ff"] [:name "Main Category MC1"] [:categories [#ordered/map ([:id "535b5ca7-c430-4a63-b5bd-09337b01bb7a"] [:name "Category C1"] [:__typename :Category])]] [:__typename :MainCategory])]] [:budget_periods []] [:settings #ordered/map ([:inspection_comments ["Eum architecto minus magnam."]] [:__typename :ProcurementSettings])])}
2023-11-24T14:02:19.223Z NX-41294 DEBUG [leihs.procurement.authorization:150] - (authorize handler request) => {:body {:data #ordered/map ([:requests [#ordered/map ([:id "df6d3979-4323-4d7d-ae8e-078e0b162dcc"] [:short_id "Budget-Period-Past.001"] [:user #ordered/map ([:value #ordered/map ([:id "1862f73f-33ba-415e-b3c2-5feb2074752d"] [:firstname "Lynsey"] [:lastname "Kertzmann"] [:__typename :User])] [:__typename :RequestFieldUser] [:read true] [:write false] [:required true])] [:category #ordered/map ([:read true] [:write false] [:required true] [:value #ordered/map ([:id "535b5ca7-c430-4a63-b5bd-09337b01bb7a"] [:name "Category C1"] [:main_category #ordered/map ([:id "46d19a93-31da-4690-a45f-b11b525ca6ff"] [:name "Main Category MC1"] [:__typename :MainCategory])] [:__typename :Category])] [:__typename :RequestFieldCategory])] [:budget_period #ordered/map ([:read true] [:write false] [:required true] [:value #ordered/map ([:name "Budget-Period-Past"] [:id "48d8c363-6af4-4a49-91ad-1b701743155f"] [:__typename :BudgetPeriod])] [:__typename :RequestFieldBudgetPeriod])] [:article_name #ordered/map ([:value "Mediocre Aluminum Shoes"] [:__typename :RequestFieldString] [:read true] [:write false] [:required true])] [:model #ordered/map ([:value nil] [:__typename :RequestFieldModel] [:read true] [:write false] [:required false])] [:receiver #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:organization #ordered/map ([:value #ordered/map ([:id "7a59c4fa-a0ed-4abf-aeae-e9c3b3323e95"] [:name "Beauty & Kids"] [:shortname nil] [:department #ordered/map ([:id "e20c5fdb-8997-43a6-bebb-133d1466c239"] [:name "Home, Jewelry & Computers"] [:__typename :Organization])] [:__typename :Organization])] [:__typename :RequestFieldOrganization])] [:price_cents #ordered/map ([:value 0] [:__typename :RequestFieldInt] [:read true] [:write false] [:required true])] [:price_currency #ordered/map ([:value "CHF"] [:__typename :RequestFieldString] [:read true] [:write false] [:required true])] [:requested_quantity #ordered/map ([:read true] [:value 1] [:__typename :RequestFieldInt] [:write false] [:required true])] [:approved_quantity #ordered/map ([:read true] [:value nil] [:__typename :RequestFieldInt] [:write false] [:required false])] [:order_quantity #ordered/map ([:read true] [:value nil] [:__typename :RequestFieldInt] [:write false] [:required false])] [:replacement #ordered/map ([:value true] [:__typename :RequestFieldBoolean] [:read true] [:write false] [:required true])] [:priority #ordered/map ([:value :NORMAL] [:__typename :RequestFieldPriority] [:read true] [:write false] [:required true])] [:state :NEW] [:article_number #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:supplier #ordered/map ([:value nil] [:__typename :RequestFieldSupplier] [:read true] [:write false] [:required false])] [:supplier_name #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:room #ordered/map ([:value #ordered/map ([:id "707541da-817b-402d-86a4-dbd6e72bee46"] [:name "reception room"] [:building #ordered/map ([:id "d1f8159a-bf85-4dde-8e9f-5472b1deb309"] [:name "9594 Beer Extension"] [:__typename :Building])] [:__typename :Room])] [:__typename :RequestFieldRoom] [:read true] [:write false] [:required true])] [:motivation #ordered/map ([:value "Corporis commodi provident nam."] [:__typename :RequestFieldString] [:read true] [:write false] [:required true])] [:inspection_comment #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:inspector_priority #ordered/map ([:value :MEDIUM] [:__typename :RequestFieldInspectorPriority] [:read true] [:write false] [:required true])] [:accounting_type #ordered/map ([:value "aquisition"] [:__typename :RequestFieldString] [:read true] [:write false] [:required true])] [:cost_center #ordered/map ([:value nil] [:__typename :RequestFieldCostCenter] [:read true] [:write false] [:required false])] [:general_ledger_account #ordered/map ([:value nil] [:__typename :RequestFieldGeneralLedgerAccount] [:read true])] [:procurement_account #ordered/map ([:value nil] [:__typename :RequestFieldProcurementAccount] [:read true] [:write false])] [:internal_order_number #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:order_status #ordered/map ([:value :NOT_PROCESSED] [:__typename :RequestFieldOrderStatus] [:read true] [:write true] [:required true])] [:order_comment #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write true] [:required false])] [:__typename :Request] [:template #ordered/map ([:value nil] [:__typename :RequestFieldTemplate])] [:attachments #ordered/map ([:read true] [:write false] [:required false] [:value []] [:__typename :RequestFieldAttachments])] [:actionPermissions #ordered/map ([:delete false] [:edit true] [:moveBudgetPeriod false] [:moveCategory false] [:__typename :RequestActionPermissions])])]] [:main_categories [#ordered/map ([:id "46d19a93-31da-4690-a45f-b11b525ca6ff"] [:name "Main Category MC1"] [:categories [#ordered/map ([:id "535b5ca7-c430-4a63-b5bd-09337b01bb7a"] [:name "Category C1"] [:__typename :Category])]] [:__typename :MainCategory])]] [:budget_periods []] [:settings #ordered/map ([:inspection_comments ["Eum architecto minus magnam."]] [:__typename :ProcurementSettings])])}}
>>> authenticate::skip= nil  handler-key= :graphql
>>> authenticate::authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-24T14:02:17.415645Z", :id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :user_session_id #uuid "e25b9e9c-082c-43d7-8468-0c267e3212a7", :scope_system_admin_read false, :access-rights (), :user_id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}

>> authorize >

>> authorize::handler > #object[leihs.core.locale$wrap$fn__44318 0x4cb26645 leihs.core.locale$wrap$fn__44318@4cb26645]

>> authorize::request > {:authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-24T14:02:17.415645Z", :id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :user_session_id #uuid "e25b9e9c-082c-43d7-8468-0c267e3212a7", :scope_system_admin_read false, :access-rights (), :user_id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}, :cookies {leihs-anti-csrf-token {:value 85b2de76-3ecd-40fd-a936-2d92f39bd32b}, leihs-user-session {:value 88ce2c7c-4075-46c2-80ca-82d865f9353e}}, :remote-addr 127.0.0.1, :start-time 489328929816000, :params {}, :settings {:email_sending_enabled false, :sessions_max_lifetime_secs 432000, :smtp_default_from_address your.lending.desk@example.com, :public_image_caching_enabled true, :sessions_force_secure false, :deliver_received_order_notifications false, :external_base_url nil, :sessions_force_uniqueness false, :email_signature Cheers,}, :tx-next #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x2e18c1e HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x4c858a34 next.jdbc.result_set$as_unqualified_lower_maps@4c858a34]}}, :query-params-raw {}, :route-params nil, :headers {origin http://localhost:3230, sec-fetch-site same-origin, host localhost:3230, user-agent Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/115.0, content-type application/json, cookie leihs-anti-csrf-token=85b2de76-3ecd-40fd-a936-2d92f39bd32b; leihs-user-session=88ce2c7c-4075-46c2-80ca-82d865f9353e, content-length 257, referer http://localhost:3230/procure/requests, connection keep-alive, x-csrf-token 85b2de76-3ecd-40fd-a936-2d92f39bd32b, accept application/json, accept-language de,en-US;q=0.7,en;q=0.3, sec-fetch-dest empty, accept-encoding gzip, deflate, br, sec-fetch-mode cors}, :async-channel #object[org.httpkit.server.AsyncChannel 0x4a32af9a /127.0.0.1:3230<->/127.0.0.1:63580], :server-port 3230, :params-raw {}, :tx {:datasource #object[com.zaxxer.hikari.HikariDataSource 0x153deae HikariDataSource (db-pool)]}, :content-length 257, :form-params {}, :websocket? false, :query-params {}, :content-type application/json, :form-params-raw {}, :character-encoding utf8, :uri /procure/graphql, :server-name localhost, :handler-key :graphql, :query-string nil, :body {:operationName getRoomsByBuilding, :variables {:buildingId d1f8159a-bf85-4dde-8e9f-5472b1deb309}, :query query getRoomsByBuilding($buildingId: ID!) {
  rooms(building_id: $buildingId) {
    id
    name
    description
    __typename
  }
}
}, :graphql-schema #CompiledSchema<>, :handler #object[leihs.procurement.graphql$handler 0x1a4a1f6f leihs.procurement.graphql$handler@1a4a1f6f], :multipart-params {}, :scheme :http, :request-method :post, :accept {:mime :json, :charset nil, :encoding nil, :language nil}}

>> authorize::handler-key >> :graphql
2023-11-24T14:02:19.304Z NX-41294 DEBUG [leihs.procurement.authorization:135] - (skip? (:handler-key request)) => nil
2023-11-24T14:02:19.305Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:19.306Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:19.307Z NX-41294 DEBUG [leihs.procurement.permissions.user:52] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_viewers) (sql/merge-where [:= :procurement_category_viewers.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_viewers.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:19.308Z NX-41294 DEBUG [leihs.procurement.permissions.user:72] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_requesters_organizations) (sql/where [:= :procurement_requesters_organizations.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:19.308Z NX-41294 DEBUG [leihs.procurement.authorization:136] - (->> [user-perms/admin? user-perms/inspector? user-perms/viewer? user-perms/requester?] (map (fn* [p1__39355#] (p1__39355# (:tx request) (:authenticated-entity request)))) (some true?)) => true

>>>exec-query::variables {:buildingId d1f8159a-bf85-4dde-8e9f-5472b1deb309}

>>>pure-handler {:data #ordered/map ([:rooms [#ordered/map ([:id 4489feb8-39b1-46c7-94fe-e77f5987a23a] [:name general room] [:description nil] [:__typename :Room]) #ordered/map ([:id 707541da-817b-402d-86a4-dbd6e72bee46] [:name reception room] [:description nil] [:__typename :Room])]])}
2023-11-24T14:02:19.314Z NX-41294 DEBUG [leihs.procurement.graphql:64] - result => {:data #ordered/map ([:rooms [#ordered/map ([:id "4489feb8-39b1-46c7-94fe-e77f5987a23a"] [:name "general room"] [:description nil] [:__typename :Room]) #ordered/map ([:id "707541da-817b-402d-86a4-dbd6e72bee46"] [:name "reception room"] [:description nil] [:__typename :Room])]])}
2023-11-24T14:02:19.314Z NX-41294 DEBUG [leihs.procurement.authorization:150] - (authorize handler request) => {:body {:data #ordered/map ([:rooms [#ordered/map ([:id "4489feb8-39b1-46c7-94fe-e77f5987a23a"] [:name "general room"] [:description nil] [:__typename :Room]) #ordered/map ([:id "707541da-817b-402d-86a4-dbd6e72bee46"] [:name "reception room"] [:description nil] [:__typename :Room])]])}}
>>> authenticate::skip= nil  handler-key= :graphql
>>> authenticate::authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-24T14:02:17.415645Z", :id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :user_session_id #uuid "e25b9e9c-082c-43d7-8468-0c267e3212a7", :scope_system_admin_read false, :access-rights (), :user_id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}

>> authorize >

>> authorize::handler > #object[leihs.core.locale$wrap$fn__44318 0x4cb26645 leihs.core.locale$wrap$fn__44318@4cb26645]

>> authorize::request > {:authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-24T14:02:17.415645Z", :id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :user_session_id #uuid "e25b9e9c-082c-43d7-8468-0c267e3212a7", :scope_system_admin_read false, :access-rights (), :user_id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}, :cookies {leihs-anti-csrf-token {:value 85b2de76-3ecd-40fd-a936-2d92f39bd32b}, leihs-user-session {:value 88ce2c7c-4075-46c2-80ca-82d865f9353e}}, :remote-addr 127.0.0.1, :start-time 489328954952208, :params {}, :settings {:email_sending_enabled false, :sessions_max_lifetime_secs 432000, :smtp_default_from_address your.lending.desk@example.com, :public_image_caching_enabled true, :sessions_force_secure false, :deliver_received_order_notifications false, :external_base_url nil, :sessions_force_uniqueness false, :email_signature Cheers,}, :tx-next #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x2e18c1e HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x4c858a34 next.jdbc.result_set$as_unqualified_lower_maps@4c858a34]}}, :query-params-raw {}, :route-params nil, :headers {origin http://localhost:3230, sec-fetch-site same-origin, host localhost:3230, user-agent Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/115.0, content-type application/json, cookie leihs-anti-csrf-token=85b2de76-3ecd-40fd-a936-2d92f39bd32b; leihs-user-session=88ce2c7c-4075-46c2-80ca-82d865f9353e, content-length 502, referer http://localhost:3230/procure/requests, connection keep-alive, x-csrf-token 85b2de76-3ecd-40fd-a936-2d92f39bd32b, accept application/json, accept-language de,en-US;q=0.7,en;q=0.3, sec-fetch-dest empty, accept-encoding gzip, deflate, br, sec-fetch-mode cors}, :async-channel #object[org.httpkit.server.AsyncChannel 0x25c24b78 /127.0.0.1:3230<->/127.0.0.1:63593], :server-port 3230, :params-raw {}, :tx {:datasource #object[com.zaxxer.hikari.HikariDataSource 0x153deae HikariDataSource (db-pool)]}, :content-length 502, :form-params {}, :websocket? false, :query-params {}, :content-type application/json, :form-params-raw {}, :character-encoding utf8, :uri /procure/graphql, :server-name localhost, :handler-key :graphql, :query-string nil, :body {:operationName me, :variables {}, :query query me {
  current_user {
    navbarProps
    user {
      id
      firstname
      lastname
      permissions {
        isAdmin
        isRequester
        isInspectorForCategories {
          id
          __typename
        }
        isViewerForCategories {
          id
          __typename
        }
        __typename
      }
      __typename
    }
    __typename
  }
  settings {
    contact_url
    __typename
  }
}
}, :graphql-schema #CompiledSchema<>, :handler #object[leihs.procurement.graphql$handler 0x1a4a1f6f leihs.procurement.graphql$handler@1a4a1f6f], :multipart-params {}, :scheme :http, :request-method :post, :accept {:mime :json, :charset nil, :encoding nil, :language nil}}
>>> authenticate::skip=
>> authorize::handler-key >> nil  handler-key=:graphql :graphql

>>> authenticate::authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-24T14:02:17.415645Z", :id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :user_session_id #uuid "e25b9e9c-082c-43d7-8468-0c267e3212a7", :scope_system_admin_read false, :access-rights (), :user_id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}
2023-11-24T14:02:19.326Z NX-41294 DEBUG [leihs.procurement.authorization:135] - (skip? (:handler-key request)) => nil

>> authorize >

>> authorize::handler > #object[leihs.core.locale$wrap$fn__44318 0x4cb26645 leihs.core.locale$wrap$fn__44318@4cb26645]

>> authorize::request > {:authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-24T14:02:17.415645Z", :id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :user_session_id #uuid "e25b9e9c-082c-43d7-8468-0c267e3212a7", :scope_system_admin_read false, :access-rights (), :user_id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}, :cookies {leihs-anti-csrf-token {:value 85b2de76-3ecd-40fd-a936-2d92f39bd32b}, leihs-user-session {:value 88ce2c7c-4075-46c2-80ca-82d865f9353e}}, :remote-addr 127.0.0.1, :start-time 489328929737166, :params {}, :settings {:email_sending_enabled false, :sessions_max_lifetime_secs 432000, :smtp_default_from_address your.lending.desk@example.com, :public_image_caching_enabled true, :sessions_force_secure false, :deliver_received_order_notifications false, :external_base_url nil, :sessions_force_uniqueness false, :email_signature Cheers,}, :tx-next #next.jdbc.default_options.DefaultOptions{:connectable 2023-11-24T14:02:19.328Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
#object[com.zaxxer.hikari.HikariDataSource 0x2e18c1e HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x4c858a34 next.jdbc.result_set$as_unqualified_lower_maps@4c858a34]}}, :query-params-raw {}, :route-params nil, :headers {origin http://localhost:3230, sec-fetch-site same-origin, host localhost:3230, user-agent Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/115.0, content-type application/json, cookie leihs-anti-csrf-token=85b2de76-3ecd-40fd-a936-2d92f39bd32b; leihs-user-session=88ce2c7c-4075-46c2-80ca-82d865f9353e, content-length 137, referer http://localhost:3230/procure/requests, connection keep-alive, x-csrf-token 85b2de76-3ecd-40fd-a936-2d92f39bd32b, accept application/json, accept-language de,en-US;q=0.7,en;q=0.3, sec-fetch-dest empty, accept-encoding gzip, deflate, br, sec-fetch-mode cors}, :async-channel #object[org.httpkit.server.AsyncChannel 0x6cfac20c /127.0.0.1:3230<->/127.0.0.1:63590], :server-port 3230, :params-raw {}, :tx {:datasource #object[com.zaxxer.hikari.HikariDataSource 0x153deae HikariDataSource (db-pool)]}, :content-length 137, :form-params {}, :websocket? false, :query-params {}, :content-type application/json, :form-params-raw {}, :character-encoding utf8, :uri /procure/graphql, :server-name localhost, :handler-key :graphql, :query-string nil, :body {:operationName getBuildings, :variables {}, :query query getBuildings {
  buildings {
    id
    name
    __typename
  }
}
}, :graphql-schema #CompiledSchema<>, :handler #object[leihs.procurement.graphql$handler 0x1a4a1f6f leihs.procurement.graphql$handler@1a4a1f6f], :multipart-params {}, :scheme :http, :request-method :post, :accept {:mime :json, :charset nil, :encoding nil, :language nil}}
2023-11-24T14:02:19.332Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]

>> authorize::handler-key >> :graphql
2023-11-24T14:02:19.334Z NX-41294 DEBUG [leihs.procurement.authorization:135] - (skip? (:handler-key request)) => nil
2023-11-24T14:02:19.335Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:19.335Z NX-41294 DEBUG [leihs.procurement.permissions.user:52] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_viewers) (sql/merge-where [:= :procurement_category_viewers.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_viewers.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:19.336Z NX-41294 DEBUG [leihs.procurement.permissions.user:72] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_requesters_organizations) (sql/where [:= :procurement_requesters_organizations.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:19.336Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:19.338Z NX-41294 DEBUG [leihs.procurement.permissions.user:52] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_viewers) (sql/merge-where [:= :procurement_category_viewers.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_viewers.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:19.338Z NX-41294 DEBUG [leihs.procurement.authorization:136] - (->> [user-perms/admin? user-perms/inspector? user-perms/viewer? user-perms/requester?] (map (fn* [p1__39355#] (p1__39355# (:tx request) (:authenticated-entity request)))) (some true?)) => true
2023-11-24T14:02:19.339Z NX-41294 DEBUG [leihs.procurement.permissions.user:72] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_requesters_organizations) (sql/where [:= :procurement_requesters_organizations.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]

>>>exec-query::variables 2023-11-24T14:02:19.340Z NX-41294 DEBUG [leihs.procurement.authorization:136] - (->> [user-perms/admin? user-perms/inspector? user-perms/viewer? user-perms/requester?] (map (fn* [p1__39355#] (p1__39355# (:tx request) (:authenticated-entity request)))) (some true?)) => true
{}

>>>exec-query::variables {}

>>>pure-handler {:data #ordered/map ([:buildings [#ordered/map ([:id abae04c5-d767-425e-acc2-7ce04df645d1] [:name general building] [:__typename :Building]) #ordered/map ([:id d1f8159a-bf85-4dde-8e9f-5472b1deb309] [:name 9594 Beer Extension] [:__typename :Building])]])}
2023-11-24T14:02:19.348Z NX-41294 DEBUG [leihs.procurement.graphql:64] - result => {:data #ordered/map ([:buildings [#ordered/map ([:id "abae04c5-d767-425e-acc2-7ce04df645d1"] [:name "general building"] [:__typename :Building]) #ordered/map ([:id "d1f8159a-bf85-4dde-8e9f-5472b1deb309"] [:name "9594 Beer Extension"] [:__typename :Building])]])}
2023-11-24T14:02:19.348Z NX-41294 DEBUG [leihs.procurement.authorization:150] - (authorize handler request) => {:body {:data #ordered/map ([:buildings [#ordered/map ([:id "abae04c5-d767-425e-acc2-7ce04df645d1"] [:name "general building"] [:__typename :Building]) #ordered/map ([:id "d1f8159a-bf85-4dde-8e9f-5472b1deb309"] [:name "9594 Beer Extension"] [:__typename :Building])]])}}
2023-11-24T14:02:19.356Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:19.357Z NX-41294 DEBUG [leihs.procurement.permissions.user:72] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_requesters_organizations) (sql/where [:= :procurement_requesters_organizations.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]

>>>pure-handler {:data #ordered/map ([:current_user #ordered/map ([:navbarProps {"csrfToken":{"value":"85b2de76-3ecd-40fd-a936-2d92f39bd32b","name":"csrf-token"},"config":{"appTitle":"leihs","appColor":"gray","me":{"user":{"id":"3b8e0ffa-8f85-46fd-8ea6-52eb2927015f","firstname":"Procurement","lastname":"Admin","login":null,"email":"jimmie@goyette.com"}},"subApps":{"borrow":false,"admin":false,"procure":false,"manage":[]},"locales":[{"name":"English (UK)","locale":"en-GB","active":true,"isDefault":true,"isSelected":true},{"name":"English (US)","locale":"en-US","active":true,"isDefault":false,"isSelected":false},{"name":"Deutsch","locale":"de-CH","active":true,"isDefault":false,"isSelected":false},{"name":"Züritüütsch","locale":"gsw-CH","active":true,"isDefault":false,"isSelected":false}]}}] [:user #ordered/map ([:id 3b8e0ffa-8f85-46fd-8ea6-52eb2927015f] [:firstname Procurement] [:lastname Admin] [:permissions #ordered/map ([:isAdmin true] [:isRequester false] [:isInspectorForCategories []] [:isViewerForCategories []] [:__typename :UserPermissions])] [:__typename :User])] [:__typename :CurrentUser])] [:settings #ordered/map ([:contact_url http://hartmann.io/rolf] [:__typename :ProcurementSettings])])}
2023-11-24T14:02:19.360Z NX-41294 DEBUG [leihs.procurement.graphql:64] - result => {:data #ordered/map ([:current_user #ordered/map ([:navbarProps "{\"csrfToken\":{\"value\":\"85b2de76-3ecd-40fd-a936-2d92f39bd32b\",\"name\":\"csrf-token\"},\"config\":{\"appTitle\":\"leihs\",\"appColor\":\"gray\",\"me\":{\"user\":{\"id\":\"3b8e0ffa-8f85-46fd-8ea6-52eb2927015f\",\"firstname\":\"Procurement\",\"lastname\":\"Admin\",\"login\":null,\"email\":\"jimmie@goyette.com\"}},\"subApps\":{\"borrow\":false,\"admin\":false,\"procure\":false,\"manage\":[]},\"locales\":[{\"name\":\"English (UK)\",\"locale\":\"en-GB\",\"active\":true,\"isDefault\":true,\"isSelected\":true},{\"name\":\"English (US)\",\"locale\":\"en-US\",\"active\":true,\"isDefault\":false,\"isSelected\":false},{\"name\":\"Deutsch\",\"locale\":\"de-CH\",\"active\":true,\"isDefault\":false,\"isSelected\":false},{\"name\":\"Züritüütsch\",\"locale\":\"gsw-CH\",\"active\":true,\"isDefault\":false,\"isSelected\":false}]}}"] [:user #ordered/map ([:id "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"] [:firstname "Procurement"] [:lastname "Admin"] [:permissions #ordered/map ([:isAdmin true] [:isRequester false] [:isInspectorForCategories []] [:isViewerForCategories []] [:__typename :UserPermissions])] [:__typename :User])] [:__typename :CurrentUser])] [:settings #ordered/map ([:contact_url "http://hartmann.io/rolf"] [:__typename :ProcurementSettings])])}
2023-11-24T14:02:19.362Z NX-41294 DEBUG [leihs.procurement.authorization:150] - (authorize handler request) => {:body {:data #ordered/map ([:current_user #ordered/map ([:navbarProps "{\"csrfToken\":{\"value\":\"85b2de76-3ecd-40fd-a936-2d92f39bd32b\",\"name\":\"csrf-token\"},\"config\":{\"appTitle\":\"leihs\",\"appColor\":\"gray\",\"me\":{\"user\":{\"id\":\"3b8e0ffa-8f85-46fd-8ea6-52eb2927015f\",\"firstname\":\"Procurement\",\"lastname\":\"Admin\",\"login\":null,\"email\":\"jimmie@goyette.com\"}},\"subApps\":{\"borrow\":false,\"admin\":false,\"procure\":false,\"manage\":[]},\"locales\":[{\"name\":\"English (UK)\",\"locale\":\"en-GB\",\"active\":true,\"isDefault\":true,\"isSelected\":true},{\"name\":\"English (US)\",\"locale\":\"en-US\",\"active\":true,\"isDefault\":false,\"isSelected\":false},{\"name\":\"Deutsch\",\"locale\":\"de-CH\",\"active\":true,\"isDefault\":false,\"isSelected\":false},{\"name\":\"Züritüütsch\",\"locale\":\"gsw-CH\",\"active\":true,\"isDefault\":false,\"isSelected\":false}]}}"] [:user #ordered/map ([:id "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"] [:firstname "Procurement"] [:lastname "Admin"] [:permissions #ordered/map ([:isAdmin true] [:isRequester false] [:isInspectorForCategories []] [:isViewerForCategories []] [:__typename :UserPermissions])] [:__typename :User])] [:__typename :CurrentUser])] [:settings #ordered/map ([:contact_url "http://hartmann.io/rolf"] [:__typename :ProcurementSettings])])}}
>>> authenticate::skip= nil  handler-key= :graphql
>>> authenticate::authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-24T14:02:17.415645Z", :id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :user_session_id #uuid "e25b9e9c-082c-43d7-8468-0c267e3212a7", :scope_system_admin_read false, :access-rights (), :user_id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}

>> authorize >

>> authorize::handler > #object[leihs.core.locale$wrap$fn__44318 0x4cb26645 leihs.core.locale$wrap$fn__44318@4cb26645]

>> authorize::request > {:authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-24T14:02:17.415645Z", :id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :user_session_id #uuid "e25b9e9c-082c-43d7-8468-0c267e3212a7", :scope_system_admin_read false, :access-rights (), :user_id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}, :cookies {leihs-anti-csrf-token {:value 85b2de76-3ecd-40fd-a936-2d92f39bd32b}, leihs-user-session {:value 88ce2c7c-4075-46c2-80ca-82d865f9353e}}, :remote-addr 127.0.0.1, :start-time 489329023499916, :params {}, :settings {:email_sending_enabled false, :sessions_max_lifetime_secs 432000, :smtp_default_from_address your.lending.desk@example.com, :public_image_caching_enabled true, :sessions_force_secure false, :deliver_received_order_notifications false, :external_base_url nil, :sessions_force_uniqueness false, :email_signature Cheers,}, :tx-next #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x2e18c1e HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x4c858a34 next.jdbc.result_set$as_unqualified_lower_maps@4c858a34]}}, :query-params-raw {}, :route-params nil, :headers {origin http://localhost:3230, sec-fetch-site same-origin, host localhost:3230, user-agent Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/115.0, content-type application/json, cookie leihs-anti-csrf-token=85b2de76-3ecd-40fd-a936-2d92f39bd32b; leihs-user-session=88ce2c7c-4075-46c2-80ca-82d865f9353e, content-length 5678, referer http://localhost:3230/procure/requests, connection keep-alive, x-csrf-token 85b2de76-3ecd-40fd-a936-2d92f39bd32b, accept application/json, accept-language de,en-US;q=0.7,en;q=0.3, sec-fetch-dest empty, accept-encoding gzip, deflate, br, sec-fetch-mode cors}, :async-channel #object[org.httpkit.server.AsyncChannel 0x5e222e85 /127.0.0.1:3230<->/127.0.0.1:63590], :server-port 3230, :params-raw {}, :tx {:datasource #object[com.zaxxer.hikari.HikariDataSource 0x153deae HikariDataSource (db-pool)]}, :content-length 5678, :form-params {}, :websocket? false, :query-params {}, :content-type application/json, :form-params-raw {}, :character-encoding utf8, :uri /procure/graphql, :server-name localhost, :handler-key :graphql, :query-string nil, :body {:operationName RequestForEdit, :variables {:id [df6d3979-4323-4d7d-ae8e-078e0b162dcc]}, :query query RequestForEdit($id: [ID!]!) {
  requests(id: $id) {
    ...RequestFieldsForEdit
    actionPermissions {
      delete
      edit
      moveBudgetPeriod
      moveCategory
      __typename
    }
    __typename
  }
  main_categories {
    id
    name
    categories {
      id
      name
      __typename
    }
    __typename
  }
  budget_periods(whereRequestsCanBeMovedTo: $id) {
    id
    name
    __typename
  }
  settings {
    inspection_comments
    __typename
  }
}

fragment RequestFieldsForEdit on Request {
  ...RequestFieldsForIndex
  template {
    value {
      id
      article_name
      __typename
    }
    __typename
  }
  user {
    read
    write
    required
    value {
      id
      firstname
      lastname
      __typename
    }
    __typename
  }
  article_name {
    ...RequestFieldString
    __typename
  }
  model {
    read
    write
    required
    value {
      id
      product
      version
      __typename
    }
    __typename
  }
  supplier_name {
    ...RequestFieldString
    __typename
  }
  supplier {
    read
    write
    required
    value {
      id
      name
      __typename
    }
    __typename
  }
  receiver {
    ...RequestFieldString
    __typename
  }
  price_cents {
    ...RequestFieldInt
    __typename
  }
  price_currency {
    ...RequestFieldString
    __typename
  }
  requested_quantity {
    ...RequestFieldInt
    __typename
  }
  approved_quantity {
    ...RequestFieldInt
    __typename
  }
  order_quantity {
    ...RequestFieldInt
    __typename
  }
  order_status {
    read
    write
    required
    value
    __typename
  }
  order_comment {
    ...RequestFieldString
    __typename
  }
  priority {
    read
    write
    required
    value
    __typename
  }
  inspector_priority {
    read
    write
    required
    value
    __typename
  }
  state
  article_number {
    ...RequestFieldString
    __typename
  }
  motivation {
    ...RequestFieldString
    __typename
  }
  replacement {
    ...RequestFieldBoolean
    __typename
  }
  room {
    read
    write
    required
    value {
      id
      name
      building {
        id
        name
        __typename
      }
      __typename
    }
    __typename
  }
  inspection_comment {
    ...RequestFieldString
    __typename
  }
  attachments {
    read
    write
    required
    value {
      id
      filename
      url
      __typename
    }
    __typename
  }
  accounting_type {
    ...RequestFieldString
    __typename
  }
  cost_center {
    read
    write
    required
    value
    __typename
  }
  procurement_account {
    read
    write
    value
    __typename
  }
  general_ledger_account {
    read
    value
    __typename
  }
  internal_order_number {
    ...RequestFieldString
    __typename
  }
  __typename
}

fragment RequestFieldsForIndex on Request {
  id
  short_id
  user {
    value {
      id
      firstname
      lastname
      __typename
    }
    __typename
  }
  category {
    read
    write
    required
    value {
      id
      name
      main_category {
        id
        name
        __typename
      }
      __typename
    }
    __typename
  }
  budget_period {
    read
    write
    required
    value {
      name
      id
      __typename
    }
    __typename
  }
  article_name {
    value
    __typename
  }
  model {
    value {
      id
      product
      version
      __typename
    }
    __typename
  }
  receiver {
    value
    __typename
  }
  organization {
    value {
      id
      name
      shortname
      department {
        id
        name
        __typename
      }
      __typename
    }
    __typename
  }
  price_cents {
    value
    __typename
  }
  price_currency {
    value
    __typename
  }
  requested_quantity {
    read
    value
    __typename
  }
  approved_quantity {
    read
    value
    __typename
  }
  order_quantity {
    read
    value
    __typename
  }
  replacement {
    value
    __typename
  }
  priority {
    value
    __typename
  }
  state
  article_number {
    value
    __typename
  }
  supplier {
    value {
      name
      __typename
    }
    __typename
  }
  supplier_name {
    value
    __typename
  }
  receiver {
    value
    __typename
  }
  room {
    value {
      id
      name
      building {
        id
        name
        __typename
      }
      __typename
    }
    __typename
  }
  motivation {
    value
    __typename
  }
  inspection_comment {
    value
    __typename
  }
  inspector_priority {
    value
    __typename
  }
  accounting_type {
    value
    __typename
  }
  cost_center {
    value
    __typename
  }
  general_ledger_account {
    value
    __typename
  }
  procurement_account {
    value
    __typename
  }
  internal_order_number {
    value
    __typename
  }
  order_status {
    value
    __typename
  }
  order_comment {
    value
    __typename
  }
  __typename
}

fragment RequestFieldString on RequestFieldString {
  value
  read
  write
  required
  __typename
}

fragment RequestFieldInt on RequestFieldInt {
  value
  read
  write
  required
  __typename
}

fragment RequestFieldBoolean on RequestFieldBoolean {
  value
  read
  write
  required
  __typename
}
}, :graphql-schema #CompiledSchema<>, :handler #object[leihs.procurement.graphql$handler 0x1a4a1f6f leihs.procurement.graphql$handler@1a4a1f6f], :multipart-params {}, :scheme :http, :request-method :post, :accept {:mime :json, :charset nil, :encoding nil, :language nil}}

>> authorize::handler-key >> :graphql
2023-11-24T14:02:19.409Z NX-41294 DEBUG [leihs.procurement.authorization:135] - (skip? (:handler-key request)) => nil
2023-11-24T14:02:19.410Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:19.412Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:19.412Z NX-41294 DEBUG [leihs.procurement.permissions.user:52] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_viewers) (sql/merge-where [:= :procurement_category_viewers.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_viewers.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:19.414Z NX-41294 DEBUG [leihs.procurement.permissions.user:72] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_requesters_organizations) (sql/where [:= :procurement_requesters_organizations.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:19.415Z NX-41294 DEBUG [leihs.procurement.authorization:136] - (->> [user-perms/admin? user-perms/inspector? user-perms/viewer? user-perms/requester?] (map (fn* [p1__39355#] (p1__39355# (:tx request) (:authenticated-entity request)))) (some true?)) => true

>>>exec-query::variables {:id [df6d3979-4323-4d7d-ae8e-078e0b162dcc]}
2023-11-24T14:02:19.427Z NX-41294 DEBUG [leihs.procurement.permissions.user:52] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_viewers) (sql/merge-where [:= :procurement_category_viewers.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_viewers.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:19.428Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:19.429Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:19.430Z NX-41294 DEBUG [leihs.procurement.permissions.user:85] - (->> [viewer? inspector? admin?] (map (fn* [p1__39296#] (p1__39296# tx auth-entity))) (some true?)) => true
>>a  {:NEW [:= :procurement_requests.approved_quantity nil], :APPROVED [:>= :procurement_requests.approved_quantity :procurement_requests.requested_quantity], :PARTIALLY_APPROVED [:and [:< :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:> :procurement_requests.approved_quantity 0]], :DENIED [:= :procurement_requests.approved_quantity 0]}
>>b  #sql/call [:case [:= :procurement_requests.approved_quantity nil] NEW [:>= :procurement_requests.approved_quantity :procurement_requests.requested_quantity] APPROVED [:and [:< :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:> :procurement_requests.approved_quantity 0]] PARTIALLY_APPROVED [:= :procurement_requests.approved_quantity 0] DENIED]
2023-11-24T14:02:19.430Z NX-41294 DEBUG [leihs.procurement.resources.request:157] - (-> requests-base-query (sql/merge-select [(state-sql advanced-user?) :state]) (sql/merge-join :procurement_budget_periods [:= :procurement_budget_periods.id :procurement_requests.budget_period_id])) => {:select (#sql/raw "DISTINCT ON (procurement_requests.id, concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))) procurement_requests.*" [#sql/call [:case [:= :procurement_requests.approved_quantity nil] "NEW" [:>= :procurement_requests.approved_quantity :procurement_requests.requested_quantity] "APPROVED" [:and [:< :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:> :procurement_requests.approved_quantity 0]] "PARTIALLY_APPROVED" [:= :procurement_requests.approved_quantity 0] "DENIED"] :state]), :from (:procurement_requests), :left-join (:models [:= :models.id :procurement_requests.model_id]), :order-by (#sql/raw "concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))"), :join (:procurement_budget_periods [:= :procurement_budget_periods.id :procurement_requests.budget_period_id])}
2023-11-24T14:02:19.433Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:19.436Z NX-41294 DEBUG [leihs.procurement.resources.requests:108] - query => ["SELECT DISTINCT ON (procurement_requests.id, concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))) procurement_requests.*, CASE WHEN procurement_requests.approved_quantity IS NULL THEN ? WHEN procurement_requests.approved_quantity >= procurement_requests.requested_quantity THEN ? WHEN (procurement_requests.approved_quantity < procurement_requests.requested_quantity AND procurement_requests.approved_quantity > ?) THEN ? WHEN procurement_requests.approved_quantity = ? THEN ? END AS state, row_to_json(procurement_budget_periods_2) AS budget_period, row_to_json(procurement_categories)::jsonb || jsonb_build_object('main_category', row_to_json(procurement_main_categories)) AS category, row_to_json(models) AS model, row_to_json(procurement_organizations)::jsonb || jsonb_build_object('department', row_to_json(procurement_departments)) AS organization, row_to_json(procurement_templates) AS template, row_to_json(rooms)::jsonb || jsonb_build_object('building', row_to_json(buildings)) AS room, row_to_json(suppliers) AS supplier, row_to_json(users) AS user FROM procurement_requests INNER JOIN procurement_budget_periods ON procurement_budget_periods.id = procurement_requests.budget_period_id INNER JOIN (SELECT *, current_date > end_date AS is_past FROM procurement_budget_periods) procurement_budget_periods_2 ON procurement_budget_periods_2.id = procurement_requests.budget_period_id INNER JOIN procurement_categories ON procurement_categories.id = procurement_requests.category_id INNER JOIN procurement_main_categories ON procurement_main_categories.id = procurement_categories.main_category_id INNER JOIN procurement_organizations ON procurement_organizations.id = procurement_requests.organization_id INNER JOIN procurement_organizations procurement_departments ON procurement_departments.id = procurement_organizations.parent_id INNER JOIN rooms ON rooms.id = procurement_requests.room_id INNER JOIN buildings ON buildings.id = rooms.building_id LEFT JOIN models ON models.id = procurement_requests.model_id LEFT JOIN procurement_templates ON procurement_templates.id = procurement_requests.template_id LEFT JOIN suppliers ON suppliers.id = procurement_requests.supplier_id LEFT JOIN users ON users.id = procurement_requests.user_id WHERE (procurement_requests.id in (?)) ORDER BY concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))" "NEW" "APPROVED" 0 "PARTIALLY_APPROVED" 0 "DENIED" "df6d3979-4323-4d7d-ae8e-078e0b162dcc"]
>>broken-query [SELECT DISTINCT ON (procurement_requests.id, concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))) procurement_requests.*, CASE WHEN procurement_requests.approved_quantity IS NULL THEN ? WHEN procurement_requests.approved_quantity >= procurement_requests.requested_quantity THEN ? WHEN (procurement_requests.approved_quantity < procurement_requests.requested_quantity AND procurement_requests.approved_quantity > ?) THEN ? WHEN procurement_requests.approved_quantity = ? THEN ? END AS state, row_to_json(procurement_budget_periods_2) AS budget_period, row_to_json(procurement_categories)::jsonb || jsonb_build_object('main_category', row_to_json(procurement_main_categories)) AS category, row_to_json(models) AS model, row_to_json(procurement_organizations)::jsonb || jsonb_build_object('department', row_to_json(procurement_departments)) AS organization, row_to_json(procurement_templates) AS template, row_to_json(rooms)::jsonb || jsonb_build_object('building', row_to_json(buildings)) AS room, row_to_json(suppliers) AS supplier, row_to_json(users) AS user FROM procurement_requests INNER JOIN procurement_budget_periods ON procurement_budget_periods.id = procurement_requests.budget_period_id INNER JOIN (SELECT *, current_date > end_date AS is_past FROM procurement_budget_periods) procurement_budget_periods_2 ON procurement_budget_periods_2.id = procurement_requests.budget_period_id INNER JOIN procurement_categories ON procurement_categories.id = procurement_requests.category_id INNER JOIN procurement_main_categories ON procurement_main_categories.id = procurement_categories.main_category_id INNER JOIN procurement_organizations ON procurement_organizations.id = procurement_requests.organization_id INNER JOIN procurement_organizations procurement_departments ON procurement_departments.id = procurement_organizations.parent_id INNER JOIN rooms ON rooms.id = procurement_requests.room_id INNER JOIN buildings ON buildings.id = rooms.building_id LEFT JOIN models ON models.id = procurement_requests.model_id LEFT JOIN procurement_templates ON procurement_templates.id = procurement_requests.template_id LEFT JOIN suppliers ON suppliers.id = procurement_requests.supplier_id LEFT JOIN users ON users.id = procurement_requests.user_id WHERE (procurement_requests.id in (?)) ORDER BY concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, ''))) NEW APPROVED 0 PARTIALLY_APPROVED 0 DENIED df6d3979-4323-4d7d-ae8e-078e0b162dcc]
2023-11-24T14:02:19.442Z NX-41294 DEBUG [leihs.procurement.permissions.user:52] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_viewers) (sql/merge-where [:= :procurement_category_viewers.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_viewers.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:19.443Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:19.444Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:19.445Z NX-41294 DEBUG [leihs.procurement.permissions.user:85] - (->> [viewer? inspector? admin?] (map (fn* [p1__39296#] (p1__39296# tx auth-entity))) (some true?)) => true
2023-11-24T14:02:19.456Z NX-41294 DEBUG [leihs.procurement.permissions.user:72] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_requesters_organizations) (sql/where [:= :procurement_requesters_organizations.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:19.457Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:19.458Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:19.460Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE (procurement_category_inspectors.user_id = ? AND procurement_category_inspectors.category_id = ?))) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f" "535b5ca7-c430-4a63-b5bd-09337b01bb7a"]
2023-11-24T14:02:19.461Z NX-41294 DEBUG [leihs.procurement.permissions.user:52] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_viewers) (sql/merge-where [:= :procurement_category_viewers.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_viewers.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_viewers WHERE (procurement_category_viewers.user_id = ? AND procurement_category_viewers.category_id = ?))) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f" "535b5ca7-c430-4a63-b5bd-09337b01bb7a"]

>>>pure-handler {:data #ordered/map ([:requests [#ordered/map ([:id df6d3979-4323-4d7d-ae8e-078e0b162dcc] [:short_id Budget-Period-Past.001] [:user #ordered/map ([:value #ordered/map ([:id 1862f73f-33ba-415e-b3c2-5feb2074752d] [:firstname Lynsey] [:lastname Kertzmann] [:__typename :User])] [:__typename :RequestFieldUser] [:read true] [:write false] [:required true])] [:category #ordered/map ([:read true] [:write false] [:required true] [:value #ordered/map ([:id 535b5ca7-c430-4a63-b5bd-09337b01bb7a] [:name Category C1] [:main_category #ordered/map ([:id 46d19a93-31da-4690-a45f-b11b525ca6ff] [:name Main Category MC1] [:__typename :MainCategory])] [:__typename :Category])] [:__typename :RequestFieldCategory])] [:budget_period #ordered/map ([:read true] [:write false] [:required true] [:value #ordered/map ([:name Budget-Period-Past] [:id 48d8c363-6af4-4a49-91ad-1b701743155f] [:__typename :BudgetPeriod])] [:__typename :RequestFieldBudgetPeriod])] [:article_name #ordered/map ([:value Mediocre Aluminum Shoes] [:__typename :RequestFieldString] [:read true] [:write false] [:required true])] [:model #ordered/map ([:value nil] [:__typename :RequestFieldModel] [:read true] [:write false] [:required false])] [:receiver #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:organization #ordered/map ([:value #ordered/map ([:id 7a59c4fa-a0ed-4abf-aeae-e9c3b3323e95] [:name Beauty & Kids] [:shortname nil] [:department #ordered/map ([:id e20c5fdb-8997-43a6-bebb-133d1466c239] [:name Home, Jewelry & Computers] [:__typename :Organization])] [:__typename :Organization])] [:__typename :RequestFieldOrganization])] [:price_cents #ordered/map ([:value 0] [:__typename :RequestFieldInt] [:read true] [:write false] [:required true])] [:price_currency #ordered/map ([:value CHF] [:__typename :RequestFieldString] [:read true] [:write false] [:required true])] [:requested_quantity #ordered/map ([:read true] [:value 1] [:__typename :RequestFieldInt] [:write false] [:required true])] [:approved_quantity #ordered/map ([:read true] [:value nil] [:__typename :RequestFieldInt] [:write false] [:required false])] [:order_quantity #ordered/map ([:read true] [:value nil] [:__typename :RequestFieldInt] [:write false] [:required false])] [:replacement #ordered/map ([:value true] [:__typename :RequestFieldBoolean] [:read true] [:write false] [:required true])] [:priority #ordered/map ([:value :NORMAL] [:__typename :RequestFieldPriority] [:read true] [:write false] [:required true])] [:state :NEW] [:article_number #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:supplier #ordered/map ([:value nil] [:__typename :RequestFieldSupplier] [:read true] [:write false] [:required false])] [:supplier_name #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:room #ordered/map ([:value #ordered/map ([:id 707541da-817b-402d-86a4-dbd6e72bee46] [:name reception room] [:building #ordered/map ([:id d1f8159a-bf85-4dde-8e9f-5472b1deb309] [:name 9594 Beer Extension] [:__typename :Building])] [:__typename :Room])] [:__typename :RequestFieldRoom] [:read true] [:write false] [:required true])] [:motivation #ordered/map ([:value Corporis commodi provident nam.] [:__typename :RequestFieldString] [:read true] [:write false] [:required true])] [:inspection_comment #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:inspector_priority #ordered/map ([:value :MEDIUM] [:__typename :RequestFieldInspectorPriority] [:read true] [:write false] [:required true])] [:accounting_type #ordered/map ([:value aquisition] [:__typename :RequestFieldString] [:read true] [:write false] [:required true])] [:cost_center #ordered/map ([:value nil] [:__typename :RequestFieldCostCenter] [:read true] [:write false] [:required false])] [:general_ledger_account #ordered/map ([:value nil] [:__typename :RequestFieldGeneralLedgerAccount] [:read true])] [:procurement_account #ordered/map ([:value nil] [:__typename :RequestFieldProcurementAccount] [:read true] [:write false])] [:internal_order_number #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:order_status #ordered/map ([:value :NOT_PROCESSED] [:__typename :RequestFieldOrderStatus] [:read true] [:write true] [:required true])] [:order_comment #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write true] [:required false])] [:__typename :Request] [:template #ordered/map ([:value nil] [:__typename :RequestFieldTemplate])] [:attachments #ordered/map ([:read true] [:write false] [:required false] [:value []] [:__typename :RequestFieldAttachments])] [:actionPermissions #ordered/map ([:delete false] [:edit true] [:moveBudgetPeriod false] [:moveCategory false] [:__typename :RequestActionPermissions])])]] [:main_categories [#ordered/map ([:id 46d19a93-31da-4690-a45f-b11b525ca6ff] [:name Main Category MC1] [:categories [#ordered/map ([:id 535b5ca7-c430-4a63-b5bd-09337b01bb7a] [:name Category C1] [:__typename :Category])]] [:__typename :MainCategory])]] [:budget_periods []] [:settings #ordered/map ([:inspection_comments [Eum architecto minus magnam.]] [:__typename :ProcurementSettings])])}
2023-11-24T14:02:19.486Z NX-41294 DEBUG [leihs.procurement.graphql:64] - result => {:data #ordered/map ([:requests [#ordered/map ([:id "df6d3979-4323-4d7d-ae8e-078e0b162dcc"] [:short_id "Budget-Period-Past.001"] [:user #ordered/map ([:value #ordered/map ([:id "1862f73f-33ba-415e-b3c2-5feb2074752d"] [:firstname "Lynsey"] [:lastname "Kertzmann"] [:__typename :User])] [:__typename :RequestFieldUser] [:read true] [:write false] [:required true])] [:category #ordered/map ([:read true] [:write false] [:required true] [:value #ordered/map ([:id "535b5ca7-c430-4a63-b5bd-09337b01bb7a"] [:name "Category C1"] [:main_category #ordered/map ([:id "46d19a93-31da-4690-a45f-b11b525ca6ff"] [:name "Main Category MC1"] [:__typename :MainCategory])] [:__typename :Category])] [:__typename :RequestFieldCategory])] [:budget_period #ordered/map ([:read true] [:write false] [:required true] [:value #ordered/map ([:name "Budget-Period-Past"] [:id "48d8c363-6af4-4a49-91ad-1b701743155f"] [:__typename :BudgetPeriod])] [:__typename :RequestFieldBudgetPeriod])] [:article_name #ordered/map ([:value "Mediocre Aluminum Shoes"] [:__typename :RequestFieldString] [:read true] [:write false] [:required true])] [:model #ordered/map ([:value nil] [:__typename :RequestFieldModel] [:read true] [:write false] [:required false])] [:receiver #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:organization #ordered/map ([:value #ordered/map ([:id "7a59c4fa-a0ed-4abf-aeae-e9c3b3323e95"] [:name "Beauty & Kids"] [:shortname nil] [:department #ordered/map ([:id "e20c5fdb-8997-43a6-bebb-133d1466c239"] [:name "Home, Jewelry & Computers"] [:__typename :Organization])] [:__typename :Organization])] [:__typename :RequestFieldOrganization])] [:price_cents #ordered/map ([:value 0] [:__typename :RequestFieldInt] [:read true] [:write false] [:required true])] [:price_currency #ordered/map ([:value "CHF"] [:__typename :RequestFieldString] [:read true] [:write false] [:required true])] [:requested_quantity #ordered/map ([:read true] [:value 1] [:__typename :RequestFieldInt] [:write false] [:required true])] [:approved_quantity #ordered/map ([:read true] [:value nil] [:__typename :RequestFieldInt] [:write false] [:required false])] [:order_quantity #ordered/map ([:read true] [:value nil] [:__typename :RequestFieldInt] [:write false] [:required false])] [:replacement #ordered/map ([:value true] [:__typename :RequestFieldBoolean] [:read true] [:write false] [:required true])] [:priority #ordered/map ([:value :NORMAL] [:__typename :RequestFieldPriority] [:read true] [:write false] [:required true])] [:state :NEW] [:article_number #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:supplier #ordered/map ([:value nil] [:__typename :RequestFieldSupplier] [:read true] [:write false] [:required false])] [:supplier_name #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:room #ordered/map ([:value #ordered/map ([:id "707541da-817b-402d-86a4-dbd6e72bee46"] [:name "reception room"] [:building #ordered/map ([:id "d1f8159a-bf85-4dde-8e9f-5472b1deb309"] [:name "9594 Beer Extension"] [:__typename :Building])] [:__typename :Room])] [:__typename :RequestFieldRoom] [:read true] [:write false] [:required true])] [:motivation #ordered/map ([:value "Corporis commodi provident nam."] [:__typename :RequestFieldString] [:read true] [:write false] [:required true])] [:inspection_comment #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:inspector_priority #ordered/map ([:value :MEDIUM] [:__typename :RequestFieldInspectorPriority] [:read true] [:write false] [:required true])] [:accounting_type #ordered/map ([:value "aquisition"] [:__typename :RequestFieldString] [:read true] [:write false] [:required true])] [:cost_center #ordered/map ([:value nil] [:__typename :RequestFieldCostCenter] [:read true] [:write false] [:required false])] [:general_ledger_account #ordered/map ([:value nil] [:__typename :RequestFieldGeneralLedgerAccount] [:read true])] [:procurement_account #ordered/map ([:value nil] [:__typename :RequestFieldProcurementAccount] [:read true] [:write false])] [:internal_order_number #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:order_status #ordered/map ([:value :NOT_PROCESSED] [:__typename :RequestFieldOrderStatus] [:read true] [:write true] [:required true])] [:order_comment #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write true] [:required false])] [:__typename :Request] [:template #ordered/map ([:value nil] [:__typename :RequestFieldTemplate])] [:attachments #ordered/map ([:read true] [:write false] [:required false] [:value []] [:__typename :RequestFieldAttachments])] [:actionPermissions #ordered/map ([:delete false] [:edit true] [:moveBudgetPeriod false] [:moveCategory false] [:__typename :RequestActionPermissions])])]] [:main_categories [#ordered/map ([:id "46d19a93-31da-4690-a45f-b11b525ca6ff"] [:name "Main Category MC1"] [:categories [#ordered/map ([:id "535b5ca7-c430-4a63-b5bd-09337b01bb7a"] [:name "Category C1"] [:__typename :Category])]] [:__typename :MainCategory])]] [:budget_periods []] [:settings #ordered/map ([:inspection_comments ["Eum architecto minus magnam."]] [:__typename :ProcurementSettings])])}
2023-11-24T14:02:19.497Z NX-41294 DEBUG [leihs.procurement.authorization:150] - (authorize handler request) => {:body {:data #ordered/map ([:requests [#ordered/map ([:id "df6d3979-4323-4d7d-ae8e-078e0b162dcc"] [:short_id "Budget-Period-Past.001"] [:user #ordered/map ([:value #ordered/map ([:id "1862f73f-33ba-415e-b3c2-5feb2074752d"] [:firstname "Lynsey"] [:lastname "Kertzmann"] [:__typename :User])] [:__typename :RequestFieldUser] [:read true] [:write false] [:required true])] [:category #ordered/map ([:read true] [:write false] [:required true] [:value #ordered/map ([:id "535b5ca7-c430-4a63-b5bd-09337b01bb7a"] [:name "Category C1"] [:main_category #ordered/map ([:id "46d19a93-31da-4690-a45f-b11b525ca6ff"] [:name "Main Category MC1"] [:__typename :MainCategory])] [:__typename :Category])] [:__typename :RequestFieldCategory])] [:budget_period #ordered/map ([:read true] [:write false] [:required true] [:value #ordered/map ([:name "Budget-Period-Past"] [:id "48d8c363-6af4-4a49-91ad-1b701743155f"] [:__typename :BudgetPeriod])] [:__typename :RequestFieldBudgetPeriod])] [:article_name #ordered/map ([:value "Mediocre Aluminum Shoes"] [:__typename :RequestFieldString] [:read true] [:write false] [:required true])] [:model #ordered/map ([:value nil] [:__typename :RequestFieldModel] [:read true] [:write false] [:required false])] [:receiver #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:organization #ordered/map ([:value #ordered/map ([:id "7a59c4fa-a0ed-4abf-aeae-e9c3b3323e95"] [:name "Beauty & Kids"] [:shortname nil] [:department #ordered/map ([:id "e20c5fdb-8997-43a6-bebb-133d1466c239"] [:name "Home, Jewelry & Computers"] [:__typename :Organization])] [:__typename :Organization])] [:__typename :RequestFieldOrganization])] [:price_cents #ordered/map ([:value 0] [:__typename :RequestFieldInt] [:read true] [:write false] [:required true])] [:price_currency #ordered/map ([:value "CHF"] [:__typename :RequestFieldString] [:read true] [:write false] [:required true])] [:requested_quantity #ordered/map ([:read true] [:value 1] [:__typename :RequestFieldInt] [:write false] [:required true])] [:approved_quantity #ordered/map ([:read true] [:value nil] [:__typename :RequestFieldInt] [:write false] [:required false])] [:order_quantity #ordered/map ([:read true] [:value nil] [:__typename :RequestFieldInt] [:write false] [:required false])] [:replacement #ordered/map ([:value true] [:__typename :RequestFieldBoolean] [:read true] [:write false] [:required true])] [:priority #ordered/map ([:value :NORMAL] [:__typename :RequestFieldPriority] [:read true] [:write false] [:required true])] [:state :NEW] [:article_number #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:supplier #ordered/map ([:value nil] [:__typename :RequestFieldSupplier] [:read true] [:write false] [:required false])] [:supplier_name #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:room #ordered/map ([:value #ordered/map ([:id "707541da-817b-402d-86a4-dbd6e72bee46"] [:name "reception room"] [:building #ordered/map ([:id "d1f8159a-bf85-4dde-8e9f-5472b1deb309"] [:name "9594 Beer Extension"] [:__typename :Building])] [:__typename :Room])] [:__typename :RequestFieldRoom] [:read true] [:write false] [:required true])] [:motivation #ordered/map ([:value "Corporis commodi provident nam."] [:__typename :RequestFieldString] [:read true] [:write false] [:required true])] [:inspection_comment #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:inspector_priority #ordered/map ([:value :MEDIUM] [:__typename :RequestFieldInspectorPriority] [:read true] [:write false] [:required true])] [:accounting_type #ordered/map ([:value "aquisition"] [:__typename :RequestFieldString] [:read true] [:write false] [:required true])] [:cost_center #ordered/map ([:value nil] [:__typename :RequestFieldCostCenter] [:read true] [:write false] [:required false])] [:general_ledger_account #ordered/map ([:value nil] [:__typename :RequestFieldGeneralLedgerAccount] [:read true])] [:procurement_account #ordered/map ([:value nil] [:__typename :RequestFieldProcurementAccount] [:read true] [:write false])] [:internal_order_number #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:order_status #ordered/map ([:value :NOT_PROCESSED] [:__typename :RequestFieldOrderStatus] [:read true] [:write true] [:required true])] [:order_comment #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write true] [:required false])] [:__typename :Request] [:template #ordered/map ([:value nil] [:__typename :RequestFieldTemplate])] [:attachments #ordered/map ([:read true] [:write false] [:required false] [:value []] [:__typename :RequestFieldAttachments])] [:actionPermissions #ordered/map ([:delete false] [:edit true] [:moveBudgetPeriod false] [:moveCategory false] [:__typename :RequestActionPermissions])])]] [:main_categories [#ordered/map ([:id "46d19a93-31da-4690-a45f-b11b525ca6ff"] [:name "Main Category MC1"] [:categories [#ordered/map ([:id "535b5ca7-c430-4a63-b5bd-09337b01bb7a"] [:name "Category C1"] [:__typename :Category])]] [:__typename :MainCategory])]] [:budget_periods []] [:settings #ordered/map ([:inspection_comments ["Eum architecto minus magnam."]] [:__typename :ProcurementSettings])])}}
>>> authenticate::skip= nil  handler-key= :graphql
>>> authenticate::authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-24T14:02:17.415645Z", :id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :user_session_id #uuid "e25b9e9c-082c-43d7-8468-0c267e3212a7", :scope_system_admin_read false, :access-rights (), :user_id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}

>> authorize >

>> authorize::handler > #object[leihs.core.locale$wrap$fn__44318 0x4cb26645 leihs.core.locale$wrap$fn__44318@4cb26645]

>> authorize::request > {:authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-24T14:02:17.415645Z", :id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :user_session_id #uuid "e25b9e9c-082c-43d7-8468-0c267e3212a7", :scope_system_admin_read false, :access-rights (), :user_id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}, :cookies {leihs-anti-csrf-token {:value 85b2de76-3ecd-40fd-a936-2d92f39bd32b}, leihs-user-session {:value 88ce2c7c-4075-46c2-80ca-82d865f9353e}}, :remote-addr 127.0.0.1, :start-time 489329630321916, :params {}, :settings {:email_sending_enabled false, :sessions_max_lifetime_secs 432000, :smtp_default_from_address your.lending.desk@example.com, :public_image_caching_enabled true, :sessions_force_secure false, :deliver_received_order_notifications false, :external_base_url nil, :sessions_force_uniqueness false, :email_signature Cheers,}, :tx-next #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.pool.HikariProxyConnection 0x56d2d4 HikariProxyConnection@5690068 wrapping org.postgresql.jdbc.PgConnection@31a1367e], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x4c858a34 next.jdbc.result_set$as_unqualified_lower_maps@4c858a34]}}, :query-params-raw {}, :route-params nil, :headers {origin http://localhost:3230, sec-fetch-site same-origin, host localhost:3230, user-agent Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/115.0, content-type application/json, cookie leihs-anti-csrf-token=85b2de76-3ecd-40fd-a936-2d92f39bd32b; leihs-user-session=88ce2c7c-4075-46c2-80ca-82d865f9353e, content-length 5402, referer http://localhost:3230/procure/requests, connection keep-alive, x-csrf-token 85b2de76-3ecd-40fd-a936-2d92f39bd32b, accept application/json, accept-language de,en-US;q=0.7,en;q=0.3, sec-fetch-dest empty, accept-encoding gzip, deflate, br, sec-fetch-mode cors}, :async-channel #object[org.httpkit.server.AsyncChannel 0x63621040 /127.0.0.1:3230<->/127.0.0.1:63590], :server-port 3230, :params-raw {}, :tx {:datasource #object[com.zaxxer.hikari.HikariDataSource 0x153deae HikariDataSource (db-pool)], :connection #object[com.zaxxer.hikari.pool.HikariProxyConnection 0x5f612410 HikariProxyConnection@1600201744 wrapping org.postgresql.jdbc.PgConnection@5197d5af], :level 1, :rollback #object[clojure.lang.Atom 0x69179d5a {:status :ready, :val false}]}, :content-length 5402, :form-params {}, :websocket? false, :query-params {}, :content-type application/json, :form-params-raw {}, :character-encoding utf8, :uri /procure/graphql, :server-name localhost, :handler-key :graphql, :query-string nil, :body {:operationName updateRequest, :variables {:requestData {:id df6d3979-4323-4d7d-ae8e-078e0b162dcc, :order_status PROCURED, :order_comment Wurde bestellt und geliefert!}}, :query mutation updateRequest($requestData: RequestInput) {
  request(input_data: $requestData) {
    ...RequestFieldsForEdit
    __typename
  }
}

fragment RequestFieldsForEdit on Request {
  ...RequestFieldsForIndex
  template {
    value {
      id
      article_name
      __typename
    }
    __typename
  }
  user {
    read
    write
    required
    value {
      id
      firstname
      lastname
      __typename
    }
    __typename
  }
  article_name {
    ...RequestFieldString
    __typename
  }
  model {
    read
    write
    required
    value {
      id
      product
      version
      __typename
    }
    __typename
  }
  supplier_name {
    ...RequestFieldString
    __typename
  }
  supplier {
    read
    write
    required
    value {
      id
      name
      __typename
    }
    __typename
  }
  receiver {
    ...RequestFieldString
    __typename
  }
  price_cents {
    ...RequestFieldInt
    __typename
  }
  price_currency {
    ...RequestFieldString
    __typename
  }
  requested_quantity {
    ...RequestFieldInt
    __typename
  }
  approved_quantity {
    ...RequestFieldInt
    __typename
  }
  order_quantity {
    ...RequestFieldInt
    __typename
  }
  order_status {
    read
    write
    required
    value
    __typename
  }
  order_comment {
    ...RequestFieldString
    __typename
  }
  priority {
    read
    write
    required
    value
    __typename
  }
  inspector_priority {
    read
    write
    required
    value
    __typename
  }
  state
  article_number {
    ...RequestFieldString
    __typename
  }
  motivation {
    ...RequestFieldString
    __typename
  }
  replacement {
    ...RequestFieldBoolean
    __typename
  }
  room {
    read
    write
    required
    value {
      id
      name
      building {
        id
        name
        __typename
      }
      __typename
    }
    __typename
  }
  inspection_comment {
    ...RequestFieldString
    __typename
  }
  attachments {
    read
    write
    required
    value {
      id
      filename
      url
      __typename
    }
    __typename
  }
  accounting_type {
    ...RequestFieldString
    __typename
  }
  cost_center {
    read
    write
    required
    value
    __typename
  }
  procurement_account {
    read
    write
    value
    __typename
  }
  general_ledger_account {
    read
    value
    __typename
  }
  internal_order_number {
    ...RequestFieldString
    __typename
  }
  __typename
}

fragment RequestFieldsForIndex on Request {
  id
  short_id
  user {
    value {
      id
      firstname
      lastname
      __typename
    }
    __typename
  }
  category {
    read
    write
    required
    value {
      id
      name
      main_category {
        id
        name
        __typename
      }
      __typename
    }
    __typename
  }
  budget_period {
    read
    write
    required
    value {
      name
      id
      __typename
    }
    __typename
  }
  article_name {
    value
    __typename
  }
  model {
    value {
      id
      product
      version
      __typename
    }
    __typename
  }
  receiver {
    value
    __typename
  }
  organization {
    value {
      id
      name
      shortname
      department {
        id
        name
        __typename
      }
      __typename
    }
    __typename
  }
  price_cents {
    value
    __typename
  }
  price_currency {
    value
    __typename
  }
  requested_quantity {
    read
    value
    __typename
  }
  approved_quantity {
    read
    value
    __typename
  }
  order_quantity {
    read
    value
    __typename
  }
  replacement {
    value
    __typename
  }
  priority {
    value
    __typename
  }
  state
  article_number {
    value
    __typename
  }
  supplier {
    value {
      name
      __typename
    }
    __typename
  }
  supplier_name {
    value
    __typename
  }
  receiver {
    value
    __typename
  }
  room {
    value {
      id
      name
      building {
        id
        name
        __typename
      }
      __typename
    }
    __typename
  }
  motivation {
    value
    __typename
  }
  inspection_comment {
    value
    __typename
  }
  inspector_priority {
    value
    __typename
  }
  accounting_type {
    value
    __typename
  }
  cost_center {
    value
    __typename
  }
  general_ledger_account {
    value
    __typename
  }
  procurement_account {
    value
    __typename
  }
  internal_order_number {
    value
    __typename
  }
  order_status {
    value
    __typename
  }
  order_comment {
    value
    __typename
  }
  __typename
}

fragment RequestFieldString on RequestFieldString {
  value
  read
  write
  required
  __typename
}

fragment RequestFieldInt on RequestFieldInt {
  value
  read
  write
  required
  __typename
}

fragment RequestFieldBoolean on RequestFieldBoolean {
  value
  read
  write
  required
  __typename
}
}, :graphql-schema #CompiledSchema<>, :handler #object[leihs.procurement.graphql$handler 0x1a4a1f6f leihs.procurement.graphql$handler@1a4a1f6f], :multipart-params {}, :scheme :http, :request-method :post, :accept {:mime :json, :charset nil, :encoding nil, :language nil}}

>> authorize::handler-key >> :graphql
2023-11-24T14:02:20.015Z NX-41294 DEBUG [leihs.procurement.authorization:135] - (skip? (:handler-key request)) => nil
2023-11-24T14:02:20.015Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:20.016Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:20.017Z NX-41294 DEBUG [leihs.procurement.permissions.user:52] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_viewers) (sql/merge-where [:= :procurement_category_viewers.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_viewers.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:20.018Z NX-41294 DEBUG [leihs.procurement.permissions.user:72] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_requesters_organizations) (sql/where [:= :procurement_requesters_organizations.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:20.019Z NX-41294 DEBUG [leihs.procurement.authorization:136] - (->> [user-perms/admin? user-perms/inspector? user-perms/viewer? user-perms/requester?] (map (fn* [p1__39355#] (p1__39355# (:tx request) (:authenticated-entity request)))) (some true?)) => true

>>>exec-query::variables {:requestData {:id df6d3979-4323-4d7d-ae8e-078e0b162dcc, :order_status PROCURED, :order_comment Wurde bestellt und geliefert!}}
2023-11-24T14:02:20.033Z NX-41294 DEBUG [leihs.procurement.permissions.user:52] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_viewers) (sql/merge-where [:= :procurement_category_viewers.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_viewers.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:20.034Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:20.035Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:20.036Z NX-41294 DEBUG [leihs.procurement.permissions.user:85] - (->> [viewer? inspector? admin?] (map (fn* [p1__39296#] (p1__39296# tx auth-entity))) (some true?)) => true
>>a  {:NEW [:= :procurement_requests.approved_quantity nil], :APPROVED [:>= :procurement_requests.approved_quantity :procurement_requests.requested_quantity], :PARTIALLY_APPROVED [:and [:< :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:> :procurement_requests.approved_quantity 0]], :DENIED [:= :procurement_requests.approved_quantity 0]}
>>b  #sql/call [:case [:= :procurement_requests.approved_quantity nil] NEW [:>= :procurement_requests.approved_quantity :procurement_requests.requested_quantity] APPROVED [:and [:< :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:> :procurement_requests.approved_quantity 0]] PARTIALLY_APPROVED [:= :procurement_requests.approved_quantity 0] DENIED]
2023-11-24T14:02:20.036Z NX-41294 DEBUG [leihs.procurement.resources.request:157] - (-> requests-base-query (sql/merge-select [(state-sql advanced-user?) :state]) (sql/merge-join :procurement_budget_periods [:= :procurement_budget_periods.id :procurement_requests.budget_period_id])) => {:select (#sql/raw "DISTINCT ON (procurement_requests.id, concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))) procurement_requests.*" [#sql/call [:case [:= :procurement_requests.approved_quantity nil] "NEW" [:>= :procurement_requests.approved_quantity :procurement_requests.requested_quantity] "APPROVED" [:and [:< :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:> :procurement_requests.approved_quantity 0]] "PARTIALLY_APPROVED" [:= :procurement_requests.approved_quantity 0] "DENIED"] :state]), :from (:procurement_requests), :left-join (:models [:= :models.id :procurement_requests.model_id]), :order-by (#sql/raw "concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))"), :join (:procurement_budget_periods [:= :procurement_budget_periods.id :procurement_requests.budget_period_id])}
2023-11-24T14:02:20.038Z NX-41294 DEBUG [leihs.procurement.resources.request:260] - (-> advanced-user? requests-base-query-with-state (sql/where [:= :procurement_requests.id id])) => {:select (#sql/raw "DISTINCT ON (procurement_requests.id, concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))) procurement_requests.*" [#sql/call [:case [:= :procurement_requests.approved_quantity nil] "NEW" [:>= :procurement_requests.approved_quantity :procurement_requests.requested_quantity] "APPROVED" [:and [:< :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:> :procurement_requests.approved_quantity 0]] "PARTIALLY_APPROVED" [:= :procurement_requests.approved_quantity 0] "DENIED"] :state]), :from (:procurement_requests), :left-join (:models [:= :models.id :procurement_requests.model_id]), :order-by (#sql/raw "concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))"), :join (:procurement_budget_periods [:= :procurement_budget_periods.id :procurement_requests.budget_period_id]), :where [:= :procurement_requests.id "df6d3979-4323-4d7d-ae8e-078e0b162dcc"]}
2023-11-24T14:02:20.039Z NX-41294 DEBUG [leihs.procurement.permissions.user:52] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_viewers) (sql/merge-where [:= :procurement_category_viewers.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_viewers.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:20.041Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:20.041Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:20.042Z NX-41294 DEBUG [leihs.procurement.permissions.user:85] - (->> [viewer? inspector? admin?] (map (fn* [p1__39296#] (p1__39296# tx auth-entity))) (some true?)) => true
2023-11-24T14:02:20.072Z NX-41294 DEBUG [leihs.procurement.permissions.user:72] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_requesters_organizations) (sql/where [:= :procurement_requesters_organizations.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:20.072Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:20.073Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:20.075Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE (procurement_category_inspectors.user_id = ? AND procurement_category_inspectors.category_id = ?))) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f" "535b5ca7-c430-4a63-b5bd-09337b01bb7a"]
2023-11-24T14:02:20.075Z NX-41294 DEBUG [leihs.procurement.permissions.user:52] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_viewers) (sql/merge-where [:= :procurement_category_viewers.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_viewers.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_viewers WHERE (procurement_category_viewers.user_id = ? AND procurement_category_viewers.category_id = ?))) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f" "535b5ca7-c430-4a63-b5bd-09337b01bb7a"]
2023-11-24T14:02:20.091Z NX-41294 DEBUG [leihs.procurement.permissions.user:52] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_viewers) (sql/merge-where [:= :procurement_category_viewers.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_viewers.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:20.093Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:20.095Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:20.095Z NX-41294 DEBUG [leihs.procurement.permissions.user:85] - (->> [viewer? inspector? admin?] (map (fn* [p1__39296#] (p1__39296# tx auth-entity))) (some true?)) => true
>>a  {:NEW [:= :procurement_requests.approved_quantity nil], :APPROVED [:>= :procurement_requests.approved_quantity :procurement_requests.requested_quantity], :PARTIALLY_APPROVED [:and [:< :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:> :procurement_requests.approved_quantity 0]], :DENIED [:= :procurement_requests.approved_quantity 0]}
>>b  #sql/call [:case [:= :procurement_requests.approved_quantity nil] NEW [:>= :procurement_requests.approved_quantity :procurement_requests.requested_quantity] APPROVED [:and [:< :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:> :procurement_requests.approved_quantity 0]] PARTIALLY_APPROVED [:= :procurement_requests.approved_quantity 0] DENIED]
2023-11-24T14:02:20.096Z NX-41294 DEBUG [leihs.procurement.resources.request:157] - (-> requests-base-query (sql/merge-select [(state-sql advanced-user?) :state]) (sql/merge-join :procurement_budget_periods [:= :procurement_budget_periods.id :procurement_requests.budget_period_id])) => {:select (#sql/raw "DISTINCT ON (procurement_requests.id, concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))) procurement_requests.*" [#sql/call [:case [:= :procurement_requests.approved_quantity nil] "NEW" [:>= :procurement_requests.approved_quantity :procurement_requests.requested_quantity] "APPROVED" [:and [:< :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:> :procurement_requests.approved_quantity 0]] "PARTIALLY_APPROVED" [:= :procurement_requests.approved_quantity 0] "DENIED"] :state]), :from (:procurement_requests), :left-join (:models [:= :models.id :procurement_requests.model_id]), :order-by (#sql/raw "concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))"), :join (:procurement_budget_periods [:= :procurement_budget_periods.id :procurement_requests.budget_period_id])}
2023-11-24T14:02:20.098Z NX-41294 DEBUG [leihs.procurement.resources.request:260] - (-> advanced-user? requests-base-query-with-state (sql/where [:= :procurement_requests.id id])) => {:select (#sql/raw "DISTINCT ON (procurement_requests.id, concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))) procurement_requests.*" [#sql/call [:case [:= :procurement_requests.approved_quantity nil] "NEW" [:>= :procurement_requests.approved_quantity :procurement_requests.requested_quantity] "APPROVED" [:and [:< :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:> :procurement_requests.approved_quantity 0]] "PARTIALLY_APPROVED" [:= :procurement_requests.approved_quantity 0] "DENIED"] :state]), :from (:procurement_requests), :left-join (:models [:= :models.id :procurement_requests.model_id]), :order-by (#sql/raw "concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))"), :join (:procurement_budget_periods [:= :procurement_budget_periods.id :procurement_requests.budget_period_id]), :where [:= :procurement_requests.id "df6d3979-4323-4d7d-ae8e-078e0b162dcc"]}
2023-11-24T14:02:20.099Z NX-41294 DEBUG [leihs.procurement.permissions.user:52] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_viewers) (sql/merge-where [:= :procurement_category_viewers.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_viewers.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:20.100Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:20.101Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:20.102Z NX-41294 DEBUG [leihs.procurement.permissions.user:85] - (->> [viewer? inspector? admin?] (map (fn* [p1__39296#] (p1__39296# tx auth-entity))) (some true?)) => true
2023-11-24T14:02:20.115Z NX-41294 DEBUG [leihs.procurement.permissions.user:72] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_requesters_organizations) (sql/where [:= :procurement_requesters_organizations.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:20.116Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:20.116Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:20.118Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE (procurement_category_inspectors.user_id = ? AND procurement_category_inspectors.category_id = ?))) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f" "535b5ca7-c430-4a63-b5bd-09337b01bb7a"]
2023-11-24T14:02:20.119Z NX-41294 DEBUG [leihs.procurement.permissions.user:52] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_viewers) (sql/merge-where [:= :procurement_category_viewers.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_viewers.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_viewers WHERE (procurement_category_viewers.user_id = ? AND procurement_category_viewers.category_id = ?))) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f" "535b5ca7-c430-4a63-b5bd-09337b01bb7a"]

>>>pure-handler {:data #ordered/map ([:request #ordered/map ([:id df6d3979-4323-4d7d-ae8e-078e0b162dcc] [:short_id Budget-Period-Past.001] [:user #ordered/map ([:value #ordered/map ([:id 1862f73f-33ba-415e-b3c2-5feb2074752d] [:firstname Lynsey] [:lastname Kertzmann] [:__typename :User])] [:__typename :RequestFieldUser] [:read true] [:write false] [:required true])] [:category #ordered/map ([:read true] [:write false] [:required true] [:value #ordered/map ([:id 535b5ca7-c430-4a63-b5bd-09337b01bb7a] [:name Category C1] [:main_category #ordered/map ([:id 46d19a93-31da-4690-a45f-b11b525ca6ff] [:name Main Category MC1] [:__typename :MainCategory])] [:__typename :Category])] [:__typename :RequestFieldCategory])] [:budget_period #ordered/map ([:read true] [:write false] [:required true] [:value #ordered/map ([:name Budget-Period-Past] [:id 48d8c363-6af4-4a49-91ad-1b701743155f] [:__typename :BudgetPeriod])] [:__typename :RequestFieldBudgetPeriod])] [:article_name #ordered/map ([:value Mediocre Aluminum Shoes] [:__typename :RequestFieldString] [:read true] [:write false] [:required true])] [:model #ordered/map ([:value nil] [:__typename :RequestFieldModel] [:read true] [:write false] [:required false])] [:receiver #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:organization #ordered/map ([:value #ordered/map ([:id 7a59c4fa-a0ed-4abf-aeae-e9c3b3323e95] [:name Beauty & Kids] [:shortname nil] [:department #ordered/map ([:id e20c5fdb-8997-43a6-bebb-133d1466c239] [:name Home, Jewelry & Computers] [:__typename :Organization])] [:__typename :Organization])] [:__typename :RequestFieldOrganization])] [:price_cents #ordered/map ([:value 0] [:__typename :RequestFieldInt] [:read true] [:write false] [:required true])] [:price_currency #ordered/map ([:value CHF] [:__typename :RequestFieldString] [:read true] [:write false] [:required true])] [:requested_quantity #ordered/map ([:read true] [:value 1] [:__typename :RequestFieldInt] [:write false] [:required true])] [:approved_quantity #ordered/map ([:read true] [:value nil] [:__typename :RequestFieldInt] [:write false] [:required false])] [:order_quantity #ordered/map ([:read true] [:value nil] [:__typename :RequestFieldInt] [:write false] [:required false])] [:replacement #ordered/map ([:value true] [:__typename :RequestFieldBoolean] [:read true] [:write false] [:required true])] [:priority #ordered/map ([:value :NORMAL] [:__typename :RequestFieldPriority] [:read true] [:write false] [:required true])] [:state :NEW] [:article_number #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:supplier #ordered/map ([:value nil] [:__typename :RequestFieldSupplier] [:read true] [:write false] [:required false])] [:supplier_name #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:room #ordered/map ([:value #ordered/map ([:id 707541da-817b-402d-86a4-dbd6e72bee46] [:name reception room] [:building #ordered/map ([:id d1f8159a-bf85-4dde-8e9f-5472b1deb309] [:name 9594 Beer Extension] [:__typename :Building])] [:__typename :Room])] [:__typename :RequestFieldRoom] [:read true] [:write false] [:required true])] [:motivation #ordered/map ([:value Corporis commodi provident nam.] [:__typename :RequestFieldString] [:read true] [:write false] [:required true])] [:inspection_comment #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:inspector_priority #ordered/map ([:value :MEDIUM] [:__typename :RequestFieldInspectorPriority] [:read true] [:write false] [:required true])] [:accounting_type #ordered/map ([:value aquisition] [:__typename :RequestFieldString] [:read true] [:write false] [:required true])] [:cost_center #ordered/map ([:value nil] [:__typename :RequestFieldCostCenter] [:read true] [:write false] [:required false])] [:general_ledger_account #ordered/map ([:value nil] [:__typename :RequestFieldGeneralLedgerAccount] [:read true])] [:procurement_account #ordered/map ([:value nil] [:__typename :RequestFieldProcurementAccount] [:read true] [:write false])] [:internal_order_number #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:order_status #ordered/map ([:value :PROCURED] [:__typename :RequestFieldOrderStatus] [:read true] [:write true] [:required true])] [:order_comment #ordered/map ([:value Wurde bestellt und geliefert!] [:__typename :RequestFieldString] [:read true] [:write true] [:required false])] [:__typename :Request] [:template #ordered/map ([:value nil] [:__typename :RequestFieldTemplate])] [:attachments #ordered/map ([:read true] [:write false] [:required false] [:value []] [:__typename :RequestFieldAttachments])])])}
2023-11-24T14:02:20.132Z NX-41294 DEBUG [leihs.procurement.graphql:64] - result => {:data #ordered/map ([:request #ordered/map ([:id "df6d3979-4323-4d7d-ae8e-078e0b162dcc"] [:short_id "Budget-Period-Past.001"] [:user #ordered/map ([:value #ordered/map ([:id "1862f73f-33ba-415e-b3c2-5feb2074752d"] [:firstname "Lynsey"] [:lastname "Kertzmann"] [:__typename :User])] [:__typename :RequestFieldUser] [:read true] [:write false] [:required true])] [:category #ordered/map ([:read true] [:write false] [:required true] [:value #ordered/map ([:id "535b5ca7-c430-4a63-b5bd-09337b01bb7a"] [:name "Category C1"] [:main_category #ordered/map ([:id "46d19a93-31da-4690-a45f-b11b525ca6ff"] [:name "Main Category MC1"] [:__typename :MainCategory])] [:__typename :Category])] [:__typename :RequestFieldCategory])] [:budget_period #ordered/map ([:read true] [:write false] [:required true] [:value #ordered/map ([:name "Budget-Period-Past"] [:id "48d8c363-6af4-4a49-91ad-1b701743155f"] [:__typename :BudgetPeriod])] [:__typename :RequestFieldBudgetPeriod])] [:article_name #ordered/map ([:value "Mediocre Aluminum Shoes"] [:__typename :RequestFieldString] [:read true] [:write false] [:required true])] [:model #ordered/map ([:value nil] [:__typename :RequestFieldModel] [:read true] [:write false] [:required false])] [:receiver #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:organization #ordered/map ([:value #ordered/map ([:id "7a59c4fa-a0ed-4abf-aeae-e9c3b3323e95"] [:name "Beauty & Kids"] [:shortname nil] [:department #ordered/map ([:id "e20c5fdb-8997-43a6-bebb-133d1466c239"] [:name "Home, Jewelry & Computers"] [:__typename :Organization])] [:__typename :Organization])] [:__typename :RequestFieldOrganization])] [:price_cents #ordered/map ([:value 0] [:__typename :RequestFieldInt] [:read true] [:write false] [:required true])] [:price_currency #ordered/map ([:value "CHF"] [:__typename :RequestFieldString] [:read true] [:write false] [:required true])] [:requested_quantity #ordered/map ([:read true] [:value 1] [:__typename :RequestFieldInt] [:write false] [:required true])] [:approved_quantity #ordered/map ([:read true] [:value nil] [:__typename :RequestFieldInt] [:write false] [:required false])] [:order_quantity #ordered/map ([:read true] [:value nil] [:__typename :RequestFieldInt] [:write false] [:required false])] [:replacement #ordered/map ([:value true] [:__typename :RequestFieldBoolean] [:read true] [:write false] [:required true])] [:priority #ordered/map ([:value :NORMAL] [:__typename :RequestFieldPriority] [:read true] [:write false] [:required true])] [:state :NEW] [:article_number #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:supplier #ordered/map ([:value nil] [:__typename :RequestFieldSupplier] [:read true] [:write false] [:required false])] [:supplier_name #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:room #ordered/map ([:value #ordered/map ([:id "707541da-817b-402d-86a4-dbd6e72bee46"] [:name "reception room"] [:building #ordered/map ([:id "d1f8159a-bf85-4dde-8e9f-5472b1deb309"] [:name "9594 Beer Extension"] [:__typename :Building])] [:__typename :Room])] [:__typename :RequestFieldRoom] [:read true] [:write false] [:required true])] [:motivation #ordered/map ([:value "Corporis commodi provident nam."] [:__typename :RequestFieldString] [:read true] [:write false] [:required true])] [:inspection_comment #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:inspector_priority #ordered/map ([:value :MEDIUM] [:__typename :RequestFieldInspectorPriority] [:read true] [:write false] [:required true])] [:accounting_type #ordered/map ([:value "aquisition"] [:__typename :RequestFieldString] [:read true] [:write false] [:required true])] [:cost_center #ordered/map ([:value nil] [:__typename :RequestFieldCostCenter] [:read true] [:write false] [:required false])] [:general_ledger_account #ordered/map ([:value nil] [:__typename :RequestFieldGeneralLedgerAccount] [:read true])] [:procurement_account #ordered/map ([:value nil] [:__typename :RequestFieldProcurementAccount] [:read true] [:write false])] [:internal_order_number #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:order_status #ordered/map ([:value :PROCURED] [:__typename :RequestFieldOrderStatus] [:read true] [:write true] [:required true])] [:order_comment #ordered/map ([:value "Wurde bestellt und geliefert!"] [:__typename :RequestFieldString] [:read true] [:write true] [:required false])] [:__typename :Request] [:template #ordered/map ([:value nil] [:__typename :RequestFieldTemplate])] [:attachments #ordered/map ([:read true] [:write false] [:required false] [:value []] [:__typename :RequestFieldAttachments])])])}
2023-11-24T14:02:20.141Z NX-41294 DEBUG [leihs.procurement.authorization:150] - (authorize handler request) => {:body {:data #ordered/map ([:request #ordered/map ([:id "df6d3979-4323-4d7d-ae8e-078e0b162dcc"] [:short_id "Budget-Period-Past.001"] [:user #ordered/map ([:value #ordered/map ([:id "1862f73f-33ba-415e-b3c2-5feb2074752d"] [:firstname "Lynsey"] [:lastname "Kertzmann"] [:__typename :User])] [:__typename :RequestFieldUser] [:read true] [:write false] [:required true])] [:category #ordered/map ([:read true] [:write false] [:required true] [:value #ordered/map ([:id "535b5ca7-c430-4a63-b5bd-09337b01bb7a"] [:name "Category C1"] [:main_category #ordered/map ([:id "46d19a93-31da-4690-a45f-b11b525ca6ff"] [:name "Main Category MC1"] [:__typename :MainCategory])] [:__typename :Category])] [:__typename :RequestFieldCategory])] [:budget_period #ordered/map ([:read true] [:write false] [:required true] [:value #ordered/map ([:name "Budget-Period-Past"] [:id "48d8c363-6af4-4a49-91ad-1b701743155f"] [:__typename :BudgetPeriod])] [:__typename :RequestFieldBudgetPeriod])] [:article_name #ordered/map ([:value "Mediocre Aluminum Shoes"] [:__typename :RequestFieldString] [:read true] [:write false] [:required true])] [:model #ordered/map ([:value nil] [:__typename :RequestFieldModel] [:read true] [:write false] [:required false])] [:receiver #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:organization #ordered/map ([:value #ordered/map ([:id "7a59c4fa-a0ed-4abf-aeae-e9c3b3323e95"] [:name "Beauty & Kids"] [:shortname nil] [:department #ordered/map ([:id "e20c5fdb-8997-43a6-bebb-133d1466c239"] [:name "Home, Jewelry & Computers"] [:__typename :Organization])] [:__typename :Organization])] [:__typename :RequestFieldOrganization])] [:price_cents #ordered/map ([:value 0] [:__typename :RequestFieldInt] [:read true] [:write false] [:required true])] [:price_currency #ordered/map ([:value "CHF"] [:__typename :RequestFieldString] [:read true] [:write false] [:required true])] [:requested_quantity #ordered/map ([:read true] [:value 1] [:__typename :RequestFieldInt] [:write false] [:required true])] [:approved_quantity #ordered/map ([:read true] [:value nil] [:__typename :RequestFieldInt] [:write false] [:required false])] [:order_quantity #ordered/map ([:read true] [:value nil] [:__typename :RequestFieldInt] [:write false] [:required false])] [:replacement #ordered/map ([:value true] [:__typename :RequestFieldBoolean] [:read true] [:write false] [:required true])] [:priority #ordered/map ([:value :NORMAL] [:__typename :RequestFieldPriority] [:read true] [:write false] [:required true])] [:state :NEW] [:article_number #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:supplier #ordered/map ([:value nil] [:__typename :RequestFieldSupplier] [:read true] [:write false] [:required false])] [:supplier_name #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:room #ordered/map ([:value #ordered/map ([:id "707541da-817b-402d-86a4-dbd6e72bee46"] [:name "reception room"] [:building #ordered/map ([:id "d1f8159a-bf85-4dde-8e9f-5472b1deb309"] [:name "9594 Beer Extension"] [:__typename :Building])] [:__typename :Room])] [:__typename :RequestFieldRoom] [:read true] [:write false] [:required true])] [:motivation #ordered/map ([:value "Corporis commodi provident nam."] [:__typename :RequestFieldString] [:read true] [:write false] [:required true])] [:inspection_comment #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:inspector_priority #ordered/map ([:value :MEDIUM] [:__typename :RequestFieldInspectorPriority] [:read true] [:write false] [:required true])] [:accounting_type #ordered/map ([:value "aquisition"] [:__typename :RequestFieldString] [:read true] [:write false] [:required true])] [:cost_center #ordered/map ([:value nil] [:__typename :RequestFieldCostCenter] [:read true] [:write false] [:required false])] [:general_ledger_account #ordered/map ([:value nil] [:__typename :RequestFieldGeneralLedgerAccount] [:read true])] [:procurement_account #ordered/map ([:value nil] [:__typename :RequestFieldProcurementAccount] [:read true] [:write false])] [:internal_order_number #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:order_status #ordered/map ([:value :PROCURED] [:__typename :RequestFieldOrderStatus] [:read true] [:write true] [:required true])] [:order_comment #ordered/map ([:value "Wurde bestellt und geliefert!"] [:__typename :RequestFieldString] [:read true] [:write true] [:required false])] [:__typename :Request] [:template #ordered/map ([:value nil] [:__typename :RequestFieldTemplate])] [:attachments #ordered/map ([:read true] [:write false] [:required false] [:value []] [:__typename :RequestFieldAttachments])])])}}
>>> authenticate::skip= nil  handler-key= :graphql
>>> authenticate::authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-24T14:02:17.415645Z", :id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :user_session_id #uuid "e25b9e9c-082c-43d7-8468-0c267e3212a7", :scope_system_admin_read false, :access-rights (), :user_id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}

>> authorize >

>> authorize::handler > #object[leihs.core.locale$wrap$fn__44318 0x4cb26645 leihs.core.locale$wrap$fn__44318@4cb26645]

>> authorize::request > {:authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-24T14:02:17.415645Z", :id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :user_session_id #uuid "e25b9e9c-082c-43d7-8468-0c267e3212a7", :scope_system_admin_read false, :access-rights (), :user_id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}, :cookies {leihs-anti-csrf-token {:value 85b2de76-3ecd-40fd-a936-2d92f39bd32b}, leihs-user-session {:value 88ce2c7c-4075-46c2-80ca-82d865f9353e}}, :remote-addr 127.0.0.1, :start-time 489329829518750, :params {}, :settings {:email_sending_enabled false, :sessions_max_lifetime_secs 432000, :smtp_default_from_address your.lending.desk@example.com, :public_image_caching_enabled true, :sessions_force_secure false, :deliver_received_order_notifications false, :external_base_url nil, :sessions_force_uniqueness false, :email_signature Cheers,}, :tx-next #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x2e18c1e HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x4c858a34 next.jdbc.result_set$as_unqualified_lower_maps@4c858a34]}}, :query-params-raw {}, :route-params nil, :headers {origin http://localhost:3230, sec-fetch-site same-origin, host localhost:3230, user-agent Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/115.0, content-type application/json, cookie leihs-anti-csrf-token=85b2de76-3ecd-40fd-a936-2d92f39bd32b; leihs-user-session=88ce2c7c-4075-46c2-80ca-82d865f9353e, content-length 1214, referer http://localhost:3230/procure/requests, connection keep-alive, x-csrf-token 85b2de76-3ecd-40fd-a936-2d92f39bd32b, accept application/json, accept-language de,en-US;q=0.7,en;q=0.3, sec-fetch-dest empty, accept-encoding gzip, deflate, br, sec-fetch-mode cors}, :async-channel #object[org.httpkit.server.AsyncChannel 0x36497e18 /127.0.0.1:3230<->/127.0.0.1:63590], :server-port 3230, :params-raw {}, :tx {:datasource #object[com.zaxxer.hikari.HikariDataSource 0x153deae HikariDataSource (db-pool)]}, :content-length 1214, :form-params {}, :websocket? false, :query-params {}, :content-type application/json, :form-params-raw {}, :character-encoding utf8, :uri /procure/graphql, :server-name localhost, :handler-key :graphql, :query-string nil, :body {:operationName RequestsIndexFiltered, :variables {:search nil, :budgetPeriods [48d8c363-6af4-4a49-91ad-1b701743155f], :categories [535b5ca7-c430-4a63-b5bd-09337b01bb7a], :organizations [7a59c4fa-a0ed-4abf-aeae-e9c3b3323e95], :onlyOwnRequests false, :priority [NORMAL HIGH], :inspector_priority [LOW MEDIUM HIGH MANDATORY], :state [NEW APPROVED PARTIALLY_APPROVED DENIED]}, :query query RequestsIndexFiltered($budgetPeriods: [ID!], $categories: [ID!], $search: String, $state: [State!], $organizations: [ID!], $priority: [Priority!], $inspector_priority: [InspectorPriority!], $onlyOwnRequests: Boolean) {
  dashboard(budget_period_id: $budgetPeriods, category_id: $categories, search: $search, state: $state, organization_id: $organizations, priority: $priority, inspector_priority: $inspector_priority, requested_by_auth_user: $onlyOwnRequests) {
    cacheKey
    budget_periods {
      cacheKey
      total_price_cents
      main_categories {
        cacheKey
        total_price_cents
        categories {
          cacheKey
          total_price_cents
          __typename
        }
        __typename
      }
      __typename
    }
    __typename
  }
}
}, :graphql-schema #CompiledSchema<>, :handler #object[leihs.procurement.graphql$handler 0x1a4a1f6f leihs.procurement.graphql$handler@1a4a1f6f], :multipart-params {}, :scheme :http, :request-method :post, :accept {:mime :json, :charset nil, :encoding nil, :language nil}}

>> authorize::handler-key >> :graphql
2023-11-24T14:02:20.201Z NX-41294 DEBUG [leihs.procurement.authorization:135] - (skip? (:handler-key request)) => nil
2023-11-24T14:02:20.202Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:20.202Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
>>> authenticate::skip= nil  handler-key= :graphql
>>> authenticate::authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-24T14:02:17.415645Z", :id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :user_session_id #uuid "e25b9e9c-082c-43d7-8468-0c267e3212a7", :scope_system_admin_read false, :access-rights (), :user_id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}
2023-11-24T14:02:20.205Z NX-41294 DEBUG [leihs.procurement.permissions.user:52] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_viewers) (sql/merge-where [:= :procurement_category_viewers.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_viewers.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]

>> authorize >

>> authorize::handler > #object[leihs.core.locale$wrap$fn__44318 0x4cb26645 leihs.core.locale$wrap$fn__44318@4cb26645]

>> authorize::request > {:authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-24T14:02:17.415645Z", :id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :user_session_id #uuid "e25b9e9c-082c-43d7-8468-0c267e3212a7", :scope_system_admin_read false, :access-rights (), :user_id #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}, :cookies {leihs-anti-csrf-token {:value 85b2de76-3ecd-40fd-a936-2d92f39bd32b}, leihs-user-session {:value 88ce2c7c-4075-46c2-80ca-82d865f9353e}}, :remote-addr 127.0.0.1, :start-time 489329829962625, :params {}, :settings {:email_sending_enabled false, :sessions_max_lifetime_secs 432000, :smtp_default_from_address your.lending.desk@example.com, :public_image_caching_enabled true, :sessions_force_secure false, :deliver_received_order_notifications false, :external_base_url nil, :sessions_force_uniqueness false, :email_signature Cheers,}, :tx-next #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x2e18c1e HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x4c858a34 next.jdbc.result_set$as_unqualified_lower_maps@4c858a34]}}, :query-params-raw {}, :route-params nil, :headers {origin http://localhost:3230, sec-fetch-site same-origin, host localhost:3230, user-agent Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/115.0, content-type application/json, cookie leihs-anti-csrf-token=85b2de76-3ecd-40fd-a936-2d92f39bd32b; leihs-user-session=88ce2c7c-4075-46c2-80ca-82d865f9353e, content-length 5678, referer http://localhost:3230/procure/requests, connection keep-alive, x-csrf-token 85b2de76-3ecd-40fd-a936-2d92f39bd32b, accept application/json, accept-language de,en-US;q=0.7,en;q=0.3, sec-fetch-dest empty, accept-encoding gzip, deflate, br, sec-fetch-mode cors}, :async-channel #object[org.httpkit.server.AsyncChannel 0xa73738c /127.0.0.1:3230<->/127.0.0.1:63593], :server-port 3230, :params-raw {}, :tx {:datasource #object[com.zaxxer.hikari.HikariDataSource 0x153deae HikariDataSource (db-pool)]}, :content-length 5678, :form-params {}, :websocket? false, :query-params {}, :content-type application/json, :form-params-raw {}, :character-encoding utf8, :uri /procure/graphql, :server-name localhost, :handler-key :graphql, :query-string nil, :body {:operationName RequestForEdit, :variables {:id [df6d3979-4323-4d7d-ae8e-078e0b162dcc]}, :query query RequestForEdit($id: [ID!]!) {
  requests(id: $id) {
    ...RequestFieldsForEdit
    actionPermissions {
      delete
      edit
      moveBudgetPeriod
      moveCategory
      __typename
    }
    __typename
  }
  main_categories {
    id
    name
    categories {
      id
      name
      __typename
    }
    __typename
  }
  budget_periods(whereRequestsCanBeMovedTo: $id) {
    id
    name
    __typename
  }
  settings {
    inspection_comments
    __typename
  }
}

fragment RequestFieldsForEdit on Request {
  ...RequestFieldsForIndex
  template {
    value {
      id
      article_name
      __typename
    }
    __typename
  }
  user {
    read
    write
    required
    value {
      id
      firstname
      lastname
      __typename
    }
    __typename
  }
  article_name {
    ...RequestFieldString
    __typename
  }
  model {
    read
    write
    required
    value {
      id
      product
      version
      __typename
    }
    __typename
  }
  supplier_name {
    ...RequestFieldString
    __typename
  }
  supplier {
    read
    write
    required
    value {
      id
      name
      __typename
    }
    __typename
  }
  receiver {
    ...RequestFieldString
    __typename
  }
  price_cents {
    ...RequestFieldInt
    __typename
  }
  price_currency {
    ...RequestFieldString
    __typename
  }
  requested_quantity {
    ...RequestFieldInt
    __typename
  }
  approved_quantity {
    ...RequestFieldInt
    __typename
  }
  order_quantity {
    ...RequestFieldInt
    __typename
  }
  order_status {
    read
    write
    required
    value
    __typename
  }
  order_comment {
    ...RequestFieldString
    __typename
  }
  priority {
    read
    write
    required
    value
    __typename
  }
  inspector_priority {
    read
    write
    required
    value
    __typename
  }
  state
  article_number {
    ...RequestFieldString
    __typename
  }
  motivation {
    ...RequestFieldString
    __typename
  }
  replacement {
    ...RequestFieldBoolean
    __typename
  }
  room {
    read
    write
    required
    value {
      id
      name
      building {
        id
        name
        __typename
      }
      __typename
    }
    __typename
  }
  inspection_comment {
    ...RequestFieldString
    __typename
  }
  attachments {
    read
    write
    required
    value {
      id
      filename
      url
      __typename
    }
    __typename
  }
  accounting_type {
    ...RequestFieldString
    __typename
  }
  cost_center {
    read
    write
    required
    value
    __typename
  }
  procurement_account {
    read
    write
    value
    __typename
  }
  general_ledger_account {
    read
    value
    __typename
  }
  internal_order_number {
    ...RequestFieldString
    __typename
  }
  __typename
}

fragment RequestFieldsForIndex on Request {
  id
  short_id
  user {
    value {
      id
      firstname
      lastname
      __typename
    }
    __typename
  }
  category {
    read
    write
    required
    value {
      id
      name
      main_category {
        id
        name
        __typename
      }
      __typename
    }
    __typename
  }
  budget_period {
    read
    write
    required
    value {
      name
      id
      __typename
    }
    __typename
  }
  article_name {
    value
    __typename
  }
  model {
    value {
      id
      product
      version
      __typename
    }
    __typename
  }
  receiver {
    value
    __typename
  }
  organization {
    value {
      id
      name
      shortname
      department {
        id
        name
        __typename
      }
      __typename
    }
    __typename
  }
  price_cents {
    value
    __typename
  }
  price_currency {
    value
    __typename
  }
  requested_quantity {
    read
    value
    __typename
  }
  approved_quantity {
    read
    value
    __typename
  }
  order_quantity {
    read
    value
    __typename
  }
  replacement {
    value
    __typename
  }
  priority {
    value
    __typename
  }
  state
  article_number {
    value
    __typename
  }
  supplier {
    value {
      name
      __typename
    }
    __typename
  }
  supplier_name {
    value
    __typename
  }
  receiver {
    value
    __typename
  }
  room {
    value {
      id
      name
      building {
        id
        name
        __typename
      }
      __typename
    }
    __typename
  }
  motivation {
    value
    __typename
  }
  inspection_comment {
    value
    __typename
  }
  inspector_priority {
    value
    __typename
  }
  accounting_type {
    value
    __typename
  }
  cost_center {
    value
    __typename
  }
  general_ledger_account {
    value
    __typename
  }
  procurement_account {
    value
    __typename
  }
  internal_order_number {
    value
    __typename
  }
  order_status {
    value
    __typename
  }
  order_comment {
    value
    __typename
  }
  __typename
}

fragment RequestFieldString on RequestFieldString {
  value
  read
  write
  required
  __typename
}

fragment RequestFieldInt on RequestFieldInt {
  value
  read
  write
  required
  __typename
}

fragment RequestFieldBoolean on RequestFieldBoolean {
  value
  read
  write
  required
  __typename
}
}, :graphql-schema #CompiledSchema<>, :handler #object[leihs.procurement.graphql$handler 0x1a4a1f6f leihs.procurement.graphql$handler@1a4a1f6f], :multipart-params {}, :scheme :http, :request-method :post, :accept 2023-11-24T14:02:20.208Z NX-41294 DEBUG [leihs.procurement.permissions.user:72] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_requesters_organizations) (sql/where [:= :procurement_requesters_organizations.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
{:mime :json, :charset nil, :encoding nil, :language nil}}

>> authorize::handler-key >> :graphql
2023-11-24T14:02:20.220Z NX-41294 DEBUG [leihs.procurement.authorization:135] - (skip? (:handler-key request)) => nil
2023-11-24T14:02:20.221Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:20.221Z NX-41294 DEBUG [leihs.procurement.authorization:136] - (->> [user-perms/admin? user-perms/inspector? user-perms/viewer? user-perms/requester?] (map (fn* [p1__39355#] (p1__39355# (:tx request) (:authenticated-entity request)))) (some true?)) => true
2023-11-24T14:02:20.222Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:20.223Z NX-41294 DEBUG [leihs.procurement.permissions.user:52] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_viewers) (sql/merge-where [:= :procurement_category_viewers.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_viewers.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]

>>>exec-query::variables {:search nil, :budgetPeriods [48d8c363-6af4-4a49-91ad-1b701743155f], :categories [535b5ca7-c430-4a63-b5bd-09337b01bb7a], :organizations [7a59c4fa-a0ed-4abf-aeae-e9c3b3323e95], :onlyOwnRequests false, :priority [NORMAL HIGH], :inspector_priority [LOW MEDIUM HIGH MANDATORY], :state [NEW APPROVED PARTIALLY_APPROVED DENIED]}
2023-11-24T14:02:20.224Z NX-41294 DEBUG [leihs.procurement.permissions.user:72] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_requesters_organizations) (sql/where [:= :procurement_requesters_organizations.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:20.225Z NX-41294 DEBUG [leihs.procurement.authorization:136] - (->> [user-perms/admin? user-perms/inspector? user-perms/viewer? user-perms/requester?] (map (fn* [p1__39355#] (p1__39355# (:tx request) (:authenticated-entity request)))) (some true?)) => true

>>>get-dashboard
2023-11-24T14:02:20.225Z NX-41294 DEBUG [leihs.procurement.dashboard:33] - args => {:budget_period_id ["48d8c363-6af4-4a49-91ad-1b701743155f"], :category_id ["535b5ca7-c430-4a63-b5bd-09337b01bb7a"], :search nil, :state [:NEW :APPROVED :PARTIALLY_APPROVED :DENIED], :organization_id ["7a59c4fa-a0ed-4abf-aeae-e9c3b3323e95"], :priority [:NORMAL :HIGH], :inspector_priority [:LOW :MEDIUM :HIGH :MANDATORY], :requested_by_auth_user false}
2023-11-24T14:02:20.226Z NX-41294 DEBUG [leihs.procurement.dashboard:34] - value => nil
2023-11-24T14:02:20.228Z NX-41294 DEBUG [leihs.procurement.permissions.user:52] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_viewers) (sql/merge-where [:= :procurement_category_viewers.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_viewers.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:20.228Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:20.229Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:20.229Z NX-41294 DEBUG [leihs.procurement.permissions.user:85] - (->> [viewer? inspector? admin?] (map (fn* [p1__39296#] (p1__39296# tx auth-entity))) (some true?)) => true

>>a  {:NEW [:= :procurement_requests.approved_quantity nil], :APPROVED [:>= :procurement_requests.approved_quantity :procurement_requests.requested_quantity], :PARTIALLY_APPROVED [:and [:< :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:> :procurement_requests.approved_quantity 0]], :DENIED [:= :procurement_requests.approved_quantity 0]}

>>b  #sql/call [:case [:= :procurement_requests.approved_quantity nil] NEW [:>= :procurement_requests.approved_quantity :procurement_requests.requested_quantity] APPROVED [:and [:< :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:> :procurement_requests.approved_quantity 0]] PARTIALLY_APPROVED [:= :procurement_requests.approved_quantity 0] DENIED]

>>>exec-query::variables {:id [df6d3979-4323-4d7d-ae8e-078e0b162dcc]}
2023-11-24T14:02:20.230Z NX-41294 DEBUG [leihs.procurement.resources.request:157] - (-> requests-base-query (sql/merge-select [(state-sql advanced-user?) :state]) (sql/merge-join :procurement_budget_periods [:= :procurement_budget_periods.id :procurement_requests.budget_period_id])) => {:select (#sql/raw "DISTINCT ON (procurement_requests.id, concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))) procurement_requests.*" [#sql/call [:case [:= :procurement_requests.approved_quantity nil] "NEW" [:>= :procurement_requests.approved_quantity :procurement_requests.requested_quantity] "APPROVED" [:and [:< :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:> :procurement_requests.approved_quantity 0]] "PARTIALLY_APPROVED" [:= :procurement_requests.approved_quantity 0] "DENIED"] :state]), :from (:procurement_requests), :left-join (:models [:= :models.id :procurement_requests.model_id]), :order-by (#sql/raw "concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))"), :join (:procurement_budget_periods [:= :procurement_budget_periods.id :procurement_requests.budget_period_id])}
2023-11-24T14:02:20.231Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:20.234Z NX-41294 DEBUG [leihs.procurement.permissions.user:52] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_viewers) (sql/merge-where [:= :procurement_category_viewers.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_viewers.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:20.235Z NX-41294 DEBUG [leihs.procurement.resources.requests:108] - query => ["SELECT DISTINCT ON (procurement_requests.id, concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))) procurement_requests.*, CASE WHEN procurement_requests.approved_quantity IS NULL THEN ? WHEN procurement_requests.approved_quantity >= procurement_requests.requested_quantity THEN ? WHEN (procurement_requests.approved_quantity < procurement_requests.requested_quantity AND procurement_requests.approved_quantity > ?) THEN ? WHEN procurement_requests.approved_quantity = ? THEN ? END AS state, row_to_json(procurement_budget_periods_2) AS budget_period, row_to_json(procurement_categories)::jsonb || jsonb_build_object('main_category', row_to_json(procurement_main_categories)) AS category, row_to_json(models) AS model, row_to_json(procurement_organizations)::jsonb || jsonb_build_object('department', row_to_json(procurement_departments)) AS organization, row_to_json(procurement_templates) AS template, row_to_json(rooms)::jsonb || jsonb_build_object('building', row_to_json(buildings)) AS room, row_to_json(suppliers) AS supplier, row_to_json(users) AS user FROM procurement_requests INNER JOIN procurement_budget_periods ON procurement_budget_periods.id = procurement_requests.budget_period_id INNER JOIN (SELECT *, current_date > end_date AS is_past FROM procurement_budget_periods) procurement_budget_periods_2 ON procurement_budget_periods_2.id = procurement_requests.budget_period_id INNER JOIN procurement_categories ON procurement_categories.id = procurement_requests.category_id INNER JOIN procurement_main_categories ON procurement_main_categories.id = procurement_categories.main_category_id INNER JOIN procurement_organizations ON procurement_organizations.id = procurement_requests.organization_id INNER JOIN procurement_organizations procurement_departments ON procurement_departments.id = procurement_organizations.parent_id INNER JOIN rooms ON rooms.id = procurement_requests.room_id INNER JOIN buildings ON buildings.id = rooms.building_id LEFT JOIN models ON models.id = procurement_requests.model_id LEFT JOIN procurement_templates ON procurement_templates.id = procurement_requests.template_id LEFT JOIN suppliers ON suppliers.id = procurement_requests.supplier_id LEFT JOIN users ON users.id = procurement_requests.user_id WHERE ((procurement_requests.category_id in (?)) AND (procurement_requests.budget_period_id in (?)) AND (procurement_requests.organization_id in (?)) AND (procurement_requests.priority in (?, ?)) AND (procurement_requests.inspector_priority in (?, ?, ?, ?)) AND (procurement_requests.approved_quantity IS NULL OR procurement_requests.approved_quantity >= procurement_requests.requested_quantity OR (procurement_requests.approved_quantity < procurement_requests.requested_quantity AND procurement_requests.approved_quantity > ?) OR procurement_requests.approved_quantity = ?)) ORDER BY concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))" "NEW" "APPROVED" 0 "PARTIALLY_APPROVED" 0 "DENIED" "535b5ca7-c430-4a63-b5bd-09337b01bb7a" "48d8c363-6af4-4a49-91ad-1b701743155f" "7a59c4fa-a0ed-4abf-aeae-e9c3b3323e95" "normal" "high" "low" "medium" "high" "mandatory" 0 0]
2023-11-24T14:02:20.237Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
>>broken-query [SELECT DISTINCT ON (procurement_requests.id, concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))) procurement_requests.*, CASE WHEN procurement_requests.approved_quantity IS NULL THEN ? WHEN procurement_requests.approved_quantity >= procurement_requests.requested_quantity THEN ? WHEN (procurement_requests.approved_quantity < procurement_requests.requested_quantity AND procurement_requests.approved_quantity > ?) THEN ? WHEN procurement_requests.approved_quantity = ? THEN ? END AS state, row_to_json(procurement_budget_periods_2) AS budget_period, row_to_json(procurement_categories)::jsonb || jsonb_build_object('main_category', row_to_json(procurement_main_categories)) AS category, row_to_json(models) AS model, row_to_json(procurement_organizations)::jsonb || jsonb_build_object('department', row_to_json(procurement_departments)) AS organization, row_to_json(procurement_templates) AS template, row_to_json(rooms)::jsonb || jsonb_build_object('building', row_to_json(buildings)) AS room, row_to_json(suppliers) AS supplier, row_to_json(users) AS user FROM procurement_requests INNER JOIN procurement_budget_periods ON procurement_budget_periods.id = procurement_requests.budget_period_id INNER JOIN (SELECT *, current_date > end_date AS is_past FROM procurement_budget_periods) procurement_budget_periods_2 ON procurement_budget_periods_2.id = procurement_requests.budget_period_id INNER JOIN procurement_categories ON procurement_categories.id = procurement_requests.category_id INNER JOIN procurement_main_categories ON procurement_main_categories.id = procurement_categories.main_category_id INNER JOIN procurement_organizations ON procurement_organizations.id = procurement_requests.organization_id INNER JOIN procurement_organizations procurement_departments ON procurement_departments.id = procurement_organizations.parent_id INNER JOIN rooms ON rooms.id = procurement_requests.room_id INNER JOIN buildings ON buildings.id = rooms.building_id LEFT JOIN models ON models.id = procurement_requests.model_id LEFT JOIN procurement_templates ON procurement_templates.id = procurement_requests.template_id LEFT JOIN suppliers ON suppliers.id = procurement_requests.supplier_id LEFT JOIN users ON users.id = procurement_requests.user_id WHERE ((procurement_requests.category_id in (?)) AND (procurement_requests.budget_period_id in (?)) AND (procurement_requests.organization_id in (?)) AND (procurement_requests.priority in (?, ?)) AND (procurement_requests.inspector_priority in (?, ?, ?, ?)) AND (procurement_requests.approved_quantity IS NULL OR procurement_requests.approved_quantity >= procurement_requests.requested_quantity OR (procurement_requests.approved_quantity < procurement_requests.requested_quantity AND procurement_requests.approved_quantity > ?) OR procurement_requests.approved_quantity = ?)) ORDER BY concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, ''))) NEW APPROVED 0 PARTIALLY_APPROVED 0 DENIED 535b5ca7-c430-4a63-b5bd-09337b01bb7a 48d8c363-6af4-4a49-91ad-1b701743155f 7a59c4fa-a0ed-4abf-aeae-e9c3b3323e95 normal high low medium high mandatory 0 0]
2023-11-24T14:02:20.241Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:20.247Z NX-41294 DEBUG [leihs.procurement.permissions.user:52] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_viewers) (sql/merge-where [:= :procurement_category_viewers.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_viewers.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:20.248Z NX-41294 DEBUG [leihs.procurement.permissions.user:85] - (->> [viewer? inspector? admin?] (map (fn* [p1__39296#] (p1__39296# tx auth-entity))) (some true?)) => true
2023-11-24T14:02:20.248Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
>>a  {:NEW [:= :procurement_requests.approved_quantity nil], :APPROVED [:>= :procurement_requests.approved_quantity :procurement_requests.requested_quantity], :PARTIALLY_APPROVED [:and [:< :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:> :procurement_requests.approved_quantity 0]], :DENIED [:= :procurement_requests.approved_quantity 0]}
2023-11-24T14:02:20.249Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
>>b  #sql/call [:case [:= :procurement_requests.approved_quantity nil] NEW [:>= :procurement_requests.approved_quantity :procurement_requests.requested_quantity] APPROVED [:and [:< :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:> :procurement_requests.approved_quantity 0]] PARTIALLY_APPROVED [:= :procurement_requests.approved_quantity 0] DENIED]
2023-11-24T14:02:20.250Z NX-41294 DEBUG [leihs.procurement.resources.request:157] - (-> requests-base-query (sql/merge-select [(state-sql advanced-user?) :state]) (sql/merge-join :procurement_budget_periods [:= :procurement_budget_periods.id :procurement_requests.budget_period_id])) => {:select (#sql/raw "DISTINCT ON (procurement_requests.id, concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))) procurement_requests.*" [#sql/call [:case [:= :procurement_requests.approved_quantity nil] "NEW" [:>= :procurement_requests.approved_quantity :procurement_requests.requested_quantity] "APPROVED" [:and [:< :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:> :procurement_requests.approved_quantity 0]] "PARTIALLY_APPROVED" [:= :procurement_requests.approved_quantity 0] "DENIED"] :state]), :from (:procurement_requests), :left-join (:models [:= :models.id :procurement_requests.model_id]), :order-by (#sql/raw "concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))"), :join (:procurement_budget_periods [:= :procurement_budget_periods.id :procurement_requests.budget_period_id])}
2023-11-24T14:02:20.251Z NX-41294 DEBUG [leihs.procurement.permissions.user:85] - (->> [viewer? inspector? admin?] (map (fn* [p1__39296#] (p1__39296# tx auth-entity))) (some true?)) => true
2023-11-24T14:02:20.253Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:20.254Z NX-41294 DEBUG [leihs.procurement.resources.requests:108] - query => ["SELECT DISTINCT ON (procurement_requests.id, concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))) procurement_requests.*, CASE WHEN procurement_requests.approved_quantity IS NULL THEN ? WHEN procurement_requests.approved_quantity >= procurement_requests.requested_quantity THEN ? WHEN (procurement_requests.approved_quantity < procurement_requests.requested_quantity AND procurement_requests.approved_quantity > ?) THEN ? WHEN procurement_requests.approved_quantity = ? THEN ? END AS state, row_to_json(procurement_budget_periods_2) AS budget_period, row_to_json(procurement_categories)::jsonb || jsonb_build_object('main_category', row_to_json(procurement_main_categories)) AS category, row_to_json(models) AS model, row_to_json(procurement_organizations)::jsonb || jsonb_build_object('department', row_to_json(procurement_departments)) AS organization, row_to_json(procurement_templates) AS template, row_to_json(rooms)::jsonb || jsonb_build_object('building', row_to_json(buildings)) AS room, row_to_json(suppliers) AS supplier, row_to_json(users) AS user FROM procurement_requests INNER JOIN procurement_budget_periods ON procurement_budget_periods.id = procurement_requests.budget_period_id INNER JOIN (SELECT *, current_date > end_date AS is_past FROM procurement_budget_periods) procurement_budget_periods_2 ON procurement_budget_periods_2.id = procurement_requests.budget_period_id INNER JOIN procurement_categories ON procurement_categories.id = procurement_requests.category_id INNER JOIN procurement_main_categories ON procurement_main_categories.id = procurement_categories.main_category_id INNER JOIN procurement_organizations ON procurement_organizations.id = procurement_requests.organization_id INNER JOIN procurement_organizations procurement_departments ON procurement_departments.id = procurement_organizations.parent_id INNER JOIN rooms ON rooms.id = procurement_requests.room_id INNER JOIN buildings ON buildings.id = rooms.building_id LEFT JOIN models ON models.id = procurement_requests.model_id LEFT JOIN procurement_templates ON procurement_templates.id = procurement_requests.template_id LEFT JOIN suppliers ON suppliers.id = procurement_requests.supplier_id LEFT JOIN users ON users.id = procurement_requests.user_id WHERE (procurement_requests.id in (?)) ORDER BY concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))" "NEW" "APPROVED" 0 "PARTIALLY_APPROVED" 0 "DENIED" "df6d3979-4323-4d7d-ae8e-078e0b162dcc"]
>>broken-query [SELECT DISTINCT ON (procurement_requests.id, concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))) procurement_requests.*, CASE WHEN procurement_requests.approved_quantity IS NULL THEN ? WHEN procurement_requests.approved_quantity >= procurement_requests.requested_quantity THEN ? WHEN (procurement_requests.approved_quantity < procurement_requests.requested_quantity AND procurement_requests.approved_quantity > ?) THEN ? WHEN procurement_requests.approved_quantity = ? THEN ? END AS state, row_to_json(procurement_budget_periods_2) AS budget_period, row_to_json(procurement_categories)::jsonb || jsonb_build_object('main_category', row_to_json(procurement_main_categories)) AS category, row_to_json(models) AS model, row_to_json(procurement_organizations)::jsonb || jsonb_build_object('department', row_to_json(procurement_departments)) AS organization, row_to_json(procurement_templates) AS template, row_to_json(rooms)::jsonb || jsonb_build_object('building', row_to_json(buildings)) AS room, row_to_json(suppliers) AS supplier, row_to_json(users) AS user FROM procurement_requests INNER JOIN procurement_budget_periods ON procurement_budget_periods.id = procurement_requests.budget_period_id INNER JOIN (SELECT *, current_date > end_date AS is_past FROM procurement_budget_periods) procurement_budget_periods_2 ON procurement_budget_periods_2.id = procurement_requests.budget_period_id INNER JOIN procurement_categories ON procurement_categories.id = procurement_requests.category_id INNER JOIN procurement_main_categories ON procurement_main_categories.id = procurement_categories.main_category_id INNER JOIN procurement_organizations ON procurement_organizations.id = procurement_requests.organization_id INNER JOIN procurement_organizations procurement_departments ON procurement_departments.id = procurement_organizations.parent_id INNER JOIN rooms ON rooms.id = procurement_requests.room_id INNER JOIN buildings ON buildings.id = rooms.building_id LEFT JOIN models ON models.id = procurement_requests.model_id LEFT JOIN procurement_templates ON procurement_templates.id = procurement_requests.template_id LEFT JOIN suppliers ON suppliers.id = procurement_requests.supplier_id LEFT JOIN users ON users.id = procurement_requests.user_id WHERE (procurement_requests.id in (?)) ORDER BY concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, ''))) NEW APPROVED 0 PARTIALLY_APPROVED 0 DENIED df6d3979-4323-4d7d-ae8e-078e0b162dcc]
2023-11-24T14:02:20.264Z NX-41294 DEBUG [leihs.procurement.permissions.user:52] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_viewers) (sql/merge-where [:= :procurement_category_viewers.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_viewers.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:20.266Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:20.267Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:20.268Z NX-41294 DEBUG [leihs.procurement.permissions.user:85] - (->> [viewer? inspector? admin?] (map (fn* [p1__39296#] (p1__39296# tx auth-entity))) (some true?)) => true
2023-11-24T14:02:20.271Z NX-41294 DEBUG [leihs.procurement.permissions.user:72] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_requesters_organizations) (sql/where [:= :procurement_requesters_organizations.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:20.272Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:20.272Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:20.274Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE (procurement_category_inspectors.user_id = ? AND procurement_category_inspectors.category_id = ?))) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f" "535b5ca7-c430-4a63-b5bd-09337b01bb7a"]
2023-11-24T14:02:20.274Z NX-41294 DEBUG [leihs.procurement.permissions.user:52] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_viewers) (sql/merge-where [:= :procurement_category_viewers.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_viewers.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_viewers WHERE (procurement_category_viewers.user_id = ? AND procurement_category_viewers.category_id = ?))) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f" "535b5ca7-c430-4a63-b5bd-09337b01bb7a"]
2023-11-24T14:02:20.268Z NX-41294 DEBUG [leihs.procurement.dashboard:50] - (requests/get-requests ctx args value) => ({:category {:read true, :write false, :default {:id #uuid "535b5ca7-c430-4a63-b5bd-09337b01bb7a", :name "Category C1", :main_category_id #uuid "46d19a93-31da-4690-a45f-b11b525ca6ff", :general_ledger_account nil, :cost_center nil, :procurement_account nil}, :required true, :value {:id "535b5ca7-c430-4a63-b5bd-09337b01bb7a", :name "Category C1", :cost_center nil, :main_category {:id "46d19a93-31da-4690-a45f-b11b525ca6ff", :name "Main Category MC1"}, :main_category_id "46d19a93-31da-4690-a45f-b11b525ca6ff", :procurement_account nil, :general_ledger_account nil}, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :supplier {:read true, :write false, :default nil, :required false, :value nil, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :motivation {:read true, :write false, :required true, :value "Corporis commodi provident nam.", :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :accounting_type {:read true, :write false, :default "aquisition", :required true, :value "aquisition", :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :actionPermissions {:edit true, :delete false, :moveBudgetPeriod false, :moveCategory false}, :article_number {:read true, :write false, :default nil, :required false, :value nil, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :inspector_priority {:read true, :write false, :default "MEDIUM", :required true, :value :MEDIUM, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :price_cents {:read true, :write false, :default 0, :required true, :value 0, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :budget_period {:read true, :write false, :default {:id #uuid "48d8c363-6af4-4a49-91ad-1b701743155f", :name "Budget-Period-Past", :inspection_start_date #time/instant "2023-08-23T22:00:00Z", :end_date #time/instant "2023-11-22T23:00:00Z", :created_at #time/instant "2023-11-24T14:02:16.844231Z", :updated_at #time/instant "2023-11-24T14:02:16.844231Z"}, :required true, :value {:id "48d8c363-6af4-4a49-91ad-1b701743155f", :name "Budget-Period-Past", :inspection_start_date "2023-08-24T00:00:00+02:00", :end_date "2023-11-23T00:00:00+01:00", :created_at "2023-11-24T15:02:16.844231", :updated_at "2023-11-24T15:02:16.844231", :is_past true}, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :article_name {:read true, :write false, :default nil, :required true, :value "Mediocre Aluminum Shoes", :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :replacement {:read true, :write false, :default nil, :required true, :value true, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :attachments {:read true, :write false, :required false, :value :unqueried, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :DELETE false, :template {:read true, :write false, :default nil, :required true, :value nil, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :state :NEW, :organization {:value {:id "7a59c4fa-a0ed-4abf-aeae-e9c3b3323e95", :name "Beauty & Kids", :parent_id "e20c5fdb-8997-43a6-bebb-133d1466c239", :shortname nil, :department {:id "e20c5fdb-8997-43a6-bebb-133d1466c239", :name "Home, Jewelry & Computers", :parent_id nil, :shortname nil}}, :read false, :write false, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :supplier_name {:read true, :write false, :default nil, :required false, :value nil, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :order_status {:read true, :write true, :default "NOT_PROCURED", :required true, :value :PROCURED, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :requested_quantity {:read true, :write false, :required true, :value 1, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :general_ledger_account {:read true, :write false, :required false, :value nil, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :updated_at {:value #time/instant "2023-11-24T14:02:16.941919Z", :read false, :write false, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :priority {:read true, :write false, :default "NORMAL", :required true, :value :NORMAL, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc", :total_price_cents 0, :price_currency {:read true, :write false, :default "CHF", :required true, :value "CHF", :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :procurement_account {:read true, :write false, :value nil, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :room {:read true, :write false, :default {:id #uuid "b8927fd2-014c-48c2-b095-fa1d5620debe", :name "general room", :description nil, :building_id #uuid "abae04c5-d767-425e-acc2-7ce04df645d1", :general true, :building {:id #uuid "abae04c5-d767-425e-acc2-7ce04df645d1", :name "general building", :code nil}}, :required true, :value {:id "707541da-817b-402d-86a4-dbd6e72bee46", :name "reception room", :general false, :building {:id "d1f8159a-bf85-4dde-8e9f-5472b1deb309", :code nil, :name "9594 Beer Extension"}, :building_id "d1f8159a-bf85-4dde-8e9f-5472b1deb309", :description nil}, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :inspection_comment {:read true, :write false, :required false, :value nil, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :approved_quantity {:read true, :write false, :required false, :value nil, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :order_quantity {:read true, :write false, :required false, :value nil, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :cost_center {:read true, :write false, :required false, :value nil, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :user {:read true, :write false, :required true, :default {:id #uuid "1862f73f-33ba-415e-b3c2-5feb2074752d", :firstname "Lynsey", :lastname "Kertzmann"}, :value {:system_admin_protected false, :address nil, :email "chanda@ortiz.net", :pool_protected false, :last_sign_in_at nil, :img32_url nil, :account_enabled true, :lastname "Kertzmann", :phone nil, :img_digest nil, :org_id nil, :extended_info nil, :secondary_email nil, :city nil, :settings nil, :is_admin false, :organization "local", :login nil, :searchable "Lynsey Kertzmann chanda@ortiz.net    Kertzmann Lynsey", :updated_at "2023-11-24T15:02:16.902996+01:00", :firstname "Lynsey", :zip nil, :id "1862f73f-33ba-415e-b3c2-5feb2074752d", :url nil, :password_sign_in_enabled true, :account_disabled_at nil, :is_system_admin false, :badge_id nil, :language_locale nil, :img256_url nil, :country nil, :delegator_user_id nil, :created_at "2023-11-24T15:02:16.902996+01:00", :admin_protected false}, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :receiver {:read true, :write false, :required false, :value nil, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :internal_order_number {:read true, :write false, :required false, :value nil, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :created_at {:value #time/instant "2023-11-24T14:02:16.941919Z", :read false, :write false, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :order_comment {:read true, :write true, :required false, :value "Wurde bestellt und geliefert!", :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}, :short_id "Budget-Period-Past.001", :model {:read true, :write false, :default nil, :required false, :value nil, :request-id #uuid "df6d3979-4323-4d7d-ae8e-078e0b162dcc"}})

>>>pure-handler {:data #ordered/map ([:dashboard #ordered/map ([:cacheKey 134631865] [:budget_periods [#ordered/map ([:cacheKey 134631865_48d8c363-6af4-4a49-91ad-1b701743155f] [:total_price_cents 0] [:main_categories [#ordered/map ([:cacheKey 134631865_48d8c363-6af4-4a49-91ad-1b701743155f_46d19a93-31da-4690-a45f-b11b525ca6ff] [:total_price_cents 0] [:categories [#ordered/map ([:cacheKey 134631865_48d8c363-6af4-4a49-91ad-1b701743155f_46d19a93-31da-4690-a45f-b11b525ca6ff_535b5ca7-c430-4a63-b5bd-09337b01bb7a] [:total_price_cents 0] [:__typename :Category])]] [:__typename :MainCategory])]] [:__typename :BudgetPeriod])]] [:__typename :Dashboard])])}
2023-11-24T14:02:20.291Z NX-41294 DEBUG [leihs.procurement.graphql:64] - result => {:data #ordered/map ([:dashboard #ordered/map ([:cacheKey "134631865"] [:budget_periods [#ordered/map ([:cacheKey "134631865_48d8c363-6af4-4a49-91ad-1b701743155f"] [:total_price_cents "0"] [:main_categories [#ordered/map ([:cacheKey "134631865_48d8c363-6af4-4a49-91ad-1b701743155f_46d19a93-31da-4690-a45f-b11b525ca6ff"] [:total_price_cents "0"] [:categories [#ordered/map ([:cacheKey "134631865_48d8c363-6af4-4a49-91ad-1b701743155f_46d19a93-31da-4690-a45f-b11b525ca6ff_535b5ca7-c430-4a63-b5bd-09337b01bb7a"] [:total_price_cents "0"] [:__typename :Category])]] [:__typename :MainCategory])]] [:__typename :BudgetPeriod])]] [:__typename :Dashboard])])}
2023-11-24T14:02:20.291Z NX-41294 DEBUG [leihs.procurement.authorization:150] - (authorize handler request) => {:body {:data #ordered/map ([:dashboard #ordered/map ([:cacheKey "134631865"] [:budget_periods [#ordered/map ([:cacheKey "134631865_48d8c363-6af4-4a49-91ad-1b701743155f"] [:total_price_cents "0"] [:main_categories [#ordered/map ([:cacheKey "134631865_48d8c363-6af4-4a49-91ad-1b701743155f_46d19a93-31da-4690-a45f-b11b525ca6ff"] [:total_price_cents "0"] [:categories [#ordered/map ([:cacheKey "134631865_48d8c363-6af4-4a49-91ad-1b701743155f_46d19a93-31da-4690-a45f-b11b525ca6ff_535b5ca7-c430-4a63-b5bd-09337b01bb7a"] [:total_price_cents "0"] [:__typename :Category])]] [:__typename :MainCategory])]] [:__typename :BudgetPeriod])]] [:__typename :Dashboard])])}}
2023-11-24T14:02:20.301Z NX-41294 DEBUG [leihs.procurement.permissions.user:72] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_requesters_organizations) (sql/where [:= :procurement_requesters_organizations.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:20.305Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:20.308Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f"]
2023-11-24T14:02:20.310Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE (procurement_category_inspectors.user_id = ? AND procurement_category_inspectors.category_id = ?))) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f" "535b5ca7-c430-4a63-b5bd-09337b01bb7a"]
2023-11-24T14:02:20.311Z NX-41294 DEBUG [leihs.procurement.permissions.user:52] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_viewers) (sql/merge-where [:= :procurement_category_viewers.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_viewers.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_viewers WHERE (procurement_category_viewers.user_id = ? AND procurement_category_viewers.category_id = ?))) AS result " #uuid "3b8e0ffa-8f85-46fd-8ea6-52eb2927015f" "535b5ca7-c430-4a63-b5bd-09337b01bb7a"]

>>>pure-handler {:data #ordered/map ([:requests [#ordered/map ([:id df6d3979-4323-4d7d-ae8e-078e0b162dcc] [:short_id Budget-Period-Past.001] [:user #ordered/map ([:value #ordered/map ([:id 1862f73f-33ba-415e-b3c2-5feb2074752d] [:firstname Lynsey] [:lastname Kertzmann] [:__typename :User])] [:__typename :RequestFieldUser] [:read true] [:write false] [:required true])] [:category #ordered/map ([:read true] [:write false] [:required true] [:value #ordered/map ([:id 535b5ca7-c430-4a63-b5bd-09337b01bb7a] [:name Category C1] [:main_category #ordered/map ([:id 46d19a93-31da-4690-a45f-b11b525ca6ff] [:name Main Category MC1] [:__typename :MainCategory])] [:__typename :Category])] [:__typename :RequestFieldCategory])] [:budget_period #ordered/map ([:read true] [:write false] [:required true] [:value #ordered/map ([:name Budget-Period-Past] [:id 48d8c363-6af4-4a49-91ad-1b701743155f] [:__typename :BudgetPeriod])] [:__typename :RequestFieldBudgetPeriod])] [:article_name #ordered/map ([:value Mediocre Aluminum Shoes] [:__typename :RequestFieldString] [:read true] [:write false] [:required true])] [:model #ordered/map ([:value nil] [:__typename :RequestFieldModel] [:read true] [:write false] [:required false])] [:receiver #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:organization #ordered/map ([:value #ordered/map ([:id 7a59c4fa-a0ed-4abf-aeae-e9c3b3323e95] [:name Beauty & Kids] [:shortname nil] [:department #ordered/map ([:id e20c5fdb-8997-43a6-bebb-133d1466c239] [:name Home, Jewelry & Computers] [:__typename :Organization])] [:__typename :Organization])] [:__typename :RequestFieldOrganization])] [:price_cents #ordered/map ([:value 0] [:__typename :RequestFieldInt] [:read true] [:write false] [:required true])] [:price_currency #ordered/map ([:value CHF] [:__typename :RequestFieldString] [:read true] [:write false] [:required true])] [:requested_quantity #ordered/map ([:read true] [:value 1] [:__typename :RequestFieldInt] [:write false] [:required true])] [:approved_quantity #ordered/map ([:read true] [:value nil] [:__typename :RequestFieldInt] [:write false] [:required false])] [:order_quantity #ordered/map ([:read true] [:value nil] [:__typename :RequestFieldInt] [:write false] [:required false])] [:replacement #ordered/map ([:value true] [:__typename :RequestFieldBoolean] [:read true] [:write false] [:required true])] [:priority #ordered/map ([:value :NORMAL] [:__typename :RequestFieldPriority] [:read true] [:write false] [:required true])] [:state :NEW] [:article_number #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:supplier #ordered/map ([:value nil] [:__typename :RequestFieldSupplier] [:read true] [:write false] [:required false])] [:supplier_name #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:room #ordered/map ([:value #ordered/map ([:id 707541da-817b-402d-86a4-dbd6e72bee46] [:name reception room] [:building #ordered/map ([:id d1f8159a-bf85-4dde-8e9f-5472b1deb309] [:name 9594 Beer Extension] [:__typename :Building])] [:__typename :Room])] [:__typename :RequestFieldRoom] [:read true] [:write false] [:required true])] [:motivation #ordered/map ([:value Corporis commodi provident nam.] [:__typename :RequestFieldString] [:read true] [:write false] [:required true])] [:inspection_comment #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:inspector_priority #ordered/map ([:value :MEDIUM] [:__typename :RequestFieldInspectorPriority] [:read true] [:write false] [:required true])] [:accounting_type #ordered/map ([:value aquisition] [:__typename :RequestFieldString] [:read true] [:write false] [:required true])] [:cost_center #ordered/map ([:value nil] [:__typename :RequestFieldCostCenter] [:read true] [:write false] [:required false])] [:general_ledger_account #ordered/map ([:value nil] [:__typename :RequestFieldGeneralLedgerAccount] [:read true])] [:procurement_account #ordered/map ([:value nil] [:__typename :RequestFieldProcurementAccount] [:read true] [:write false])] [:internal_order_number #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:order_status #ordered/map ([:value :PROCURED] [:__typename :RequestFieldOrderStatus] [:read true] [:write true] [:required true])] [:order_comment #ordered/map ([:value Wurde bestellt und geliefert!] [:__typename :RequestFieldString] [:read true] [:write true] [:required false])] [:__typename :Request] [:template #ordered/map ([:value nil] [:__typename :RequestFieldTemplate])] [:attachments #ordered/map ([:read true] [:write false] [:required false] [:value []] [:__typename :RequestFieldAttachments])] [:actionPermissions #ordered/map ([:delete false] [:edit true] [:moveBudgetPeriod false] [:moveCategory false] [:__typename :RequestActionPermissions])])]] [:main_categories [#ordered/map ([:id 46d19a93-31da-4690-a45f-b11b525ca6ff] [:name Main Category MC1] [:categories [#ordered/map ([:id 535b5ca7-c430-4a63-b5bd-09337b01bb7a] [:name Category C1] [:__typename :Category])]] [:__typename :MainCategory])]] [:budget_periods []] [:settings #ordered/map ([:inspection_comments [Eum architecto minus magnam.]] [:__typename :ProcurementSettings])])}
2023-11-24T14:02:20.332Z NX-41294 DEBUG [leihs.procurement.graphql:64] - result => {:data #ordered/map ([:requests [#ordered/map ([:id "df6d3979-4323-4d7d-ae8e-078e0b162dcc"] [:short_id "Budget-Period-Past.001"] [:user #ordered/map ([:value #ordered/map ([:id "1862f73f-33ba-415e-b3c2-5feb2074752d"] [:firstname "Lynsey"] [:lastname "Kertzmann"] [:__typename :User])] [:__typename :RequestFieldUser] [:read true] [:write false] [:required true])] [:category #ordered/map ([:read true] [:write false] [:required true] [:value #ordered/map ([:id "535b5ca7-c430-4a63-b5bd-09337b01bb7a"] [:name "Category C1"] [:main_category #ordered/map ([:id "46d19a93-31da-4690-a45f-b11b525ca6ff"] [:name "Main Category MC1"] [:__typename :MainCategory])] [:__typename :Category])] [:__typename :RequestFieldCategory])] [:budget_period #ordered/map ([:read true] [:write false] [:required true] [:value #ordered/map ([:name "Budget-Period-Past"] [:id "48d8c363-6af4-4a49-91ad-1b701743155f"] [:__typename :BudgetPeriod])] [:__typename :RequestFieldBudgetPeriod])] [:article_name #ordered/map ([:value "Mediocre Aluminum Shoes"] [:__typename :RequestFieldString] [:read true] [:write false] [:required true])] [:model #ordered/map ([:value nil] [:__typename :RequestFieldModel] [:read true] [:write false] [:required false])] [:receiver #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:organization #ordered/map ([:value #ordered/map ([:id "7a59c4fa-a0ed-4abf-aeae-e9c3b3323e95"] [:name "Beauty & Kids"] [:shortname nil] [:department #ordered/map ([:id "e20c5fdb-8997-43a6-bebb-133d1466c239"] [:name "Home, Jewelry & Computers"] [:__typename :Organization])] [:__typename :Organization])] [:__typename :RequestFieldOrganization])] [:price_cents #ordered/map ([:value 0] [:__typename :RequestFieldInt] [:read true] [:write false] [:required true])] [:price_currency #ordered/map ([:value "CHF"] [:__typename :RequestFieldString] [:read true] [:write false] [:required true])] [:requested_quantity #ordered/map ([:read true] [:value 1] [:__typename :RequestFieldInt] [:write false] [:required true])] [:approved_quantity #ordered/map ([:read true] [:value nil] [:__typename :RequestFieldInt] [:write false] [:required false])] [:order_quantity #ordered/map ([:read true] [:value nil] [:__typename :RequestFieldInt] [:write false] [:required false])] [:replacement #ordered/map ([:value true] [:__typename :RequestFieldBoolean] [:read true] [:write false] [:required true])] [:priority #ordered/map ([:value :NORMAL] [:__typename :RequestFieldPriority] [:read true] [:write false] [:required true])] [:state :NEW] [:article_number #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:supplier #ordered/map ([:value nil] [:__typename :RequestFieldSupplier] [:read true] [:write false] [:required false])] [:supplier_name #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:room #ordered/map ([:value #ordered/map ([:id "707541da-817b-402d-86a4-dbd6e72bee46"] [:name "reception room"] [:building #ordered/map ([:id "d1f8159a-bf85-4dde-8e9f-5472b1deb309"] [:name "9594 Beer Extension"] [:__typename :Building])] [:__typename :Room])] [:__typename :RequestFieldRoom] [:read true] [:write false] [:required true])] [:motivation #ordered/map ([:value "Corporis commodi provident nam."] [:__typename :RequestFieldString] [:read true] [:write false] [:required true])] [:inspection_comment #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:inspector_priority #ordered/map ([:value :MEDIUM] [:__typename :RequestFieldInspectorPriority] [:read true] [:write false] [:required true])] [:accounting_type #ordered/map ([:value "aquisition"] [:__typename :RequestFieldString] [:read true] [:write false] [:required true])] [:cost_center #ordered/map ([:value nil] [:__typename :RequestFieldCostCenter] [:read true] [:write false] [:required false])] [:general_ledger_account #ordered/map ([:value nil] [:__typename :RequestFieldGeneralLedgerAccount] [:read true])] [:procurement_account #ordered/map ([:value nil] [:__typename :RequestFieldProcurementAccount] [:read true] [:write false])] [:internal_order_number #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:order_status #ordered/map ([:value :PROCURED] [:__typename :RequestFieldOrderStatus] [:read true] [:write true] [:required true])] [:order_comment #ordered/map ([:value "Wurde bestellt und geliefert!"] [:__typename :RequestFieldString] [:read true] [:write true] [:required false])] [:__typename :Request] [:template #ordered/map ([:value nil] [:__typename :RequestFieldTemplate])] [:attachments #ordered/map ([:read true] [:write false] [:required false] [:value []] [:__typename :RequestFieldAttachments])] [:actionPermissions #ordered/map ([:delete false] [:edit true] [:moveBudgetPeriod false] [:moveCategory false] [:__typename :RequestActionPermissions])])]] [:main_categories [#ordered/map ([:id "46d19a93-31da-4690-a45f-b11b525ca6ff"] [:name "Main Category MC1"] [:categories [#ordered/map ([:id "535b5ca7-c430-4a63-b5bd-09337b01bb7a"] [:name "Category C1"] [:__typename :Category])]] [:__typename :MainCategory])]] [:budget_periods []] [:settings #ordered/map ([:inspection_comments ["Eum architecto minus magnam."]] [:__typename :ProcurementSettings])])}
2023-11-24T14:02:20.343Z NX-41294 DEBUG [leihs.procurement.authorization:150] - (authorize handler request) => {:body {:data #ordered/map ([:requests [#ordered/map ([:id "df6d3979-4323-4d7d-ae8e-078e0b162dcc"] [:short_id "Budget-Period-Past.001"] [:user #ordered/map ([:value #ordered/map ([:id "1862f73f-33ba-415e-b3c2-5feb2074752d"] [:firstname "Lynsey"] [:lastname "Kertzmann"] [:__typename :User])] [:__typename :RequestFieldUser] [:read true] [:write false] [:required true])] [:category #ordered/map ([:read true] [:write false] [:required true] [:value #ordered/map ([:id "535b5ca7-c430-4a63-b5bd-09337b01bb7a"] [:name "Category C1"] [:main_category #ordered/map ([:id "46d19a93-31da-4690-a45f-b11b525ca6ff"] [:name "Main Category MC1"] [:__typename :MainCategory])] [:__typename :Category])] [:__typename :RequestFieldCategory])] [:budget_period #ordered/map ([:read true] [:write false] [:required true] [:value #ordered/map ([:name "Budget-Period-Past"] [:id "48d8c363-6af4-4a49-91ad-1b701743155f"] [:__typename :BudgetPeriod])] [:__typename :RequestFieldBudgetPeriod])] [:article_name #ordered/map ([:value "Mediocre Aluminum Shoes"] [:__typename :RequestFieldString] [:read true] [:write false] [:required true])] [:model #ordered/map ([:value nil] [:__typename :RequestFieldModel] [:read true] [:write false] [:required false])] [:receiver #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:organization #ordered/map ([:value #ordered/map ([:id "7a59c4fa-a0ed-4abf-aeae-e9c3b3323e95"] [:name "Beauty & Kids"] [:shortname nil] [:department #ordered/map ([:id "e20c5fdb-8997-43a6-bebb-133d1466c239"] [:name "Home, Jewelry & Computers"] [:__typename :Organization])] [:__typename :Organization])] [:__typename :RequestFieldOrganization])] [:price_cents #ordered/map ([:value 0] [:__typename :RequestFieldInt] [:read true] [:write false] [:required true])] [:price_currency #ordered/map ([:value "CHF"] [:__typename :RequestFieldString] [:read true] [:write false] [:required true])] [:requested_quantity #ordered/map ([:read true] [:value 1] [:__typename :RequestFieldInt] [:write false] [:required true])] [:approved_quantity #ordered/map ([:read true] [:value nil] [:__typename :RequestFieldInt] [:write false] [:required false])] [:order_quantity #ordered/map ([:read true] [:value nil] [:__typename :RequestFieldInt] [:write false] [:required false])] [:replacement #ordered/map ([:value true] [:__typename :RequestFieldBoolean] [:read true] [:write false] [:required true])] [:priority #ordered/map ([:value :NORMAL] [:__typename :RequestFieldPriority] [:read true] [:write false] [:required true])] [:state :NEW] [:article_number #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:supplier #ordered/map ([:value nil] [:__typename :RequestFieldSupplier] [:read true] [:write false] [:required false])] [:supplier_name #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:room #ordered/map ([:value #ordered/map ([:id "707541da-817b-402d-86a4-dbd6e72bee46"] [:name "reception room"] [:building #ordered/map ([:id "d1f8159a-bf85-4dde-8e9f-5472b1deb309"] [:name "9594 Beer Extension"] [:__typename :Building])] [:__typename :Room])] [:__typename :RequestFieldRoom] [:read true] [:write false] [:required true])] [:motivation #ordered/map ([:value "Corporis commodi provident nam."] [:__typename :RequestFieldString] [:read true] [:write false] [:required true])] [:inspection_comment #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:inspector_priority #ordered/map ([:value :MEDIUM] [:__typename :RequestFieldInspectorPriority] [:read true] [:write false] [:required true])] [:accounting_type #ordered/map ([:value "aquisition"] [:__typename :RequestFieldString] [:read true] [:write false] [:required true])] [:cost_center #ordered/map ([:value nil] [:__typename :RequestFieldCostCenter] [:read true] [:write false] [:required false])] [:general_ledger_account #ordered/map ([:value nil] [:__typename :RequestFieldGeneralLedgerAccount] [:read true])] [:procurement_account #ordered/map ([:value nil] [:__typename :RequestFieldProcurementAccount] [:read true] [:write false])] [:internal_order_number #ordered/map ([:value nil] [:__typename :RequestFieldString] [:read true] [:write false] [:required false])] [:order_status #ordered/map ([:value :PROCURED] [:__typename :RequestFieldOrderStatus] [:read true] [:write true] [:required true])] [:order_comment #ordered/map ([:value "Wurde bestellt und geliefert!"] [:__typename :RequestFieldString] [:read true] [:write true] [:required false])] [:__typename :Request] [:template #ordered/map ([:value nil] [:__typename :RequestFieldTemplate])] [:attachments #ordered/map ([:read true] [:write false] [:required false] [:value []] [:__typename :RequestFieldAttachments])] [:actionPermissions #ordered/map ([:delete false] [:edit true] [:moveBudgetPeriod false] [:moveCategory false] [:__typename :RequestActionPermissions])])]] [:main_categories [#ordered/map ([:id "46d19a93-31da-4690-a45f-b11b525ca6ff"] [:name "Main Category MC1"] [:categories [#ordered/map ([:id "535b5ca7-c430-4a63-b5bd-09337b01bb7a"] [:name "Category C1"] [:__typename :Category])]] [:__typename :MainCategory])]] [:budget_periods []] [:settings #ordered/map ([:inspection_comments ["Eum architecto minus magnam."]] [:__typename :ProcurementSettings])])}}


