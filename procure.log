# java_leihs-procure-server env check via asdf v0.13.1
# java_leihs-procure-server env skipped update; touch .tool-versions or remove /var/folders/jl/49spzkdd2v3cdz37fgmp0ddr6cj76v/T/asdf_cache_java_leihs-procure-server to force update
# clojure_leihs-procure-server env check via asdf v0.13.1
# clojure_leihs-procure-server env skipped update; touch .tool-versions or remove /var/folders/jl/49spzkdd2v3cdz37fgmp0ddr6cj76v/T/asdf_cache_clojure_leihs-procure-server to force update
Warning: environ value /Users/mradl/.asdf/installs/java/zulu-11.60.19 for key :java-home has been overwritten with /Users/mradl/.asdf/installs/java/zulu-11.60.19/zulu-11.jdk/Contents/Home
>o> conc concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))
2023-11-29T17:30:52.377Z NX-41294 WARN [leihs.core.release:13] - Failed to read releases.yml, returning bogus value 
2023-11-29T17:30:52.936Z NX-41294 INFO [leihs.core.logging:36] - initializing logging  {:min-level [[#{"leihs.procurement" "leihs.procurement.resources.*" "leihs.procurement.permissions.*" "leihs.procurement.authorization"} :debug] [#{"com.zaxxer.hikari.*" "leihs.*"} :info] [#{"*"} :warn]], :log-level nil}
2023-11-29T17:30:52.945Z NX-41294 INFO [leihs.core.logging:38] - initialized logging  {:min-level [[#{"leihs.procurement" "leihs.procurement.resources.*" "leihs.procurement.permissions.*" "leihs.procurement.authorization"} :debug] [#{"com.zaxxer.hikari.*" "leihs.*"} :info] [#{"*"} :warn]], :ns-filter #{"*"}, :middleware [], :timestamp-opts {:pattern :iso8601, :locale :jvm-default, :timezone :utc}, :output-fn #object[taoensso.timbre$default_output_fn 0x720b1daf "taoensso.timbre$default_output_fn@720b1daf"], :appenders {:println {:enabled? true, :fn #object[taoensso.timbre.appenders.core$println_appender$fn__3459 0x3114a0d9 "taoensso.timbre.appenders.core$println_appender$fn__3459@3114a0d9"]}}, :_init-config {:loaded-from-source :default, :compile-time-config {:min-level nil, :ns-pattern "*"}}, :log-level nil}
2023-11-29T17:30:52.948Z NX-41294 INFO [leihs.procurement.main:50] - main ("--dev-mode" "true" "--repl" "true" "run" "--db-port" "5415" "--db-name" "leihs_test")
2023-11-29T17:30:52.960Z NX-41294 INFO [leihs.core.repl:62] - init {:dev-mode true, :repl true, :repl-bind "localhost", :repl-port 60584, :repl-port-file ".nrepl-port"}
2023-11-29T17:30:52.962Z NX-41294 INFO [leihs.core.repl:70] - starting nREPL server  60584 localhost
2023-11-29T17:30:52.981Z NX-41294 INFO [leihs.core.repl:75] - started nREPL server 
2023-11-29T17:30:52.986Z NX-41294 INFO [leihs.procurement.run:326] - Invoking run with options:  {:db-host localhost, :db-max-pool-size 16, :db-min-pool-size 2, :db-name leihs_test, :db-password leihs, :db-port 5415, :db-user leihs, :dev-mode true, :http-host localhost, :http-max-threads 8, :http-min-threads 1, :http-port 3230, :http-queue-capacity 640, :http-thread-keep-alive-seconds 10, :http-worker-prefix leihs-service-http-worker-, :pid-file nil, :repl true, :repl-bind localhost, :repl-port 60584, :repl-port-file .nrepl-port}
2023-11-29T17:30:52.986Z NX-41294 INFO [leihs.core.shutdown:20] - PID 91368
2023-11-29T17:30:53.011Z NX-41294 INFO [leihs.core.shutdown:29] - Registering SIGTERM handler for shutdown.
2023-11-29T17:30:53.063Z NX-41294 INFO [leihs.core.graphql:17] - Initialized graphQL schema.
2023-11-29T17:30:53.065Z NX-41294 INFO [leihs.core.db:220] - Initializing db  {:db-name "leihs_test", :db-port 5415, :db-host "localhost", :db-user "leihs", :db-password "leihs", :db-min-pool-size 2, :db-max-pool-size 16}
2023-11-29T17:30:53.071Z NX-41294 INFO [com.zaxxer.hikari.HikariDataSource:80] - db-pool - Starting...
2023-11-29T17:30:53.152Z NX-41294 INFO [com.zaxxer.hikari.pool.HikariPool:565] - db-pool - Added connection org.postgresql.jdbc.PgConnection@2d8328e1
2023-11-29T17:30:53.158Z NX-41294 INFO [com.zaxxer.hikari.HikariDataSource:82] - db-pool - Start completed.
2023-11-29T17:30:53.158Z NX-41294 INFO [leihs.core.db:222] - Initialized db  {:datasource #object[com.zaxxer.hikari.HikariDataSource 0x6df8cf94 "HikariDataSource (db-pool)"]}
2023-11-29T17:30:53.159Z NX-41294 INFO [leihs.core.db:223] - Initializing ds-next  {:db-name "leihs_test", :db-port 5415, :db-host "localhost", :db-user "leihs", :db-password "leihs", :db-min-pool-size 2, :db-max-pool-size 16}
2023-11-29T17:30:53.173Z NX-41294 INFO [com.zaxxer.hikari.HikariDataSource:110] - HikariPool-1 - Starting...
2023-11-29T17:30:53.183Z NX-41294 INFO [com.zaxxer.hikari.pool.HikariPool:565] - HikariPool-1 - Added connection org.postgresql.jdbc.PgConnection@3a67a02c
2023-11-29T17:30:53.184Z NX-41294 INFO [com.zaxxer.hikari.HikariDataSource:123] - HikariPool-1 - Start completed.
2023-11-29T17:30:53.190Z NX-41294 INFO [leihs.core.db:225] - Initialized ds-next  #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x7853e277 "HikariDataSource (HikariPool-1)"], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x5092222d "next.jdbc.result_set$as_unqualified_lower_maps@5092222d"]}}
2023-11-29T17:30:53.197Z NX-41294 INFO [leihs.core.http-server:101] - starting http-server  {:port 3230, :ip "localhost", :pool {:queue #object[java.util.concurrent.ArrayBlockingQueue 0x1f18b4bd "[]"], :pool #object[java.util.concurrent.ThreadPoolExecutor 0x6ffaa6e0 "java.util.concurrent.ThreadPoolExecutor@6ffaa6e0[Running, pool size = 0, active threads = 0, queued tasks = 0, completed tasks = 0]"]}}
2023-11-29T17:30:53.208Z NX-41294 INFO [leihs.core.http-server:104] - started http-server 
>>> authenticate::skip= true  handler-key= :sign-in
>>> authenticate::authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-29T17:05:24.895916Z", :id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :user_session_id #uuid "5ec785a6-4a10-4fe2-a704-1f89fda3c176", :scope_system_admin_read false, :access-rights (), :user_id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}

>> authorize >

>> authorize::handler > #object[leihs.core.locale$wrap$fn__44320 0x2ac0f7a5 leihs.core.locale$wrap$fn__44320@2ac0f7a5]

>> authorize::request > {:authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-29T17:05:24.895916Z", :id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :user_session_id #uuid "5ec785a6-4a10-4fe2-a704-1f89fda3c176", :scope_system_admin_read false, :access-rights (), :user_id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}, :cookies {Idea-d8c89f6f {:value 5d06a449-7aaa-4285-b65a-53c2ae3cb299}, leihs-anti-csrf-token {:value 65184e75-5146-4915-8494-09445d034d15}, leihs-user-session {:value eb7994ee-1e47-4c67-aab6-d6006debd5b3}}, :remote-addr 127.0.0.1, :start-time 92591404552500, :params {:return-to /procure}, :settings {:email_sending_enabled false, :sessions_max_lifetime_secs 432000, :smtp_default_from_address your.lending.desk@example.com, :public_image_caching_enabled true, :sessions_force_secure false, :deliver_received_order_notifications false, :external_base_url nil, :sessions_force_uniqueness false, :email_signature Cheers,}, :tx-next #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x7853e277 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x5092222d next.jdbc.result_set$as_unqualified_lower_maps@5092222d]}}, :query-params-raw {:return-to /procure}, :route-params nil, :headers {sec-fetch-site none, sec-ch-ua-mobile ?0, host localhost:3230, user-agent Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36, cookie Idea-d8c89f6f=5d06a449-7aaa-4285-b65a-53c2ae3cb299; leihs-anti-csrf-token=65184e75-5146-4915-8494-09445d034d15; leihs-user-session=eb7994ee-1e47-4c67-aab6-d6006debd5b3, sec-fetch-user ?1, sec-ch-ua "Google Chrome";v="119", "Chromium";v="119", "Not?A_Brand";v="24", sec-ch-ua-platform "macOS", connection keep-alive, upgrade-insecure-requests 1, pragma no-cache, accept text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7, accept-language de-DE,de;q=0.9,en-US;q=0.8,en;q=0.7, sec-fetch-dest document, accept-encoding gzip, deflate, br, sec-fetch-mode navigate, cache-control no-cache}, :async-channel #object[org.httpkit.server.AsyncChannel 0x7211c408 /127.0.0.1:3230<->/127.0.0.1:65269], :server-port 3230, :params-raw {:return-to /procure}, :tx {:datasource #object[com.zaxxer.hikari.HikariDataSource 0x6df8cf94 HikariDataSource (db-pool)]}, :content-length 0, :form-params {}, :websocket? false, :query-params {:return-to /procure}, :content-type nil, :form-params-raw {}, :character-encoding utf8, :uri /sign-in, :server-name localhost, :handler-key :sign-in, :query-string return-to=%2Fprocure, :body nil, :graphql-schema #CompiledSchema<>, :handler #object[compojure.core$routes$fn__27950 0x3e4c591e compojure.core$routes$fn__27950@3e4c591e], :multipart-params {}, :scheme :http, :request-method :get, :accept {:mime :html, :charset nil, :encoding nil, :language nil}}

>> authorize::handler-key >> :sign-in

> 1 anti-csrf-token >  65184e75-5146-4915-8494-09445d034d15

> 1 anti-csrf-token class >  java.lang.String

> 2 anti-csrf-token-new >  nil
>>> authenticate::skip= nil  handler-key= :procurement
>>> authenticate::authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-29T17:05:24.895916Z", :id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :user_session_id #uuid "5ec785a6-4a10-4fe2-a704-1f89fda3c176", :scope_system_admin_read false, :access-rights (), :user_id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}

>> authorize >

>> authorize::handler > #object[leihs.core.locale$wrap$fn__44320 0x2ac0f7a5 leihs.core.locale$wrap$fn__44320@2ac0f7a5]

>> authorize::request > {:authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-29T17:05:24.895916Z", :id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :user_session_id #uuid "5ec785a6-4a10-4fe2-a704-1f89fda3c176", :scope_system_admin_read false, :access-rights (), :user_id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}, :cookies {Idea-d8c89f6f {:value 5d06a449-7aaa-4285-b65a-53c2ae3cb299}, leihs-anti-csrf-token {:value 65184e75-5146-4915-8494-09445d034d15}, leihs-user-session {:value eb7994ee-1e47-4c67-aab6-d6006debd5b3}}, :remote-addr 127.0.0.1, :start-time 92591538939166, :params {}, :settings {:email_sending_enabled false, :sessions_max_lifetime_secs 432000, :smtp_default_from_address your.lending.desk@example.com, :public_image_caching_enabled true, :sessions_force_secure false, :deliver_received_order_notifications false, :external_base_url nil, :sessions_force_uniqueness false, :email_signature Cheers,}, :tx-next #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x7853e277 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x5092222d next.jdbc.result_set$as_unqualified_lower_maps@5092222d]}}, :query-params-raw {}, :route-params nil, :headers {sec-fetch-site none, sec-ch-ua-mobile ?0, host localhost:3230, user-agent Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36, cookie Idea-d8c89f6f=5d06a449-7aaa-4285-b65a-53c2ae3cb299; leihs-anti-csrf-token=65184e75-5146-4915-8494-09445d034d15; leihs-user-session=eb7994ee-1e47-4c67-aab6-d6006debd5b3, sec-fetch-user ?1, sec-ch-ua "Google Chrome";v="119", "Chromium";v="119", "Not?A_Brand";v="24", sec-ch-ua-platform "macOS", connection keep-alive, upgrade-insecure-requests 1, pragma no-cache, accept text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7, accept-language de-DE,de;q=0.9,en-US;q=0.8,en;q=0.7, sec-fetch-dest document, accept-encoding gzip, deflate, br, sec-fetch-mode navigate, cache-control no-cache}, :async-channel #object[org.httpkit.server.AsyncChannel 0x2724fa66 /127.0.0.1:3230<->/127.0.0.1:65269], :server-port 3230, :params-raw {}, :tx {:datasource #object[com.zaxxer.hikari.HikariDataSource 0x6df8cf94 HikariDataSource (db-pool)]}, :content-length 0, :form-params {}, :websocket? false, :query-params {}, :content-type nil, :form-params-raw {}, :character-encoding utf8, :uri /procure, :server-name localhost, :handler-key :procurement, :query-string nil, :body nil, :graphql-schema #CompiledSchema<>, :handler #object[leihs.procurement.backend.html$not_found_handler 0x622660e6 leihs.procurement.backend.html$not_found_handler@622660e6], :multipart-params {}, :scheme :http, :request-method :get, :accept {:mime :html, :charset nil, :encoding nil, :language nil}}

>> authorize::handler-key >> :procurement
2023-11-29T17:31:01.171Z NX-41294 DEBUG [leihs.procurement.permissions.user:24] - (-> (sql/select [true :has_entry]) (sql/from :procurement_admins) (sql/where [:= :user_id [:cast (:user_id auth-entity) :uuid]]) sql-format) => ["SELECT TRUE AS has_entry FROM procurement_admins WHERE user_id = CAST(? AS UUID)" #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-29T17:31:01.176Z NX-41294 DEBUG [leihs.procurement.permissions.user:57] - query => ["SELECT TRUE AS has_entry FROM procurement_category_inspectors WHERE user_id = ?" #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-29T17:31:01.177Z NX-41294 DEBUG [leihs.procurement.permissions.user:79] - query => ["SELECT TRUE AS has_entry FROM procurement_category_viewers WHERE user_id = ?" #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-29T17:31:01.180Z NX-41294 DEBUG [leihs.procurement.permissions.user:87] - (-> (sql/select [true :has_entry]) (sql/from :procurement_requesters_organizations) (sql/where [:= :user_id [:cast (:user_id auth-entity) :uuid]]) sql-format) => ["SELECT TRUE AS has_entry FROM procurement_requesters_organizations WHERE user_id = CAST(? AS UUID)" #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]

> 1 anti-csrf-token >  65184e75-5146-4915-8494-09445d034d15

> 1 anti-csrf-token class >  java.lang.String

> 2 anti-csrf-token-new >  nil
>>> authenticate::skip= nil  handler-key= :graphql
>>> authenticate::authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-29T17:05:24.895916Z", :id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :user_session_id #uuid "5ec785a6-4a10-4fe2-a704-1f89fda3c176", :scope_system_admin_read false, :access-rights (), :user_id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}

>> authorize >

>> authorize::handler > #object[leihs.core.locale$wrap$fn__44320 0x2ac0f7a5 leihs.core.locale$wrap$fn__44320@2ac0f7a5]

>> authorize::request > {:authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-29T17:05:24.895916Z", :id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :user_session_id #uuid "5ec785a6-4a10-4fe2-a704-1f89fda3c176", :scope_system_admin_read false, :access-rights (), :user_id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}, :cookies {Idea-d8c89f6f {:value 5d06a449-7aaa-4285-b65a-53c2ae3cb299}, leihs-anti-csrf-token {:value 65184e75-5146-4915-8494-09445d034d15}, leihs-user-session {:value eb7994ee-1e47-4c67-aab6-d6006debd5b3}}, :remote-addr 127.0.0.1, :start-time 92591771584000, :params {}, :settings {:email_sending_enabled false, :sessions_max_lifetime_secs 432000, :smtp_default_from_address your.lending.desk@example.com, :public_image_caching_enabled true, :sessions_force_secure false, :deliver_received_order_notifications false, :external_base_url nil, :sessions_force_uniqueness false, :email_signature Cheers,}, :tx-next #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x7853e277 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x5092222d next.jdbc.result_set$as_unqualified_lower_maps@5092222d]}}, :query-params-raw {}, :route-params nil, :headers {origin http://localhost:3230, sec-fetch-site same-origin, sec-ch-ua-mobile ?0, host localhost:3230, user-agent Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36, content-type application/json, cookie Idea-d8c89f6f=5d06a449-7aaa-4285-b65a-53c2ae3cb299; leihs-anti-csrf-token=65184e75-5146-4915-8494-09445d034d15; leihs-user-session=eb7994ee-1e47-4c67-aab6-d6006debd5b3, content-length 502, sec-ch-ua "Google Chrome";v="119", "Chromium";v="119", "Not?A_Brand";v="24", sec-ch-ua-platform "macOS", referer http://localhost:3230/procure, connection keep-alive, pragma no-cache, x-csrf-token 65184e75-5146-4915-8494-09445d034d15, accept application/json, accept-language de-DE,de;q=0.9,en-US;q=0.8,en;q=0.7, sec-fetch-dest empty, accept-encoding gzip, deflate, br, sec-fetch-mode cors, cache-control no-cache}, :async-channel #object[org.httpkit.server.AsyncChannel 0x16a183b8 /127.0.0.1:3230<->/127.0.0.1:65269], :server-port 3230, :params-raw {}, :tx {:datasource #object[com.zaxxer.hikari.HikariDataSource 0x6df8cf94 HikariDataSource (db-pool)]}, :content-length 502, :form-params {}, :websocket? false, :query-params {}, :content-type application/json, :form-params-raw {}, :character-encoding utf8, :uri /procure/graphql, :server-name localhost, :handler-key :graphql, :query-string nil, :body {:operationName me, :variables {}, :query query me {
  current_user {
    navbarProps
    user {
      id
      firstname
      lastname
      permissions {
        isAdmin
        isRequester
        isInspectorForCategories {
          id
          __typename
        }
        isViewerForCategories {
          id
          __typename
        }
        __typename
      }
      __typename
    }
    __typename
  }
  settings {
    contact_url
    __typename
  }
}
}, :graphql-schema #CompiledSchema<>, :handler #object[leihs.procurement.graphql$handler 0x7a1e88b5 leihs.procurement.graphql$handler@7a1e88b5], :multipart-params {}, :scheme :http, :request-method :post, :accept {:mime :json, :charset nil, :encoding nil, :language nil}}

>> authorize::handler-key >> :graphql
2023-11-29T17:31:01.439Z NX-41294 DEBUG [leihs.procurement.permissions.user:24] - (-> (sql/select [true :has_entry]) (sql/from :procurement_admins) (sql/where [:= :user_id [:cast (:user_id auth-entity) :uuid]]) sql-format) => ["SELECT TRUE AS has_entry FROM procurement_admins WHERE user_id = CAST(? AS UUID)" #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-29T17:31:01.440Z NX-41294 DEBUG [leihs.procurement.permissions.user:57] - query => ["SELECT TRUE AS has_entry FROM procurement_category_inspectors WHERE user_id = ?" #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-29T17:31:01.440Z NX-41294 DEBUG [leihs.procurement.permissions.user:79] - query => ["SELECT TRUE AS has_entry FROM procurement_category_viewers WHERE user_id = ?" #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-29T17:31:01.441Z NX-41294 DEBUG [leihs.procurement.permissions.user:87] - (-> (sql/select [true :has_entry]) (sql/from :procurement_requesters_organizations) (sql/where [:= :user_id [:cast (:user_id auth-entity) :uuid]]) sql-format) => ["SELECT TRUE AS has_entry FROM procurement_requesters_organizations WHERE user_id = CAST(? AS UUID)" #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]

> 1 anti-csrf-token >  65184e75-5146-4915-8494-09445d034d15

> 1 anti-csrf-token class >  java.lang.String

> 2 anti-csrf-token-new >  nil
pure-handler >> 2

>>> queryStr  query me {
  current_user {
    navbarProps
    user {
      id
      firstname
      lastname
      permissions {
        isAdmin
        isRequester
        isInspectorForCategories {
          id
          __typename
        }
        isViewerForCategories {
          id
          __typename
        }
        __typename
      }
      __typename
    }
    __typename
  }
  settings {
    contact_url
    __typename
  }
}


>>vars1 {}

>>vars2 {} 

>>>1 #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"
2023-11-29T17:31:01.455Z NX-41294 DEBUG [leihs.procurement.resources.user:75] - id => #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"
>>>2 {:id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :firstname Procurement, :lastname Admin}
>>oida>> #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"
2023-11-29T17:31:01.459Z NX-41294 DEBUG [leihs.procurement.resources.saved-filters:19] - (-> (sql/select :*) (sql/from :procurement_users_filters) (sql/where [:= :user_id [:cast user-id :uuid]]) sql-format) => ["SELECT * FROM procurement_users_filters WHERE user_id = CAST(? AS UUID)" #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
>>>3 nil
2023-11-29T17:31:01.483Z NX-41294 DEBUG [leihs.procurement.permissions.user:24] - (-> (sql/select [true :has_entry]) (sql/from :procurement_admins) (sql/where [:= :user_id [:cast (:user_id auth-entity) :uuid]]) sql-format) => ["SELECT TRUE AS has_entry FROM procurement_admins WHERE user_id = CAST(? AS UUID)" #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-29T17:31:01.484Z NX-41294 DEBUG [leihs.procurement.permissions.user:87] - (-> (sql/select [true :has_entry]) (sql/from :procurement_requesters_organizations) (sql/where [:= :user_id [:cast (:user_id auth-entity) :uuid]]) sql-format) => ["SELECT TRUE AS has_entry FROM procurement_requesters_organizations WHERE user_id = CAST(? AS UUID)" #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]

>>>pure-handler {:data #ordered/map ([:current_user #ordered/map ([:navbarProps {"csrfToken":{"value":"65184e75-5146-4915-8494-09445d034d15","name":"csrf-token"},"config":{"appTitle":"leihs","appColor":"gray","me":{"user":{"id":"e68ca036-dced-4666-b9e9-a6b55119f013","firstname":"Procurement","lastname":"Admin","login":null,"email":"jimmie@goyette.com"}},"subApps":{"borrow":false,"admin":false,"procure":false,"manage":[]},"locales":[{"name":"English (UK)","locale":"en-GB","active":true,"isDefault":true,"isSelected":true},{"name":"English (US)","locale":"en-US","active":true,"isDefault":false,"isSelected":false},{"name":"Deutsch","locale":"de-CH","active":true,"isDefault":false,"isSelected":false},{"name":"Züritüütsch","locale":"gsw-CH","active":true,"isDefault":false,"isSelected":false}]}}] [:user #ordered/map ([:id e68ca036-dced-4666-b9e9-a6b55119f013] [:firstname Procurement] [:lastname Admin] [:permissions #ordered/map ([:isAdmin true] [:isRequester false] [:isInspectorForCategories []] [:isViewerForCategories []] [:__typename :UserPermissions])] [:__typename :User])] [:__typename :CurrentUser])] [:settings #ordered/map ([:contact_url nil] [:__typename :ProcurementSettings])])}
>>> authenticate::skip= nil  handler-key= :graphql
>>> authenticate::authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-29T17:05:24.895916Z", :id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :user_session_id #uuid "5ec785a6-4a10-4fe2-a704-1f89fda3c176", :scope_system_admin_read false, :access-rights (), :user_id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}

>> authorize >

>> authorize::handler > #object[leihs.core.locale$wrap$fn__44320 0x2ac0f7a5 leihs.core.locale$wrap$fn__44320@2ac0f7a5]

>> authorize::request > {:authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-29T17:05:24.895916Z", :id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :user_session_id #uuid "5ec785a6-4a10-4fe2-a704-1f89fda3c176", :scope_system_admin_read false, :access-rights (), :user_id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}, :cookies {Idea-d8c89f6f {:value 5d06a449-7aaa-4285-b65a-53c2ae3cb299}, leihs-anti-csrf-token {:value 65184e75-5146-4915-8494-09445d034d15}, leihs-user-session {:value eb7994ee-1e47-4c67-aab6-d6006debd5b3}}, :remote-addr 127.0.0.1, :start-time 92591916535833, :params {}, :settings {:email_sending_enabled false, :sessions_max_lifetime_secs 432000, :smtp_default_from_address your.lending.desk@example.com, :public_image_caching_enabled true, :sessions_force_secure false, :deliver_received_order_notifications false, :external_base_url nil, :sessions_force_uniqueness false, :email_signature Cheers,}, :tx-next #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x7853e277 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x5092222d next.jdbc.result_set$as_unqualified_lower_maps@5092222d]}}, :query-params-raw {}, :route-params nil, :headers {origin http://localhost:3230, sec-fetch-site same-origin, sec-ch-ua-mobile ?0, host localhost:3230, user-agent Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36, content-type application/json, cookie Idea-d8c89f6f=5d06a449-7aaa-4285-b65a-53c2ae3cb299; leihs-anti-csrf-token=65184e75-5146-4915-8494-09445d034d15; leihs-user-session=eb7994ee-1e47-4c67-aab6-d6006debd5b3, content-length 502, sec-ch-ua "Google Chrome";v="119", "Chromium";v="119", "Not?A_Brand";v="24", sec-ch-ua-platform "macOS", referer http://localhost:3230/procure/requests, connection keep-alive, pragma no-cache, x-csrf-token 65184e75-5146-4915-8494-09445d034d15, accept application/json, accept-language de-DE,de;q=0.9,en-US;q=0.8,en;q=0.7, sec-fetch-dest empty, accept-encoding gzip, deflate, br, sec-fetch-mode cors, cache-control no-cache}, :async-channel #object[org.httpkit.server.AsyncChannel 0x781757d9 /127.0.0.1:3230<->/127.0.0.1:65279], :server-port 3230, :params-raw {}, :tx {:datasource #object[com.zaxxer.hikari.HikariDataSource 0x6df8cf94 HikariDataSource (db-pool)]}, :content-length 502, :form-params {}, :websocket? false, :query-params {}, :content-type application/json, :form-params-raw {}, :character-encoding utf8, :uri /procure/graphql, :server-name localhost, :handler-key :graphql, :query-string nil, :body {:operationName me, :variables {}, :query query me {
  current_user {
    navbarProps
    user {
      id
      firstname
      lastname
      permissions {
        isAdmin
        isRequester
        isInspectorForCategories {
          id
          __typename
        }
        isViewerForCategories {
          id
          __typename
        }
        __typename
      }
      __typename
    }
    __typename
  }
  settings {
    contact_url
    __typename
  }
}
}, :graphql-schema #CompiledSchema<>, :handler #object[leihs.procurement.graphql$handler 0x7a1e88b5 leihs.procurement.graphql$handler@7a1e88b5], :multipart-params {}, :scheme :http, :request-method :post, :accept {:mime :json, :charset nil, :encoding nil, :language nil}}

>> authorize::handler-key >> :graphql
2023-11-29T17:31:01.553Z NX-41294 DEBUG [leihs.procurement.permissions.user:24] - (-> (sql/select [true :has_entry]) (sql/from :procurement_admins) (sql/where [:= :user_id [:cast (:user_id auth-entity) :uuid]]) sql-format) => ["SELECT TRUE AS has_entry FROM procurement_admins WHERE user_id = CAST(? AS UUID)" #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-29T17:31:01.554Z NX-41294 DEBUG [leihs.procurement.permissions.user:57] - query => ["SELECT TRUE AS has_entry FROM procurement_category_inspectors WHERE user_id = ?" #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-29T17:31:01.555Z NX-41294 DEBUG [leihs.procurement.permissions.user:79] - query => ["SELECT TRUE AS has_entry FROM procurement_category_viewers WHERE user_id = ?" #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-29T17:31:01.555Z NX-41294 DEBUG [leihs.procurement.permissions.user:87] - (-> (sql/select [true :has_entry]) (sql/from :procurement_requesters_organizations) (sql/where [:= :user_id [:cast (:user_id auth-entity) :uuid]]) sql-format) => ["SELECT TRUE AS has_entry FROM procurement_requesters_organizations WHERE user_id = CAST(? AS UUID)" #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]

> 1 anti-csrf-token >  65184e75-5146-4915-8494-09445d034d15

> 1 anti-csrf-token class >  java.lang.String

> 2 anti-csrf-token-new >  nil
pure-handler >> 2

>>> queryStr  query me {
  current_user {
    navbarProps
    user {
      id
      firstname
      lastname
      permissions {
        isAdmin
        isRequester
        isInspectorForCategories {
          id
          __typename
        }
        isViewerForCategories {
          id
          __typename
        }
        __typename
      }
      __typename
    }
    __typename
  }
  settings {
    contact_url
    __typename
  }
}


>>vars1 {}

>>vars2 {} 

>>>1 #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"
2023-11-29T17:31:01.566Z NX-41294 DEBUG [leihs.procurement.resources.user:75] - id => #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"
>>>2 {:id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :firstname Procurement, :lastname Admin}
>>oida>> #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"
2023-11-29T17:31:01.567Z NX-41294 DEBUG [leihs.procurement.resources.saved-filters:19] - (-> (sql/select :*) (sql/from :procurement_users_filters) (sql/where [:= :user_id [:cast user-id :uuid]]) sql-format) => ["SELECT * FROM procurement_users_filters WHERE user_id = CAST(? AS UUID)" #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
>>>3 nil
>>> authenticate::skip= nil  handler-key= :graphql
>>> authenticate::authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-29T17:05:24.895916Z", :id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :user_session_id #uuid "5ec785a6-4a10-4fe2-a704-1f89fda3c176", :scope_system_admin_read false, :access-rights (), :user_id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}

>> authorize >

>> authorize::handler > #object[leihs.core.locale$wrap$fn__44320 0x2ac0f7a5 leihs.core.locale$wrap$fn__44320@2ac0f7a5]

>> authorize::request > {:authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-29T17:05:24.895916Z", :id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :user_session_id #uuid "5ec785a6-4a10-4fe2-a704-1f89fda3c176", :scope_system_admin_read false, :access-rights (), :user_id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}, :cookies {Idea-d8c89f6f {:value 5d06a449-7aaa-4285-b65a-53c2ae3cb299}, leihs-anti-csrf-token {:value 65184e75-5146-4915-8494-09445d034d15}, leihs-user-session {:value eb7994ee-1e47-4c67-aab6-d6006debd5b3}}, :remote-addr 127.0.0.1, :start-time 92591916090750, :params {}, :settings {:email_sending_enabled false, :sessions_max_lifetime_secs 432000, :smtp_default_from_address your.lending.desk@example.com, :public_image_caching_enabled true, :sessions_force_secure false, :deliver_received_order_notifications false, :external_base_url nil, :sessions_force_uniqueness false, :email_signature Cheers,}, :tx-next #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x7853e277 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x5092222d next.jdbc.result_set$as_unqualified_lower_maps@5092222d]}}, :query-params-raw {}, :route-params nil, :headers {origin http://localhost:3230, sec-fetch-site same-origin, sec-ch-ua-mobile ?0, host localhost:3230, user-agent Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36, content-type application/json, cookie Idea-d8c89f6f=5d06a449-7aaa-4285-b65a-53c2ae3cb299; leihs-anti-csrf-token=65184e75-5146-4915-8494-09445d034d15; leihs-user-session=eb7994ee-1e47-4c67-aab6-d6006debd5b3, content-length 4019, sec-ch-ua "Google Chrome";v="119", "Chromium";v="119", "Not?A_Brand";v="24", sec-ch-ua-platform "macOS", referer http://localhost:3230/procure/requests, connection keep-alive, pragma no-cache, x-csrf-token 65184e75-5146-4915-8494-09445d034d15, accept application/json, accept-language de-DE,de;q=0.9,en-US;q=0.8,en;q=0.7, sec-fetch-dest empty, accept-encoding gzip, deflate, br, sec-fetch-mode cors, cache-control no-cache}, :async-channel #object[org.httpkit.server.AsyncChannel 0xc9e8d39 /127.0.0.1:3230<->/127.0.0.1:65269], :server-port 3230, :params-raw {}, :tx {:datasource #object[com.zaxxer.hikari.HikariDataSource 0x6df8cf94 HikariDataSource (db-pool)]}, :content-length 4019, :form-params {}, :websocket? false, :query-params {}, :content-type application/json, :form-params-raw {}, :character-encoding utf8, :uri /procure/graphql, :server-name localhost, :handler-key :graphql, :query-string nil, :body {:operationName RequestsIndexFiltered, :variables {:inspector_priority [LOW MEDIUM HIGH MANDATORY], :onlyOwnRequests false, :state [NEW APPROVED PARTIALLY_APPROVED DENIED], :order_status [NOT_PROCESSED IN_PROGRESS PROCURED ALTERNATIVE_PROCURED NOT_PROCURED], :search nil, :organizations [fb664326-a8ef-4556-af02-07d3127cd9ec], :categories [7d5ba731-edd9-41ba-8773-7337d24c2327], :priority [NORMAL HIGH], :budgetPeriods [8b8fe440-cae5-4bf9-8048-d0ec2399faa1]}, :query query RequestsIndexFiltered($budgetPeriods: [ID!], $categories: [ID!], $search: String, $state: [State!], $order_status: [OrderStatus], $organizations: [ID!], $priority: [Priority!], $inspector_priority: [InspectorPriority!], $onlyOwnRequests: Boolean) {
  dashboard(budget_period_id: $budgetPeriods, category_id: $categories, search: $search, state: $state, order_status: $order_status, organization_id: $organizations, priority: $priority, inspector_priority: $inspector_priority, requested_by_auth_user: $onlyOwnRequests) {
    cacheKey
    total_count
    budget_periods {
      id
      cacheKey
      name
      inspection_start_date
      end_date
      total_price_cents
      main_categories {
        id
        cacheKey
        name
        image_url
        total_price_cents
        categories {
          id
          cacheKey
          name
          total_price_cents
          requests {
            ...RequestFieldsForIndex
            total_price_cents
            actionPermissions {
              edit
              __typename
            }
            __typename
          }
          __typename
        }
        __typename
      }
      __typename
    }
    __typename
  }
}

fragment RequestFieldsForIndex on Request {
  id
  short_id
  user {
    value {
      id
      firstname
      lastname
      __typename
    }
    __typename
  }
  category {
    read
    write
    required
    value {
      id
      name
      main_category {
        id
        name
        __typename
      }
      __typename
    }
    __typename
  }
  budget_period {
    read
    write
    required
    value {
      name
      id
      __typename
    }
    __typename
  }
  article_name {
    value
    __typename
  }
  model {
    value {
      id
      product
      version
      __typename
    }
    __typename
  }
  receiver {
    value
    __typename
  }
  organization {
    value {
      id
      name
      shortname
      department {
        id
        name
        __typename
      }
      __typename
    }
    __typename
  }
  price_cents {
    value
    __typename
  }
  price_currency {
    value
    __typename
  }
  requested_quantity {
    read
    value
    __typename
  }
  approved_quantity {
    read
    value
    __typename
  }
  order_quantity {
    read
    value
    __typename
  }
  replacement {
    value
    __typename
  }
  priority {
    value
    __typename
  }
  state
  article_number {
    value
    __typename
  }
  supplier {
    value {
      name
      __typename
    }
    __typename
  }
  supplier_name {
    value
    __typename
  }
  receiver {
    value
    __typename
  }
  room {
    value {
      id
      name
      building {
        id
        name
        __typename
      }
      __typename
    }
    __typename
  }
  motivation {
    value
    __typename
  }
  inspection_comment {
    value
    __typename
  }
  inspector_priority {
    value
    __typename
  }
  accounting_type {
    value
    __typename
  }
  cost_center {
    value
    __typename
  }
  general_ledger_account {
    value
    __typename
  }
  procurement_account {
    value
    __typename
  }
  internal_order_number {
    value
    __typename
  }
  order_status {
    value
    __typename
  }
  order_comment {
    value
    __typename
  }
  __typename
}
}, :graphql-schema #CompiledSchema<>, :handler #object[leihs.procurement.graphql$handler 0x7a1e88b5 leihs.procurement.graphql$handler@7a1e88b5], :multipart-params {}, :scheme :http, :request-method :post, :accept {:mime :json, :charset nil, :encoding nil, :language nil}}

>> authorize::handler-key >> :graphql
>>> authenticate::skip= nil  handler-key= :graphql
>>> authenticate::authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-29T17:05:24.895916Z", :id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :user_session_id #uuid "5ec785a6-4a10-4fe2-a704-1f89fda3c176", :scope_system_admin_read false, :access-rights (), :user_id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}

>> authorize >

>> authorize::handler > #object[leihs.core.locale$wrap$fn__44320 0x2ac0f7a5 leihs.core.locale$wrap$fn__44320@2ac0f7a5]

>> authorize::request > {:authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-29T17:05:24.895916Z", :id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :user_session_id #uuid "5ec785a6-4a10-4fe2-a704-1f89fda3c176", :scope_system_admin_read false, :access-rights (), :user_id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}, :cookies {Idea-d8c89f6f {:value 5d06a449-7aaa-4285-b65a-53c2ae3cb299}, leihs-anti-csrf-token {:value 65184e75-5146-4915-8494-09445d034d15}, leihs-user-session {:value eb7994ee-1e47-4c67-aab6-d6006debd5b3}}, :remote-addr 127.0.0.1, :start-time 92591916249916, :params {}, :settings {:email_sending_enabled false, :sessions_max_lifetime_secs 432000, :smtp_default_from_address your.lending.desk@example.com, :public_image_caching_enabled true, :sessions_force_secure false, :deliver_received_order_notifications false, :external_base_url nil, :sessions_force_uniqueness false, :email_signature Cheers,}, :tx-next #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x7853e277 HikariDataSource (HikariPool-1)], :options {2023-11-29T17:31:01.572Z NX-41294 DEBUG [leihs.procurement.permissions.user:24] - (-> (sql/select [true :has_entry]) (sql/from :procurement_admins) (sql/where [:= :user_id [:cast (:user_id auth-entity) :uuid]]) sql-format) => ["SELECT TRUE AS has_entry FROM procurement_admins WHERE user_id = CAST(? AS UUID)" #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x5092222d next.jdbc.result_set$as_unqualified_lower_maps@5092222d]}}, :query-params-raw {}, :route-params nil, :headers {origin http://localhost:3230, sec-fetch-site same-origin, sec-ch-ua-mobile ?0, host localhost:3230, user-agent Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36, content-type application/json, cookie Idea-d8c89f6f=5d06a449-7aaa-4285-b65a-53c2ae3cb299; leihs-anti-csrf-token=65184e75-5146-4915-8494-09445d034d15; leihs-user-session=eb7994ee-1e47-4c67-aab6-d6006debd5b3, content-length 534, sec-ch-ua "Google Chrome";v="119", "Chromium";v="119", "Not?A_Brand";v="24", sec-ch-ua-platform "macOS", referer http://localhost:3230/procure/requests, connection keep-alive, pragma no-cache, x-csrf-token 65184e75-5146-4915-8494-09445d034d15, accept application/json, accept-language de-DE,de;q=0.9,en-US;q=0.8,en;q=0.7, sec-fetch-dest empty, accept-encoding gzip, deflate, br, sec-fetch-mode cors, cache-control no-cache}, :async-channel #object[org.httpkit.server.AsyncChannel 0x7b41c690 /127.0.0.1:3230<->/127.0.0.1:65271], :server-port 3230, :params-raw {}, :tx {:datasource #object[com.zaxxer.hikari.HikariDataSource 0x6df8cf94 HikariDataSource (db-pool)]}, :content-length 534, :form-params {}, :websocket? false, :query-params {}, :content-type application/json, :form-params-raw {}, :character-encoding utf8, :uri /procure/graphql, :server-name localhost, :handler-key :graphql, :query-string nil, :body {:operationName RequestFilters, :variables {}, :query query RequestFilters {
  budget_periods {
    id
    name
    inspection_start_date
    end_date
    __typename
  }
  main_categories {
    id
    name
    categories {
      id
      name
      __typename
    }
    __typename
  }
  organizations(root_only: true) {
    ...OrgProps
    organizations {
      ...OrgProps
      __typename
    }
    __typename
  }
}

fragment OrgProps on Organization {
  id
  name
  shortname
  __typename
}
}, :graphql-schema #CompiledSchema<>, :handler #object[leihs.procurement.graphql$handler 0x7a1e88b5 leihs.procurement.graphql$handler@7a1e88b5], :multipart-params {}, :scheme :http, :request-method :post, :accept {:mime :json, :charset nil, :encoding nil, :language nil}}

>> authorize::handler-key >> :graphql
2023-11-29T17:31:01.573Z NX-41294 DEBUG [leihs.procurement.permissions.user:24] - (-> (sql/select [true :has_entry]) (sql/from :procurement_admins) (sql/where [:= :user_id [:cast (:user_id auth-entity) :uuid]]) sql-format) => ["SELECT TRUE AS has_entry FROM procurement_admins WHERE user_id = CAST(? AS UUID)" #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-29T17:31:01.574Z NX-41294 DEBUG [leihs.procurement.permissions.user:57] - query => ["SELECT TRUE AS has_entry FROM procurement_category_inspectors WHERE user_id = ?" #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-29T17:31:01.575Z NX-41294 DEBUG [leihs.procurement.permissions.user:57] - query => ["SELECT TRUE AS has_entry FROM procurement_category_inspectors WHERE user_id = ?" #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-29T17:31:01.575Z NX-41294 DEBUG [leihs.procurement.permissions.user:79] - query => ["SELECT TRUE AS has_entry FROM procurement_category_viewers WHERE user_id = ?" #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-29T17:31:01.576Z NX-41294 DEBUG [leihs.procurement.permissions.user:79] - query => ["SELECT TRUE AS has_entry FROM procurement_category_viewers WHERE user_id = ?" #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-29T17:31:01.576Z NX-41294 DEBUG [leihs.procurement.permissions.user:87] - (-> (sql/select [true :has_entry]) (sql/from :procurement_requesters_organizations) (sql/where [:= :user_id [:cast (:user_id auth-entity) :uuid]]) sql-format) => ["SELECT TRUE AS has_entry FROM procurement_requesters_organizations WHERE user_id = CAST(? AS UUID)" #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-29T17:31:01.577Z NX-41294 DEBUG [leihs.procurement.permissions.user:87] - (-> (sql/select [true :has_entry]) (sql/from :procurement_requesters_organizations) (sql/where [:= :user_id [:cast (:user_id auth-entity) :uuid]]) sql-format) => ["SELECT TRUE AS has_entry FROM procurement_requesters_organizations WHERE user_id = CAST(? AS UUID)" #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]

> 1 anti-csrf-token >  65184e75-5146-4915-8494-09445d034d15

> 1 anti-csrf-token class >  java.lang.String

> 2 anti-csrf-token-new >  nil

> 1 anti-csrf-token >  65184e75-5146-4915-8494-09445d034d15

> 1 anti-csrf-token class >  java.lang.String

> 2 anti-csrf-token-new >  nil
2023-11-29T17:31:01.582Z NX-41294 DEBUG [leihs.procurement.permissions.user:24] - (-> (sql/select [true :has_entry]) (sql/from :procurement_admins) (sql/where [:= :user_id [:cast (:user_id auth-entity) :uuid]]) sql-format) => ["SELECT TRUE AS has_entry FROM procurement_admins WHERE user_id = CAST(? AS UUID)" #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
pure-handler >> 2

>>> queryStr  query RequestFilters {
  budget_periods {
    id
    name
    inspection_start_date
    end_date
    __typename
  }
  main_categories {
    id
    name
    categories {
      id
      name
      __typename
    }
    __typename
  }
  organizations(root_only: true) {
    ...OrgProps
    organizations {
      ...OrgProps
      __typename
    }
    __typename
  }
}

fragment OrgProps on Organization {
  id
  name
  shortname
  __typename
}


>>vars1 {}

>>vars2 {} 

2023-11-29T17:31:01.583Z NX-41294 DEBUG [leihs.procurement.permissions.user:87] - (-> (sql/select [true :has_entry]) (sql/from :procurement_requesters_organizations) (sql/where [:= :user_id [:cast (:user_id auth-entity) :uuid]]) sql-format) => ["SELECT TRUE AS has_entry FROM procurement_requesters_organizations WHERE user_id = CAST(? AS UUID)" #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]

>>>pure-handler {:data #ordered/map ([:current_user #ordered/map ([:navbarProps {"csrfToken":{"value":"65184e75-5146-4915-8494-09445d034d15","name":"csrf-token"},"config":{"appTitle":"leihs","appColor":"gray","me":{"user":{"id":"e68ca036-dced-4666-b9e9-a6b55119f013","firstname":"Procurement","lastname":"Admin","login":null,"email":"jimmie@goyette.com"}},"subApps":{"borrow":false,"admin":false,"procure":false,"manage":[]},"locales":[{"name":"English (UK)","locale":"en-GB","active":true,"isDefault":true,"isSelected":true},{"name":"English (US)","locale":"en-US","active":true,"isDefault":false,"isSelected":false},{"name":"Deutsch","locale":"de-CH","active":true,"isDefault":false,"isSelected":false},{"name":"Züritüütsch","locale":"gsw-CH","active":true,"isDefault":false,"isSelected":false}]}}] [:user #ordered/map ([:id e68ca036-dced-4666-b9e9-a6b55119f013] [:firstname Procurement] [:lastname Admin] [:permissions #ordered/map ([:isAdmin true] [:isRequester false] [:isInspectorForCategories []] [:isViewerForCategories []] [:__typename :UserPermissions])] [:__typename :User])] [:__typename :CurrentUser])] [:settings #ordered/map ([:contact_url nil] [:__typename :ProcurementSettings])])}
pure-handler >> 2

>>> queryStr  query RequestsIndexFiltered($budgetPeriods: [ID!], $categories: [ID!], $search: String, $state: [State!], $order_status: [OrderStatus], $organizations: [ID!], $priority: [Priority!], $inspector_priority: [InspectorPriority!], $onlyOwnRequests: Boolean) {
  dashboard(budget_period_id: $budgetPeriods, category_id: $categories, search: $search, state: $state, order_status: $order_status, organization_id: $organizations, priority: $priority, inspector_priority: $inspector_priority, requested_by_auth_user: $onlyOwnRequests) {
    cacheKey
    total_count
    budget_periods {
      id
      cacheKey
      name
      inspection_start_date
      end_date
      total_price_cents
      main_categories {
        id
        cacheKey
        name
        image_url
        total_price_cents
        categories {
          id
          cacheKey
          name
          total_price_cents
          requests {
            ...RequestFieldsForIndex
            total_price_cents
            actionPermissions {
              edit
              __typename
            }
            __typename
          }
          __typename
        }
        __typename
      }
      __typename
    }
    __typename
  }
}

fragment RequestFieldsForIndex on Request {
  id
  short_id
  user {
    value {
      id
      firstname
      lastname
      __typename
    }
    __typename
  }
  category {
    read
    write
    required
    value {
      id
      name
      main_category {
        id
        name
        __typename
      }
      __typename
    }
    __typename
  }
  budget_period {
    read
    write
    required
    value {
      name
      id
      __typename
    }
    __typename
  }
  article_name {
    value
    __typename
  }
  model {
    value {
      id
      product
      version
      __typename
    }
    __typename
  }
  receiver {
    value
    __typename
  }
  organization {
    value {
      id
      name
      shortname
      department {
        id
        name
        __typename
      }
      __typename
    }
    __typename
  }
  price_cents {
    value
    __typename
  }
  price_currency {
    value
    __typename
  }
  requested_quantity {
    read
    value
    __typename
  }
  approved_quantity {
    read
    value
    __typename
  }
  order_quantity {
    read
    value
    __typename
  }
  replacement {
    value
    __typename
  }
  priority {
    value
    __typename
  }
  state
  article_number {
    value
    __typename
  }
  supplier {
    value {
      name
      __typename
    }
    __typename
  }
  supplier_name {
    value
    __typename
  }
  receiver {
    value
    __typename
  }
  room {
    value {
      id
      name
      building {
        id
        name
        __typename
      }
      __typename
    }
    __typename
  }
  motivation {
    value
    __typename
  }
  inspection_comment {
    value
    __typename
  }
  inspector_priority {
    value
    __typename
  }
  accounting_type {
    value
    __typename
  }
  cost_center {
    value
    __typename
  }
  general_ledger_account {
    value
    __typename
  }
  procurement_account {
    value
    __typename
  }
  internal_order_number {
    value
    __typename
  }
  order_status {
    value
    __typename
  }
  order_comment {
    value
    __typename
  }
  __typename
}


>>vars1 {:inspector_priority [LOW MEDIUM HIGH MANDATORY], :onlyOwnRequests false, :state [NEW APPROVED PARTIALLY_APPROVED DENIED], :order_status [NOT_PROCESSED IN_PROGRESS PROCURED ALTERNATIVE_PROCURED NOT_PROCURED], :search nil, :organizations [fb664326-a8ef-4556-af02-07d3127cd9ec], :categories [7d5ba731-edd9-41ba-8773-7337d24c2327], :priority [NORMAL HIGH], :budgetPeriods [8b8fe440-cae5-4bf9-8048-d0ec2399faa1]}

>>vars2 {:inspector_priority [LOW MEDIUM HIGH MANDATORY], :onlyOwnRequests false, :state [NEW APPROVED PARTIALLY_APPROVED DENIED], :order_status [NOT_PROCESSED IN_PROGRESS PROCURED ALTERNATIVE_PROCURED NOT_PROCURED], :search nil, :organizations [#uuid "fb664326-a8ef-4556-af02-07d3127cd9ec"], :categories [#uuid "7d5ba731-edd9-41ba-8773-7337d24c2327"], :priority [NORMAL HIGH], :budgetPeriods [#uuid "8b8fe440-cae5-4bf9-8048-d0ec2399faa1"]} 

>>>get-dashboard
>>args {:inspector_priority [:LOW :MEDIUM :HIGH :MANDATORY], :organization_id [#uuid "fb664326-a8ef-4556-af02-07d3127cd9ec"], :requested_by_auth_user false, :state [:NEW :APPROVED :PARTIALLY_APPROVED :DENIED], :order_status [:NOT_PROCESSED :IN_PROGRESS :PROCURED :ALTERNATIVE_PROCURED :NOT_PROCURED], :search nil, :priority [:NORMAL :HIGH], :budget_period_id [#uuid "8b8fe440-cae5-4bf9-8048-d0ec2399faa1"], :category_id [#uuid "7d5ba731-edd9-41ba-8773-7337d24c2327"]}
>>value nil
>>mainCatsSql [SELECT procurement_main_categories.* FROM procurement_main_categories ORDER BY procurement_main_categories.name ASC]
>>mainCats [{:id #uuid "d2907cbd-98d0-48b7-ab9a-f06803e5cabb", :name Main Category MC1}]
>>queryA1 [SELECT * FROM procurement_budget_periods WHERE procurement_budget_periods.id IN (?) ORDER BY end_date DESC #uuid "8b8fe440-cae5-4bf9-8048-d0ec2399faa1"]
>>resultA1 [{:id #uuid "8b8fe440-cae5-4bf9-8048-d0ec2399faa1", :name Budget-Period-Past, :inspection_start_date #inst "2023-08-23T22:00:00.000000000-00:00", :end_date #inst "2023-11-22T23:00:00.000000000-00:00", :created_at #inst "2023-11-24T19:25:51.605131000-00:00", :updated_at #inst "2023-11-24T19:25:51.605131000-00:00"}]
>>resultA1-2 [{:id #uuid "8b8fe440-cae5-4bf9-8048-d0ec2399faa1", :name Budget-Period-Past, :inspection_start_date #inst "2023-08-23T22:00:00.000000000-00:00", :end_date #inst "2023-11-22T23:00:00.000000000-00:00", :created_at #inst "2023-11-24T19:25:51.605131000-00:00", :updated_at #inst "2023-11-24T19:25:51.605131000-00:00"}]
>>requestsB2-triggerError {:inspector_priority [:LOW :MEDIUM :HIGH :MANDATORY], :organization_id [#uuid "fb664326-a8ef-4556-af02-07d3127cd9ec"], :requested_by_auth_user false, :state [:NEW :APPROVED :PARTIALLY_APPROVED :DENIED], :order_status [:NOT_PROCESSED :IN_PROGRESS :PROCURED :ALTERNATIVE_PROCURED :NOT_PROCURED], :search nil, :priority [:NORMAL :HIGH], :budget_period_id [#uuid "8b8fe440-cae5-4bf9-8048-d0ec2399faa1"], :category_id [#uuid "7d5ba731-edd9-41ba-8773-7337d24c2327"]} nil
>>>requests::get-requests ======================
>>>args {:inspector_priority [:LOW :MEDIUM :HIGH :MANDATORY], :organization_id [#uuid "fb664326-a8ef-4556-af02-07d3127cd9ec"], :requested_by_auth_user false, :state [:NEW :APPROVED :PARTIALLY_APPROVED :DENIED], :order_status [:NOT_PROCESSED :IN_PROGRESS :PROCURED :ALTERNATIVE_PROCURED :NOT_PROCURED], :search nil, :priority [:NORMAL :HIGH], :budget_period_id [#uuid "8b8fe440-cae5-4bf9-8048-d0ec2399faa1"], :category_id [#uuid "7d5ba731-edd9-41ba-8773-7337d24c2327"]}
>>>value nil
>>>auth-entity
>>>get-requests>> before first
>o> 1-After requests-query-map:
>o> helper1
>o> helper2 [#uuid "7d5ba731-edd9-41ba-8773-7337d24c2327"] [#uuid "8b8fe440-cae5-4bf9-8048-d0ec2399faa1"] [#uuid "fb664326-a8ef-4556-af02-07d3127cd9ec"]
>o> helper3
>o> helper4
>o> helper5
>o> order-status (not_processed in_progress procured alternative_procured not_procured)
>o> helper6
2023-11-29T17:31:01.610Z NX-41294 DEBUG [leihs.procurement.permissions.user:79] - query => ["SELECT TRUE AS has_entry FROM procurement_category_viewers WHERE user_id = ?" #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-29T17:31:01.611Z NX-41294 DEBUG [leihs.procurement.permissions.user:57] - query => ["SELECT TRUE AS has_entry FROM procurement_category_inspectors WHERE user_id = ?" #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-29T17:31:01.612Z NX-41294 DEBUG [leihs.procurement.permissions.user:24] - (-> (sql/select [true :has_entry]) (sql/from :procurement_admins) (sql/where [:= :user_id [:cast (:user_id auth-entity) :uuid]]) sql-format) => ["SELECT TRUE AS has_entry FROM procurement_admins WHERE user_id = CAST(? AS UUID)" #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-29T17:31:01.613Z NX-41294 DEBUG [leihs.procurement.permissions.user:107] - (->> [viewer? inspector? admin?] (map (fn* [p1__39094#] (p1__39094# tx auth-entity))) (some true?)) => true
>o> helper7 true
>o> requests-base-query-with-state
>o> state-sql true
>o> s-map  {:NEW [:= :procurement_requests.approved_quantity nil], :APPROVED [:>= :procurement_requests.approved_quantity :procurement_requests.requested_quantity], :PARTIALLY_APPROVED [:and [:< :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:> :procurement_requests.approved_quantity 0]], :DENIED [:= :procurement_requests.approved_quantity 0]}
>o>map-4 (>o> map NEW
>o> map [:= :procurement_requests.approved_quantity nil]
:case >o> map NEW
[:= :procurement_requests.approved_quantity nil] >o> map APPROVED
>o> map [:>= :procurement_requests.approved_quantity :procurement_requests.requested_quantity]
NEW >o> map APPROVED
[:>= :procurement_requests.approved_quantity :procurement_requests.requested_quantity] >o> map PARTIALLY_APPROVED
>o> map [:and [:< :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:> :procurement_requests.approved_quantity 0]]
APPROVED >o> map PARTIALLY_APPROVED
[:and [:< :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:> :procurement_requests.approved_quantity 0]] >o> map DENIED
>o> map [:= :procurement_requests.approved_quantity 0]
PARTIALLY_APPROVED >o> map DENIED
[:= :procurement_requests.approved_quantity 0] DENIED)
>o>map-5 (:case [:= :procurement_requests.approved_quantity nil] NEW [:>= :procurement_requests.approved_quantity :procurement_requests.requested_quantity] APPROVED [:and [:< :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:> :procurement_requests.approved_quantity 0]] PARTIALLY_APPROVED [:= :procurement_requests.approved_quantity 0] DENIED)
2023-11-29T17:31:01.618Z NX-41294 DEBUG [leihs.procurement.resources.request:163] - result => [[(:case [:= :procurement_requests.approved_quantity nil] "NEW" [:>= :procurement_requests.approved_quantity :procurement_requests.requested_quantity] "APPROVED" [:and [:< :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:> :procurement_requests.approved_quantity 0]] "PARTIALLY_APPROVED" [:= :procurement_requests.approved_quantity 0] "DENIED")]]
>o> join-and-nest-budget-periods
>o> sqlmap {:select [[[:raw DISTINCT ON (procurement_requests.id, concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))) procurement_requests.*]] [[[(:case [:= :procurement_requests.approved_quantity nil] NEW [:>= :procurement_requests.approved_quantity :procurement_requests.requested_quantity] APPROVED [:and [:< :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:> :procurement_requests.approved_quantity 0]] PARTIALLY_APPROVED [:= :procurement_requests.approved_quantity 0] DENIED)]] :state]], :from [:procurement_requests], :left-join [:models [:= :models.id :procurement_requests.model_id]], :order-by [[[:raw concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))]]], :join [:procurement_budget_periods [:= :procurement_budget_periods.id :procurement_requests.budget_period_id]]}
>o> tbl :procurement_budget_periods_2
>o> nest-key :budget_period
>o> join-and-nest-categories
>o> sqlmap {:select [[[:raw DISTINCT ON (procurement_requests.id, concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))) procurement_requests.*]] [[[(:case [:= :procurement_requests.approved_quantity nil] NEW [:>= :procurement_requests.approved_quantity :procurement_requests.requested_quantity] APPROVED [:and [:< :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:> :procurement_requests.approved_quantity 0]] PARTIALLY_APPROVED [:= :procurement_requests.approved_quantity 0] DENIED)]] :state] [[[:row_to_json :procurement_budget_periods_2]] :budget_period] [[:raw row_to_json(procurement_categories)::jsonb || jsonb_build_object('main_category', row_to_json(procurement_main_categories)) AS category]]], :from [:procurement_requests], :left-join [:models [:= :models.id :procurement_requests.model_id]], :order-by [[[:raw concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))]]], :join [:procurement_budget_periods [:= :procurement_budget_periods.id :procurement_requests.budget_period_id] [{:select [:* [[:> :current_date :end_date] :is_past]], :from [:procurement_budget_periods]} :procurement_budget_periods_2] [:= :procurement_budget_periods_2.id :procurement_requests.budget_period_id] :procurement_categories [:= :procurement_categories.id :procurement_requests.category_id] :procurement_main_categories [:= :procurement_main_categories.id :procurement_categories.main_category_id]]}
>o> tbl :models
>o> nest-key :model
>o> join-and-nest-templates
>o> sqlmap {:select [[[:raw DISTINCT ON (procurement_requests.id, concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))) procurement_requests.*]] [[[(:case [:= :procurement_requests.approved_quantity nil] NEW [:>= :procurement_requests.approved_quantity :procurement_requests.requested_quantity] APPROVED [:and [:< :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:> :procurement_requests.approved_quantity 0]] PARTIALLY_APPROVED [:= :procurement_requests.approved_quantity 0] DENIED)]] :state] [[[:row_to_json :procurement_budget_periods_2]] :budget_period] [[:raw row_to_json(procurement_categories)::jsonb || jsonb_build_object('main_category', row_to_json(procurement_main_categories)) AS category]] [[[:row_to_json :models]] :model] [[:raw row_to_json(procurement_organizations)::jsonb || jsonb_build_object('department', row_to_json(procurement_departments)) AS organization]]], :from [:procurement_requests], :left-join [:models [:= :models.id :procurement_requests.model_id]], :order-by [[[:raw concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))]]], :join [:procurement_budget_periods [:= :procurement_budget_periods.id :procurement_requests.budget_period_id] [{:select [:* [[:> :current_date :end_date] :is_past]], :from [:procurement_budget_periods]} :procurement_budget_periods_2] [:= :procurement_budget_periods_2.id :procurement_requests.budget_period_id] :procurement_categories [:= :procurement_categories.id :procurement_requests.category_id] :procurement_main_categories [:= :procurement_main_categories.id :procurement_categories.main_category_id] :procurement_organizations [:= :procurement_organizations.id :procurement_requests.organization_id] [:procurement_organizations :procurement_departments] [:= :procurement_departments.id :procurement_organizations.parent_id]]}
>o> tbl :procurement_templates
>o> nest-key :template

>>>pure-handler {:data #ordered/map ([:budget_periods [nil]] [:main_categories [nil]] [:organizations [nil]]), :errors ({:message Non-nullable field was null., :locations [{:line 3, :column 5}], :path [:budget_periods 0 :id]} {:message Non-nullable field was null., :locations [{:line 4, :column 5}], :path [:budget_periods 0 :name]} {:message Non-nullable field was null., :locations [{:line 5, :column 5}], :path [:budget_periods 0 :inspection_start_date]} {:message Non-nullable field was null., :locations [{:line 6, :column 5}], :path [:budget_periods 0 :end_date]} {:message Non-nullable field was null., :locations [{:line 10, :column 5}], :path [:main_categories 0 :id]} {:message Non-nullable field was null., :locations [{:line 11, :column 5}], :path [:main_categories 0 :name]} {:message Non-nullable field was null., :locations [{:line 30, :column 3}], :path [:organizations 0 :id]} {:message Non-nullable field was null., :locations [{:line 31, :column 3}], :path [:organizations 0 :name]} {:message Non-nullable field was null., :locations [{:line 30, :column 3}], :path [:organizations 0 :organizations 0 :id]} {:message Non-nullable field was null., :locations [{:line 31, :column 3}], :path [:organizations 0 :organizations 0 :name]} {:message Non-nullable field was null., :locations [{:line 30, :column 3}], :path [:organizations 0 :organizations 1 :id]} {:message Non-nullable field was null., :locations [{:line 31, :column 3}], :path [:organizations 0 :organizations 1 :name]})}
>o> sqlmap {:select [[[:raw DISTINCT ON (procurement_requests.id, concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))) procurement_requests.*]] [[[(:case [:= :procurement_requests.approved_quantity nil] NEW [:>= :procurement_requests.approved_quantity :procurement_requests.requested_quantity] APPROVED [:and [:< :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:> :procurement_requests.approved_quantity 0]] PARTIALLY_APPROVED [:= :procurement_requests.approved_quantity 0] DENIED)]] :state] [[[:row_to_json :procurement_budget_periods_2]] :budget_period] [[:raw row_to_json(procurement_categories)::jsonb || jsonb_build_object('main_category', row_to_json(procurement_main_categories)) AS category]] [[[:row_to_json :models]] :model] [[:raw row_to_json(procurement_organizations)::jsonb || jsonb_build_object('department', row_to_json(procurement_departments)) AS organization]] [[[:row_to_json :procurement_templates]] :template] [[:raw row_to_json(rooms)::jsonb || jsonb_build_object('building', row_to_json(buildings)) AS room]]], :from [:procurement_requests], :left-join (:models [:= :models.id :procurement_requests.model_id] :procurement_templates [:= :procurement_templates.id :procurement_requests.template_id]), :order-by [[[:raw concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))]]], :join [:procurement_budget_periods [:= :procurement_budget_periods.id :procurement_requests.budget_period_id] [{:select [:* [[:> :current_date :end_date] :is_past]], :from [:procurement_budget_periods]} :procurement_budget_periods_2] [:= :procurement_budget_periods_2.id :procurement_requests.budget_period_id] :procurement_categories [:= :procurement_categories.id :procurement_requests.category_id] :procurement_main_categories [:= :procurement_main_categories.id :procurement_categories.main_category_id] :procurement_organizations [:= :procurement_organizations.id :procurement_requests.organization_id] [:procurement_organizations :procurement_departments] [:= :procurement_departments.id :procurement_organizations.parent_id] :rooms [:= :rooms.id :procurement_requests.room_id] :buildings [:= :buildings.id :rooms.building_id]]}
>o> tbl :suppliers
>o> nest-key :supplier
>o> join-and-nest-users
>o> sqlmap {:select [[[:raw DISTINCT ON (procurement_requests.id, concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))) procurement_requests.*]] [[[(:case [:= :procurement_requests.approved_quantity nil] NEW [:>= :procurement_requests.approved_quantity :procurement_requests.requested_quantity] APPROVED [:and [:< :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:> :procurement_requests.approved_quantity 0]] PARTIALLY_APPROVED [:= :procurement_requests.approved_quantity 0] DENIED)]] :state] [[[:row_to_json :procurement_budget_periods_2]] :budget_period] [[:raw row_to_json(procurement_categories)::jsonb || jsonb_build_object('main_category', row_to_json(procurement_main_categories)) AS category]] [[[:row_to_json :models]] :model] [[:raw row_to_json(procurement_organizations)::jsonb || jsonb_build_object('department', row_to_json(procurement_departments)) AS organization]] [[[:row_to_json :procurement_templates]] :template] [[:raw row_to_json(rooms)::jsonb || jsonb_build_object('building', row_to_json(buildings)) AS room]] [[[:row_to_json :suppliers]] :supplier]], :from [:procurement_requests], :left-join (:models [:= :models.id :procurement_requests.model_id] :procurement_templates [:= :procurement_templates.id :procurement_requests.template_id] :suppliers [:= :suppliers.id :procurement_requests.supplier_id]), :order-by [[[:raw concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))]]], :join [:procurement_budget_periods [:= :procurement_budget_periods.id :procurement_requests.budget_period_id] [{:select [:* [[:> :current_date :end_date] :is_past]], :from [:procurement_budget_periods]} :procurement_budget_periods_2] [:= :procurement_budget_periods_2.id :procurement_requests.budget_period_id] :procurement_categories [:= :procurement_categories.id :procurement_requests.category_id] :procurement_main_categories [:= :procurement_main_categories.id :procurement_categories.main_category_id] :procurement_organizations [:= :procurement_organizations.id :procurement_requests.organization_id] [:procurement_organizations :procurement_departments] [:= :procurement_departments.id :procurement_organizations.parent_id] :rooms [:= :rooms.id :procurement_requests.room_id] :buildings [:= :buildings.id :rooms.building_id]]}
>o> tbl :users
>o> nest-key :user
>o> helper8
>o> 2-After apply-scope: {:select [[[:raw DISTINCT ON (procurement_requests.id, concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))) procurement_requests.*]] [[[(:case [:= :procurement_requests.approved_quantity nil] NEW [:>= :procurement_requests.approved_quantity :procurement_requests.requested_quantity] APPROVED [:and [:< :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:> :procurement_requests.approved_quantity 0]] PARTIALLY_APPROVED [:= :procurement_requests.approved_quantity 0] DENIED)]] :state] [[[:row_to_json :procurement_budget_periods_2]] :budget_period] [[:raw row_to_json(procurement_categories)::jsonb || jsonb_build_object('main_category', row_to_json(procurement_main_categories)) AS category]] [[[:row_to_json :models]] :model] [[:raw row_to_json(procurement_organizations)::jsonb || jsonb_build_object('department', row_to_json(procurement_departments)) AS organization]] [[[:row_to_json :procurement_templates]] :template] [[:raw row_to_json(rooms)::jsonb || jsonb_build_object('building', row_to_json(buildings)) AS room]] [[[:row_to_json :suppliers]] :supplier] [[[:row_to_json :users]] :user]], :from [:procurement_requests], :left-join (:models [:= :models.id :procurement_requests.model_id] :procurement_templates [:= :procurement_templates.id :procurement_requests.template_id] :suppliers [:= :suppliers.id :procurement_requests.supplier_id] :users [:= :users.id :procurement_requests.user_id]), :order-by [[[:raw concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))]]], :join [:procurement_budget_periods [:= :procurement_budget_periods.id :procurement_requests.budget_period_id] [{:select [:* [[:> :current_date :end_date] :is_past]], :from [:procurement_budget_periods]} :procurement_budget_periods_2] [:= :procurement_budget_periods_2.id :procurement_requests.budget_period_id] :procurement_categories [:= :procurement_categories.id :procurement_requests.category_id] :procurement_main_categories [:= :procurement_main_categories.id :procurement_categories.main_category_id] :procurement_organizations [:= :procurement_organizations.id :procurement_requests.organization_id] [:procurement_organizations :procurement_departments] [:= :procurement_departments.id :procurement_organizations.parent_id] :rooms [:= :rooms.id :procurement_requests.room_id] :buildings [:= :buildings.id :rooms.building_id]], :where [:and [:in :procurement_requests.category_id [#uuid "7d5ba731-edd9-41ba-8773-7337d24c2327"]] [:in :procurement_requests.budget_period_id [#uuid "8b8fe440-cae5-4bf9-8048-d0ec2399faa1"]] [:in :procurement_requests.organization_id [#uuid "fb664326-a8ef-4556-af02-07d3127cd9ec"]] [:in :procurement_requests.priority (normal high)] [:in :procurement_requests.inspector_priority (low medium high mandatory)] [:or [:= :procurement_requests.approved_quantity nil] [:>= :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:and [:< :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:> :procurement_requests.approved_quantity 0]] [:= :procurement_requests.approved_quantity 0]] [:in :procurement_requests.order_status ([[:cast not_processed :order_status_enum]] [[:cast in_progress :order_status_enum]] [[:cast procured :order_status_enum]] [[:cast alternative_procured :order_status_enum]] [[:cast not_procured :order_status_enum]])]]}
>o> apply-scope #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"
2023-11-29T17:31:01.624Z NX-41294 DEBUG [leihs.procurement.permissions.user:24] - (-> (sql/select [true :has_entry]) (sql/from :procurement_admins) (sql/where [:= :user_id [:cast (:user_id auth-entity) :uuid]]) sql-format) => ["SELECT TRUE AS has_entry FROM procurement_admins WHERE user_id = CAST(? AS UUID)" #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-29T17:31:01.626Z NX-41294 DEBUG [leihs.procurement.permissions.requests:25] - sqlmap => {:select [[[:raw "DISTINCT ON (procurement_requests.id, concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))) procurement_requests.*"]] [[[(:case [:= :procurement_requests.approved_quantity nil] "NEW" [:>= :procurement_requests.approved_quantity :procurement_requests.requested_quantity] "APPROVED" [:and [:< :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:> :procurement_requests.approved_quantity 0]] "PARTIALLY_APPROVED" [:= :procurement_requests.approved_quantity 0] "DENIED")]] :state] [[[:row_to_json :procurement_budget_periods_2]] :budget_period] [[:raw "row_to_json(procurement_categories)::jsonb || jsonb_build_object('main_category', row_to_json(procurement_main_categories)) AS category"]] [[[:row_to_json :models]] :model] [[:raw "row_to_json(procurement_organizations)::jsonb || jsonb_build_object('department', row_to_json(procurement_departments)) AS organization"]] [[[:row_to_json :procurement_templates]] :template] [[:raw "row_to_json(rooms)::jsonb || jsonb_build_object('building', row_to_json(buildings)) AS room"]] [[[:row_to_json :suppliers]] :supplier] [[[:row_to_json :users]] :user]], :from [:procurement_requests], :left-join (:models [:= :models.id :procurement_requests.model_id] :procurement_templates [:= :procurement_templates.id :procurement_requests.template_id] :suppliers [:= :suppliers.id :procurement_requests.supplier_id] :users [:= :users.id :procurement_requests.user_id]), :order-by [[[:raw "concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))"]]], :join [:procurement_budget_periods [:= :procurement_budget_periods.id :procurement_requests.budget_period_id] [{:select [:* [[:> :current_date :end_date] :is_past]], :from [:procurement_budget_periods]} :procurement_budget_periods_2] [:= :procurement_budget_periods_2.id :procurement_requests.budget_period_id] :procurement_categories [:= :procurement_categories.id :procurement_requests.category_id] :procurement_main_categories [:= :procurement_main_categories.id :procurement_categories.main_category_id] :procurement_organizations [:= :procurement_organizations.id :procurement_requests.organization_id] [:procurement_organizations :procurement_departments] [:= :procurement_departments.id :procurement_organizations.parent_id] :rooms [:= :rooms.id :procurement_requests.room_id] :buildings [:= :buildings.id :rooms.building_id]], :where [:and [:in :procurement_requests.category_id [#uuid "7d5ba731-edd9-41ba-8773-7337d24c2327"]] [:in :procurement_requests.budget_period_id [#uuid "8b8fe440-cae5-4bf9-8048-d0ec2399faa1"]] [:in :procurement_requests.organization_id [#uuid "fb664326-a8ef-4556-af02-07d3127cd9ec"]] [:in :procurement_requests.priority ("normal" "high")] [:in :procurement_requests.inspector_priority ("low" "medium" "high" "mandatory")] [:or [:= :procurement_requests.approved_quantity nil] [:>= :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:and [:< :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:> :procurement_requests.approved_quantity 0]] [:= :procurement_requests.approved_quantity 0]] [:in :procurement_requests.order_status ([[:cast "not_processed" :order_status_enum]] [[:cast "in_progress" :order_status_enum]] [[:cast "procured" :order_status_enum]] [[:cast "alternative_procured" :order_status_enum]] [[:cast "not_procured" :order_status_enum]])]]}
>o> 3-After sql-format: {:select [[[:raw DISTINCT ON (procurement_requests.id, concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))) procurement_requests.*]] [[[(:case [:= :procurement_requests.approved_quantity nil] NEW [:>= :procurement_requests.approved_quantity :procurement_requests.requested_quantity] APPROVED [:and [:< :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:> :procurement_requests.approved_quantity 0]] PARTIALLY_APPROVED [:= :procurement_requests.approved_quantity 0] DENIED)]] :state] [[[:row_to_json :procurement_budget_periods_2]] :budget_period] [[:raw row_to_json(procurement_categories)::jsonb || jsonb_build_object('main_category', row_to_json(procurement_main_categories)) AS category]] [[[:row_to_json :models]] :model] [[:raw row_to_json(procurement_organizations)::jsonb || jsonb_build_object('department', row_to_json(procurement_departments)) AS organization]] [[[:row_to_json :procurement_templates]] :template] [[:raw row_to_json(rooms)::jsonb || jsonb_build_object('building', row_to_json(buildings)) AS room]] [[[:row_to_json :suppliers]] :supplier] [[[:row_to_json :users]] :user]], :from [:procurement_requests], :left-join (:models [:= :models.id :procurement_requests.model_id] :procurement_templates [:= :procurement_templates.id :procurement_requests.template_id] :suppliers [:= :suppliers.id :procurement_requests.supplier_id] :users [:= :users.id :procurement_requests.user_id]), :order-by [[[:raw concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))]]], :join [:procurement_budget_periods [:= :procurement_budget_periods.id :procurement_requests.budget_period_id] [{:select [:* [[:> :current_date :end_date] :is_past]], :from [:procurement_budget_periods]} :procurement_budget_periods_2] [:= :procurement_budget_periods_2.id :procurement_requests.budget_period_id] :procurement_categories [:= :procurement_categories.id :procurement_requests.category_id] :procurement_main_categories [:= :procurement_main_categories.id :procurement_categories.main_category_id] :procurement_organizations [:= :procurement_organizations.id :procurement_requests.organization_id] [:procurement_organizations :procurement_departments] [:= :procurement_departments.id :procurement_organizations.parent_id] :rooms [:= :rooms.id :procurement_requests.room_id] :buildings [:= :buildings.id :rooms.building_id]], :where [:and [:in :procurement_requests.category_id [#uuid "7d5ba731-edd9-41ba-8773-7337d24c2327"]] [:in :procurement_requests.budget_period_id [#uuid "8b8fe440-cae5-4bf9-8048-d0ec2399faa1"]] [:in :procurement_requests.organization_id [#uuid "fb664326-a8ef-4556-af02-07d3127cd9ec"]] [:in :procurement_requests.priority (normal high)] [:in :procurement_requests.inspector_priority (low medium high mandatory)] [:or [:= :procurement_requests.approved_quantity nil] [:>= :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:and [:< :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:> :procurement_requests.approved_quantity 0]] [:= :procurement_requests.approved_quantity 0]] [:in :procurement_requests.order_status ([[:cast not_processed :order_status_enum]] [[:cast in_progress :order_status_enum]] [[:cast procured :order_status_enum]] [[:cast alternative_procured :order_status_enum]] [[:cast not_procured :order_status_enum]])]]}
2023-11-29T17:31:01.632Z NX-41294 DEBUG [leihs.procurement.resources.requests:234] - (sql-format <>) => ["SELECT DISTINCT ON (procurement_requests.id, concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))) procurement_requests.*, ((CASE WHEN procurement_requests.approved_quantity IS NULL THEN ? WHEN procurement_requests.approved_quantity >= procurement_requests.requested_quantity THEN ? WHEN (procurement_requests.approved_quantity < procurement_requests.requested_quantity) AND (procurement_requests.approved_quantity > ?) THEN ? WHEN procurement_requests.approved_quantity = ? THEN ? END)) AS state, (ROW_TO_JSON(procurement_budget_periods_2)) AS budget_period, row_to_json(procurement_categories)::jsonb || jsonb_build_object('main_category', row_to_json(procurement_main_categories)) AS category, (ROW_TO_JSON(models)) AS model, row_to_json(procurement_organizations)::jsonb || jsonb_build_object('department', row_to_json(procurement_departments)) AS organization, (ROW_TO_JSON(procurement_templates)) AS template, row_to_json(rooms)::jsonb || jsonb_build_object('building', row_to_json(buildings)) AS room, (ROW_TO_JSON(suppliers)) AS supplier, (ROW_TO_JSON(users)) AS user FROM procurement_requests INNER JOIN procurement_budget_periods ON procurement_budget_periods.id = procurement_requests.budget_period_id INNER JOIN (SELECT *, current_date > end_date AS is_past FROM procurement_budget_periods) AS procurement_budget_periods_2 ON procurement_budget_periods_2.id = procurement_requests.budget_period_id INNER JOIN procurement_categories ON procurement_categories.id = procurement_requests.category_id INNER JOIN procurement_main_categories ON procurement_main_categories.id = procurement_categories.main_category_id INNER JOIN procurement_organizations ON procurement_organizations.id = procurement_requests.organization_id INNER JOIN procurement_organizations AS procurement_departments ON procurement_departments.id = procurement_organizations.parent_id INNER JOIN rooms ON rooms.id = procurement_requests.room_id INNER JOIN buildings ON buildings.id = rooms.building_id LEFT JOIN models ON models.id = procurement_requests.model_id LEFT JOIN procurement_templates ON procurement_templates.id = procurement_requests.template_id LEFT JOIN suppliers ON suppliers.id = procurement_requests.supplier_id LEFT JOIN users ON users.id = procurement_requests.user_id WHERE (procurement_requests.category_id IN (?)) AND (procurement_requests.budget_period_id IN (?)) AND (procurement_requests.organization_id IN (?)) AND (procurement_requests.priority IN (?, ?)) AND (procurement_requests.inspector_priority IN (?, ?, ?, ?)) AND ((procurement_requests.approved_quantity IS NULL) OR (procurement_requests.approved_quantity >= procurement_requests.requested_quantity) OR ((procurement_requests.approved_quantity < procurement_requests.requested_quantity) AND (procurement_requests.approved_quantity > ?)) OR (procurement_requests.approved_quantity = ?)) AND (procurement_requests.order_status IN ((CAST(? AS ORDER_STATUS_ENUM)), (CAST(? AS ORDER_STATUS_ENUM)), (CAST(? AS ORDER_STATUS_ENUM)), (CAST(? AS ORDER_STATUS_ENUM)), (CAST(? AS ORDER_STATUS_ENUM)))) ORDER BY concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, ''))) ASC" "NEW" "APPROVED" 0 "PARTIALLY_APPROVED" 0 "DENIED" #uuid "7d5ba731-edd9-41ba-8773-7337d24c2327" #uuid "8b8fe440-cae5-4bf9-8048-d0ec2399faa1" #uuid "fb664326-a8ef-4556-af02-07d3127cd9ec" "normal" "high" "low" "medium" "high" "mandatory" 0 0 "not_processed" "in_progress" "procured" "alternative_procured" "not_procured"]
2023-11-29T17:31:01.633Z NX-41294 DEBUG [leihs.procurement.resources.requests:239] - query => ["SELECT DISTINCT ON (procurement_requests.id, concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))) procurement_requests.*, ((CASE WHEN procurement_requests.approved_quantity IS NULL THEN ? WHEN procurement_requests.approved_quantity >= procurement_requests.requested_quantity THEN ? WHEN (procurement_requests.approved_quantity < procurement_requests.requested_quantity) AND (procurement_requests.approved_quantity > ?) THEN ? WHEN procurement_requests.approved_quantity = ? THEN ? END)) AS state, (ROW_TO_JSON(procurement_budget_periods_2)) AS budget_period, row_to_json(procurement_categories)::jsonb || jsonb_build_object('main_category', row_to_json(procurement_main_categories)) AS category, (ROW_TO_JSON(models)) AS model, row_to_json(procurement_organizations)::jsonb || jsonb_build_object('department', row_to_json(procurement_departments)) AS organization, (ROW_TO_JSON(procurement_templates)) AS template, row_to_json(rooms)::jsonb || jsonb_build_object('building', row_to_json(buildings)) AS room, (ROW_TO_JSON(suppliers)) AS supplier, (ROW_TO_JSON(users)) AS user FROM procurement_requests INNER JOIN procurement_budget_periods ON procurement_budget_periods.id = procurement_requests.budget_period_id INNER JOIN (SELECT *, current_date > end_date AS is_past FROM procurement_budget_periods) AS procurement_budget_periods_2 ON procurement_budget_periods_2.id = procurement_requests.budget_period_id INNER JOIN procurement_categories ON procurement_categories.id = procurement_requests.category_id INNER JOIN procurement_main_categories ON procurement_main_categories.id = procurement_categories.main_category_id INNER JOIN procurement_organizations ON procurement_organizations.id = procurement_requests.organization_id INNER JOIN procurement_organizations AS procurement_departments ON procurement_departments.id = procurement_organizations.parent_id INNER JOIN rooms ON rooms.id = procurement_requests.room_id INNER JOIN buildings ON buildings.id = rooms.building_id LEFT JOIN models ON models.id = procurement_requests.model_id LEFT JOIN procurement_templates ON procurement_templates.id = procurement_requests.template_id LEFT JOIN suppliers ON suppliers.id = procurement_requests.supplier_id LEFT JOIN users ON users.id = procurement_requests.user_id WHERE (procurement_requests.category_id IN (?)) AND (procurement_requests.budget_period_id IN (?)) AND (procurement_requests.organization_id IN (?)) AND (procurement_requests.priority IN (?, ?)) AND (procurement_requests.inspector_priority IN (?, ?, ?, ?)) AND ((procurement_requests.approved_quantity IS NULL) OR (procurement_requests.approved_quantity >= procurement_requests.requested_quantity) OR ((procurement_requests.approved_quantity < procurement_requests.requested_quantity) AND (procurement_requests.approved_quantity > ?)) OR (procurement_requests.approved_quantity = ?)) AND (procurement_requests.order_status IN ((CAST(? AS ORDER_STATUS_ENUM)), (CAST(? AS ORDER_STATUS_ENUM)), (CAST(? AS ORDER_STATUS_ENUM)), (CAST(? AS ORDER_STATUS_ENUM)), (CAST(? AS ORDER_STATUS_ENUM)))) ORDER BY concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, ''))) ASC" "NEW" "APPROVED" 0 "PARTIALLY_APPROVED" 0 "DENIED" #uuid "7d5ba731-edd9-41ba-8773-7337d24c2327" #uuid "8b8fe440-cae5-4bf9-8048-d0ec2399faa1" #uuid "fb664326-a8ef-4556-af02-07d3127cd9ec" "normal" "high" "low" "medium" "high" "mandatory" 0 0 "not_processed" "in_progress" "procured" "alternative_procured" "not_procured"]
>o>ring-request-3 [SELECT DISTINCT ON (procurement_requests.id, concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))) procurement_requests.*, ((CASE WHEN procurement_requests.approved_quantity IS NULL THEN ? WHEN procurement_requests.approved_quantity >= procurement_requests.requested_quantity THEN ? WHEN (procurement_requests.approved_quantity < procurement_requests.requested_quantity) AND (procurement_requests.approved_quantity > ?) THEN ? WHEN procurement_requests.approved_quantity = ? THEN ? END)) AS state, (ROW_TO_JSON(procurement_budget_periods_2)) AS budget_period, row_to_json(procurement_categories)::jsonb || jsonb_build_object('main_category', row_to_json(procurement_main_categories)) AS category, (ROW_TO_JSON(models)) AS model, row_to_json(procurement_organizations)::jsonb || jsonb_build_object('department', row_to_json(procurement_departments)) AS organization, (ROW_TO_JSON(procurement_templates)) AS template, row_to_json(rooms)::jsonb || jsonb_build_object('building', row_to_json(buildings)) AS room, (ROW_TO_JSON(suppliers)) AS supplier, (ROW_TO_JSON(users)) AS user FROM procurement_requests INNER JOIN procurement_budget_periods ON procurement_budget_periods.id = procurement_requests.budget_period_id INNER JOIN (SELECT *, current_date > end_date AS is_past FROM procurement_budget_periods) AS procurement_budget_periods_2 ON procurement_budget_periods_2.id = procurement_requests.budget_period_id INNER JOIN procurement_categories ON procurement_categories.id = procurement_requests.category_id INNER JOIN procurement_main_categories ON procurement_main_categories.id = procurement_categories.main_category_id INNER JOIN procurement_organizations ON procurement_organizations.id = procurement_requests.organization_id INNER JOIN procurement_organizations AS procurement_departments ON procurement_departments.id = procurement_organizations.parent_id INNER JOIN rooms ON rooms.id = procurement_requests.room_id INNER JOIN buildings ON buildings.id = rooms.building_id LEFT JOIN models ON models.id = procurement_requests.model_id LEFT JOIN procurement_templates ON procurement_templates.id = procurement_requests.template_id LEFT JOIN suppliers ON suppliers.id = procurement_requests.supplier_id LEFT JOIN users ON users.id = procurement_requests.user_id WHERE (procurement_requests.category_id IN (?)) AND (procurement_requests.budget_period_id IN (?)) AND (procurement_requests.organization_id IN (?)) AND (procurement_requests.priority IN (?, ?)) AND (procurement_requests.inspector_priority IN (?, ?, ?, ?)) AND ((procurement_requests.approved_quantity IS NULL) OR (procurement_requests.approved_quantity >= procurement_requests.requested_quantity) OR ((procurement_requests.approved_quantity < procurement_requests.requested_quantity) AND (procurement_requests.approved_quantity > ?)) OR (procurement_requests.approved_quantity = ?)) AND (procurement_requests.order_status IN ((CAST(? AS ORDER_STATUS_ENUM)), (CAST(? AS ORDER_STATUS_ENUM)), (CAST(? AS ORDER_STATUS_ENUM)), (CAST(? AS ORDER_STATUS_ENUM)), (CAST(? AS ORDER_STATUS_ENUM)))) ORDER BY concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, ''))) ASC NEW APPROVED 0 PARTIALLY_APPROVED 0 DENIED #uuid "7d5ba731-edd9-41ba-8773-7337d24c2327" #uuid "8b8fe440-cae5-4bf9-8048-d0ec2399faa1" #uuid "fb664326-a8ef-4556-af02-07d3127cd9ec" normal high low medium high mandatory 0 0 not_processed in_progress procured alternative_procured not_procured]
2023-11-29T17:31:01.634Z NX-41294 DEBUG [leihs.procurement.permissions.user:79] - query => ["SELECT TRUE AS has_entry FROM procurement_category_viewers WHERE user_id = ?" #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-29T17:31:01.635Z NX-41294 DEBUG [leihs.procurement.permissions.user:57] - query => ["SELECT TRUE AS has_entry FROM procurement_category_inspectors WHERE user_id = ?" #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-29T17:31:01.636Z NX-41294 DEBUG [leihs.procurement.permissions.user:24] - (-> (sql/select [true :has_entry]) (sql/from :procurement_admins) (sql/where [:= :user_id [:cast (:user_id auth-entity) :uuid]]) sql-format) => ["SELECT TRUE AS has_entry FROM procurement_admins WHERE user_id = CAST(? AS UUID)" #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-29T17:31:01.637Z NX-41294 DEBUG [leihs.procurement.permissions.user:107] - (->> [viewer? inspector? admin?] (map (fn* [p1__39094#] (p1__39094# tx auth-entity))) (some true?)) => true
>>>ring-request-procRequests [{:category {:id 7d5ba731-edd9-41ba-8773-7337d24c2327, :name Category C1, :cost_center nil, :main_category {:id d2907cbd-98d0-48b7-ab9a-f06803e5cabb, :name Main Category MC1}, :main_category_id d2907cbd-98d0-48b7-ab9a-f06803e5cabb, :procurement_account nil, :general_ledger_account nil}, :supplier nil, :motivation Corporis commodi provident nam., :accounting_type aquisition, :template_id nil, :article_number nil, :inspector_priority medium, :price_cents 0, :budget_period {:id 8b8fe440-cae5-4bf9-8048-d0ec2399faa1, :name Budget-Period-Past, :inspection_start_date 2023-08-24T00:00:00+02:00, :end_date 2023-11-23T00:00:00+01:00, :created_at 2023-11-24T20:25:51.605131, :updated_at 2023-11-24T20:25:51.605131, :is_past true}, :article_name Mediocre Aluminum Shoes, :organization_id #uuid "fb664326-a8ef-4556-af02-07d3127cd9ec", :replacement true, :template nil, :state NEW, :organization {:id fb664326-a8ef-4556-af02-07d3127cd9ec, :name Beauty & Kids, :parent_id d6f9842f-4a7f-45ed-8ac5-c708cd6f8ca9, :shortname nil, :department {:id d6f9842f-4a7f-45ed-8ac5-c708cd6f8ca9, :name Home, Jewelry & Computers, :parent_id nil, :shortname nil}}, :supplier_name nil, :order_status not_processed, :requested_quantity 1, :updated_at #inst "2023-11-24T19:25:51.635215000-00:00", :model_id nil, :priority normal, :supplier_id nil, :budget_period_id #uuid "8b8fe440-cae5-4bf9-8048-d0ec2399faa1", :id #uuid "40284a6b-cf5e-41c1-af6c-dc423894ee11", :price_currency CHF, :user_id #uuid "2187a76b-557a-4775-9a1e-778142161819", :room {:id 64bfb152-ea6c-42da-98c6-325afeb462bc, :name reception room, :general false, :building {:id 3eaa2152-ebd3-4b7c-b370-f107fa7b4d7c, :code nil, :name 9594 Beer Extension}, :building_id 3eaa2152-ebd3-4b7c-b370-f107fa7b4d7c, :description nil}, :inspection_comment nil, :approved_quantity nil, :order_quantity nil, :room_id #uuid "64bfb152-ea6c-42da-98c6-325afeb462bc", :user {:system_admin_protected false, :address nil, :email chanda@ortiz.net, :pool_protected false, :last_sign_in_at nil, :img32_url nil, :account_enabled true, :lastname Kertzmann, :phone nil, :img_digest nil, :org_id nil, :extended_info nil, :secondary_email nil, :city nil, :settings nil, :is_admin false, :organization local, :login nil, :searchable Lynsey Kertzmann chanda@ortiz.net    Kertzmann Lynsey, :updated_at 2023-11-24T20:25:51.614964+01:00, :firstname Lynsey, :zip nil, :id 2187a76b-557a-4775-9a1e-778142161819, :url nil, :password_sign_in_enabled true, :account_disabled_at nil, :is_system_admin false, :badge_id nil, :language_locale nil, :img256_url nil, :country nil, :delegator_user_id nil, :created_at 2023-11-24T20:25:51.614964+01:00, :admin_protected false}, :receiver nil, :internal_order_number nil, :category_id #uuid "7d5ba731-edd9-41ba-8773-7337d24c2327", :created_at #inst "2023-11-24T19:25:51.635215000-00:00", :order_comment nil, :short_id Budget-Period-Past.001, :model nil}]
>>requestsB2 (>e> #error {
 :cause ERROR: column "uuid" does not exist
  Hinweis: Perhaps you meant to reference the column "procurement_budget_periods.id".
  Position: 107
 :via
 [{:type org.postgresql.util.PSQLException
   :message ERROR: column "uuid" does not exist
  Hinweis: Perhaps you meant to reference the column "procurement_budget_periods.id".
  Position: 107
   :at [org.postgresql.core.v3.QueryExecutorImpl receiveErrorResponse QueryExecutorImpl.java 2533]}]
 :trace
 [[org.postgresql.core.v3.QueryExecutorImpl receiveErrorResponse QueryExecutorImpl.java 2533]
  [org.postgresql.core.v3.QueryExecutorImpl processResults QueryExecutorImpl.java 2268]
  [org.postgresql.core.v3.QueryExecutorImpl execute QueryExecutorImpl.java 313]
  [org.postgresql.jdbc.PgStatement executeInternal PgStatement.java 448]
  [org.postgresql.jdbc.PgStatement execute PgStatement.java 369]
  [org.postgresql.jdbc.PgPreparedStatement executeWithFlags PgPreparedStatement.java 159]
  [org.postgresql.jdbc.PgPreparedStatement execute PgPreparedStatement.java 148]
  [com.zaxxer.hikari.pool.ProxyPreparedStatement execute ProxyPreparedStatement.java 44]
  [com.zaxxer.hikari.pool.HikariProxyPreparedStatement execute HikariProxyPreparedStatement.java -1]
  [next.jdbc.result_set$stmt__GT_result_set invokeStatic result_set.clj 669]
  [next.jdbc.result_set$stmt__GT_result_set invoke result_set.clj 664]
  [next.jdbc.result_set$eval11841$fn__11849 invoke result_set.clj 944]
  [next.jdbc.protocols$eval10723$fn__10754$G__10714__10763 invoke protocols.clj 34]
  [next.jdbc.default_options$eval11019$fn__11024 invoke default_options.clj 31]
  [next.jdbc.protocols$eval10723$fn__10754$G__10714__10763 invoke protocols.clj 34]
  [next.jdbc$execute_BANG_ invokeStatic jdbc.clj 251]
  [next.jdbc$execute_BANG_ invoke jdbc.clj 238]
  [leihs.procurement.resources.budget_period$get_budget_period_by_id invokeStatic budget_period.clj 24]
  [leihs.procurement.resources.budget_period$get_budget_period_by_id invoke budget_period.clj 22]
  [leihs.procurement.permissions.request_fields$get_for_user_and_request invokeStatic request_fields.clj 25]
  [leihs.procurement.permissions.request_fields$get_for_user_and_request invoke request_fields.clj 19]
  [leihs.procurement.permissions.request_helpers$apply_permissions invokeStatic request_helpers.clj 37]
  [leihs.procurement.permissions.request_helpers$apply_permissions invoke request_helpers.clj 33]
  [leihs.procurement.resources.requests$get_requests$fn__44194 invoke requests.clj 257]
  [clojure.core$map$fn__5884 invoke core.clj 2757]
  [clojure.lang.LazySeq sval LazySeq.java 42]
  [clojure.lang.LazySeq seq LazySeq.java 51]
  [clojure.lang.RT seq RT.java 535]
  [clojure.core$seq__5419 invokeStatic core.clj 139]
  [clojure.core$print_sequential invokeStatic core_print.clj 53]
  [clojure.core$fn__7329 invokeStatic core_print.clj 174]
  [clojure.core$fn__7329 invoke core_print.clj 174]
  [clojure.lang.MultiFn invoke MultiFn.java 234]
  [clojure.core$pr_on invokeStatic core.clj 3662]
  [clojure.core$pr invokeStatic core.clj 3665]
  [clojure.core$pr invoke core.clj 3665]
  [clojure.lang.AFn applyToHelper AFn.java 154]
  [clojure.lang.RestFn applyTo RestFn.java 132]
  [clojure.core$apply invokeStatic core.clj 667]
  [clojure.core$pr invokeStatic core.clj 3678]
  [clojure.core$pr doInvoke core.clj 3665]
  [clojure.lang.RestFn applyTo RestFn.java 139]
  [clojure.core$apply invokeStatic core.clj 667]
  [clojure.core$prn invokeStatic core.clj 3702]
  [clojure.core$prn doInvoke core.clj 3702]
  [clojure.lang.RestFn applyTo RestFn.java 137]
  [clojure.core$apply invokeStatic core.clj 667]
  [clojure.core$println invokeStatic core.clj 3721]
  [clojure.core$println doInvoke core.clj 3721]
  [clojure.lang.RestFn invoke RestFn.java 421]
  [leihs.procurement.dashboard$get_dashboard invokeStatic dashboard.clj 88]
  [leihs.procurement.dashboard$get_dashboard invoke dashboard.clj 35]
  [leihs.procurement.graphql.resolver$wrap_resolver_with_error$fn__44440 invoke resolver.clj 16]
  [com.walmartlabs.lacinia.schema$wrap_resolver_to_ensure_resolver_result$fn__14023 invoke schema.clj 986]
  [com.walmartlabs.lacinia.executor$invoke_resolver_for_field invokeStatic executor.clj 86]
  [com.walmartlabs.lacinia.executor$invoke_resolver_for_field invoke executor.clj 68]
  [com.walmartlabs.lacinia.executor$resolve_and_select invokeStatic executor.clj 353]
  [com.walmartlabs.lacinia.executor$resolve_and_select invoke executor.clj 234]
  [com.walmartlabs.lacinia.executor$apply_field_selection invokeStatic executor.clj 140]
  [com.walmartlabs.lacinia.executor$apply_field_selection invoke executor.clj 135]
  [com.walmartlabs.lacinia.executor$apply_selection invokeStatic executor.clj 173]
  [com.walmartlabs.lacinia.executor$apply_selection invoke executor.clj 165]
  [com.walmartlabs.lacinia.executor$execute_nested_selections$fn__17481 invoke executor.clj 197]
  [com.walmartlabs.lacinia.internal_utils$keepv$fn__12187 invoke internal_utils.clj 46]
  [clojure.lang.ArrayChunk reduce ArrayChunk.java 58]
  [clojure.core.protocols$fn__8176 invokeStatic protocols.clj 136]
  [clojure.core.protocols$fn__8176 invoke protocols.clj 124]
  [clojure.core.protocols$fn__8136$G__8131__8145 invoke protocols.clj 19]
  [clojure.core.protocols$seq_reduce invokeStatic protocols.clj 31]
  [clojure.core.protocols$fn__8168 invokeStatic protocols.clj 75]
  [clojure.core.protocols$fn__8168 invoke protocols.clj 75]
  [clojure.core.protocols$fn__8110$G__8105__8123 invoke protocols.clj 13]
  [clojure.core$reduce invokeStatic core.clj 6830]
  [clojure.core$reduce invoke core.clj 6812]
  [com.walmartlabs.lacinia.internal_utils$keepv invokeStatic internal_utils.clj 45]
  [com.walmartlabs.lacinia.internal_utils$keepv invoke internal_utils.clj 41]
  [com.walmartlabs.lacinia.executor$execute_nested_selections invokeStatic executor.clj 197]
  [com.walmartlabs.lacinia.executor$execute_nested_selections invoke executor.clj 190]
  [com.walmartlabs.lacinia.executor$execute_query$fn__17519 invoke executor.clj 400]
  [clojure.lang.AFn applyToHelper AFn.java 152]
  [clojure.lang.AFn applyTo AFn.java 144]
  [clojure.core$apply invokeStatic core.clj 667]
  [clojure.core$with_bindings_STAR_ invokeStatic core.clj 1977]
  [clojure.core$with_bindings_STAR_ doInvoke core.clj 1977]
  [clojure.lang.RestFn invoke RestFn.java 425]
  [clojure.lang.AFn applyToHelper AFn.java 156]
  [clojure.lang.RestFn applyTo RestFn.java 132]
  [clojure.core$apply invokeStatic core.clj 671]
  [clojure.core$bound_fn_STAR_$fn__5767 doInvoke core.clj 2007]
  [clojure.lang.RestFn invoke RestFn.java 397]
  [com.walmartlabs.lacinia.executor$execute_query$fn__17524 invoke executor.clj 421]
  [clojure.core$binding_conveyor_fn$fn__5772 invoke core.clj 2034]
  [clojure.lang.AFn call AFn.java 18]
  [java.util.concurrent.FutureTask run FutureTask.java 264]
  [java.util.concurrent.ThreadPoolExecutor runWorker ThreadPoolExecutor.java 1128]
  [java.util.concurrent.ThreadPoolExecutor$Worker run ThreadPoolExecutor.java 628]
  [java.lang.Thread run Thread.java 829]]}
2023-11-29T17:31:01.660Z NX-41294 WARN [leihs.procurement.graphql.resolver:326] - ERROR: column "uuid" does not exist
  Hinweis: Perhaps you meant to reference the column "procurement_budget_periods.id".
  Position: 107

>>>pure-handler {:data #ordered/map ([:dashboard nil]), :errors ({:message ERROR: column "uuid" does not exist
  Hinweis: Perhaps you meant to reference the column "procurement_budget_periods.id".
  Position: 107, :locations [{:line 2, :column 3}], :path [:dashboard], :extensions {:exception PSQLException, :arguments {:inspector_priority $inspector_priority, :organization_id $organizations, :requested_by_auth_user $onlyOwnRequests, :state $state, :order_status $order_status, :search $search, :priority $priority, :budget_period_id $budgetPeriods, :category_id $categories}}})}
