# java_leihs-procure-server env check via asdf v0.13.1
# java_leihs-procure-server env skipped update; touch .tool-versions or remove /var/folders/jl/49spzkdd2v3cdz37fgmp0ddr6cj76v/T/asdf_cache_java_leihs-procure-server to force update
# clojure_leihs-procure-server env check via asdf v0.13.1
# clojure_leihs-procure-server env skipped update; touch .tool-versions or remove /var/folders/jl/49spzkdd2v3cdz37fgmp0ddr6cj76v/T/asdf_cache_clojure_leihs-procure-server to force update
Warning: environ value /Users/mradl/.asdf/installs/java/zulu-11.60.19 for key :java-home has been overwritten with /Users/mradl/.asdf/installs/java/zulu-11.60.19/zulu-11.jdk/Contents/Home
>o> conc concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))
2023-12-09T07:59:33.885Z NX-41294 DEBUG [leihs.procurement.resources.request:209] - (-> (sql/select [[:raw (str "DISTINCT ON (procurement_requests.id, " conc ") procurement_requests.*")]]) (sql/from :procurement_requests) (sql/left-join :models [:= :models.id :procurement_requests.model_id]) (sql/order-by :procurement_requests.id [[:raw conc]])) => {:select [[[:raw "DISTINCT ON (procurement_requests.id, concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))) procurement_requests.*"]]], :from [:procurement_requests], :left-join [:models [:= :models.id :procurement_requests.model_id]], :order-by [:procurement_requests.id [[:raw "concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))"]]]}
>o> templates::templates-base-query ERROR?
2023-12-09T07:59:33.948Z NX-41294 DEBUG [leihs.procurement.resources.templates:27] - (-> (sql/select :procurement_templates.*) (sql/from :procurement_templates) (sql/left-join :models [:= :models.id :procurement_templates.model_id]) (sql/order-by [[:concat (->> [:procurement_templates.article_name :models.product :models.version] (map (fn* [p1__44523#] (->> [:lower [:coalesce p1__44523# ""]]))))]])) => {:select [:procurement_templates.*], :from [:procurement_templates], :left-join [:models [:= :models.id :procurement_templates.model_id]], :order-by [[[:concat ([:lower [:coalesce :procurement_templates.article_name ""]] [:lower [:coalesce :models.product ""]] [:lower [:coalesce :models.version ""]])]]]}
2023-12-09T07:59:34.199Z NX-41294 WARN [leihs.core.release:13] - Failed to read releases.yml, returning bogus value 
2023-12-09T07:59:34.780Z NX-41294 INFO [leihs.core.logging:37] - initializing logging  {:min-level [[#{"leihs.procurement" "leihs.procurement.resources.*" "leihs.procurement.permissions.*" "leihs.procurement.authorization" "leihs.procurement.*"} :debug] [#{"com.zaxxer.hikari.*" "leihs.*"} :info] [#{"*"} :warn]], :log-level nil}
2023-12-09T07:59:34.782Z NX-41294 INFO [leihs.core.logging:39] - initialized logging  {:min-level [[#{"leihs.procurement" "leihs.procurement.resources.*" "leihs.procurement.permissions.*" "leihs.procurement.authorization" "leihs.procurement.*"} :debug] [#{"com.zaxxer.hikari.*" "leihs.*"} :info] [#{"*"} :warn]], :ns-filter #{"*"}, :middleware [], :timestamp-opts {:pattern :iso8601, :locale :jvm-default, :timezone :utc}, :output-fn #object[taoensso.timbre$default_output_fn 0x948b01c "taoensso.timbre$default_output_fn@948b01c"], :appenders {:println {:enabled? true, :fn #object[taoensso.timbre.appenders.core$println_appender$fn__3459 0x7eecbdae "taoensso.timbre.appenders.core$println_appender$fn__3459@7eecbdae"]}}, :_init-config {:loaded-from-source :default, :compile-time-config {:min-level nil, :ns-pattern "*"}}, :log-level nil}
2023-12-09T07:59:34.784Z NX-41294 INFO [leihs.procurement.main:50] - main ("--dev-mode" "true" "--repl" "true" "run")
2023-12-09T07:59:34.796Z NX-41294 INFO [leihs.core.repl:62] - init {:dev-mode true, :repl true, :repl-bind "localhost", :repl-port 24962, :repl-port-file ".nrepl-port"}
2023-12-09T07:59:34.798Z NX-41294 INFO [leihs.core.repl:70] - starting nREPL server  24962 localhost
2023-12-09T07:59:34.823Z NX-41294 INFO [leihs.core.repl:75] - started nREPL server 
2023-12-09T07:59:34.827Z NX-41294 INFO [leihs.procurement.run:326] - Invoking run with options:  {:db-host localhost, :db-max-pool-size 16, :db-min-pool-size 2, :db-name leihs_test, :db-password leihs, :db-port 5415, :db-user leihs, :dev-mode true, :http-host localhost, :http-max-threads 8, :http-min-threads 1, :http-port 3230, :http-queue-capacity 640, :http-thread-keep-alive-seconds 10, :http-worker-prefix leihs-service-http-worker-, :pid-file nil, :repl true, :repl-bind localhost, :repl-port 24962, :repl-port-file .nrepl-port}
2023-12-09T07:59:34.827Z NX-41294 INFO [leihs.core.shutdown:20] - PID 97261
2023-12-09T07:59:34.841Z NX-41294 INFO [leihs.core.shutdown:29] - Registering SIGTERM handler for shutdown.
2023-12-09T07:59:34.903Z NX-41294 INFO [leihs.core.graphql:17] - Initialized graphQL schema.
2023-12-09T07:59:34.905Z NX-41294 INFO [leihs.core.db:220] - Initializing db  {:db-name "leihs_test", :db-port 5415, :db-host "localhost", :db-user "leihs", :db-password "leihs", :db-min-pool-size 2, :db-max-pool-size 16}
2023-12-09T07:59:34.910Z NX-41294 INFO [com.zaxxer.hikari.HikariDataSource:80] - db-pool - Starting...
2023-12-09T07:59:34.981Z NX-41294 INFO [com.zaxxer.hikari.pool.HikariPool:565] - db-pool - Added connection org.postgresql.jdbc.PgConnection@3639b62d
2023-12-09T07:59:34.987Z NX-41294 INFO [com.zaxxer.hikari.HikariDataSource:82] - db-pool - Start completed.
2023-12-09T07:59:34.987Z NX-41294 INFO [leihs.core.db:222] - Initialized db  {:datasource #object[com.zaxxer.hikari.HikariDataSource 0x691cb6c4 "HikariDataSource (db-pool)"]}
2023-12-09T07:59:34.988Z NX-41294 INFO [leihs.core.db:223] - Initializing ds-next  {:db-name "leihs_test", :db-port 5415, :db-host "localhost", :db-user "leihs", :db-password "leihs", :db-min-pool-size 2, :db-max-pool-size 16}
2023-12-09T07:59:35.001Z NX-41294 INFO [com.zaxxer.hikari.HikariDataSource:110] - HikariPool-1 - Starting...
2023-12-09T07:59:35.011Z NX-41294 INFO [com.zaxxer.hikari.pool.HikariPool:565] - HikariPool-1 - Added connection org.postgresql.jdbc.PgConnection@14849d46
2023-12-09T07:59:35.011Z NX-41294 INFO [com.zaxxer.hikari.HikariDataSource:123] - HikariPool-1 - Start completed.
2023-12-09T07:59:35.017Z NX-41294 INFO [leihs.core.db:225] - Initialized ds-next  #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x69c80923 "HikariDataSource (HikariPool-1)"], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f "next.jdbc.result_set$as_unqualified_lower_maps@61e4316f"]}}
2023-12-09T07:59:35.024Z NX-41294 INFO [leihs.core.http-server:101] - starting http-server  {:port 3230, :ip "localhost", :pool {:queue #object[java.util.concurrent.ArrayBlockingQueue 0x51355836 "[]"], :pool #object[java.util.concurrent.ThreadPoolExecutor 0x62a50821 "java.util.concurrent.ThreadPoolExecutor@62a50821[Running, pool size = 0, active threads = 0, queued tasks = 0, completed tasks = 0]"]}}
2023-12-09T07:59:35.037Z NX-41294 INFO [leihs.core.http-server:104] - started http-server 
>>> authenticate::skip= nil  handler-key= :not-found
>>> authenticate::authenticated-entity {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}

>> authorize >

>> authorize::handler > #object[leihs.core.locale$wrap$fn__44823 0x34b1fe60 leihs.core.locale$wrap$fn__44823@34b1fe60]

>> authorize::request > {:authenticated-entity {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}, :cookies {leihs-anti-csrf-token {:value dc7e186c-6046-4dce-9a37-5d14ea14e0e1}, leihs-user-session {:value 9c7d0f0a-d4f8-419f-843b-2642a9e25659}}, :remote-addr 127.0.0.1, :start-time 216268911966541, :params {}, :settings {:email_sending_enabled false, :sessions_max_lifetime_secs 432000, :smtp_default_from_address noreply@zhdk.ch, :public_image_caching_enabled true, :sessions_force_secure false, :deliver_received_order_notifications false, :external_base_url http://localhost:3200, :sessions_force_uniqueness false, :email_signature Das ZHdK-Ausleihe-Team}, :tx-next #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x69c80923 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}, :query-params-raw {}, :route-params nil, :headers {sec-fetch-site same-origin, sec-ch-ua-mobile ?0, host localhost:3230, user-agent Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36, cookie leihs-anti-csrf-token=dc7e186c-6046-4dce-9a37-5d14ea14e0e1; leihs-user-session=9c7d0f0a-d4f8-419f-843b-2642a9e25659, sec-fetch-user ?1, sec-ch-ua "Google Chrome";v="119", "Chromium";v="119", "Not?A_Brand";v="24", sec-ch-ua-platform "macOS", referer http://localhost:3230/procure/admin/budget-periods, connection keep-alive, upgrade-insecure-requests 1, pragma no-cache, accept text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7, accept-language de-DE,de;q=0.9,en-US;q=0.8,en;q=0.7, sec-fetch-dest document, accept-encoding gzip, deflate, br, sec-fetch-mode navigate, cache-control no-cache}, :async-channel #object[org.httpkit.server.AsyncChannel 0x7b695131 /127.0.0.1:3230<->/127.0.0.1:54416], :server-port 3230, :params-raw {}, :tx {:datasource #object[com.zaxxer.hikari.HikariDataSource 0x691cb6c4 HikariDataSource (db-pool)]}, :content-length 0, :form-params {}, :websocket? false, :query-params {}, :content-type nil, :form-params-raw {}, :character-encoding utf8, :uri /procure/admin/budget-periods, :server-name localhost, :handler-key :not-found, :query-string nil, :body nil, :graphql-schema #CompiledSchema<>, :handler #object[leihs.procurement.backend.html$not_found_handler 0x6cbdde62 leihs.procurement.backend.html$not_found_handler@6cbdde62], :multipart-params {}, :scheme :http, :request-method :get, :accept {:mime :html, :charset nil, :encoding nil, :language nil}}

>> authorize::handler-key >> :not-found
>myprint>  authEnt? {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}
>myprint>  txn #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x69c80923 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}
>o> admin? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.277Z NX-41294 DEBUG [leihs.procurement.permissions.user:33] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> admin? {:exists true}
>myprint>  admin true
>o> inspector? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = CAST(? AS UUID)) AS result #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.281Z NX-41294 DEBUG [leihs.procurement.permissions.user:57] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = CAST(? AS UUID)) AS result" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> inspector? {:result false}
>myprint>  inspector false
>o> viewer? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = CAST(? AS UUID)) AS result #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.284Z NX-41294 DEBUG [leihs.procurement.permissions.user:80] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = CAST(? AS UUID)) AS result" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> viewer? {:result false}
>myprint>  viewer false
>o> requester?? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.286Z NX-41294 DEBUG [leihs.procurement.permissions.user:164] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> requester?? {:exists false}
>myprint>  requester false
>o> admin? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.288Z NX-41294 DEBUG [leihs.procurement.permissions.user:33] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> admin? {:exists true}
>o> inspector? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = CAST(? AS UUID)) AS result #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.289Z NX-41294 DEBUG [leihs.procurement.permissions.user:57] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = CAST(? AS UUID)) AS result" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> inspector? {:result false}
>o> viewer? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = CAST(? AS UUID)) AS result #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.290Z NX-41294 DEBUG [leihs.procurement.permissions.user:80] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = CAST(? AS UUID)) AS result" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> viewer? {:result false}
>o> requester?? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.291Z NX-41294 DEBUG [leihs.procurement.permissions.user:164] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> requester?? {:exists false}

> 1 anti-csrf-token >  dc7e186c-6046-4dce-9a37-5d14ea14e0e1

> 1 anti-csrf-token class >  java.lang.String

> 2 anti-csrf-token-new >  nil
>>> authenticate::skip= nil  handler-key= :graphql
>>> authenticate::authenticated-entity {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}

>> authorize >

>> authorize::handler > #object[leihs.core.locale$wrap$fn__44823 0x34b1fe60 leihs.core.locale$wrap$fn__44823@34b1fe60]

>> authorize::request > {:authenticated-entity {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}, :cookies {leihs-anti-csrf-token {:value dc7e186c-6046-4dce-9a37-5d14ea14e0e1}, leihs-user-session {:value 9c7d0f0a-d4f8-419f-843b-2642a9e25659}}, :remote-addr 127.0.0.1, :start-time 216269363490833, :params {}, :settings {:email_sending_enabled false, :sessions_max_lifetime_secs 432000, :smtp_default_from_address noreply@zhdk.ch, :public_image_caching_enabled true, :sessions_force_secure false, :deliver_received_order_notifications false, :external_base_url http://localhost:3200, :sessions_force_uniqueness false, :email_signature Das ZHdK-Ausleihe-Team}, :tx-next #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x69c80923 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}, :query-params-raw {}, :route-params nil, :headers {origin http://localhost:3230, sec-fetch-site same-origin, sec-ch-ua-mobile ?0, host localhost:3230, user-agent Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36, content-type application/json, cookie leihs-anti-csrf-token=dc7e186c-6046-4dce-9a37-5d14ea14e0e1; leihs-user-session=9c7d0f0a-d4f8-419f-843b-2642a9e25659, content-length 502, sec-ch-ua "Google Chrome";v="119", "Chromium";v="119", "Not?A_Brand";v="24", sec-ch-ua-platform "macOS", referer http://localhost:3230/procure/admin/budget-periods, connection keep-alive, pragma no-cache, x-csrf-token dc7e186c-6046-4dce-9a37-5d14ea14e0e1, accept application/json, accept-language de-DE,de;q=0.9,en-US;q=0.8,en;q=0.7, sec-fetch-dest empty, accept-encoding gzip, deflate, br, sec-fetch-mode cors, cache-control no-cache}, :async-channel #object[org.httpkit.server.AsyncChannel 0x16603aef /127.0.0.1:3230<->/127.0.0.1:54417], :server-port 3230, :params-raw {}, :tx {:datasource #object[com.zaxxer.hikari.HikariDataSource 0x691cb6c4 HikariDataSource (db-pool)]}, :content-length 502, :form-params {}, :websocket? false, :query-params {}, :content-type application/json, :form-params-raw {}, :character-encoding utf8, :uri /procure/graphql, :server-name localhost, :handler-key :graphql, :query-string nil, :body {:operationName me, :variables {}, :query query me {
  current_user {
    navbarProps
    user {
      id
      firstname
      lastname
      permissions {
        isAdmin
        isRequester
        isInspectorForCategories {
          id
          __typename
        }
        isViewerForCategories {
          id
          __typename
        }
        __typename
      }
      __typename
    }
    __typename
  }
  settings {
    contact_url
    __typename
  }
}
}, :graphql-schema #CompiledSchema<>, :handler #object[leihs.procurement.graphql$handler 0x362b488d leihs.procurement.graphql$handler@362b488d], :multipart-params {}, :scheme :http, :request-method :post, :accept {:mime :json, :charset nil, :encoding nil, :language nil}}

>> authorize::handler-key >> :graphql
>myprint>  authEnt? {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}
>myprint>  txn #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x69c80923 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}
>o> admin? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.701Z NX-41294 DEBUG [leihs.procurement.permissions.user:33] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> admin? {:exists true}
>myprint>  admin true
>o> inspector? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = CAST(? AS UUID)) AS result #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.702Z NX-41294 DEBUG [leihs.procurement.permissions.user:57] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = CAST(? AS UUID)) AS result" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> inspector? {:result false}
>myprint>  inspector false
>o> viewer? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = CAST(? AS UUID)) AS result #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.703Z NX-41294 DEBUG [leihs.procurement.permissions.user:80] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = CAST(? AS UUID)) AS result" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> viewer? {:result false}
>myprint>  viewer false
>o> requester?? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.704Z NX-41294 DEBUG [leihs.procurement.permissions.user:164] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> requester?? {:exists false}
>myprint>  requester false
>o> admin? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.705Z NX-41294 DEBUG [leihs.procurement.permissions.user:33] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> admin? {:exists true}
>o> inspector? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = CAST(? AS UUID)) AS result #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.706Z NX-41294 DEBUG [leihs.procurement.permissions.user:57] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = CAST(? AS UUID)) AS result" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> inspector? {:result false}
>o> viewer? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = CAST(? AS UUID)) AS result #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.707Z NX-41294 DEBUG [leihs.procurement.permissions.user:80] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = CAST(? AS UUID)) AS result" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> viewer? {:result false}
>o> requester?? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.708Z NX-41294 DEBUG [leihs.procurement.permissions.user:164] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> requester?? {:exists false}

> 1 anti-csrf-token >  dc7e186c-6046-4dce-9a37-5d14ea14e0e1

> 1 anti-csrf-token class >  java.lang.String

> 2 anti-csrf-token-new >  nil
pure-handler >> 2
2023-12-09T07:59:36.715Z NX-41294 DEBUG [leihs.procurement.graphql:46] - graphql query query me {
  current_user {
    navbarProps
    user {
      id
      firstname
      lastname
      permissions {
        isAdmin
        isRequester
        isInspectorForCategories {
          id
          __typename
        }
        isViewerForCategories {
          id
          __typename
        }
        __typename
      }
      __typename
    }
    __typename
  }
  settings {
    contact_url
    __typename
  }
}
 with variables {}
>oo> vars from graphQL-Requst nil nil nil {}
>>>1 #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"
2023-12-09T07:59:36.731Z NX-41294 DEBUG [leihs.procurement.resources.user:80] - id => #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"
>o> >tocheck>
2023-12-09T07:59:36.732Z NX-41294 DEBUG [leihs.procurement.resources.user:?] - (sql-format (sql/where user-base-query [:= :id [:cast id :uuid]])) => ["SELECT id, firstname, lastname FROM users WHERE id = CAST(? AS UUID)" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>>>2 {:id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :firstname Manuel, :lastname Radl}
>>oida>> #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"
2023-12-09T07:59:36.734Z NX-41294 DEBUG [leihs.procurement.resources.saved-filters:19] - (-> (sql/select :*) (sql/from :procurement_users_filters) (sql/where [:= :user_id [:cast user-id :uuid]]) sql-format) => ["SELECT * FROM procurement_users_filters WHERE user_id = CAST(? AS UUID)" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>>>3 nil
>o> admin? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.760Z NX-41294 DEBUG [leihs.procurement.permissions.user:33] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> admin? {:exists true}
>o> requester?? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.761Z NX-41294 DEBUG [leihs.procurement.permissions.user:164] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> requester?? {:exists false}

>request-grapql _> request {:leihs-user-language {:name Deutsch, :locale de-CH, :default true, :active true}, :authenticated-entity {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}, :cookies {leihs-anti-csrf-token {:value dc7e186c-6046-4dce-9a37-5d14ea14e0e1}, leihs-user-session {:value 9c7d0f0a-d4f8-419f-843b-2642a9e25659}}, :remote-addr 127.0.0.1, :start-time 216269363490833, :params {}, :settings {:email_sending_enabled false, :sessions_max_lifetime_secs 432000, :smtp_default_from_address noreply@zhdk.ch, :public_image_caching_enabled true, :sessions_force_secure false, :deliver_received_order_notifications false, :external_base_url http://localhost:3200, :sessions_force_uniqueness false, :email_signature Das ZHdK-Ausleihe-Team}, :tx-next #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x69c80923 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}, :query-params-raw {}, :route-params nil, :headers {origin http://localhost:3230, sec-fetch-site same-origin, sec-ch-ua-mobile ?0, host localhost:3230, user-agent Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36, content-type application/json, cookie leihs-anti-csrf-token=dc7e186c-6046-4dce-9a37-5d14ea14e0e1; leihs-user-session=9c7d0f0a-d4f8-419f-843b-2642a9e25659, content-length 502, sec-ch-ua "Google Chrome";v="119", "Chromium";v="119", "Not?A_Brand";v="24", sec-ch-ua-platform "macOS", referer http://localhost:3230/procure/admin/budget-periods, connection keep-alive, pragma no-cache, x-csrf-token dc7e186c-6046-4dce-9a37-5d14ea14e0e1, accept application/json, accept-language de-DE,de;q=0.9,en-US;q=0.8,en;q=0.7, sec-fetch-dest empty, accept-encoding gzip, deflate, br, sec-fetch-mode cors, cache-control no-cache}, :async-channel #object[org.httpkit.server.AsyncChannel 0x16603aef /127.0.0.1:3230<->/127.0.0.1:54417], :server-port 3230, :params-raw {}, :tx {:datasource #object[com.zaxxer.hikari.HikariDataSource 0x691cb6c4 HikariDataSource (db-pool)]}, :content-length 502, :form-params {}, :websocket? false, :query-params {}, :content-type application/json, :form-params-raw {}, :character-encoding utf8, :uri /procure/graphql, :server-name localhost, :handler-key :graphql, :query-string nil, :body {:operationName me, :variables {}, :query query me {
  current_user {
    navbarProps
    user {
      id
      firstname
      lastname
      permissions {
        isAdmin
        isRequester
        isInspectorForCategories {
          id
          __typename
        }
        isViewerForCategories {
          id
          __typename
        }
        __typename
      }
      __typename
    }
    __typename
  }
  settings {
    contact_url
    __typename
  }
}
}, :graphql-schema #CompiledSchema<>, :handler #object[leihs.procurement.graphql$handler 0x362b488d leihs.procurement.graphql$handler@362b488d], :multipart-params {}, :scheme :http, :request-method :post, :accept {:mime :json, :charset nil, :encoding nil, :language nil}}

>request-c-grapql _> request (json) {"leihs-user-language":{"name":"Deutsch","locale":"de-CH","default":true,"active":true},"authenticated-entity":{"email":"manuel.radl@zhdk.ch","contracts_count":1,"lastname":"Radl","org_id":"271682","scope_read":true,"is_admin":true,"authentication-method":"session","login":"mradl","scope_system_admin_write":true,"scope_write":true,"firstname":"Manuel","scope_admin_write":true,"user_session_created_at":"2023-12-09T07:09:54.188679Z","id":"a786135f-c159-4618-9dd3-0012ebb3d500","user_session_id":"4d6070c4-5989-45bb-a1dc-1ee5409551ae","scope_system_admin_read":true,"access-rights":[{"role":"customer","inventory_pool_id":"3977012c-ce0e-501f-889b-8715fdb5d83b"},{"role":"customer","inventory_pool_id":"5863967f-9804-4909-a9b7-92254616d6b2"},{"role":"customer","inventory_pool_id":"5dd25b58-fa56-5095-bd97-2696d92c2fb1"},{"role":"customer","inventory_pool_id":"77e88ec8-9ff6-5435-818e-dc902fc631a6"},{"role":"inventory_manager","inventory_pool_id":"8bd16d45-056d-5590-bc7f-12849f034351"},{"role":"inventory_manager","inventory_pool_id":"a02b8163-9a16-5066-b48e-9eb74cf8b791"},{"role":"inventory_manager","inventory_pool_id":"b534b07c-d9bf-4572-840c-0a630b8cd8ed"},{"role":"customer","inventory_pool_id":"fc5a841e-36c6-5dc3-8207-1306c1fb89bf"},{"role":"customer","inventory_pool_id":"ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}],"user_id":"a786135f-c159-4618-9dd3-0012ebb3d500","is_system_admin":true,"external_sign_out_url":null,"language_locale":"de-CH","inventory_pool_roles_count":9,"scope_admin_read":true},"cookies":{"leihs-anti-csrf-token":{"value":"dc7e186c-6046-4dce-9a37-5d14ea14e0e1"},"leihs-user-session":{"value":"9c7d0f0a-d4f8-419f-843b-2642a9e25659"}},"remote-addr":"127.0.0.1","start-time":216269363490833,"params":{},"settings":{"email_sending_enabled":false,"sessions_max_lifetime_secs":432000,"smtp_default_from_address":"noreply@zhdk.ch","public_image_caching_enabled":true,"sessions_force_secure":false,"deliver_received_order_notifications":false,"external_base_url":"http:\/\/localhost:3200","sessions_force_uniqueness":false,"email_signature":"Das ZHdK-Ausleihe-Team"},"query-params-raw":{},"route-params":null,"headers":{"origin":"http:\/\/localhost:3230","sec-fetch-site":"same-origin","sec-ch-ua-mobile":"?0","host":"localhost:3230","user-agent":"Mozilla\/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit\/537.36 (KHTML, like Gecko) Chrome\/119.0.0.0 Safari\/537.36","content-type":"application\/json","cookie":"leihs-anti-csrf-token=dc7e186c-6046-4dce-9a37-5d14ea14e0e1; leihs-user-session=9c7d0f0a-d4f8-419f-843b-2642a9e25659","content-length":"502","sec-ch-ua":"\"Google Chrome\";v=\"119\", \"Chromium\";v=\"119\", \"Not?A_Brand\";v=\"24\"","sec-ch-ua-platform":"\"macOS\"","referer":"http:\/\/localhost:3230\/procure\/admin\/budget-periods","connection":"keep-alive","pragma":"no-cache","x-csrf-token":"dc7e186c-6046-4dce-9a37-5d14ea14e0e1","accept":"application\/json","accept-language":"de-DE,de;q=0.9,en-US;q=0.8,en;q=0.7","sec-fetch-dest":"empty","accept-encoding":"gzip, deflate, br","sec-fetch-mode":"cors","cache-control":"no-cache"},"server-port":3230,"params-raw":{},"content-length":502,"form-params":{},"websocket?":false,"query-params":{},"content-type":"application\/json","form-params-raw":{},"character-encoding":"utf8","uri":"\/procure\/graphql","server-name":"localhost","handler-key":"graphql","query-string":null,"body":{"operationName":"me","variables":{},"query":"query me {\n  current_user {\n    navbarProps\n    user {\n      id\n      firstname\n      lastname\n      permissions {\n        isAdmin\n        isRequester\n        isInspectorForCategories {\n          id\n          __typename\n        }\n        isViewerForCategories {\n          id\n          __typename\n        }\n        __typename\n      }\n      __typename\n    }\n    __typename\n  }\n  settings {\n    contact_url\n    __typename\n  }\n}\n"},"multipart-params":{},"scheme":"http","request-method":"post","accept":{"mime":"json","charset":null,"encoding":null,"language":null}}

>request-grapql _> result => {:data #ordered/map ([:current_user #ordered/map ([:navbarProps {"csrfToken":{"value":"dc7e186c-6046-4dce-9a37-5d14ea14e0e1","name":"csrf-token"},"config":{"appTitle":"leihs","appColor":"gray","me":{"user":{"id":"a786135f-c159-4618-9dd3-0012ebb3d500","firstname":"Manuel","lastname":"Radl","login":"mradl","email":"manuel.radl@zhdk.ch"}},"subApps":{"borrow":true,"admin":true,"procure":false,"manage":[{"name":"Ausleihe Toni-Areal","href":"/manage/8bd16d45-056d-5590-bc7f-12849f034351/daily"},{"name":"AVS-Museum/Ausstellungen","href":"/manage/b534b07c-d9bf-4572-840c-0a630b8cd8ed/daily"},{"name":"Kostüm- und Kleinrequisitenfundus DDK","href":"/manage/a02b8163-9a16-5066-b48e-9eb74cf8b791/daily"}]},"locales":[{"name":"Deutsch","locale":"de-CH","active":true,"isDefault":true,"isSelected":true},{"name":"English","locale":"en-GB","active":true,"isDefault":false,"isSelected":false},{"name":"Castellano","locale":"es","active":true,"isDefault":false,"isSelected":false},{"name":"Züritüütsch","locale":"gsw-CH","active":true,"isDefault":false,"isSelected":false}]}}] [:user #ordered/map ([:id a786135f-c159-4618-9dd3-0012ebb3d500] [:firstname Manuel] [:lastname Radl] [:permissions #ordered/map ([:isAdmin true] [:isRequester false] [:isInspectorForCategories []] [:isViewerForCategories []] [:__typename :UserPermissions])] [:__typename :User])] [:__typename :CurrentUser])] [:settings #ordered/map ([:contact_url https://intern.zhdk.ch/index.php?id=leihs_bedarfsermittlung] [:__typename :ProcurementSettings])])}
2023-12-09T07:59:36.775Z NX-41294 DEBUG [leihs.procurement.graphql:86] - result => {:data #ordered/map ([:current_user #ordered/map ([:navbarProps "{\"csrfToken\":{\"value\":\"dc7e186c-6046-4dce-9a37-5d14ea14e0e1\",\"name\":\"csrf-token\"},\"config\":{\"appTitle\":\"leihs\",\"appColor\":\"gray\",\"me\":{\"user\":{\"id\":\"a786135f-c159-4618-9dd3-0012ebb3d500\",\"firstname\":\"Manuel\",\"lastname\":\"Radl\",\"login\":\"mradl\",\"email\":\"manuel.radl@zhdk.ch\"}},\"subApps\":{\"borrow\":true,\"admin\":true,\"procure\":false,\"manage\":[{\"name\":\"Ausleihe Toni-Areal\",\"href\":\"/manage/8bd16d45-056d-5590-bc7f-12849f034351/daily\"},{\"name\":\"AVS-Museum/Ausstellungen\",\"href\":\"/manage/b534b07c-d9bf-4572-840c-0a630b8cd8ed/daily\"},{\"name\":\"Kostüm- und Kleinrequisitenfundus DDK\",\"href\":\"/manage/a02b8163-9a16-5066-b48e-9eb74cf8b791/daily\"}]},\"locales\":[{\"name\":\"Deutsch\",\"locale\":\"de-CH\",\"active\":true,\"isDefault\":true,\"isSelected\":true},{\"name\":\"English\",\"locale\":\"en-GB\",\"active\":true,\"isDefault\":false,\"isSelected\":false},{\"name\":\"Castellano\",\"locale\":\"es\",\"active\":true,\"isDefault\":false,\"isSelected\":false},{\"name\":\"Züritüütsch\",\"locale\":\"gsw-CH\",\"active\":true,\"isDefault\":false,\"isSelected\":false}]}}"] [:user #ordered/map ([:id "a786135f-c159-4618-9dd3-0012ebb3d500"] [:firstname "Manuel"] [:lastname "Radl"] [:permissions #ordered/map ([:isAdmin true] [:isRequester false] [:isInspectorForCategories []] [:isViewerForCategories []] [:__typename :UserPermissions])] [:__typename :User])] [:__typename :CurrentUser])] [:settings #ordered/map ([:contact_url "https://intern.zhdk.ch/index.php?id=leihs_bedarfsermittlung"] [:__typename :ProcurementSettings])])}
>>> authenticate::skip= nil  handler-key= :graphql
>>> authenticate::authenticated-entity {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}

>> authorize >

>> authorize::handler > #object[leihs.core.locale$wrap$fn__44823 0x34b1fe60 leihs.core.locale$wrap$fn__44823@34b1fe60]

>> authorize::request > {:authenticated-entity {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}, :cookies {leihs-anti-csrf-token {:value dc7e186c-6046-4dce-9a37-5d14ea14e0e1}, leihs-user-session {:value 9c7d0f0a-d4f8-419f-843b-2642a9e25659}}, :remote-addr 127.0.0.1, :start-time 216269529253000, :params {}, :settings {:email_sending_enabled false, :sessions_max_lifetime_secs 432000, :smtp_default_from_address noreply@zhdk.ch, :public_image_caching_enabled true, :sessions_force_secure false, :deliver_received_order_notifications false, :external_base_url http://localhost:3200, :sessions_force_uniqueness false, :email_signature Das ZHdK-Ausleihe-Team}, :tx-next #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x69c80923 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}, :query-params-raw {}, :route-params nil, :headers {origin http://localhost:3230, sec-fetch-site same-origin, sec-ch-ua-mobile ?0, host localhost:3230, user-agent Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36, content-type application/json, cookie leihs-anti-csrf-token=dc7e186c-6046-4dce-9a37-5d14ea14e0e1; leihs-user-session=9c7d0f0a-d4f8-419f-843b-2642a9e25659, content-length 376, sec-ch-ua "Google Chrome";v="119", "Chromium";v="119", "Not?A_Brand";v="24", sec-ch-ua-platform "macOS", referer http://localhost:3230/procure/admin/budget-periods, connection keep-alive, pragma no-cache, x-csrf-token dc7e186c-6046-4dce-9a37-5d14ea14e0e1, accept application/json, accept-language de-DE,de;q=0.9,en-US;q=0.8,en;q=0.7, sec-fetch-dest empty, accept-encoding gzip, deflate, br, sec-fetch-mode cors, cache-control no-cache}, :async-channel #object[org.httpkit.server.AsyncChannel 0x3e7eeeee /127.0.0.1:3230<->/127.0.0.1:54417], :server-port 3230, :params-raw {}, :tx {:datasource #object[com.zaxxer.hikari.HikariDataSource 0x691cb6c4 HikariDataSource (db-pool)]}, :content-length 376, :form-params {}, :websocket? false, :query-params {}, :content-type application/json, :form-params-raw {}, :character-encoding utf8, :uri /procure/graphql, :server-name localhost, :handler-key :graphql, :query-string nil, :body {:operationName AdminBudgetPeriods, :variables {}, :query query AdminBudgetPeriods {
  budget_periods {
    ...AdminBudgetPeriodProps
    __typename
  }
}

fragment AdminBudgetPeriodProps on BudgetPeriod {
  id
  name
  inspection_start_date
  end_date
  can_delete
  total_price_cents_new_requests
  total_price_cents_inspected_requests
  __typename
}
}, :graphql-schema #CompiledSchema<>, :handler #object[leihs.procurement.graphql$handler 0x362b488d leihs.procurement.graphql$handler@362b488d], :multipart-params {}, :scheme :http, :request-method :post, :accept {:mime :json, :charset nil, :encoding nil, :language nil}}

>> authorize::handler-key >> :graphql
>myprint>  authEnt? {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}
>myprint>  txn #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x69c80923 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}
>o> admin? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.811Z NX-41294 DEBUG [leihs.procurement.permissions.user:33] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> admin? {:exists true}
>myprint>  admin true
>o> inspector? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = CAST(? AS UUID)) AS result #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.812Z NX-41294 DEBUG [leihs.procurement.permissions.user:57] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = CAST(? AS UUID)) AS result" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> inspector? {:result false}
>myprint>  inspector false
>o> viewer? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = CAST(? AS UUID)) AS result #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.813Z NX-41294 DEBUG [leihs.procurement.permissions.user:80] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = CAST(? AS UUID)) AS result" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> viewer? {:result false}
>myprint>  viewer false
>o> requester?? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.814Z NX-41294 DEBUG [leihs.procurement.permissions.user:164] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> requester?? {:exists false}
>myprint>  requester false
>o> admin? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.815Z NX-41294 DEBUG [leihs.procurement.permissions.user:33] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> admin? {:exists true}
>o> inspector? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = CAST(? AS UUID)) AS result #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.816Z NX-41294 DEBUG [leihs.procurement.permissions.user:57] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = CAST(? AS UUID)) AS result" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> inspector? {:result false}
>o> viewer? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = CAST(? AS UUID)) AS result #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.817Z NX-41294 DEBUG [leihs.procurement.permissions.user:80] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = CAST(? AS UUID)) AS result" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> viewer? {:result false}
>o> requester?? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.818Z NX-41294 DEBUG [leihs.procurement.permissions.user:164] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> requester?? {:exists false}

> 1 anti-csrf-token >  dc7e186c-6046-4dce-9a37-5d14ea14e0e1

> 1 anti-csrf-token class >  java.lang.String

> 2 anti-csrf-token-new >  nil
pure-handler >> 2
2023-12-09T07:59:36.824Z NX-41294 DEBUG [leihs.procurement.graphql:46] - graphql query query AdminBudgetPeriods {
  budget_periods {
    ...AdminBudgetPeriodProps
    __typename
  }
}

fragment AdminBudgetPeriodProps on BudgetPeriod {
  id
  name
  inspection_start_date
  end_date
  can_delete
  total_price_cents_new_requests
  total_price_cents_inspected_requests
  __typename
}
 with variables {}
>oo> vars from graphQL-Requst nil nil nil {}
>>1x #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x69c80923 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}
>>2x {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}
>o> admin? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.836Z NX-41294 DEBUG [leihs.procurement.permissions.user:33] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> admin? {:exists true}
>> can-delete2
>oo> hoi2
2023-12-09T07:59:36.839Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:?] - (sql-format (sql/select (vector [:and [:not [:exists (-> (sql/select true) (sql/from [:procurement_requests :pr]) (sql/where [:= :pr.budget_period_id [:cast (:id value) :uuid]]))]] [:not [:exists (-> (sql/select true) (sql/from [:procurement_budget_limits :pbl]) (sql/where [:= :pbl.budget_period_id [:cast (:id value) :uuid]]))]]] :result))) => ["SELECT NOT EXISTS (SELECT TRUE FROM procurement_requests AS pr WHERE pr.budget_period_id = CAST(? AS UUID)) AND NOT EXISTS (SELECT TRUE FROM procurement_budget_limits AS pbl WHERE pbl.budget_period_id = CAST(? AS UUID)) AS result" #uuid "1a1dab20-c661-4204-a913-28065d570f7c" #uuid "1a1dab20-c661-4204-a913-28065d570f7c"]
2023-12-09T07:59:36.843Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:155] - (jdbc/execute-one! (-> context :request :tx-next) (-> [:and [:not [:exists (-> (sql/select true) (sql/from [:procurement_requests :pr]) (sql/where [:= :pr.budget_period_id [:cast (:id value) :uuid]]))]] [:not [:exists (-> (sql/select true) (sql/from [:procurement_budget_limits :pbl]) (sql/where [:= :pbl.budget_period_id [:cast (:id value) :uuid]]))]]] (vector :result) sql/select sql-format spy)) => {:result false}
2023-12-09T07:59:36.844Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:155] - (-> (spy (jdbc/execute-one! (-> context :request :tx-next) (-> [:and [:not [:exists (-> (sql/select true) (sql/from [:procurement_requests :pr]) (sql/where [:= :pr.budget_period_id [:cast (:id value) :uuid]]))]] [:not [:exists (-> (sql/select true) (sql/from [:procurement_budget_limits :pbl]) (sql/where [:= :pbl.budget_period_id [:cast (:id value) :uuid]]))]]] (vector :result) sql/select sql-format spy))) :result) => false
>>1x #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x69c80923 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}
>>2x {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}
>o> admin? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.845Z NX-41294 DEBUG [leihs.procurement.permissions.user:33] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> admin? {:exists true}
>oo> total-price-cents-new-requests {:id #uuid "1a1dab20-c661-4204-a913-28065d570f7c", :name 2028, :inspection_start_date #inst "2027-11-01T00:00:00.000000000-00:00", :end_date #inst "2027-12-31T00:00:00.000000000-00:00", :created_at #inst "2018-09-18T04:45:19.539768000-00:00", :updated_at #inst "2018-09-18T04:45:19.539768000-00:00"}
>oo> total-price-sqlmap :requested_quantity
>oo> sql-sum :requested_quantity
2023-12-09T07:59:36.846Z NX-41294 DEBUG [leihs.procurement.resources.requests:432] - (as-> qty-type <> [:* :procurement_requests.price_cents <>] [:cast <> :bigint] [:sum <>]) => [:sum [:cast [:* :procurement_requests.price_cents :requested_quantity] :bigint]]
2023-12-09T07:59:36.847Z NX-41294 DEBUG [leihs.procurement.resources.requests:467] - (-> (sql/select :procurement_requests.budget_period_id [(sql-sum qty-type) :result]) (sql/from :procurement_requests) (sql/where [:= :procurement_requests.budget_period_id [:cast bp-id :uuid]]) (sql/group-by :procurement_requests.budget_period_id)) => {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents :requested_quantity] :bigint]] :result]], :from [:procurement_requests], :where [:= :procurement_requests.budget_period_id [:cast [:cast #uuid "1a1dab20-c661-4204-a913-28065d570f7c" :uuid] :uuid]], :group-by [:procurement_requests.budget_period_id]}
>oo> get-total-price-cents {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents :requested_quantity] :bigint]] :result]], :from [:procurement_requests], :where [:and [:= :procurement_requests.budget_period_id [:cast [:cast #uuid "1a1dab20-c661-4204-a913-28065d570f7c" :uuid] :uuid]] [:= :procurement_requests.approved_quantity nil]], :group-by [:procurement_requests.budget_period_id]}
2023-12-09T07:59:36.852Z NX-41294 DEBUG [leihs.procurement.resources.requests:420] - (some->> sqlmap sql-format (jdbc/execute-one! tx) :result) => nil
>>1x #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x69c80923 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}
>>2x {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}
>o> admin? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.853Z NX-41294 DEBUG [leihs.procurement.permissions.user:33] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> admin? {:exists true}
>oo> total-price-cents-inspected-requests {:id #uuid "1a1dab20-c661-4204-a913-28065d570f7c", :name 2028, :inspection_start_date #inst "2027-11-01T00:00:00.000000000-00:00", :end_date #inst "2027-12-31T00:00:00.000000000-00:00", :created_at #inst "2018-09-18T04:45:19.539768000-00:00", :updated_at #inst "2018-09-18T04:45:19.539768000-00:00"}
>oo> bp-id #uuid "1a1dab20-c661-4204-a913-28065d570f7c"
>oo> total-price-sqlmap [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]
>oo> sql-sum [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]
2023-12-09T07:59:36.854Z NX-41294 DEBUG [leihs.procurement.resources.requests:432] - (as-> qty-type <> [:* :procurement_requests.price_cents <>] [:cast <> :bigint] [:sum <>]) => [:sum [:cast [:* :procurement_requests.price_cents [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]] :bigint]]
2023-12-09T07:59:36.854Z NX-41294 DEBUG [leihs.procurement.resources.requests:467] - (-> (sql/select :procurement_requests.budget_period_id [(sql-sum qty-type) :result]) (sql/from :procurement_requests) (sql/where [:= :procurement_requests.budget_period_id [:cast bp-id :uuid]]) (sql/group-by :procurement_requests.budget_period_id)) => {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]] :bigint]] :result]], :from [:procurement_requests], :where [:= :procurement_requests.budget_period_id [:cast #uuid "1a1dab20-c661-4204-a913-28065d570f7c" :uuid]], :group-by [:procurement_requests.budget_period_id]}
>oo> get-total-price-cents {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]] :bigint]] :result]], :from [:procurement_requests], :where [:and [:= :procurement_requests.budget_period_id [:cast #uuid "1a1dab20-c661-4204-a913-28065d570f7c" :uuid]] [:!= :procurement_requests.approved_quantity nil]], :group-by [:procurement_requests.budget_period_id]}
2023-12-09T07:59:36.857Z NX-41294 DEBUG [leihs.procurement.resources.requests:420] - (some->> sqlmap sql-format (jdbc/execute-one! tx) :result) => nil
>>1x #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x69c80923 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}
>>2x {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}
>o> admin? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.858Z NX-41294 DEBUG [leihs.procurement.permissions.user:33] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> admin? {:exists true}
>> can-delete2
>oo> hoi2
2023-12-09T07:59:36.859Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:?] - (sql-format (sql/select (vector [:and [:not [:exists (-> (sql/select true) (sql/from [:procurement_requests :pr]) (sql/where [:= :pr.budget_period_id [:cast (:id value) :uuid]]))]] [:not [:exists (-> (sql/select true) (sql/from [:procurement_budget_limits :pbl]) (sql/where [:= :pbl.budget_period_id [:cast (:id value) :uuid]]))]]] :result))) => ["SELECT NOT EXISTS (SELECT TRUE FROM procurement_requests AS pr WHERE pr.budget_period_id = CAST(? AS UUID)) AND NOT EXISTS (SELECT TRUE FROM procurement_budget_limits AS pbl WHERE pbl.budget_period_id = CAST(? AS UUID)) AS result" #uuid "dfdd0798-6462-46fc-995f-a7d7233f30fd" #uuid "dfdd0798-6462-46fc-995f-a7d7233f30fd"]
2023-12-09T07:59:36.860Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:155] - (jdbc/execute-one! (-> context :request :tx-next) (-> [:and [:not [:exists (-> (sql/select true) (sql/from [:procurement_requests :pr]) (sql/where [:= :pr.budget_period_id [:cast (:id value) :uuid]]))]] [:not [:exists (-> (sql/select true) (sql/from [:procurement_budget_limits :pbl]) (sql/where [:= :pbl.budget_period_id [:cast (:id value) :uuid]]))]]] (vector :result) sql/select sql-format spy)) => {:result false}
2023-12-09T07:59:36.860Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:155] - (-> (spy (jdbc/execute-one! (-> context :request :tx-next) (-> [:and [:not [:exists (-> (sql/select true) (sql/from [:procurement_requests :pr]) (sql/where [:= :pr.budget_period_id [:cast (:id value) :uuid]]))]] [:not [:exists (-> (sql/select true) (sql/from [:procurement_budget_limits :pbl]) (sql/where [:= :pbl.budget_period_id [:cast (:id value) :uuid]]))]]] (vector :result) sql/select sql-format spy))) :result) => false
>>1x #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x69c80923 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}
>>2x {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}
>o> admin? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.861Z NX-41294 DEBUG [leihs.procurement.permissions.user:33] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> admin? {:exists true}
>oo> total-price-cents-new-requests {:id #uuid "dfdd0798-6462-46fc-995f-a7d7233f30fd", :name 2027, :inspection_start_date #inst "2026-11-02T00:00:00.000000000-00:00", :end_date #inst "2026-12-31T00:00:00.000000000-00:00", :created_at #inst "2018-09-18T04:45:19.536865000-00:00", :updated_at #inst "2018-09-18T04:45:19.536865000-00:00"}
>oo> total-price-sqlmap :requested_quantity
>oo> sql-sum :requested_quantity
2023-12-09T07:59:36.861Z NX-41294 DEBUG [leihs.procurement.resources.requests:432] - (as-> qty-type <> [:* :procurement_requests.price_cents <>] [:cast <> :bigint] [:sum <>]) => [:sum [:cast [:* :procurement_requests.price_cents :requested_quantity] :bigint]]
2023-12-09T07:59:36.861Z NX-41294 DEBUG [leihs.procurement.resources.requests:467] - (-> (sql/select :procurement_requests.budget_period_id [(sql-sum qty-type) :result]) (sql/from :procurement_requests) (sql/where [:= :procurement_requests.budget_period_id [:cast bp-id :uuid]]) (sql/group-by :procurement_requests.budget_period_id)) => {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents :requested_quantity] :bigint]] :result]], :from [:procurement_requests], :where [:= :procurement_requests.budget_period_id [:cast [:cast #uuid "dfdd0798-6462-46fc-995f-a7d7233f30fd" :uuid] :uuid]], :group-by [:procurement_requests.budget_period_id]}
>oo> get-total-price-cents {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents :requested_quantity] :bigint]] :result]], :from [:procurement_requests], :where [:and [:= :procurement_requests.budget_period_id [:cast [:cast #uuid "dfdd0798-6462-46fc-995f-a7d7233f30fd" :uuid] :uuid]] [:= :procurement_requests.approved_quantity nil]], :group-by [:procurement_requests.budget_period_id]}
2023-12-09T07:59:36.863Z NX-41294 DEBUG [leihs.procurement.resources.requests:420] - (some->> sqlmap sql-format (jdbc/execute-one! tx) :result) => nil
>>1x #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x69c80923 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}
>>2x {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}
>o> admin? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.864Z NX-41294 DEBUG [leihs.procurement.permissions.user:33] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> admin? {:exists true}
>oo> total-price-cents-inspected-requests {:id #uuid "dfdd0798-6462-46fc-995f-a7d7233f30fd", :name 2027, :inspection_start_date #inst "2026-11-02T00:00:00.000000000-00:00", :end_date #inst "2026-12-31T00:00:00.000000000-00:00", :created_at #inst "2018-09-18T04:45:19.536865000-00:00", :updated_at #inst "2018-09-18T04:45:19.536865000-00:00"}
>oo> bp-id #uuid "dfdd0798-6462-46fc-995f-a7d7233f30fd"
>oo> total-price-sqlmap [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]
>oo> sql-sum [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]
2023-12-09T07:59:36.865Z NX-41294 DEBUG [leihs.procurement.resources.requests:432] - (as-> qty-type <> [:* :procurement_requests.price_cents <>] [:cast <> :bigint] [:sum <>]) => [:sum [:cast [:* :procurement_requests.price_cents [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]] :bigint]]
2023-12-09T07:59:36.865Z NX-41294 DEBUG [leihs.procurement.resources.requests:467] - (-> (sql/select :procurement_requests.budget_period_id [(sql-sum qty-type) :result]) (sql/from :procurement_requests) (sql/where [:= :procurement_requests.budget_period_id [:cast bp-id :uuid]]) (sql/group-by :procurement_requests.budget_period_id)) => {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]] :bigint]] :result]], :from [:procurement_requests], :where [:= :procurement_requests.budget_period_id [:cast #uuid "dfdd0798-6462-46fc-995f-a7d7233f30fd" :uuid]], :group-by [:procurement_requests.budget_period_id]}
>oo> get-total-price-cents {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]] :bigint]] :result]], :from [:procurement_requests], :where [:and [:= :procurement_requests.budget_period_id [:cast #uuid "dfdd0798-6462-46fc-995f-a7d7233f30fd" :uuid]] [:!= :procurement_requests.approved_quantity nil]], :group-by [:procurement_requests.budget_period_id]}
2023-12-09T07:59:36.867Z NX-41294 DEBUG [leihs.procurement.resources.requests:420] - (some->> sqlmap sql-format (jdbc/execute-one! tx) :result) => nil
>>1x #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x69c80923 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}
>>2x {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}
>o> admin? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.869Z NX-41294 DEBUG [leihs.procurement.permissions.user:33] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> admin? {:exists true}
>> can-delete2
>oo> hoi2
2023-12-09T07:59:36.869Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:?] - (sql-format (sql/select (vector [:and [:not [:exists (-> (sql/select true) (sql/from [:procurement_requests :pr]) (sql/where [:= :pr.budget_period_id [:cast (:id value) :uuid]]))]] [:not [:exists (-> (sql/select true) (sql/from [:procurement_budget_limits :pbl]) (sql/where [:= :pbl.budget_period_id [:cast (:id value) :uuid]]))]]] :result))) => ["SELECT NOT EXISTS (SELECT TRUE FROM procurement_requests AS pr WHERE pr.budget_period_id = CAST(? AS UUID)) AND NOT EXISTS (SELECT TRUE FROM procurement_budget_limits AS pbl WHERE pbl.budget_period_id = CAST(? AS UUID)) AS result" #uuid "6b689ed8-8148-485a-b1ca-86c1c739503e" #uuid "6b689ed8-8148-485a-b1ca-86c1c739503e"]
2023-12-09T07:59:36.871Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:155] - (jdbc/execute-one! (-> context :request :tx-next) (-> [:and [:not [:exists (-> (sql/select true) (sql/from [:procurement_requests :pr]) (sql/where [:= :pr.budget_period_id [:cast (:id value) :uuid]]))]] [:not [:exists (-> (sql/select true) (sql/from [:procurement_budget_limits :pbl]) (sql/where [:= :pbl.budget_period_id [:cast (:id value) :uuid]]))]]] (vector :result) sql/select sql-format spy)) => {:result false}
2023-12-09T07:59:36.871Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:155] - (-> (spy (jdbc/execute-one! (-> context :request :tx-next) (-> [:and [:not [:exists (-> (sql/select true) (sql/from [:procurement_requests :pr]) (sql/where [:= :pr.budget_period_id [:cast (:id value) :uuid]]))]] [:not [:exists (-> (sql/select true) (sql/from [:procurement_budget_limits :pbl]) (sql/where [:= :pbl.budget_period_id [:cast (:id value) :uuid]]))]]] (vector :result) sql/select sql-format spy))) :result) => false
>>1x #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x69c80923 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}
>>2x {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}
>o> admin? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.872Z NX-41294 DEBUG [leihs.procurement.permissions.user:33] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> admin? {:exists true}
>oo> total-price-cents-new-requests {:id #uuid "6b689ed8-8148-485a-b1ca-86c1c739503e", :name 2026, :inspection_start_date #inst "2025-11-03T00:00:00.000000000-00:00", :end_date #inst "2025-12-31T00:00:00.000000000-00:00", :created_at #inst "2018-09-18T04:45:19.533886000-00:00", :updated_at #inst "2018-09-18T04:45:19.533886000-00:00"}
>oo> total-price-sqlmap :requested_quantity
>oo> sql-sum :requested_quantity
2023-12-09T07:59:36.873Z NX-41294 DEBUG [leihs.procurement.resources.requests:432] - (as-> qty-type <> [:* :procurement_requests.price_cents <>] [:cast <> :bigint] [:sum <>]) => [:sum [:cast [:* :procurement_requests.price_cents :requested_quantity] :bigint]]
2023-12-09T07:59:36.873Z NX-41294 DEBUG [leihs.procurement.resources.requests:467] - (-> (sql/select :procurement_requests.budget_period_id [(sql-sum qty-type) :result]) (sql/from :procurement_requests) (sql/where [:= :procurement_requests.budget_period_id [:cast bp-id :uuid]]) (sql/group-by :procurement_requests.budget_period_id)) => {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents :requested_quantity] :bigint]] :result]], :from [:procurement_requests], :where [:= :procurement_requests.budget_period_id [:cast [:cast #uuid "6b689ed8-8148-485a-b1ca-86c1c739503e" :uuid] :uuid]], :group-by [:procurement_requests.budget_period_id]}
>oo> get-total-price-cents {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents :requested_quantity] :bigint]] :result]], :from [:procurement_requests], :where [:and [:= :procurement_requests.budget_period_id [:cast [:cast #uuid "6b689ed8-8148-485a-b1ca-86c1c739503e" :uuid] :uuid]] [:= :procurement_requests.approved_quantity nil]], :group-by [:procurement_requests.budget_period_id]}
2023-12-09T07:59:36.876Z NX-41294 DEBUG [leihs.procurement.resources.requests:420] - (some->> sqlmap sql-format (jdbc/execute-one! tx) :result) => 70543100M
>>1x #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x69c80923 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}
>>2x {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}
>o> admin? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.877Z NX-41294 DEBUG [leihs.procurement.permissions.user:33] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> admin? {:exists true}
>oo> total-price-cents-inspected-requests {:id #uuid "6b689ed8-8148-485a-b1ca-86c1c739503e", :name 2026, :inspection_start_date #inst "2025-11-03T00:00:00.000000000-00:00", :end_date #inst "2025-12-31T00:00:00.000000000-00:00", :created_at #inst "2018-09-18T04:45:19.533886000-00:00", :updated_at #inst "2018-09-18T04:45:19.533886000-00:00"}
>oo> bp-id #uuid "6b689ed8-8148-485a-b1ca-86c1c739503e"
>oo> total-price-sqlmap [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]
>oo> sql-sum [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]
2023-12-09T07:59:36.877Z NX-41294 DEBUG [leihs.procurement.resources.requests:432] - (as-> qty-type <> [:* :procurement_requests.price_cents <>] [:cast <> :bigint] [:sum <>]) => [:sum [:cast [:* :procurement_requests.price_cents [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]] :bigint]]
2023-12-09T07:59:36.878Z NX-41294 DEBUG [leihs.procurement.resources.requests:467] - (-> (sql/select :procurement_requests.budget_period_id [(sql-sum qty-type) :result]) (sql/from :procurement_requests) (sql/where [:= :procurement_requests.budget_period_id [:cast bp-id :uuid]]) (sql/group-by :procurement_requests.budget_period_id)) => {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]] :bigint]] :result]], :from [:procurement_requests], :where [:= :procurement_requests.budget_period_id [:cast #uuid "6b689ed8-8148-485a-b1ca-86c1c739503e" :uuid]], :group-by [:procurement_requests.budget_period_id]}
>oo> get-total-price-cents {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]] :bigint]] :result]], :from [:procurement_requests], :where [:and [:= :procurement_requests.budget_period_id [:cast #uuid "6b689ed8-8148-485a-b1ca-86c1c739503e" :uuid]] [:!= :procurement_requests.approved_quantity nil]], :group-by [:procurement_requests.budget_period_id]}
2023-12-09T07:59:36.884Z NX-41294 DEBUG [leihs.procurement.resources.requests:420] - (some->> sqlmap sql-format (jdbc/execute-one! tx) :result) => nil
>>1x #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x69c80923 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}
>>2x {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}
>o> admin? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.885Z NX-41294 DEBUG [leihs.procurement.permissions.user:33] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> admin? {:exists true}
>> can-delete2
>oo> hoi2
2023-12-09T07:59:36.886Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:?] - (sql-format (sql/select (vector [:and [:not [:exists (-> (sql/select true) (sql/from [:procurement_requests :pr]) (sql/where [:= :pr.budget_period_id [:cast (:id value) :uuid]]))]] [:not [:exists (-> (sql/select true) (sql/from [:procurement_budget_limits :pbl]) (sql/where [:= :pbl.budget_period_id [:cast (:id value) :uuid]]))]]] :result))) => ["SELECT NOT EXISTS (SELECT TRUE FROM procurement_requests AS pr WHERE pr.budget_period_id = CAST(? AS UUID)) AND NOT EXISTS (SELECT TRUE FROM procurement_budget_limits AS pbl WHERE pbl.budget_period_id = CAST(? AS UUID)) AS result" #uuid "1173b482-b9e6-46b4-a5e3-0b021c860e9b" #uuid "1173b482-b9e6-46b4-a5e3-0b021c860e9b"]
2023-12-09T07:59:36.887Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:155] - (jdbc/execute-one! (-> context :request :tx-next) (-> [:and [:not [:exists (-> (sql/select true) (sql/from [:procurement_requests :pr]) (sql/where [:= :pr.budget_period_id [:cast (:id value) :uuid]]))]] [:not [:exists (-> (sql/select true) (sql/from [:procurement_budget_limits :pbl]) (sql/where [:= :pbl.budget_period_id [:cast (:id value) :uuid]]))]]] (vector :result) sql/select sql-format spy)) => {:result false}
2023-12-09T07:59:36.887Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:155] - (-> (spy (jdbc/execute-one! (-> context :request :tx-next) (-> [:and [:not [:exists (-> (sql/select true) (sql/from [:procurement_requests :pr]) (sql/where [:= :pr.budget_period_id [:cast (:id value) :uuid]]))]] [:not [:exists (-> (sql/select true) (sql/from [:procurement_budget_limits :pbl]) (sql/where [:= :pbl.budget_period_id [:cast (:id value) :uuid]]))]]] (vector :result) sql/select sql-format spy))) :result) => false
>>1x #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x69c80923 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}
>>2x {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}
>o> admin? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.888Z NX-41294 DEBUG [leihs.procurement.permissions.user:33] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> admin? {:exists true}
>oo> total-price-cents-new-requests {:id #uuid "1173b482-b9e6-46b4-a5e3-0b021c860e9b", :name 2025, :inspection_start_date #inst "2024-11-04T00:00:00.000000000-00:00", :end_date #inst "2024-12-31T00:00:00.000000000-00:00", :created_at #inst "2018-09-18T04:45:19.530961000-00:00", :updated_at #inst "2018-09-18T04:45:19.530961000-00:00"}
>oo> total-price-sqlmap :requested_quantity
>oo> sql-sum :requested_quantity
2023-12-09T07:59:36.888Z NX-41294 DEBUG [leihs.procurement.resources.requests:432] - (as-> qty-type <> [:* :procurement_requests.price_cents <>] [:cast <> :bigint] [:sum <>]) => [:sum [:cast [:* :procurement_requests.price_cents :requested_quantity] :bigint]]
2023-12-09T07:59:36.888Z NX-41294 DEBUG [leihs.procurement.resources.requests:467] - (-> (sql/select :procurement_requests.budget_period_id [(sql-sum qty-type) :result]) (sql/from :procurement_requests) (sql/where [:= :procurement_requests.budget_period_id [:cast bp-id :uuid]]) (sql/group-by :procurement_requests.budget_period_id)) => {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents :requested_quantity] :bigint]] :result]], :from [:procurement_requests], :where [:= :procurement_requests.budget_period_id [:cast [:cast #uuid "1173b482-b9e6-46b4-a5e3-0b021c860e9b" :uuid] :uuid]], :group-by [:procurement_requests.budget_period_id]}
>oo> get-total-price-cents {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents :requested_quantity] :bigint]] :result]], :from [:procurement_requests], :where [:and [:= :procurement_requests.budget_period_id [:cast [:cast #uuid "1173b482-b9e6-46b4-a5e3-0b021c860e9b" :uuid] :uuid]] [:= :procurement_requests.approved_quantity nil]], :group-by [:procurement_requests.budget_period_id]}
2023-12-09T07:59:36.890Z NX-41294 DEBUG [leihs.procurement.resources.requests:420] - (some->> sqlmap sql-format (jdbc/execute-one! tx) :result) => 75250000M
>>1x #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x69c80923 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}
>>2x {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}
>o> admin? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.891Z NX-41294 DEBUG [leihs.procurement.permissions.user:33] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> admin? {:exists true}
>oo> total-price-cents-inspected-requests {:id #uuid "1173b482-b9e6-46b4-a5e3-0b021c860e9b", :name 2025, :inspection_start_date #inst "2024-11-04T00:00:00.000000000-00:00", :end_date #inst "2024-12-31T00:00:00.000000000-00:00", :created_at #inst "2018-09-18T04:45:19.530961000-00:00", :updated_at #inst "2018-09-18T04:45:19.530961000-00:00"}
>oo> bp-id #uuid "1173b482-b9e6-46b4-a5e3-0b021c860e9b"
>oo> total-price-sqlmap [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]
>oo> sql-sum [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]
2023-12-09T07:59:36.891Z NX-41294 DEBUG [leihs.procurement.resources.requests:432] - (as-> qty-type <> [:* :procurement_requests.price_cents <>] [:cast <> :bigint] [:sum <>]) => [:sum [:cast [:* :procurement_requests.price_cents [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]] :bigint]]
2023-12-09T07:59:36.891Z NX-41294 DEBUG [leihs.procurement.resources.requests:467] - (-> (sql/select :procurement_requests.budget_period_id [(sql-sum qty-type) :result]) (sql/from :procurement_requests) (sql/where [:= :procurement_requests.budget_period_id [:cast bp-id :uuid]]) (sql/group-by :procurement_requests.budget_period_id)) => {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]] :bigint]] :result]], :from [:procurement_requests], :where [:= :procurement_requests.budget_period_id [:cast #uuid "1173b482-b9e6-46b4-a5e3-0b021c860e9b" :uuid]], :group-by [:procurement_requests.budget_period_id]}
>oo> get-total-price-cents {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]] :bigint]] :result]], :from [:procurement_requests], :where [:and [:= :procurement_requests.budget_period_id [:cast #uuid "1173b482-b9e6-46b4-a5e3-0b021c860e9b" :uuid]] [:!= :procurement_requests.approved_quantity nil]], :group-by [:procurement_requests.budget_period_id]}
2023-12-09T07:59:36.893Z NX-41294 DEBUG [leihs.procurement.resources.requests:420] - (some->> sqlmap sql-format (jdbc/execute-one! tx) :result) => nil
>>1x #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x69c80923 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}
>>2x {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}
>o> admin? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.894Z NX-41294 DEBUG [leihs.procurement.permissions.user:33] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> admin? {:exists true}
>> can-delete2
>oo> hoi2
2023-12-09T07:59:36.895Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:?] - (sql-format (sql/select (vector [:and [:not [:exists (-> (sql/select true) (sql/from [:procurement_requests :pr]) (sql/where [:= :pr.budget_period_id [:cast (:id value) :uuid]]))]] [:not [:exists (-> (sql/select true) (sql/from [:procurement_budget_limits :pbl]) (sql/where [:= :pbl.budget_period_id [:cast (:id value) :uuid]]))]]] :result))) => ["SELECT NOT EXISTS (SELECT TRUE FROM procurement_requests AS pr WHERE pr.budget_period_id = CAST(? AS UUID)) AND NOT EXISTS (SELECT TRUE FROM procurement_budget_limits AS pbl WHERE pbl.budget_period_id = CAST(? AS UUID)) AS result" #uuid "e5d2ae4b-566f-4d6d-aed9-d6a8353eda7f" #uuid "e5d2ae4b-566f-4d6d-aed9-d6a8353eda7f"]
2023-12-09T07:59:36.895Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:155] - (jdbc/execute-one! (-> context :request :tx-next) (-> [:and [:not [:exists (-> (sql/select true) (sql/from [:procurement_requests :pr]) (sql/where [:= :pr.budget_period_id [:cast (:id value) :uuid]]))]] [:not [:exists (-> (sql/select true) (sql/from [:procurement_budget_limits :pbl]) (sql/where [:= :pbl.budget_period_id [:cast (:id value) :uuid]]))]]] (vector :result) sql/select sql-format spy)) => {:result false}
2023-12-09T07:59:36.896Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:155] - (-> (spy (jdbc/execute-one! (-> context :request :tx-next) (-> [:and [:not [:exists (-> (sql/select true) (sql/from [:procurement_requests :pr]) (sql/where [:= :pr.budget_period_id [:cast (:id value) :uuid]]))]] [:not [:exists (-> (sql/select true) (sql/from [:procurement_budget_limits :pbl]) (sql/where [:= :pbl.budget_period_id [:cast (:id value) :uuid]]))]]] (vector :result) sql/select sql-format spy))) :result) => false
>>1x #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x69c80923 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}
>>2x {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}
>o> admin? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.896Z NX-41294 DEBUG [leihs.procurement.permissions.user:33] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> admin? {:exists true}
>oo> total-price-cents-new-requests {:id #uuid "e5d2ae4b-566f-4d6d-aed9-d6a8353eda7f", :name 2024, :inspection_start_date #inst "2023-10-01T10:00:00.000000000-00:00", :end_date #inst "2023-12-31T00:00:00.000000000-00:00", :created_at #inst "2018-09-18T04:45:19.527129000-00:00", :updated_at #inst "2018-09-18T04:45:19.527129000-00:00"}
>oo> total-price-sqlmap :requested_quantity
>oo> sql-sum :requested_quantity
2023-12-09T07:59:36.896Z NX-41294 DEBUG [leihs.procurement.resources.requests:432] - (as-> qty-type <> [:* :procurement_requests.price_cents <>] [:cast <> :bigint] [:sum <>]) => [:sum [:cast [:* :procurement_requests.price_cents :requested_quantity] :bigint]]
2023-12-09T07:59:36.897Z NX-41294 DEBUG [leihs.procurement.resources.requests:467] - (-> (sql/select :procurement_requests.budget_period_id [(sql-sum qty-type) :result]) (sql/from :procurement_requests) (sql/where [:= :procurement_requests.budget_period_id [:cast bp-id :uuid]]) (sql/group-by :procurement_requests.budget_period_id)) => {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents :requested_quantity] :bigint]] :result]], :from [:procurement_requests], :where [:= :procurement_requests.budget_period_id [:cast [:cast #uuid "e5d2ae4b-566f-4d6d-aed9-d6a8353eda7f" :uuid] :uuid]], :group-by [:procurement_requests.budget_period_id]}
>oo> get-total-price-cents {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents :requested_quantity] :bigint]] :result]], :from [:procurement_requests], :where [:and [:= :procurement_requests.budget_period_id [:cast [:cast #uuid "e5d2ae4b-566f-4d6d-aed9-d6a8353eda7f" :uuid] :uuid]] [:= :procurement_requests.approved_quantity nil]], :group-by [:procurement_requests.budget_period_id]}
2023-12-09T07:59:36.899Z NX-41294 DEBUG [leihs.procurement.resources.requests:420] - (some->> sqlmap sql-format (jdbc/execute-one! tx) :result) => nil
>>1x #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x69c80923 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}
>>2x {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}
>o> admin? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.900Z NX-41294 DEBUG [leihs.procurement.permissions.user:33] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> admin? {:exists true}
>oo> total-price-cents-inspected-requests {:id #uuid "e5d2ae4b-566f-4d6d-aed9-d6a8353eda7f", :name 2024, :inspection_start_date #inst "2023-10-01T10:00:00.000000000-00:00", :end_date #inst "2023-12-31T00:00:00.000000000-00:00", :created_at #inst "2018-09-18T04:45:19.527129000-00:00", :updated_at #inst "2018-09-18T04:45:19.527129000-00:00"}
>oo> bp-id #uuid "e5d2ae4b-566f-4d6d-aed9-d6a8353eda7f"
>oo> total-price-sqlmap [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]
>oo> sql-sum [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]
2023-12-09T07:59:36.900Z NX-41294 DEBUG [leihs.procurement.resources.requests:432] - (as-> qty-type <> [:* :procurement_requests.price_cents <>] [:cast <> :bigint] [:sum <>]) => [:sum [:cast [:* :procurement_requests.price_cents [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]] :bigint]]
2023-12-09T07:59:36.901Z NX-41294 DEBUG [leihs.procurement.resources.requests:467] - (-> (sql/select :procurement_requests.budget_period_id [(sql-sum qty-type) :result]) (sql/from :procurement_requests) (sql/where [:= :procurement_requests.budget_period_id [:cast bp-id :uuid]]) (sql/group-by :procurement_requests.budget_period_id)) => {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]] :bigint]] :result]], :from [:procurement_requests], :where [:= :procurement_requests.budget_period_id [:cast #uuid "e5d2ae4b-566f-4d6d-aed9-d6a8353eda7f" :uuid]], :group-by [:procurement_requests.budget_period_id]}
>oo> get-total-price-cents {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]] :bigint]] :result]], :from [:procurement_requests], :where [:and [:= :procurement_requests.budget_period_id [:cast #uuid "e5d2ae4b-566f-4d6d-aed9-d6a8353eda7f" :uuid]] [:!= :procurement_requests.approved_quantity nil]], :group-by [:procurement_requests.budget_period_id]}
2023-12-09T07:59:36.903Z NX-41294 DEBUG [leihs.procurement.resources.requests:420] - (some->> sqlmap sql-format (jdbc/execute-one! tx) :result) => 560501800M
>>1x #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x69c80923 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}
>>2x {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}
>o> admin? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.904Z NX-41294 DEBUG [leihs.procurement.permissions.user:33] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> admin? {:exists true}
>> can-delete2
>oo> hoi2
2023-12-09T07:59:36.904Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:?] - (sql-format (sql/select (vector [:and [:not [:exists (-> (sql/select true) (sql/from [:procurement_requests :pr]) (sql/where [:= :pr.budget_period_id [:cast (:id value) :uuid]]))]] [:not [:exists (-> (sql/select true) (sql/from [:procurement_budget_limits :pbl]) (sql/where [:= :pbl.budget_period_id [:cast (:id value) :uuid]]))]]] :result))) => ["SELECT NOT EXISTS (SELECT TRUE FROM procurement_requests AS pr WHERE pr.budget_period_id = CAST(? AS UUID)) AND NOT EXISTS (SELECT TRUE FROM procurement_budget_limits AS pbl WHERE pbl.budget_period_id = CAST(? AS UUID)) AS result" #uuid "951ac476-4f92-4ff9-9f64-26fc8f8b61c5" #uuid "951ac476-4f92-4ff9-9f64-26fc8f8b61c5"]
2023-12-09T07:59:36.905Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:155] - (jdbc/execute-one! (-> context :request :tx-next) (-> [:and [:not [:exists (-> (sql/select true) (sql/from [:procurement_requests :pr]) (sql/where [:= :pr.budget_period_id [:cast (:id value) :uuid]]))]] [:not [:exists (-> (sql/select true) (sql/from [:procurement_budget_limits :pbl]) (sql/where [:= :pbl.budget_period_id [:cast (:id value) :uuid]]))]]] (vector :result) sql/select sql-format spy)) => {:result false}
2023-12-09T07:59:36.905Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:155] - (-> (spy (jdbc/execute-one! (-> context :request :tx-next) (-> [:and [:not [:exists (-> (sql/select true) (sql/from [:procurement_requests :pr]) (sql/where [:= :pr.budget_period_id [:cast (:id value) :uuid]]))]] [:not [:exists (-> (sql/select true) (sql/from [:procurement_budget_limits :pbl]) (sql/where [:= :pbl.budget_period_id [:cast (:id value) :uuid]]))]]] (vector :result) sql/select sql-format spy))) :result) => false
>>1x #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x69c80923 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}
>>2x {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}
>o> admin? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.906Z NX-41294 DEBUG [leihs.procurement.permissions.user:33] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> admin? {:exists true}
>oo> total-price-cents-new-requests {:id #uuid "951ac476-4f92-4ff9-9f64-26fc8f8b61c5", :name 2023, :inspection_start_date #inst "2022-11-01T00:00:00.000000000-00:00", :end_date #inst "2022-12-31T11:00:00.000000000-00:00", :created_at #inst "2018-09-18T04:45:19.520406000-00:00", :updated_at #inst "2018-09-18T04:45:19.520406000-00:00"}
>oo> total-price-sqlmap :requested_quantity
>oo> sql-sum :requested_quantity
2023-12-09T07:59:36.906Z NX-41294 DEBUG [leihs.procurement.resources.requests:432] - (as-> qty-type <> [:* :procurement_requests.price_cents <>] [:cast <> :bigint] [:sum <>]) => [:sum [:cast [:* :procurement_requests.price_cents :requested_quantity] :bigint]]
2023-12-09T07:59:36.907Z NX-41294 DEBUG [leihs.procurement.resources.requests:467] - (-> (sql/select :procurement_requests.budget_period_id [(sql-sum qty-type) :result]) (sql/from :procurement_requests) (sql/where [:= :procurement_requests.budget_period_id [:cast bp-id :uuid]]) (sql/group-by :procurement_requests.budget_period_id)) => {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents :requested_quantity] :bigint]] :result]], :from [:procurement_requests], :where [:= :procurement_requests.budget_period_id [:cast [:cast #uuid "951ac476-4f92-4ff9-9f64-26fc8f8b61c5" :uuid] :uuid]], :group-by [:procurement_requests.budget_period_id]}
>oo> get-total-price-cents {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents :requested_quantity] :bigint]] :result]], :from [:procurement_requests], :where [:and [:= :procurement_requests.budget_period_id [:cast [:cast #uuid "951ac476-4f92-4ff9-9f64-26fc8f8b61c5" :uuid] :uuid]] [:= :procurement_requests.approved_quantity nil]], :group-by [:procurement_requests.budget_period_id]}
2023-12-09T07:59:36.908Z NX-41294 DEBUG [leihs.procurement.resources.requests:420] - (some->> sqlmap sql-format (jdbc/execute-one! tx) :result) => 0M
>>1x #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x69c80923 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}
>>2x {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}
>o> admin? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.909Z NX-41294 DEBUG [leihs.procurement.permissions.user:33] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> admin? {:exists true}
>oo> total-price-cents-inspected-requests {:id #uuid "951ac476-4f92-4ff9-9f64-26fc8f8b61c5", :name 2023, :inspection_start_date #inst "2022-11-01T00:00:00.000000000-00:00", :end_date #inst "2022-12-31T11:00:00.000000000-00:00", :created_at #inst "2018-09-18T04:45:19.520406000-00:00", :updated_at #inst "2018-09-18T04:45:19.520406000-00:00"}
>oo> bp-id #uuid "951ac476-4f92-4ff9-9f64-26fc8f8b61c5"
>oo> total-price-sqlmap [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]
>oo> sql-sum [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]
2023-12-09T07:59:36.909Z NX-41294 DEBUG [leihs.procurement.resources.requests:432] - (as-> qty-type <> [:* :procurement_requests.price_cents <>] [:cast <> :bigint] [:sum <>]) => [:sum [:cast [:* :procurement_requests.price_cents [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]] :bigint]]
2023-12-09T07:59:36.909Z NX-41294 DEBUG [leihs.procurement.resources.requests:467] - (-> (sql/select :procurement_requests.budget_period_id [(sql-sum qty-type) :result]) (sql/from :procurement_requests) (sql/where [:= :procurement_requests.budget_period_id [:cast bp-id :uuid]]) (sql/group-by :procurement_requests.budget_period_id)) => {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]] :bigint]] :result]], :from [:procurement_requests], :where [:= :procurement_requests.budget_period_id [:cast #uuid "951ac476-4f92-4ff9-9f64-26fc8f8b61c5" :uuid]], :group-by [:procurement_requests.budget_period_id]}
>oo> get-total-price-cents {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]] :bigint]] :result]], :from [:procurement_requests], :where [:and [:= :procurement_requests.budget_period_id [:cast #uuid "951ac476-4f92-4ff9-9f64-26fc8f8b61c5" :uuid]] [:!= :procurement_requests.approved_quantity nil]], :group-by [:procurement_requests.budget_period_id]}
2023-12-09T07:59:36.911Z NX-41294 DEBUG [leihs.procurement.resources.requests:420] - (some->> sqlmap sql-format (jdbc/execute-one! tx) :result) => 680423900M
>>1x #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x69c80923 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}
>>2x {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}
>o> admin? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.911Z NX-41294 DEBUG [leihs.procurement.permissions.user:33] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> admin? {:exists true}
>> can-delete2
>oo> hoi2
2023-12-09T07:59:36.912Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:?] - (sql-format (sql/select (vector [:and [:not [:exists (-> (sql/select true) (sql/from [:procurement_requests :pr]) (sql/where [:= :pr.budget_period_id [:cast (:id value) :uuid]]))]] [:not [:exists (-> (sql/select true) (sql/from [:procurement_budget_limits :pbl]) (sql/where [:= :pbl.budget_period_id [:cast (:id value) :uuid]]))]]] :result))) => ["SELECT NOT EXISTS (SELECT TRUE FROM procurement_requests AS pr WHERE pr.budget_period_id = CAST(? AS UUID)) AND NOT EXISTS (SELECT TRUE FROM procurement_budget_limits AS pbl WHERE pbl.budget_period_id = CAST(? AS UUID)) AS result" #uuid "76b66d78-bfe0-4c54-8c92-edbf467af784" #uuid "76b66d78-bfe0-4c54-8c92-edbf467af784"]
2023-12-09T07:59:36.912Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:155] - (jdbc/execute-one! (-> context :request :tx-next) (-> [:and [:not [:exists (-> (sql/select true) (sql/from [:procurement_requests :pr]) (sql/where [:= :pr.budget_period_id [:cast (:id value) :uuid]]))]] [:not [:exists (-> (sql/select true) (sql/from [:procurement_budget_limits :pbl]) (sql/where [:= :pbl.budget_period_id [:cast (:id value) :uuid]]))]]] (vector :result) sql/select sql-format spy)) => {:result false}
2023-12-09T07:59:36.912Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:155] - (-> (spy (jdbc/execute-one! (-> context :request :tx-next) (-> [:and [:not [:exists (-> (sql/select true) (sql/from [:procurement_requests :pr]) (sql/where [:= :pr.budget_period_id [:cast (:id value) :uuid]]))]] [:not [:exists (-> (sql/select true) (sql/from [:procurement_budget_limits :pbl]) (sql/where [:= :pbl.budget_period_id [:cast (:id value) :uuid]]))]]] (vector :result) sql/select sql-format spy))) :result) => false
>>1x #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x69c80923 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}
>>2x {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}
>o> admin? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.913Z NX-41294 DEBUG [leihs.procurement.permissions.user:33] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> admin? {:exists true}
>oo> total-price-cents-new-requests {:id #uuid "76b66d78-bfe0-4c54-8c92-edbf467af784", :name 2022, :inspection_start_date #inst "2021-10-29T10:00:00.000000000-00:00", :end_date #inst "2021-12-31T11:00:00.000000000-00:00", :created_at #inst "2018-09-18T04:45:19.514258000-00:00", :updated_at #inst "2018-09-18T04:45:19.514258000-00:00"}
>oo> total-price-sqlmap :requested_quantity
>oo> sql-sum :requested_quantity
2023-12-09T07:59:36.913Z NX-41294 DEBUG [leihs.procurement.resources.requests:432] - (as-> qty-type <> [:* :procurement_requests.price_cents <>] [:cast <> :bigint] [:sum <>]) => [:sum [:cast [:* :procurement_requests.price_cents :requested_quantity] :bigint]]
2023-12-09T07:59:36.914Z NX-41294 DEBUG [leihs.procurement.resources.requests:467] - (-> (sql/select :procurement_requests.budget_period_id [(sql-sum qty-type) :result]) (sql/from :procurement_requests) (sql/where [:= :procurement_requests.budget_period_id [:cast bp-id :uuid]]) (sql/group-by :procurement_requests.budget_period_id)) => {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents :requested_quantity] :bigint]] :result]], :from [:procurement_requests], :where [:= :procurement_requests.budget_period_id [:cast [:cast #uuid "76b66d78-bfe0-4c54-8c92-edbf467af784" :uuid] :uuid]], :group-by [:procurement_requests.budget_period_id]}
>oo> get-total-price-cents {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents :requested_quantity] :bigint]] :result]], :from [:procurement_requests], :where [:and [:= :procurement_requests.budget_period_id [:cast [:cast #uuid "76b66d78-bfe0-4c54-8c92-edbf467af784" :uuid] :uuid]] [:= :procurement_requests.approved_quantity nil]], :group-by [:procurement_requests.budget_period_id]}
2023-12-09T07:59:36.915Z NX-41294 DEBUG [leihs.procurement.resources.requests:420] - (some->> sqlmap sql-format (jdbc/execute-one! tx) :result) => nil
>>1x #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x69c80923 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}
>>2x {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}
>o> admin? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.915Z NX-41294 DEBUG [leihs.procurement.permissions.user:33] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> admin? {:exists true}
>oo> total-price-cents-inspected-requests {:id #uuid "76b66d78-bfe0-4c54-8c92-edbf467af784", :name 2022, :inspection_start_date #inst "2021-10-29T10:00:00.000000000-00:00", :end_date #inst "2021-12-31T11:00:00.000000000-00:00", :created_at #inst "2018-09-18T04:45:19.514258000-00:00", :updated_at #inst "2018-09-18T04:45:19.514258000-00:00"}
>oo> bp-id #uuid "76b66d78-bfe0-4c54-8c92-edbf467af784"
>oo> total-price-sqlmap [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]
>oo> sql-sum [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]
2023-12-09T07:59:36.916Z NX-41294 DEBUG [leihs.procurement.resources.requests:432] - (as-> qty-type <> [:* :procurement_requests.price_cents <>] [:cast <> :bigint] [:sum <>]) => [:sum [:cast [:* :procurement_requests.price_cents [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]] :bigint]]
2023-12-09T07:59:36.916Z NX-41294 DEBUG [leihs.procurement.resources.requests:467] - (-> (sql/select :procurement_requests.budget_period_id [(sql-sum qty-type) :result]) (sql/from :procurement_requests) (sql/where [:= :procurement_requests.budget_period_id [:cast bp-id :uuid]]) (sql/group-by :procurement_requests.budget_period_id)) => {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]] :bigint]] :result]], :from [:procurement_requests], :where [:= :procurement_requests.budget_period_id [:cast #uuid "76b66d78-bfe0-4c54-8c92-edbf467af784" :uuid]], :group-by [:procurement_requests.budget_period_id]}
>oo> get-total-price-cents {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]] :bigint]] :result]], :from [:procurement_requests], :where [:and [:= :procurement_requests.budget_period_id [:cast #uuid "76b66d78-bfe0-4c54-8c92-edbf467af784" :uuid]] [:!= :procurement_requests.approved_quantity nil]], :group-by [:procurement_requests.budget_period_id]}
2023-12-09T07:59:36.917Z NX-41294 DEBUG [leihs.procurement.resources.requests:420] - (some->> sqlmap sql-format (jdbc/execute-one! tx) :result) => 703900000M
>>1x #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x69c80923 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}
>>2x {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}
>o> admin? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.918Z NX-41294 DEBUG [leihs.procurement.permissions.user:33] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> admin? {:exists true}
>> can-delete2
>oo> hoi2
2023-12-09T07:59:36.919Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:?] - (sql-format (sql/select (vector [:and [:not [:exists (-> (sql/select true) (sql/from [:procurement_requests :pr]) (sql/where [:= :pr.budget_period_id [:cast (:id value) :uuid]]))]] [:not [:exists (-> (sql/select true) (sql/from [:procurement_budget_limits :pbl]) (sql/where [:= :pbl.budget_period_id [:cast (:id value) :uuid]]))]]] :result))) => ["SELECT NOT EXISTS (SELECT TRUE FROM procurement_requests AS pr WHERE pr.budget_period_id = CAST(? AS UUID)) AND NOT EXISTS (SELECT TRUE FROM procurement_budget_limits AS pbl WHERE pbl.budget_period_id = CAST(? AS UUID)) AS result" #uuid "24171a61-aec6-428e-b7ed-7461b3795454" #uuid "24171a61-aec6-428e-b7ed-7461b3795454"]
2023-12-09T07:59:36.920Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:155] - (jdbc/execute-one! (-> context :request :tx-next) (-> [:and [:not [:exists (-> (sql/select true) (sql/from [:procurement_requests :pr]) (sql/where [:= :pr.budget_period_id [:cast (:id value) :uuid]]))]] [:not [:exists (-> (sql/select true) (sql/from [:procurement_budget_limits :pbl]) (sql/where [:= :pbl.budget_period_id [:cast (:id value) :uuid]]))]]] (vector :result) sql/select sql-format spy)) => {:result false}
2023-12-09T07:59:36.920Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:155] - (-> (spy (jdbc/execute-one! (-> context :request :tx-next) (-> [:and [:not [:exists (-> (sql/select true) (sql/from [:procurement_requests :pr]) (sql/where [:= :pr.budget_period_id [:cast (:id value) :uuid]]))]] [:not [:exists (-> (sql/select true) (sql/from [:procurement_budget_limits :pbl]) (sql/where [:= :pbl.budget_period_id [:cast (:id value) :uuid]]))]]] (vector :result) sql/select sql-format spy))) :result) => false
>>1x #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x69c80923 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}
>>2x {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}
>o> admin? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.920Z NX-41294 DEBUG [leihs.procurement.permissions.user:33] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> admin? {:exists true}
>oo> total-price-cents-new-requests {:id #uuid "24171a61-aec6-428e-b7ed-7461b3795454", :name 2021, :inspection_start_date #inst "2020-10-26T11:00:00.000000000-00:00", :end_date #inst "2020-12-31T11:00:00.000000000-00:00", :created_at #inst "2018-09-18T04:41:49.945068000-00:00", :updated_at #inst "2018-09-18T04:41:49.945068000-00:00"}
>oo> total-price-sqlmap :requested_quantity
>oo> sql-sum :requested_quantity
2023-12-09T07:59:36.921Z NX-41294 DEBUG [leihs.procurement.resources.requests:432] - (as-> qty-type <> [:* :procurement_requests.price_cents <>] [:cast <> :bigint] [:sum <>]) => [:sum [:cast [:* :procurement_requests.price_cents :requested_quantity] :bigint]]
2023-12-09T07:59:36.921Z NX-41294 DEBUG [leihs.procurement.resources.requests:467] - (-> (sql/select :procurement_requests.budget_period_id [(sql-sum qty-type) :result]) (sql/from :procurement_requests) (sql/where [:= :procurement_requests.budget_period_id [:cast bp-id :uuid]]) (sql/group-by :procurement_requests.budget_period_id)) => {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents :requested_quantity] :bigint]] :result]], :from [:procurement_requests], :where [:= :procurement_requests.budget_period_id [:cast [:cast #uuid "24171a61-aec6-428e-b7ed-7461b3795454" :uuid] :uuid]], :group-by [:procurement_requests.budget_period_id]}
>oo> get-total-price-cents {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents :requested_quantity] :bigint]] :result]], :from [:procurement_requests], :where [:and [:= :procurement_requests.budget_period_id [:cast [:cast #uuid "24171a61-aec6-428e-b7ed-7461b3795454" :uuid] :uuid]] [:= :procurement_requests.approved_quantity nil]], :group-by [:procurement_requests.budget_period_id]}
2023-12-09T07:59:36.923Z NX-41294 DEBUG [leihs.procurement.resources.requests:420] - (some->> sqlmap sql-format (jdbc/execute-one! tx) :result) => nil
>>1x #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x69c80923 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}
>>2x {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}
>o> admin? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.923Z NX-41294 DEBUG [leihs.procurement.permissions.user:33] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> admin? {:exists true}
>oo> total-price-cents-inspected-requests {:id #uuid "24171a61-aec6-428e-b7ed-7461b3795454", :name 2021, :inspection_start_date #inst "2020-10-26T11:00:00.000000000-00:00", :end_date #inst "2020-12-31T11:00:00.000000000-00:00", :created_at #inst "2018-09-18T04:41:49.945068000-00:00", :updated_at #inst "2018-09-18T04:41:49.945068000-00:00"}
>oo> bp-id #uuid "24171a61-aec6-428e-b7ed-7461b3795454"
>oo> total-price-sqlmap [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]
>oo> sql-sum [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]
2023-12-09T07:59:36.924Z NX-41294 DEBUG [leihs.procurement.resources.requests:432] - (as-> qty-type <> [:* :procurement_requests.price_cents <>] [:cast <> :bigint] [:sum <>]) => [:sum [:cast [:* :procurement_requests.price_cents [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]] :bigint]]
2023-12-09T07:59:36.924Z NX-41294 DEBUG [leihs.procurement.resources.requests:467] - (-> (sql/select :procurement_requests.budget_period_id [(sql-sum qty-type) :result]) (sql/from :procurement_requests) (sql/where [:= :procurement_requests.budget_period_id [:cast bp-id :uuid]]) (sql/group-by :procurement_requests.budget_period_id)) => {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]] :bigint]] :result]], :from [:procurement_requests], :where [:= :procurement_requests.budget_period_id [:cast #uuid "24171a61-aec6-428e-b7ed-7461b3795454" :uuid]], :group-by [:procurement_requests.budget_period_id]}
>oo> get-total-price-cents {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]] :bigint]] :result]], :from [:procurement_requests], :where [:and [:= :procurement_requests.budget_period_id [:cast #uuid "24171a61-aec6-428e-b7ed-7461b3795454" :uuid]] [:!= :procurement_requests.approved_quantity nil]], :group-by [:procurement_requests.budget_period_id]}
2023-12-09T07:59:36.925Z NX-41294 DEBUG [leihs.procurement.resources.requests:420] - (some->> sqlmap sql-format (jdbc/execute-one! tx) :result) => 703900000M
>>1x #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x69c80923 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}
>>2x {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}
>o> admin? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.926Z NX-41294 DEBUG [leihs.procurement.permissions.user:33] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> admin? {:exists true}
>> can-delete2
>oo> hoi2
2023-12-09T07:59:36.926Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:?] - (sql-format (sql/select (vector [:and [:not [:exists (-> (sql/select true) (sql/from [:procurement_requests :pr]) (sql/where [:= :pr.budget_period_id [:cast (:id value) :uuid]]))]] [:not [:exists (-> (sql/select true) (sql/from [:procurement_budget_limits :pbl]) (sql/where [:= :pbl.budget_period_id [:cast (:id value) :uuid]]))]]] :result))) => ["SELECT NOT EXISTS (SELECT TRUE FROM procurement_requests AS pr WHERE pr.budget_period_id = CAST(? AS UUID)) AND NOT EXISTS (SELECT TRUE FROM procurement_budget_limits AS pbl WHERE pbl.budget_period_id = CAST(? AS UUID)) AS result" #uuid "3b7eab1e-c8b5-512b-9146-91cc295be955" #uuid "3b7eab1e-c8b5-512b-9146-91cc295be955"]
2023-12-09T07:59:36.927Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:155] - (jdbc/execute-one! (-> context :request :tx-next) (-> [:and [:not [:exists (-> (sql/select true) (sql/from [:procurement_requests :pr]) (sql/where [:= :pr.budget_period_id [:cast (:id value) :uuid]]))]] [:not [:exists (-> (sql/select true) (sql/from [:procurement_budget_limits :pbl]) (sql/where [:= :pbl.budget_period_id [:cast (:id value) :uuid]]))]]] (vector :result) sql/select sql-format spy)) => {:result false}
2023-12-09T07:59:36.927Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:155] - (-> (spy (jdbc/execute-one! (-> context :request :tx-next) (-> [:and [:not [:exists (-> (sql/select true) (sql/from [:procurement_requests :pr]) (sql/where [:= :pr.budget_period_id [:cast (:id value) :uuid]]))]] [:not [:exists (-> (sql/select true) (sql/from [:procurement_budget_limits :pbl]) (sql/where [:= :pbl.budget_period_id [:cast (:id value) :uuid]]))]]] (vector :result) sql/select sql-format spy))) :result) => false
>>1x #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x69c80923 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}
>>2x {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}
>o> admin? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.927Z NX-41294 DEBUG [leihs.procurement.permissions.user:33] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> admin? {:exists true}
>oo> total-price-cents-new-requests {:id #uuid "3b7eab1e-c8b5-512b-9146-91cc295be955", :name 2020, :inspection_start_date #inst "2019-11-09T11:00:00.000000000-00:00", :end_date #inst "2019-12-31T00:00:00.000000000-00:00", :created_at #inst "2016-03-30T09:06:19.000000000-00:00", :updated_at #inst "2018-09-18T04:41:49.937658000-00:00"}
>oo> total-price-sqlmap :requested_quantity
>oo> sql-sum :requested_quantity
2023-12-09T07:59:36.928Z NX-41294 DEBUG [leihs.procurement.resources.requests:432] - (as-> qty-type <> [:* :procurement_requests.price_cents <>] [:cast <> :bigint] [:sum <>]) => [:sum [:cast [:* :procurement_requests.price_cents :requested_quantity] :bigint]]
2023-12-09T07:59:36.928Z NX-41294 DEBUG [leihs.procurement.resources.requests:467] - (-> (sql/select :procurement_requests.budget_period_id [(sql-sum qty-type) :result]) (sql/from :procurement_requests) (sql/where [:= :procurement_requests.budget_period_id [:cast bp-id :uuid]]) (sql/group-by :procurement_requests.budget_period_id)) => {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents :requested_quantity] :bigint]] :result]], :from [:procurement_requests], :where [:= :procurement_requests.budget_period_id [:cast [:cast #uuid "3b7eab1e-c8b5-512b-9146-91cc295be955" :uuid] :uuid]], :group-by [:procurement_requests.budget_period_id]}
>oo> get-total-price-cents {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents :requested_quantity] :bigint]] :result]], :from [:procurement_requests], :where [:and [:= :procurement_requests.budget_period_id [:cast [:cast #uuid "3b7eab1e-c8b5-512b-9146-91cc295be955" :uuid] :uuid]] [:= :procurement_requests.approved_quantity nil]], :group-by [:procurement_requests.budget_period_id]}
2023-12-09T07:59:36.929Z NX-41294 DEBUG [leihs.procurement.resources.requests:420] - (some->> sqlmap sql-format (jdbc/execute-one! tx) :result) => nil
>>1x #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x69c80923 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}
>>2x {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}
>o> admin? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.930Z NX-41294 DEBUG [leihs.procurement.permissions.user:33] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> admin? {:exists true}
>oo> total-price-cents-inspected-requests {:id #uuid "3b7eab1e-c8b5-512b-9146-91cc295be955", :name 2020, :inspection_start_date #inst "2019-11-09T11:00:00.000000000-00:00", :end_date #inst "2019-12-31T00:00:00.000000000-00:00", :created_at #inst "2016-03-30T09:06:19.000000000-00:00", :updated_at #inst "2018-09-18T04:41:49.937658000-00:00"}
>oo> bp-id #uuid "3b7eab1e-c8b5-512b-9146-91cc295be955"
>oo> total-price-sqlmap [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]
>oo> sql-sum [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]
2023-12-09T07:59:36.930Z NX-41294 DEBUG [leihs.procurement.resources.requests:432] - (as-> qty-type <> [:* :procurement_requests.price_cents <>] [:cast <> :bigint] [:sum <>]) => [:sum [:cast [:* :procurement_requests.price_cents [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]] :bigint]]
2023-12-09T07:59:36.930Z NX-41294 DEBUG [leihs.procurement.resources.requests:467] - (-> (sql/select :procurement_requests.budget_period_id [(sql-sum qty-type) :result]) (sql/from :procurement_requests) (sql/where [:= :procurement_requests.budget_period_id [:cast bp-id :uuid]]) (sql/group-by :procurement_requests.budget_period_id)) => {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]] :bigint]] :result]], :from [:procurement_requests], :where [:= :procurement_requests.budget_period_id [:cast #uuid "3b7eab1e-c8b5-512b-9146-91cc295be955" :uuid]], :group-by [:procurement_requests.budget_period_id]}
>oo> get-total-price-cents {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]] :bigint]] :result]], :from [:procurement_requests], :where [:and [:= :procurement_requests.budget_period_id [:cast #uuid "3b7eab1e-c8b5-512b-9146-91cc295be955" :uuid]] [:!= :procurement_requests.approved_quantity nil]], :group-by [:procurement_requests.budget_period_id]}
2023-12-09T07:59:36.932Z NX-41294 DEBUG [leihs.procurement.resources.requests:420] - (some->> sqlmap sql-format (jdbc/execute-one! tx) :result) => 529743800M
>>1x #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x69c80923 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}
>>2x {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}
>o> admin? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.932Z NX-41294 DEBUG [leihs.procurement.permissions.user:33] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> admin? {:exists true}
>> can-delete2
>oo> hoi2
2023-12-09T07:59:36.933Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:?] - (sql-format (sql/select (vector [:and [:not [:exists (-> (sql/select true) (sql/from [:procurement_requests :pr]) (sql/where [:= :pr.budget_period_id [:cast (:id value) :uuid]]))]] [:not [:exists (-> (sql/select true) (sql/from [:procurement_budget_limits :pbl]) (sql/where [:= :pbl.budget_period_id [:cast (:id value) :uuid]]))]]] :result))) => ["SELECT NOT EXISTS (SELECT TRUE FROM procurement_requests AS pr WHERE pr.budget_period_id = CAST(? AS UUID)) AND NOT EXISTS (SELECT TRUE FROM procurement_budget_limits AS pbl WHERE pbl.budget_period_id = CAST(? AS UUID)) AS result" #uuid "9fb023db-725d-5881-8838-bae3e970ffd0" #uuid "9fb023db-725d-5881-8838-bae3e970ffd0"]
2023-12-09T07:59:36.933Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:155] - (jdbc/execute-one! (-> context :request :tx-next) (-> [:and [:not [:exists (-> (sql/select true) (sql/from [:procurement_requests :pr]) (sql/where [:= :pr.budget_period_id [:cast (:id value) :uuid]]))]] [:not [:exists (-> (sql/select true) (sql/from [:procurement_budget_limits :pbl]) (sql/where [:= :pbl.budget_period_id [:cast (:id value) :uuid]]))]]] (vector :result) sql/select sql-format spy)) => {:result false}
2023-12-09T07:59:36.933Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:155] - (-> (spy (jdbc/execute-one! (-> context :request :tx-next) (-> [:and [:not [:exists (-> (sql/select true) (sql/from [:procurement_requests :pr]) (sql/where [:= :pr.budget_period_id [:cast (:id value) :uuid]]))]] [:not [:exists (-> (sql/select true) (sql/from [:procurement_budget_limits :pbl]) (sql/where [:= :pbl.budget_period_id [:cast (:id value) :uuid]]))]]] (vector :result) sql/select sql-format spy))) :result) => false
>>1x #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x69c80923 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}
>>2x {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}
>o> admin? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.934Z NX-41294 DEBUG [leihs.procurement.permissions.user:33] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> admin? {:exists true}
>oo> total-price-cents-new-requests {:id #uuid "9fb023db-725d-5881-8838-bae3e970ffd0", :name 2019, :inspection_start_date #inst "2018-11-10T00:00:00.000000000-00:00", :end_date #inst "2018-12-31T00:00:00.000000000-00:00", :created_at #inst "2016-03-30T09:06:01.000000000-00:00", :updated_at #inst "2018-11-02T16:06:45.497590000-00:00"}
>oo> total-price-sqlmap :requested_quantity
>oo> sql-sum :requested_quantity
2023-12-09T07:59:36.934Z NX-41294 DEBUG [leihs.procurement.resources.requests:432] - (as-> qty-type <> [:* :procurement_requests.price_cents <>] [:cast <> :bigint] [:sum <>]) => [:sum [:cast [:* :procurement_requests.price_cents :requested_quantity] :bigint]]
2023-12-09T07:59:36.934Z NX-41294 DEBUG [leihs.procurement.resources.requests:467] - (-> (sql/select :procurement_requests.budget_period_id [(sql-sum qty-type) :result]) (sql/from :procurement_requests) (sql/where [:= :procurement_requests.budget_period_id [:cast bp-id :uuid]]) (sql/group-by :procurement_requests.budget_period_id)) => {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents :requested_quantity] :bigint]] :result]], :from [:procurement_requests], :where [:= :procurement_requests.budget_period_id [:cast [:cast #uuid "9fb023db-725d-5881-8838-bae3e970ffd0" :uuid] :uuid]], :group-by [:procurement_requests.budget_period_id]}
>oo> get-total-price-cents {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents :requested_quantity] :bigint]] :result]], :from [:procurement_requests], :where [:and [:= :procurement_requests.budget_period_id [:cast [:cast #uuid "9fb023db-725d-5881-8838-bae3e970ffd0" :uuid] :uuid]] [:= :procurement_requests.approved_quantity nil]], :group-by [:procurement_requests.budget_period_id]}
2023-12-09T07:59:36.935Z NX-41294 DEBUG [leihs.procurement.resources.requests:420] - (some->> sqlmap sql-format (jdbc/execute-one! tx) :result) => 1000000M
>>1x #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x69c80923 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}
>>2x {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}
>o> admin? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.936Z NX-41294 DEBUG [leihs.procurement.permissions.user:33] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> admin? {:exists true}
>oo> total-price-cents-inspected-requests {:id #uuid "9fb023db-725d-5881-8838-bae3e970ffd0", :name 2019, :inspection_start_date #inst "2018-11-10T00:00:00.000000000-00:00", :end_date #inst "2018-12-31T00:00:00.000000000-00:00", :created_at #inst "2016-03-30T09:06:01.000000000-00:00", :updated_at #inst "2018-11-02T16:06:45.497590000-00:00"}
>oo> bp-id #uuid "9fb023db-725d-5881-8838-bae3e970ffd0"
>oo> total-price-sqlmap [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]
>oo> sql-sum [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]
2023-12-09T07:59:36.936Z NX-41294 DEBUG [leihs.procurement.resources.requests:432] - (as-> qty-type <> [:* :procurement_requests.price_cents <>] [:cast <> :bigint] [:sum <>]) => [:sum [:cast [:* :procurement_requests.price_cents [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]] :bigint]]
2023-12-09T07:59:36.936Z NX-41294 DEBUG [leihs.procurement.resources.requests:467] - (-> (sql/select :procurement_requests.budget_period_id [(sql-sum qty-type) :result]) (sql/from :procurement_requests) (sql/where [:= :procurement_requests.budget_period_id [:cast bp-id :uuid]]) (sql/group-by :procurement_requests.budget_period_id)) => {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]] :bigint]] :result]], :from [:procurement_requests], :where [:= :procurement_requests.budget_period_id [:cast #uuid "9fb023db-725d-5881-8838-bae3e970ffd0" :uuid]], :group-by [:procurement_requests.budget_period_id]}
>oo> get-total-price-cents {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]] :bigint]] :result]], :from [:procurement_requests], :where [:and [:= :procurement_requests.budget_period_id [:cast #uuid "9fb023db-725d-5881-8838-bae3e970ffd0" :uuid]] [:!= :procurement_requests.approved_quantity nil]], :group-by [:procurement_requests.budget_period_id]}
2023-12-09T07:59:36.938Z NX-41294 DEBUG [leihs.procurement.resources.requests:420] - (some->> sqlmap sql-format (jdbc/execute-one! tx) :result) => 612864300M
>>1x #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x69c80923 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}
>>2x {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}
>o> admin? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.938Z NX-41294 DEBUG [leihs.procurement.permissions.user:33] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> admin? {:exists true}
>> can-delete2
>oo> hoi2
2023-12-09T07:59:36.939Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:?] - (sql-format (sql/select (vector [:and [:not [:exists (-> (sql/select true) (sql/from [:procurement_requests :pr]) (sql/where [:= :pr.budget_period_id [:cast (:id value) :uuid]]))]] [:not [:exists (-> (sql/select true) (sql/from [:procurement_budget_limits :pbl]) (sql/where [:= :pbl.budget_period_id [:cast (:id value) :uuid]]))]]] :result))) => ["SELECT NOT EXISTS (SELECT TRUE FROM procurement_requests AS pr WHERE pr.budget_period_id = CAST(? AS UUID)) AND NOT EXISTS (SELECT TRUE FROM procurement_budget_limits AS pbl WHERE pbl.budget_period_id = CAST(? AS UUID)) AS result" #uuid "c2c5f618-7e05-5e43-a2b1-ec7f9172335d" #uuid "c2c5f618-7e05-5e43-a2b1-ec7f9172335d"]
2023-12-09T07:59:36.939Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:155] - (jdbc/execute-one! (-> context :request :tx-next) (-> [:and [:not [:exists (-> (sql/select true) (sql/from [:procurement_requests :pr]) (sql/where [:= :pr.budget_period_id [:cast (:id value) :uuid]]))]] [:not [:exists (-> (sql/select true) (sql/from [:procurement_budget_limits :pbl]) (sql/where [:= :pbl.budget_period_id [:cast (:id value) :uuid]]))]]] (vector :result) sql/select sql-format spy)) => {:result false}
2023-12-09T07:59:36.940Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:155] - (-> (spy (jdbc/execute-one! (-> context :request :tx-next) (-> [:and [:not [:exists (-> (sql/select true) (sql/from [:procurement_requests :pr]) (sql/where [:= :pr.budget_period_id [:cast (:id value) :uuid]]))]] [:not [:exists (-> (sql/select true) (sql/from [:procurement_budget_limits :pbl]) (sql/where [:= :pbl.budget_period_id [:cast (:id value) :uuid]]))]]] (vector :result) sql/select sql-format spy))) :result) => false
>>1x #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x69c80923 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}
>>2x {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}
>o> admin? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.940Z NX-41294 DEBUG [leihs.procurement.permissions.user:33] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> admin? {:exists true}
>oo> total-price-cents-new-requests {:id #uuid "c2c5f618-7e05-5e43-a2b1-ec7f9172335d", :name 2018, :inspection_start_date #inst "2017-11-04T00:00:00.000000000-00:00", :end_date #inst "2017-12-31T00:00:00.000000000-00:00", :created_at #inst "2016-03-30T09:05:27.000000000-00:00", :updated_at #inst "2018-02-23T13:51:41.593810000-00:00"}
>oo> total-price-sqlmap :requested_quantity
>oo> sql-sum :requested_quantity
2023-12-09T07:59:36.940Z NX-41294 DEBUG [leihs.procurement.resources.requests:432] - (as-> qty-type <> [:* :procurement_requests.price_cents <>] [:cast <> :bigint] [:sum <>]) => [:sum [:cast [:* :procurement_requests.price_cents :requested_quantity] :bigint]]
2023-12-09T07:59:36.940Z NX-41294 DEBUG [leihs.procurement.resources.requests:467] - (-> (sql/select :procurement_requests.budget_period_id [(sql-sum qty-type) :result]) (sql/from :procurement_requests) (sql/where [:= :procurement_requests.budget_period_id [:cast bp-id :uuid]]) (sql/group-by :procurement_requests.budget_period_id)) => {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents :requested_quantity] :bigint]] :result]], :from [:procurement_requests], :where [:= :procurement_requests.budget_period_id [:cast [:cast #uuid "c2c5f618-7e05-5e43-a2b1-ec7f9172335d" :uuid] :uuid]], :group-by [:procurement_requests.budget_period_id]}
>oo> get-total-price-cents {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents :requested_quantity] :bigint]] :result]], :from [:procurement_requests], :where [:and [:= :procurement_requests.budget_period_id [:cast [:cast #uuid "c2c5f618-7e05-5e43-a2b1-ec7f9172335d" :uuid] :uuid]] [:= :procurement_requests.approved_quantity nil]], :group-by [:procurement_requests.budget_period_id]}
2023-12-09T07:59:36.942Z NX-41294 DEBUG [leihs.procurement.resources.requests:420] - (some->> sqlmap sql-format (jdbc/execute-one! tx) :result) => 2443000M
>>1x #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x69c80923 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}
>>2x {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}
>o> admin? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.942Z NX-41294 DEBUG [leihs.procurement.permissions.user:33] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> admin? {:exists true}
>oo> total-price-cents-inspected-requests {:id #uuid "c2c5f618-7e05-5e43-a2b1-ec7f9172335d", :name 2018, :inspection_start_date #inst "2017-11-04T00:00:00.000000000-00:00", :end_date #inst "2017-12-31T00:00:00.000000000-00:00", :created_at #inst "2016-03-30T09:05:27.000000000-00:00", :updated_at #inst "2018-02-23T13:51:41.593810000-00:00"}
>oo> bp-id #uuid "c2c5f618-7e05-5e43-a2b1-ec7f9172335d"
>oo> total-price-sqlmap [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]
>oo> sql-sum [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]
2023-12-09T07:59:36.943Z NX-41294 DEBUG [leihs.procurement.resources.requests:432] - (as-> qty-type <> [:* :procurement_requests.price_cents <>] [:cast <> :bigint] [:sum <>]) => [:sum [:cast [:* :procurement_requests.price_cents [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]] :bigint]]
2023-12-09T07:59:36.944Z NX-41294 DEBUG [leihs.procurement.resources.requests:467] - (-> (sql/select :procurement_requests.budget_period_id [(sql-sum qty-type) :result]) (sql/from :procurement_requests) (sql/where [:= :procurement_requests.budget_period_id [:cast bp-id :uuid]]) (sql/group-by :procurement_requests.budget_period_id)) => {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]] :bigint]] :result]], :from [:procurement_requests], :where [:= :procurement_requests.budget_period_id [:cast #uuid "c2c5f618-7e05-5e43-a2b1-ec7f9172335d" :uuid]], :group-by [:procurement_requests.budget_period_id]}
>oo> get-total-price-cents {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]] :bigint]] :result]], :from [:procurement_requests], :where [:and [:= :procurement_requests.budget_period_id [:cast #uuid "c2c5f618-7e05-5e43-a2b1-ec7f9172335d" :uuid]] [:!= :procurement_requests.approved_quantity nil]], :group-by [:procurement_requests.budget_period_id]}
2023-12-09T07:59:36.946Z NX-41294 DEBUG [leihs.procurement.resources.requests:420] - (some->> sqlmap sql-format (jdbc/execute-one! tx) :result) => 437361300M
>>1x #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x69c80923 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}
>>2x {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}
>o> admin? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.947Z NX-41294 DEBUG [leihs.procurement.permissions.user:33] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> admin? {:exists true}
>> can-delete2
>oo> hoi2
2023-12-09T07:59:36.948Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:?] - (sql-format (sql/select (vector [:and [:not [:exists (-> (sql/select true) (sql/from [:procurement_requests :pr]) (sql/where [:= :pr.budget_period_id [:cast (:id value) :uuid]]))]] [:not [:exists (-> (sql/select true) (sql/from [:procurement_budget_limits :pbl]) (sql/where [:= :pbl.budget_period_id [:cast (:id value) :uuid]]))]]] :result))) => ["SELECT NOT EXISTS (SELECT TRUE FROM procurement_requests AS pr WHERE pr.budget_period_id = CAST(? AS UUID)) AND NOT EXISTS (SELECT TRUE FROM procurement_budget_limits AS pbl WHERE pbl.budget_period_id = CAST(? AS UUID)) AS result" #uuid "4f367b79-76cf-5f12-ab7b-535a7430e6da" #uuid "4f367b79-76cf-5f12-ab7b-535a7430e6da"]
2023-12-09T07:59:36.948Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:155] - (jdbc/execute-one! (-> context :request :tx-next) (-> [:and [:not [:exists (-> (sql/select true) (sql/from [:procurement_requests :pr]) (sql/where [:= :pr.budget_period_id [:cast (:id value) :uuid]]))]] [:not [:exists (-> (sql/select true) (sql/from [:procurement_budget_limits :pbl]) (sql/where [:= :pbl.budget_period_id [:cast (:id value) :uuid]]))]]] (vector :result) sql/select sql-format spy)) => {:result false}
2023-12-09T07:59:36.948Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:155] - (-> (spy (jdbc/execute-one! (-> context :request :tx-next) (-> [:and [:not [:exists (-> (sql/select true) (sql/from [:procurement_requests :pr]) (sql/where [:= :pr.budget_period_id [:cast (:id value) :uuid]]))]] [:not [:exists (-> (sql/select true) (sql/from [:procurement_budget_limits :pbl]) (sql/where [:= :pbl.budget_period_id [:cast (:id value) :uuid]]))]]] (vector :result) sql/select sql-format spy))) :result) => false
>>1x #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x69c80923 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}
>>2x {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}
>o> admin? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.949Z NX-41294 DEBUG [leihs.procurement.permissions.user:33] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> admin? {:exists true}
>oo> total-price-cents-new-requests {:id #uuid "4f367b79-76cf-5f12-ab7b-535a7430e6da", :name 2016, :inspection_start_date #inst "2016-11-01T00:00:00.000000000-00:00", :end_date #inst "2017-01-30T00:00:00.000000000-00:00", :created_at #inst "2016-11-21T14:23:48.000000000-00:00", :updated_at #inst "2016-11-21T14:23:48.000000000-00:00"}
>oo> total-price-sqlmap :requested_quantity
>oo> sql-sum :requested_quantity
2023-12-09T07:59:36.949Z NX-41294 DEBUG [leihs.procurement.resources.requests:432] - (as-> qty-type <> [:* :procurement_requests.price_cents <>] [:cast <> :bigint] [:sum <>]) => [:sum [:cast [:* :procurement_requests.price_cents :requested_quantity] :bigint]]
2023-12-09T07:59:36.950Z NX-41294 DEBUG [leihs.procurement.resources.requests:467] - (-> (sql/select :procurement_requests.budget_period_id [(sql-sum qty-type) :result]) (sql/from :procurement_requests) (sql/where [:= :procurement_requests.budget_period_id [:cast bp-id :uuid]]) (sql/group-by :procurement_requests.budget_period_id)) => {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents :requested_quantity] :bigint]] :result]], :from [:procurement_requests], :where [:= :procurement_requests.budget_period_id [:cast [:cast #uuid "4f367b79-76cf-5f12-ab7b-535a7430e6da" :uuid] :uuid]], :group-by [:procurement_requests.budget_period_id]}
>oo> get-total-price-cents {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents :requested_quantity] :bigint]] :result]], :from [:procurement_requests], :where [:and [:= :procurement_requests.budget_period_id [:cast [:cast #uuid "4f367b79-76cf-5f12-ab7b-535a7430e6da" :uuid] :uuid]] [:= :procurement_requests.approved_quantity nil]], :group-by [:procurement_requests.budget_period_id]}
2023-12-09T07:59:36.951Z NX-41294 DEBUG [leihs.procurement.resources.requests:420] - (some->> sqlmap sql-format (jdbc/execute-one! tx) :result) => 3658000M
>>1x #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x69c80923 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}
>>2x {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}
>o> admin? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.952Z NX-41294 DEBUG [leihs.procurement.permissions.user:33] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> admin? {:exists true}
>oo> total-price-cents-inspected-requests {:id #uuid "4f367b79-76cf-5f12-ab7b-535a7430e6da", :name 2016, :inspection_start_date #inst "2016-11-01T00:00:00.000000000-00:00", :end_date #inst "2017-01-30T00:00:00.000000000-00:00", :created_at #inst "2016-11-21T14:23:48.000000000-00:00", :updated_at #inst "2016-11-21T14:23:48.000000000-00:00"}
>oo> bp-id #uuid "4f367b79-76cf-5f12-ab7b-535a7430e6da"
>oo> total-price-sqlmap [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]
>oo> sql-sum [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]
2023-12-09T07:59:36.953Z NX-41294 DEBUG [leihs.procurement.resources.requests:432] - (as-> qty-type <> [:* :procurement_requests.price_cents <>] [:cast <> :bigint] [:sum <>]) => [:sum [:cast [:* :procurement_requests.price_cents [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]] :bigint]]
2023-12-09T07:59:36.953Z NX-41294 DEBUG [leihs.procurement.resources.requests:467] - (-> (sql/select :procurement_requests.budget_period_id [(sql-sum qty-type) :result]) (sql/from :procurement_requests) (sql/where [:= :procurement_requests.budget_period_id [:cast bp-id :uuid]]) (sql/group-by :procurement_requests.budget_period_id)) => {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]] :bigint]] :result]], :from [:procurement_requests], :where [:= :procurement_requests.budget_period_id [:cast #uuid "4f367b79-76cf-5f12-ab7b-535a7430e6da" :uuid]], :group-by [:procurement_requests.budget_period_id]}
>oo> get-total-price-cents {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]] :bigint]] :result]], :from [:procurement_requests], :where [:and [:= :procurement_requests.budget_period_id [:cast #uuid "4f367b79-76cf-5f12-ab7b-535a7430e6da" :uuid]] [:!= :procurement_requests.approved_quantity nil]], :group-by [:procurement_requests.budget_period_id]}
2023-12-09T07:59:36.956Z NX-41294 DEBUG [leihs.procurement.resources.requests:420] - (some->> sqlmap sql-format (jdbc/execute-one! tx) :result) => 17990000M
>>1x #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x69c80923 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}
>>2x {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}
>o> admin? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.956Z NX-41294 DEBUG [leihs.procurement.permissions.user:33] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> admin? {:exists true}
>> can-delete2
>oo> hoi2
2023-12-09T07:59:36.958Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:?] - (sql-format (sql/select (vector [:and [:not [:exists (-> (sql/select true) (sql/from [:procurement_requests :pr]) (sql/where [:= :pr.budget_period_id [:cast (:id value) :uuid]]))]] [:not [:exists (-> (sql/select true) (sql/from [:procurement_budget_limits :pbl]) (sql/where [:= :pbl.budget_period_id [:cast (:id value) :uuid]]))]]] :result))) => ["SELECT NOT EXISTS (SELECT TRUE FROM procurement_requests AS pr WHERE pr.budget_period_id = CAST(? AS UUID)) AND NOT EXISTS (SELECT TRUE FROM procurement_budget_limits AS pbl WHERE pbl.budget_period_id = CAST(? AS UUID)) AS result" #uuid "aba0576e-d65f-5fe0-aa80-89ce226ec9b1" #uuid "aba0576e-d65f-5fe0-aa80-89ce226ec9b1"]
2023-12-09T07:59:36.960Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:155] - (jdbc/execute-one! (-> context :request :tx-next) (-> [:and [:not [:exists (-> (sql/select true) (sql/from [:procurement_requests :pr]) (sql/where [:= :pr.budget_period_id [:cast (:id value) :uuid]]))]] [:not [:exists (-> (sql/select true) (sql/from [:procurement_budget_limits :pbl]) (sql/where [:= :pbl.budget_period_id [:cast (:id value) :uuid]]))]]] (vector :result) sql/select sql-format spy)) => {:result false}
2023-12-09T07:59:36.960Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:155] - (-> (spy (jdbc/execute-one! (-> context :request :tx-next) (-> [:and [:not [:exists (-> (sql/select true) (sql/from [:procurement_requests :pr]) (sql/where [:= :pr.budget_period_id [:cast (:id value) :uuid]]))]] [:not [:exists (-> (sql/select true) (sql/from [:procurement_budget_limits :pbl]) (sql/where [:= :pbl.budget_period_id [:cast (:id value) :uuid]]))]]] (vector :result) sql/select sql-format spy))) :result) => false
>>1x #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x69c80923 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}
>>2x {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}
>o> admin? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.961Z NX-41294 DEBUG [leihs.procurement.permissions.user:33] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> admin? {:exists true}
>oo> total-price-cents-new-requests {:id #uuid "aba0576e-d65f-5fe0-aa80-89ce226ec9b1", :name 2017, :inspection_start_date #inst "2016-11-04T00:00:00.000000000-00:00", :end_date #inst "2017-01-22T00:00:00.000000000-00:00", :created_at #inst "2016-03-30T09:05:04.000000000-00:00", :updated_at #inst "2016-03-30T09:05:04.000000000-00:00"}
>oo> total-price-sqlmap :requested_quantity
>oo> sql-sum :requested_quantity
2023-12-09T07:59:36.962Z NX-41294 DEBUG [leihs.procurement.resources.requests:432] - (as-> qty-type <> [:* :procurement_requests.price_cents <>] [:cast <> :bigint] [:sum <>]) => [:sum [:cast [:* :procurement_requests.price_cents :requested_quantity] :bigint]]
2023-12-09T07:59:36.962Z NX-41294 DEBUG [leihs.procurement.resources.requests:467] - (-> (sql/select :procurement_requests.budget_period_id [(sql-sum qty-type) :result]) (sql/from :procurement_requests) (sql/where [:= :procurement_requests.budget_period_id [:cast bp-id :uuid]]) (sql/group-by :procurement_requests.budget_period_id)) => {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents :requested_quantity] :bigint]] :result]], :from [:procurement_requests], :where [:= :procurement_requests.budget_period_id [:cast [:cast #uuid "aba0576e-d65f-5fe0-aa80-89ce226ec9b1" :uuid] :uuid]], :group-by [:procurement_requests.budget_period_id]}
>oo> get-total-price-cents {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents :requested_quantity] :bigint]] :result]], :from [:procurement_requests], :where [:and [:= :procurement_requests.budget_period_id [:cast [:cast #uuid "aba0576e-d65f-5fe0-aa80-89ce226ec9b1" :uuid] :uuid]] [:= :procurement_requests.approved_quantity nil]], :group-by [:procurement_requests.budget_period_id]}
2023-12-09T07:59:36.964Z NX-41294 DEBUG [leihs.procurement.resources.requests:420] - (some->> sqlmap sql-format (jdbc/execute-one! tx) :result) => 140000M
>>1x #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x69c80923 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}
>>2x {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}
>o> admin? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:36.965Z NX-41294 DEBUG [leihs.procurement.permissions.user:33] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> admin? {:exists true}
>oo> total-price-cents-inspected-requests {:id #uuid "aba0576e-d65f-5fe0-aa80-89ce226ec9b1", :name 2017, :inspection_start_date #inst "2016-11-04T00:00:00.000000000-00:00", :end_date #inst "2017-01-22T00:00:00.000000000-00:00", :created_at #inst "2016-03-30T09:05:04.000000000-00:00", :updated_at #inst "2016-03-30T09:05:04.000000000-00:00"}
>oo> bp-id #uuid "aba0576e-d65f-5fe0-aa80-89ce226ec9b1"
>oo> total-price-sqlmap [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]
>oo> sql-sum [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]
2023-12-09T07:59:36.965Z NX-41294 DEBUG [leihs.procurement.resources.requests:432] - (as-> qty-type <> [:* :procurement_requests.price_cents <>] [:cast <> :bigint] [:sum <>]) => [:sum [:cast [:* :procurement_requests.price_cents [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]] :bigint]]
2023-12-09T07:59:36.965Z NX-41294 DEBUG [leihs.procurement.resources.requests:467] - (-> (sql/select :procurement_requests.budget_period_id [(sql-sum qty-type) :result]) (sql/from :procurement_requests) (sql/where [:= :procurement_requests.budget_period_id [:cast bp-id :uuid]]) (sql/group-by :procurement_requests.budget_period_id)) => {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]] :bigint]] :result]], :from [:procurement_requests], :where [:= :procurement_requests.budget_period_id [:cast #uuid "aba0576e-d65f-5fe0-aa80-89ce226ec9b1" :uuid]], :group-by [:procurement_requests.budget_period_id]}
>oo> get-total-price-cents {:select [:procurement_requests.budget_period_id [[:sum [:cast [:* :procurement_requests.price_cents [[:coalesce :procurement_requests.order_quantity :procurement_requests.approved_quantity]]] :bigint]] :result]], :from [:procurement_requests], :where [:and [:= :procurement_requests.budget_period_id [:cast #uuid "aba0576e-d65f-5fe0-aa80-89ce226ec9b1" :uuid]] [:!= :procurement_requests.approved_quantity nil]], :group-by [:procurement_requests.budget_period_id]}
2023-12-09T07:59:36.967Z NX-41294 DEBUG [leihs.procurement.resources.requests:420] - (some->> sqlmap sql-format (jdbc/execute-one! tx) :result) => 492786800M

>request-grapql _> request {:leihs-user-language {:name Deutsch, :locale de-CH, :default true, :active true}, :authenticated-entity {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}, :cookies {leihs-anti-csrf-token {:value dc7e186c-6046-4dce-9a37-5d14ea14e0e1}, leihs-user-session {:value 9c7d0f0a-d4f8-419f-843b-2642a9e25659}}, :remote-addr 127.0.0.1, :start-time 216269529253000, :params {}, :settings {:email_sending_enabled false, :sessions_max_lifetime_secs 432000, :smtp_default_from_address noreply@zhdk.ch, :public_image_caching_enabled true, :sessions_force_secure false, :deliver_received_order_notifications false, :external_base_url http://localhost:3200, :sessions_force_uniqueness false, :email_signature Das ZHdK-Ausleihe-Team}, :tx-next #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x69c80923 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}, :query-params-raw {}, :route-params nil, :headers {origin http://localhost:3230, sec-fetch-site same-origin, sec-ch-ua-mobile ?0, host localhost:3230, user-agent Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36, content-type application/json, cookie leihs-anti-csrf-token=dc7e186c-6046-4dce-9a37-5d14ea14e0e1; leihs-user-session=9c7d0f0a-d4f8-419f-843b-2642a9e25659, content-length 376, sec-ch-ua "Google Chrome";v="119", "Chromium";v="119", "Not?A_Brand";v="24", sec-ch-ua-platform "macOS", referer http://localhost:3230/procure/admin/budget-periods, connection keep-alive, pragma no-cache, x-csrf-token dc7e186c-6046-4dce-9a37-5d14ea14e0e1, accept application/json, accept-language de-DE,de;q=0.9,en-US;q=0.8,en;q=0.7, sec-fetch-dest empty, accept-encoding gzip, deflate, br, sec-fetch-mode cors, cache-control no-cache}, :async-channel #object[org.httpkit.server.AsyncChannel 0x3e7eeeee /127.0.0.1:3230<->/127.0.0.1:54417], :server-port 3230, :params-raw {}, :tx {:datasource #object[com.zaxxer.hikari.HikariDataSource 0x691cb6c4 HikariDataSource (db-pool)]}, :content-length 376, :form-params {}, :websocket? false, :query-params {}, :content-type application/json, :form-params-raw {}, :character-encoding utf8, :uri /procure/graphql, :server-name localhost, :handler-key :graphql, :query-string nil, :body {:operationName AdminBudgetPeriods, :variables {}, :query query AdminBudgetPeriods {
  budget_periods {
    ...AdminBudgetPeriodProps
    __typename
  }
}

fragment AdminBudgetPeriodProps on BudgetPeriod {
  id
  name
  inspection_start_date
  end_date
  can_delete
  total_price_cents_new_requests
  total_price_cents_inspected_requests
  __typename
}
}, :graphql-schema #CompiledSchema<>, :handler #object[leihs.procurement.graphql$handler 0x362b488d leihs.procurement.graphql$handler@362b488d], :multipart-params {}, :scheme :http, :request-method :post, :accept {:mime :json, :charset nil, :encoding nil, :language nil}}

>request-c-grapql _> request (json) {"leihs-user-language":{"name":"Deutsch","locale":"de-CH","default":true,"active":true},"authenticated-entity":{"email":"manuel.radl@zhdk.ch","contracts_count":1,"lastname":"Radl","org_id":"271682","scope_read":true,"is_admin":true,"authentication-method":"session","login":"mradl","scope_system_admin_write":true,"scope_write":true,"firstname":"Manuel","scope_admin_write":true,"user_session_created_at":"2023-12-09T07:09:54.188679Z","id":"a786135f-c159-4618-9dd3-0012ebb3d500","user_session_id":"4d6070c4-5989-45bb-a1dc-1ee5409551ae","scope_system_admin_read":true,"access-rights":[{"role":"customer","inventory_pool_id":"3977012c-ce0e-501f-889b-8715fdb5d83b"},{"role":"customer","inventory_pool_id":"5863967f-9804-4909-a9b7-92254616d6b2"},{"role":"customer","inventory_pool_id":"5dd25b58-fa56-5095-bd97-2696d92c2fb1"},{"role":"customer","inventory_pool_id":"77e88ec8-9ff6-5435-818e-dc902fc631a6"},{"role":"inventory_manager","inventory_pool_id":"8bd16d45-056d-5590-bc7f-12849f034351"},{"role":"inventory_manager","inventory_pool_id":"a02b8163-9a16-5066-b48e-9eb74cf8b791"},{"role":"inventory_manager","inventory_pool_id":"b534b07c-d9bf-4572-840c-0a630b8cd8ed"},{"role":"customer","inventory_pool_id":"fc5a841e-36c6-5dc3-8207-1306c1fb89bf"},{"role":"customer","inventory_pool_id":"ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}],"user_id":"a786135f-c159-4618-9dd3-0012ebb3d500","is_system_admin":true,"external_sign_out_url":null,"language_locale":"de-CH","inventory_pool_roles_count":9,"scope_admin_read":true},"cookies":{"leihs-anti-csrf-token":{"value":"dc7e186c-6046-4dce-9a37-5d14ea14e0e1"},"leihs-user-session":{"value":"9c7d0f0a-d4f8-419f-843b-2642a9e25659"}},"remote-addr":"127.0.0.1","start-time":216269529253000,"params":{},"settings":{"email_sending_enabled":false,"sessions_max_lifetime_secs":432000,"smtp_default_from_address":"noreply@zhdk.ch","public_image_caching_enabled":true,"sessions_force_secure":false,"deliver_received_order_notifications":false,"external_base_url":"http:\/\/localhost:3200","sessions_force_uniqueness":false,"email_signature":"Das ZHdK-Ausleihe-Team"},"query-params-raw":{},"route-params":null,"headers":{"origin":"http:\/\/localhost:3230","sec-fetch-site":"same-origin","sec-ch-ua-mobile":"?0","host":"localhost:3230","user-agent":"Mozilla\/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit\/537.36 (KHTML, like Gecko) Chrome\/119.0.0.0 Safari\/537.36","content-type":"application\/json","cookie":"leihs-anti-csrf-token=dc7e186c-6046-4dce-9a37-5d14ea14e0e1; leihs-user-session=9c7d0f0a-d4f8-419f-843b-2642a9e25659","content-length":"376","sec-ch-ua":"\"Google Chrome\";v=\"119\", \"Chromium\";v=\"119\", \"Not?A_Brand\";v=\"24\"","sec-ch-ua-platform":"\"macOS\"","referer":"http:\/\/localhost:3230\/procure\/admin\/budget-periods","connection":"keep-alive","pragma":"no-cache","x-csrf-token":"dc7e186c-6046-4dce-9a37-5d14ea14e0e1","accept":"application\/json","accept-language":"de-DE,de;q=0.9,en-US;q=0.8,en;q=0.7","sec-fetch-dest":"empty","accept-encoding":"gzip, deflate, br","sec-fetch-mode":"cors","cache-control":"no-cache"},"server-port":3230,"params-raw":{},"content-length":376,"form-params":{},"websocket?":false,"query-params":{},"content-type":"application\/json","form-params-raw":{},"character-encoding":"utf8","uri":"\/procure\/graphql","server-name":"localhost","handler-key":"graphql","query-string":null,"body":{"operationName":"AdminBudgetPeriods","variables":{},"query":"query AdminBudgetPeriods {\n  budget_periods {\n    ...AdminBudgetPeriodProps\n    __typename\n  }\n}\n\nfragment AdminBudgetPeriodProps on BudgetPeriod {\n  id\n  name\n  inspection_start_date\n  end_date\n  can_delete\n  total_price_cents_new_requests\n  total_price_cents_inspected_requests\n  __typename\n}\n"},"multipart-params":{},"scheme":"http","request-method":"post","accept":{"mime":"json","charset":null,"encoding":null,"language":null}}

>request-grapql _> result => {:data #ordered/map ([:budget_periods [#ordered/map ([:id 1a1dab20-c661-4204-a913-28065d570f7c] [:name 2028] [:inspection_start_date 2027-11-01 01:00:00.0] [:end_date 2027-12-31 01:00:00.0] [:can_delete false] [:total_price_cents_new_requests 0] [:total_price_cents_inspected_requests 0] [:__typename :BudgetPeriod]) #ordered/map ([:id dfdd0798-6462-46fc-995f-a7d7233f30fd] [:name 2027] [:inspection_start_date 2026-11-02 01:00:00.0] [:end_date 2026-12-31 01:00:00.0] [:can_delete false] [:total_price_cents_new_requests 0] [:total_price_cents_inspected_requests 0] [:__typename :BudgetPeriod]) #ordered/map ([:id 6b689ed8-8148-485a-b1ca-86c1c739503e] [:name 2026] [:inspection_start_date 2025-11-03 01:00:00.0] [:end_date 2025-12-31 01:00:00.0] [:can_delete false] [:total_price_cents_new_requests 70543100] [:total_price_cents_inspected_requests 0] [:__typename :BudgetPeriod]) #ordered/map ([:id 1173b482-b9e6-46b4-a5e3-0b021c860e9b] [:name 2025] [:inspection_start_date 2024-11-04 01:00:00.0] [:end_date 2024-12-31 01:00:00.0] [:can_delete false] [:total_price_cents_new_requests 75250000] [:total_price_cents_inspected_requests 0] [:__typename :BudgetPeriod]) #ordered/map ([:id e5d2ae4b-566f-4d6d-aed9-d6a8353eda7f] [:name 2024] [:inspection_start_date 2023-10-01 12:00:00.0] [:end_date 2023-12-31 01:00:00.0] [:can_delete false] [:total_price_cents_new_requests 0] [:total_price_cents_inspected_requests 560501800] [:__typename :BudgetPeriod]) #ordered/map ([:id 951ac476-4f92-4ff9-9f64-26fc8f8b61c5] [:name 2023] [:inspection_start_date 2022-11-01 01:00:00.0] [:end_date 2022-12-31 12:00:00.0] [:can_delete false] [:total_price_cents_new_requests 0] [:total_price_cents_inspected_requests 680423900] [:__typename :BudgetPeriod]) #ordered/map ([:id 76b66d78-bfe0-4c54-8c92-edbf467af784] [:name 2022] [:inspection_start_date 2021-10-29 12:00:00.0] [:end_date 2021-12-31 12:00:00.0] [:can_delete false] [:total_price_cents_new_requests 0] [:total_price_cents_inspected_requests 703900000] [:__typename :BudgetPeriod]) #ordered/map ([:id 24171a61-aec6-428e-b7ed-7461b3795454] [:name 2021] [:inspection_start_date 2020-10-26 12:00:00.0] [:end_date 2020-12-31 12:00:00.0] [:can_delete false] [:total_price_cents_new_requests 0] [:total_price_cents_inspected_requests 703900000] [:__typename :BudgetPeriod]) #ordered/map ([:id 3b7eab1e-c8b5-512b-9146-91cc295be955] [:name 2020] [:inspection_start_date 2019-11-09 12:00:00.0] [:end_date 2019-12-31 01:00:00.0] [:can_delete false] [:total_price_cents_new_requests 0] [:total_price_cents_inspected_requests 529743800] [:__typename :BudgetPeriod]) #ordered/map ([:id 9fb023db-725d-5881-8838-bae3e970ffd0] [:name 2019] [:inspection_start_date 2018-11-10 01:00:00.0] [:end_date 2018-12-31 01:00:00.0] [:can_delete false] [:total_price_cents_new_requests 1000000] [:total_price_cents_inspected_requests 612864300] [:__typename :BudgetPeriod]) #ordered/map ([:id c2c5f618-7e05-5e43-a2b1-ec7f9172335d] [:name 2018] [:inspection_start_date 2017-11-04 01:00:00.0] [:end_date 2017-12-31 01:00:00.0] [:can_delete false] [:total_price_cents_new_requests 2443000] [:total_price_cents_inspected_requests 437361300] [:__typename :BudgetPeriod]) #ordered/map ([:id 4f367b79-76cf-5f12-ab7b-535a7430e6da] [:name 2016] [:inspection_start_date 2016-11-01 01:00:00.0] [:end_date 2017-01-30 01:00:00.0] [:can_delete false] [:total_price_cents_new_requests 3658000] [:total_price_cents_inspected_requests 17990000] [:__typename :BudgetPeriod]) #ordered/map ([:id aba0576e-d65f-5fe0-aa80-89ce226ec9b1] [:name 2017] [:inspection_start_date 2016-11-04 01:00:00.0] [:end_date 2017-01-22 01:00:00.0] [:can_delete false] [:total_price_cents_new_requests 140000] [:total_price_cents_inspected_requests 492786800] [:__typename :BudgetPeriod])]])}
2023-12-09T07:59:36.974Z NX-41294 DEBUG [leihs.procurement.graphql:86] - result => {:data #ordered/map ([:budget_periods [#ordered/map ([:id "1a1dab20-c661-4204-a913-28065d570f7c"] [:name "2028"] [:inspection_start_date "2027-11-01 01:00:00.0"] [:end_date "2027-12-31 01:00:00.0"] [:can_delete false] [:total_price_cents_new_requests "0"] [:total_price_cents_inspected_requests "0"] [:__typename :BudgetPeriod]) #ordered/map ([:id "dfdd0798-6462-46fc-995f-a7d7233f30fd"] [:name "2027"] [:inspection_start_date "2026-11-02 01:00:00.0"] [:end_date "2026-12-31 01:00:00.0"] [:can_delete false] [:total_price_cents_new_requests "0"] [:total_price_cents_inspected_requests "0"] [:__typename :BudgetPeriod]) #ordered/map ([:id "6b689ed8-8148-485a-b1ca-86c1c739503e"] [:name "2026"] [:inspection_start_date "2025-11-03 01:00:00.0"] [:end_date "2025-12-31 01:00:00.0"] [:can_delete false] [:total_price_cents_new_requests "70543100"] [:total_price_cents_inspected_requests "0"] [:__typename :BudgetPeriod]) #ordered/map ([:id "1173b482-b9e6-46b4-a5e3-0b021c860e9b"] [:name "2025"] [:inspection_start_date "2024-11-04 01:00:00.0"] [:end_date "2024-12-31 01:00:00.0"] [:can_delete false] [:total_price_cents_new_requests "75250000"] [:total_price_cents_inspected_requests "0"] [:__typename :BudgetPeriod]) #ordered/map ([:id "e5d2ae4b-566f-4d6d-aed9-d6a8353eda7f"] [:name "2024"] [:inspection_start_date "2023-10-01 12:00:00.0"] [:end_date "2023-12-31 01:00:00.0"] [:can_delete false] [:total_price_cents_new_requests "0"] [:total_price_cents_inspected_requests "560501800"] [:__typename :BudgetPeriod]) #ordered/map ([:id "951ac476-4f92-4ff9-9f64-26fc8f8b61c5"] [:name "2023"] [:inspection_start_date "2022-11-01 01:00:00.0"] [:end_date "2022-12-31 12:00:00.0"] [:can_delete false] [:total_price_cents_new_requests "0"] [:total_price_cents_inspected_requests "680423900"] [:__typename :BudgetPeriod]) #ordered/map ([:id "76b66d78-bfe0-4c54-8c92-edbf467af784"] [:name "2022"] [:inspection_start_date "2021-10-29 12:00:00.0"] [:end_date "2021-12-31 12:00:00.0"] [:can_delete false] [:total_price_cents_new_requests "0"] [:total_price_cents_inspected_requests "703900000"] [:__typename :BudgetPeriod]) #ordered/map ([:id "24171a61-aec6-428e-b7ed-7461b3795454"] [:name "2021"] [:inspection_start_date "2020-10-26 12:00:00.0"] [:end_date "2020-12-31 12:00:00.0"] [:can_delete false] [:total_price_cents_new_requests "0"] [:total_price_cents_inspected_requests "703900000"] [:__typename :BudgetPeriod]) #ordered/map ([:id "3b7eab1e-c8b5-512b-9146-91cc295be955"] [:name "2020"] [:inspection_start_date "2019-11-09 12:00:00.0"] [:end_date "2019-12-31 01:00:00.0"] [:can_delete false] [:total_price_cents_new_requests "0"] [:total_price_cents_inspected_requests "529743800"] [:__typename :BudgetPeriod]) #ordered/map ([:id "9fb023db-725d-5881-8838-bae3e970ffd0"] [:name "2019"] [:inspection_start_date "2018-11-10 01:00:00.0"] [:end_date "2018-12-31 01:00:00.0"] [:can_delete false] [:total_price_cents_new_requests "1000000"] [:total_price_cents_inspected_requests "612864300"] [:__typename :BudgetPeriod]) #ordered/map ([:id "c2c5f618-7e05-5e43-a2b1-ec7f9172335d"] [:name "2018"] [:inspection_start_date "2017-11-04 01:00:00.0"] [:end_date "2017-12-31 01:00:00.0"] [:can_delete false] [:total_price_cents_new_requests "2443000"] [:total_price_cents_inspected_requests "437361300"] [:__typename :BudgetPeriod]) #ordered/map ([:id "4f367b79-76cf-5f12-ab7b-535a7430e6da"] [:name "2016"] [:inspection_start_date "2016-11-01 01:00:00.0"] [:end_date "2017-01-30 01:00:00.0"] [:can_delete false] [:total_price_cents_new_requests "3658000"] [:total_price_cents_inspected_requests "17990000"] [:__typename :BudgetPeriod]) #ordered/map ([:id "aba0576e-d65f-5fe0-aa80-89ce226ec9b1"] [:name "2017"] [:inspection_start_date "2016-11-04 01:00:00.0"] [:end_date "2017-01-22 01:00:00.0"] [:can_delete false] [:total_price_cents_new_requests "140000"] [:total_price_cents_inspected_requests "492786800"] [:__typename :BudgetPeriod])]])}
>>> authenticate::skip= nil  handler-key= :graphql
>>> authenticate::authenticated-entity {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}

>> authorize >

>> authorize::handler > #object[leihs.core.locale$wrap$fn__44823 0x34b1fe60 leihs.core.locale$wrap$fn__44823@34b1fe60]

>> authorize::request > {:authenticated-entity {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}, :cookies {leihs-anti-csrf-token {:value dc7e186c-6046-4dce-9a37-5d14ea14e0e1}, leihs-user-session {:value 9c7d0f0a-d4f8-419f-843b-2642a9e25659}}, :remote-addr 127.0.0.1, :start-time 216278610304125, :params {}, :settings {:email_sending_enabled false, :sessions_max_lifetime_secs 432000, :smtp_default_from_address noreply@zhdk.ch, :public_image_caching_enabled true, :sessions_force_secure false, :deliver_received_order_notifications false, :external_base_url http://localhost:3200, :sessions_force_uniqueness false, :email_signature Das ZHdK-Ausleihe-Team}, :tx-next #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.pool.HikariProxyConnection 0x42d54c10 HikariProxyConnection@1121274896 wrapping org.postgresql.jdbc.PgConnection@14849d46], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}, :query-params-raw {}, :route-params nil, :headers {origin http://localhost:3230, sec-fetch-site same-origin, sec-ch-ua-mobile ?0, host localhost:3230, user-agent Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36, content-type application/json, cookie leihs-anti-csrf-token=dc7e186c-6046-4dce-9a37-5d14ea14e0e1; leihs-user-session=9c7d0f0a-d4f8-419f-843b-2642a9e25659, content-length 2427, sec-ch-ua "Google Chrome";v="119", "Chromium";v="119", "Not?A_Brand";v="24", sec-ch-ua-platform "macOS", referer http://localhost:3230/procure/admin/budget-periods, connection keep-alive, pragma no-cache, x-csrf-token dc7e186c-6046-4dce-9a37-5d14ea14e0e1, accept application/json, accept-language de-DE,de;q=0.9,en-US;q=0.8,en;q=0.7, sec-fetch-dest empty, accept-encoding gzip, deflate, br, sec-fetch-mode cors, cache-control no-cache}, :async-channel #object[org.httpkit.server.AsyncChannel 0x3a2aa62d /127.0.0.1:3230<->/127.0.0.1:54417], :server-port 3230, :params-raw {}, :tx {:datasource #object[com.zaxxer.hikari.HikariDataSource 0x691cb6c4 HikariDataSource (db-pool)], :connection #object[com.zaxxer.hikari.pool.HikariProxyConnection 0xff906a HikariProxyConnection@16748650 wrapping org.postgresql.jdbc.PgConnection@3639b62d], :level 1, :rollback #object[clojure.lang.Atom 0x4a1de6a4 {:status :ready, :val false}]}, :content-length 2427, :form-params {}, :websocket? false, :query-params {}, :content-type application/json, :form-params-raw {}, :character-encoding utf8, :uri /procure/graphql, :server-name localhost, :handler-key :graphql, :query-string nil, :body {:operationName updateBudgetPeriods, :variables {:budgetPeriods [{:id aba0576e-d65f-5fe0-aa80-89ce226ec9b1, :name 2017, :inspection_start_date 2016-11-04 01:00:00.0, :end_date 2017-01-22 01:00:00.0} {:id 4f367b79-76cf-5f12-ab7b-535a7430e6da, :name 2016, :inspection_start_date 2016-11-01 01:00:00.0, :end_date 2017-01-30 01:00:00.0} {:id c2c5f618-7e05-5e43-a2b1-ec7f9172335d, :name 2018, :inspection_start_date 2017-11-04 01:00:00.0, :end_date 2017-12-31 01:00:00.0} {:id 9fb023db-725d-5881-8838-bae3e970ffd0, :name 2019, :inspection_start_date 2018-11-10 01:00:00.0, :end_date 2018-12-31 01:00:00.0} {:id 3b7eab1e-c8b5-512b-9146-91cc295be955, :name 2020, :inspection_start_date 2019-11-09 12:00:00.0, :end_date 2019-12-31 01:00:00.0} {:id 24171a61-aec6-428e-b7ed-7461b3795454, :name 2021, :inspection_start_date 2020-10-26 12:00:00.0, :end_date 2020-12-31 12:00:00.0} {:id 76b66d78-bfe0-4c54-8c92-edbf467af784, :name 2022, :inspection_start_date 2021-10-29 12:00:00.0, :end_date 2021-12-31 12:00:00.0} {:id 951ac476-4f92-4ff9-9f64-26fc8f8b61c5, :name 2023, :inspection_start_date 2022-11-01 01:00:00.0, :end_date 2022-12-31 12:00:00.0} {:id e5d2ae4b-566f-4d6d-aed9-d6a8353eda7f, :name 2024, :inspection_start_date 2023-10-01 12:00:00.0, :end_date 2023-12-31 01:00:00.0} {:id 1173b482-b9e6-46b4-a5e3-0b021c860e9b, :name 2025, :inspection_start_date 2024-11-04 01:00:00.0, :end_date 2024-12-31 01:00:00.0} {:id 6b689ed8-8148-485a-b1ca-86c1c739503e, :name 2026, :inspection_start_date 2025-11-03 01:00:00.0, :end_date 2025-12-31 01:00:00.0} {:id dfdd0798-6462-46fc-995f-a7d7233f30fd, :name 2027, :inspection_start_date 2026-11-02 01:00:00.0, :end_date 2026-12-31 01:00:00.0} {:id 1a1dab20-c661-4204-a913-28065d570f7c, :name 2028, :inspection_start_date 2027-11-01 01:00:00.0, :end_date 2027-12-31 01:00:00.0} {:name 2030, :inspection_start_date 2023-12-09T07:59:39.580Z, :end_date 2023-12-09T07:59:39.580Z}]}, :query mutation updateBudgetPeriods($budgetPeriods: [BudgetPeriodInput]) {
  budget_periods(input_data: $budgetPeriods) {
    ...AdminBudgetPeriodProps
    __typename
  }
}

fragment AdminBudgetPeriodProps on BudgetPeriod {
  id
  name
  inspection_start_date
  end_date
  can_delete
  total_price_cents_new_requests
  total_price_cents_inspected_requests
  __typename
}
}, :graphql-schema #CompiledSchema<>, :handler #object[leihs.procurement.graphql$handler 0x362b488d leihs.procurement.graphql$handler@362b488d], :multipart-params {}, :scheme :http, :request-method :post, :accept {:mime :json, :charset nil, :encoding nil, :language nil}}

>> authorize::handler-key >> :graphql
>myprint>  authEnt? {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}
>myprint>  txn #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.pool.HikariProxyConnection 0x42d54c10 HikariProxyConnection@1121274896 wrapping org.postgresql.jdbc.PgConnection@14849d46], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}
>o> admin? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:45.933Z NX-41294 DEBUG [leihs.procurement.permissions.user:33] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> admin? {:exists true}
>myprint>  admin true
>o> inspector? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = CAST(? AS UUID)) AS result #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:45.934Z NX-41294 DEBUG [leihs.procurement.permissions.user:57] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = CAST(? AS UUID)) AS result" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> inspector? {:result false}
>myprint>  inspector false
>o> viewer? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = CAST(? AS UUID)) AS result #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:45.935Z NX-41294 DEBUG [leihs.procurement.permissions.user:80] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = CAST(? AS UUID)) AS result" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> viewer? {:result false}
>myprint>  viewer false
>o> requester?? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:45.935Z NX-41294 DEBUG [leihs.procurement.permissions.user:164] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> requester?? {:exists false}
>myprint>  requester false
>o> admin? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:45.936Z NX-41294 DEBUG [leihs.procurement.permissions.user:33] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> admin? {:exists true}
>o> inspector? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = CAST(? AS UUID)) AS result #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:45.936Z NX-41294 DEBUG [leihs.procurement.permissions.user:57] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = CAST(? AS UUID)) AS result" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> inspector? {:result false}
>o> viewer? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = CAST(? AS UUID)) AS result #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:45.937Z NX-41294 DEBUG [leihs.procurement.permissions.user:80] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = CAST(? AS UUID)) AS result" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> viewer? {:result false}
>o> requester?? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:45.937Z NX-41294 DEBUG [leihs.procurement.permissions.user:164] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> requester?? {:exists false}

> 1 anti-csrf-token >  dc7e186c-6046-4dce-9a37-5d14ea14e0e1

> 1 anti-csrf-token class >  java.lang.String

> 2 anti-csrf-token-new >  nil
pure-handler >> 1
2023-12-09T07:59:45.942Z NX-41294 DEBUG [leihs.procurement.graphql:46] - graphql query mutation updateBudgetPeriods($budgetPeriods: [BudgetPeriodInput]) {
  budget_periods(input_data: $budgetPeriods) {
    ...AdminBudgetPeriodProps
    __typename
  }
}

fragment AdminBudgetPeriodProps on BudgetPeriod {
  id
  name
  inspection_start_date
  end_date
  can_delete
  total_price_cents_new_requests
  total_price_cents_inspected_requests
  __typename
}
 with variables {:budgetPeriods [{:id "aba0576e-d65f-5fe0-aa80-89ce226ec9b1", :name "2017", :inspection_start_date "2016-11-04 01:00:00.0", :end_date "2017-01-22 01:00:00.0"} {:id "4f367b79-76cf-5f12-ab7b-535a7430e6da", :name "2016", :inspection_start_date "2016-11-01 01:00:00.0", :end_date "2017-01-30 01:00:00.0"} {:id "c2c5f618-7e05-5e43-a2b1-ec7f9172335d", :name "2018", :inspection_start_date "2017-11-04 01:00:00.0", :end_date "2017-12-31 01:00:00.0"} {:id "9fb023db-725d-5881-8838-bae3e970ffd0", :name "2019", :inspection_start_date "2018-11-10 01:00:00.0", :end_date "2018-12-31 01:00:00.0"} {:id "3b7eab1e-c8b5-512b-9146-91cc295be955", :name "2020", :inspection_start_date "2019-11-09 12:00:00.0", :end_date "2019-12-31 01:00:00.0"} {:id "24171a61-aec6-428e-b7ed-7461b3795454", :name "2021", :inspection_start_date "2020-10-26 12:00:00.0", :end_date "2020-12-31 12:00:00.0"} {:id "76b66d78-bfe0-4c54-8c92-edbf467af784", :name "2022", :inspection_start_date "2021-10-29 12:00:00.0", :end_date "2021-12-31 12:00:00.0"} {:id "951ac476-4f92-4ff9-9f64-26fc8f8b61c5", :name "2023", :inspection_start_date "2022-11-01 01:00:00.0", :end_date "2022-12-31 12:00:00.0"} {:id "e5d2ae4b-566f-4d6d-aed9-d6a8353eda7f", :name "2024", :inspection_start_date "2023-10-01 12:00:00.0", :end_date "2023-12-31 01:00:00.0"} {:id "1173b482-b9e6-46b4-a5e3-0b021c860e9b", :name "2025", :inspection_start_date "2024-11-04 01:00:00.0", :end_date "2024-12-31 01:00:00.0"} {:id "6b689ed8-8148-485a-b1ca-86c1c739503e", :name "2026", :inspection_start_date "2025-11-03 01:00:00.0", :end_date "2025-12-31 01:00:00.0"} {:id "dfdd0798-6462-46fc-995f-a7d7233f30fd", :name "2027", :inspection_start_date "2026-11-02 01:00:00.0", :end_date "2026-12-31 01:00:00.0"} {:id "1a1dab20-c661-4204-a913-28065d570f7c", :name "2028", :inspection_start_date "2027-11-01 01:00:00.0", :end_date "2027-12-31 01:00:00.0"} {:name "2030", :inspection_start_date "2023-12-09T07:59:39.580Z", :end_date "2023-12-09T07:59:39.580Z"}]}
>oo> vars from graphQL-Requst nil nil nil {:budgetPeriods [{:id aba0576e-d65f-5fe0-aa80-89ce226ec9b1, :name 2017, :inspection_start_date 2016-11-04 01:00:00.0, :end_date 2017-01-22 01:00:00.0} {:id 4f367b79-76cf-5f12-ab7b-535a7430e6da, :name 2016, :inspection_start_date 2016-11-01 01:00:00.0, :end_date 2017-01-30 01:00:00.0} {:id c2c5f618-7e05-5e43-a2b1-ec7f9172335d, :name 2018, :inspection_start_date 2017-11-04 01:00:00.0, :end_date 2017-12-31 01:00:00.0} {:id 9fb023db-725d-5881-8838-bae3e970ffd0, :name 2019, :inspection_start_date 2018-11-10 01:00:00.0, :end_date 2018-12-31 01:00:00.0} {:id 3b7eab1e-c8b5-512b-9146-91cc295be955, :name 2020, :inspection_start_date 2019-11-09 12:00:00.0, :end_date 2019-12-31 01:00:00.0} {:id 24171a61-aec6-428e-b7ed-7461b3795454, :name 2021, :inspection_start_date 2020-10-26 12:00:00.0, :end_date 2020-12-31 12:00:00.0} {:id 76b66d78-bfe0-4c54-8c92-edbf467af784, :name 2022, :inspection_start_date 2021-10-29 12:00:00.0, :end_date 2021-12-31 12:00:00.0} {:id 951ac476-4f92-4ff9-9f64-26fc8f8b61c5, :name 2023, :inspection_start_date 2022-11-01 01:00:00.0, :end_date 2022-12-31 12:00:00.0} {:id e5d2ae4b-566f-4d6d-aed9-d6a8353eda7f, :name 2024, :inspection_start_date 2023-10-01 12:00:00.0, :end_date 2023-12-31 01:00:00.0} {:id 1173b482-b9e6-46b4-a5e3-0b021c860e9b, :name 2025, :inspection_start_date 2024-11-04 01:00:00.0, :end_date 2024-12-31 01:00:00.0} {:id 6b689ed8-8148-485a-b1ca-86c1c739503e, :name 2026, :inspection_start_date 2025-11-03 01:00:00.0, :end_date 2025-12-31 01:00:00.0} {:id dfdd0798-6462-46fc-995f-a7d7233f30fd, :name 2027, :inspection_start_date 2026-11-02 01:00:00.0, :end_date 2026-12-31 01:00:00.0} {:id 1a1dab20-c661-4204-a913-28065d570f7c, :name 2028, :inspection_start_date 2027-11-01 01:00:00.0, :end_date 2027-12-31 01:00:00.0} {:name 2030, :inspection_start_date 2023-12-09T07:59:39.580Z, :end_date 2023-12-09T07:59:39.580Z}]}
>>1x #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.pool.HikariProxyConnection 0x42d54c10 HikariProxyConnection@1121274896 wrapping org.postgresql.jdbc.PgConnection@14849d46], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}
>>2x {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}
>o> admin? [SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID)) #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
2023-12-09T07:59:45.953Z NX-41294 DEBUG [leihs.procurement.permissions.user:33] - query => ["SELECT EXISTS (SELECT TRUE AS exists FROM procurement_admins WHERE procurement_admins.user_id = CAST(? AS UUID))" #uuid "a786135f-c159-4618-9dd3-0012ebb3d500"]
>o> admin? {:exists true}
>oo> update-budget-periods!
>oo> before bp-with-dates= {:id aba0576e-d65f-5fe0-aa80-89ce226ec9b1, :name 2017, :inspection_start_date 2016-11-04 01:00:00.0, :end_date 2017-01-22 01:00:00.0}
>oo> after bp-with-dates= {:id aba0576e-d65f-5fe0-aa80-89ce226ec9b1, :name 2017, :inspection_start_date nil, :end_date nil}
>o> no / 22 / my-cast /debug  {:id aba0576e-d65f-5fe0-aa80-89ce226ec9b1, :name 2017, :inspection_start_date nil, :end_date nil}
2023-12-09T07:59:45.959Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:205] - data => {:id [[:cast "aba0576e-d65f-5fe0-aa80-89ce226ec9b1" :uuid]], :name "2017", :inspection_start_date [[:cast nil :timestamp]], :end_date [[:cast nil :timestamp]]}
2023-12-09T07:59:45.962Z NX-41294 DEBUG [leihs.procurement.resources.budget-period:?] - (sql-format (sql/where (sql/set (sql/update :procurement_budget_periods) bp) [:= :procurement_budget_periods.id (:id bp)])) => ["UPDATE procurement_budget_periods SET id = (CAST(? AS UUID)), name = ?, inspection_start_date = (CAST(NULL AS TIMESTAMP)), end_date = (CAST(NULL AS TIMESTAMP)) WHERE procurement_budget_periods.id = (CAST(? AS UUID))" "aba0576e-d65f-5fe0-aa80-89ce226ec9b1" "2017" "aba0576e-d65f-5fe0-aa80-89ce226ec9b1"]
>e> #error {
 :cause ERROR: null value in column "inspection_start_date" of relation "procurement_budget_periods" violates not-null constraint
  Detail: Failing row contains (aba0576e-d65f-5fe0-aa80-89ce226ec9b1, 2017, null, null, 2016-03-30 11:05:04, 2016-03-30 11:05:04).
 :via
 [{:type org.postgresql.util.PSQLException
   :message ERROR: null value in column "inspection_start_date" of relation "procurement_budget_periods" violates not-null constraint
  Detail: Failing row contains (aba0576e-d65f-5fe0-aa80-89ce226ec9b1, 2017, null, null, 2016-03-30 11:05:04, 2016-03-30 11:05:04).
   :at [org.postgresql.core.v3.QueryExecutorImpl receiveErrorResponse QueryExecutorImpl.java 2533]}]
 :trace
 [[org.postgresql.core.v3.QueryExecutorImpl receiveErrorResponse QueryExecutorImpl.java 2533]
  [org.postgresql.core.v3.QueryExecutorImpl processResults QueryExecutorImpl.java 2268]
  [org.postgresql.core.v3.QueryExecutorImpl execute QueryExecutorImpl.java 313]
  [org.postgresql.jdbc.PgStatement executeInternal PgStatement.java 448]
  [org.postgresql.jdbc.PgStatement execute PgStatement.java 369]
  [org.postgresql.jdbc.PgPreparedStatement executeWithFlags PgPreparedStatement.java 159]
  [org.postgresql.jdbc.PgPreparedStatement execute PgPreparedStatement.java 148]
  [com.zaxxer.hikari.pool.ProxyPreparedStatement execute ProxyPreparedStatement.java 44]
  [com.zaxxer.hikari.pool.HikariProxyPreparedStatement execute HikariProxyPreparedStatement.java -1]
  [next.jdbc.result_set$stmt__GT_result_set invokeStatic result_set.clj 669]
  [next.jdbc.result_set$stmt__GT_result_set invoke result_set.clj 664]
  [next.jdbc.result_set$eval11828$fn__11836 invoke result_set.clj 897]
  [next.jdbc.protocols$eval10723$fn__10754$G__10714__10763 invoke protocols.clj 34]
  [next.jdbc.default_options$eval11019$fn__11024 invoke default_options.clj 31]
  [next.jdbc.protocols$eval10723$fn__10754$G__10714__10763 invoke protocols.clj 34]
  [next.jdbc$execute_BANG_ invokeStatic jdbc.clj 251]
  [next.jdbc$execute_BANG_ invoke jdbc.clj 238]
  [leihs.procurement.resources.budget_period$update_budget_period_BANG_ invokeStatic budget_period.clj 216]
  [leihs.procurement.resources.budget_period$update_budget_period_BANG_ invoke budget_period.clj 210]
  [leihs.procurement.resources.budget_periods$update_budget_periods_BANG_ invokeStatic budget_periods.clj 81]
  [leihs.procurement.resources.budget_periods$update_budget_periods_BANG_ invoke budget_periods.clj 58]
  [leihs.procurement.authorization$wrap_ensure_one_of$fn__39307 invoke authorization.clj 39]
  [leihs.procurement.graphql.resolver$wrap_resolver_with_error$fn__45009 invoke resolver.clj 16]
  [com.walmartlabs.lacinia.schema$wrap_resolver_to_ensure_resolver_result$fn__14023 invoke schema.clj 986]
  [com.walmartlabs.lacinia.executor$invoke_resolver_for_field invokeStatic executor.clj 86]
  [com.walmartlabs.lacinia.executor$invoke_resolver_for_field invoke executor.clj 68]
  [com.walmartlabs.lacinia.executor$resolve_and_select invokeStatic executor.clj 353]
  [com.walmartlabs.lacinia.executor$resolve_and_select invoke executor.clj 234]
  [com.walmartlabs.lacinia.executor$apply_field_selection invokeStatic executor.clj 140]
  [com.walmartlabs.lacinia.executor$apply_field_selection invoke executor.clj 135]
  [com.walmartlabs.lacinia.executor$apply_selection invokeStatic executor.clj 173]
  [com.walmartlabs.lacinia.executor$apply_selection invoke executor.clj 165]
  [com.walmartlabs.lacinia.executor$combine_selection_results_sync$fn__17487 invoke executor.clj 212]
  [com.walmartlabs.lacinia.resolve.ResolverResultImpl on_deliver_BANG_ resolve.clj 135]
  [com.walmartlabs.lacinia.executor$combine_selection_results_sync invokeStatic executor.clj 208]
  [com.walmartlabs.lacinia.executor$combine_selection_results_sync invoke executor.clj 203]
  [com.walmartlabs.lacinia.executor$execute_nested_selections_sync$fn__17494 invoke executor.clj 230]
  [clojure.lang.ArrayChunk reduce ArrayChunk.java 58]
  [clojure.core.protocols$fn__8176 invokeStatic protocols.clj 136]
  [clojure.core.protocols$fn__8176 invoke protocols.clj 124]
  [clojure.core.protocols$fn__8136$G__8131__8145 invoke protocols.clj 19]
  [clojure.core.protocols$seq_reduce invokeStatic protocols.clj 31]
  [clojure.core.protocols$fn__8168 invokeStatic protocols.clj 75]
  [clojure.core.protocols$fn__8168 invoke protocols.clj 75]
  [clojure.core.protocols$fn__8110$G__8105__8123 invoke protocols.clj 13]
  [clojure.core$reduce invokeStatic core.clj 6830]
  [clojure.core$reduce invoke core.clj 6812]
  [com.walmartlabs.lacinia.executor$execute_nested_selections_sync invokeStatic executor.clj 230]
  [com.walmartlabs.lacinia.executor$execute_nested_selections_sync invoke executor.clj 221]
  [com.walmartlabs.lacinia.executor$execute_query$fn__17519 invoke executor.clj 400]
  [clojure.lang.AFn applyToHelper AFn.java 152]
  [clojure.lang.AFn applyTo AFn.java 144]
  [clojure.core$apply invokeStatic core.clj 667]
  [clojure.core$with_bindings_STAR_ invokeStatic core.clj 1977]
  [clojure.core$with_bindings_STAR_ doInvoke core.clj 1977]
  [clojure.lang.RestFn invoke RestFn.java 425]
  [clojure.lang.AFn applyToHelper AFn.java 156]
  [clojure.lang.RestFn applyTo RestFn.java 132]
  [clojure.core$apply invokeStatic core.clj 671]
  [clojure.core$bound_fn_STAR_$fn__5767 doInvoke core.clj 2007]
  [clojure.lang.RestFn invoke RestFn.java 397]
  [com.walmartlabs.lacinia.executor$execute_query$fn__17524 invoke executor.clj 421]
  [clojure.core$binding_conveyor_fn$fn__5772 invoke core.clj 2034]
  [clojure.lang.AFn call AFn.java 18]
  [java.util.concurrent.FutureTask run FutureTask.java 264]
  [java.util.concurrent.ThreadPoolExecutor runWorker ThreadPoolExecutor.java 1128]
  [java.util.concurrent.ThreadPoolExecutor$Worker run ThreadPoolExecutor.java 628]
  [java.lang.Thread run Thread.java 829]]}
2023-12-09T07:59:45.971Z NX-41294 WARN [leihs.procurement.graphql.resolver:326] - ERROR: null value in column "inspection_start_date" of relation "procurement_budget_periods" violates not-null constraint
  Detail: Failing row contains (aba0576e-d65f-5fe0-aa80-89ce226ec9b1, 2017, null, null, 2016-03-30 11:05:04, 2016-03-30 11:05:04).
2023-12-09T07:59:45.972Z NX-41294 DEBUG [leihs.procurement.graphql.resolver:326] - #error {
 :cause ERROR: null value in column "inspection_start_date" of relation "procurement_budget_periods" violates not-null constraint
  Detail: Failing row contains (aba0576e-d65f-5fe0-aa80-89ce226ec9b1, 2017, null, null, 2016-03-30 11:05:04, 2016-03-30 11:05:04).
 :via
 [{:type org.postgresql.util.PSQLException
   :message ERROR: null value in column "inspection_start_date" of relation "procurement_budget_periods" violates not-null constraint
  Detail: Failing row contains (aba0576e-d65f-5fe0-aa80-89ce226ec9b1, 2017, null, null, 2016-03-30 11:05:04, 2016-03-30 11:05:04).
   :at [org.postgresql.core.v3.QueryExecutorImpl receiveErrorResponse QueryExecutorImpl.java 2533]}]
 :trace
 [[org.postgresql.core.v3.QueryExecutorImpl receiveErrorResponse QueryExecutorImpl.java 2533]
  [org.postgresql.core.v3.QueryExecutorImpl processResults QueryExecutorImpl.java 2268]
  [org.postgresql.core.v3.QueryExecutorImpl execute QueryExecutorImpl.java 313]
  [org.postgresql.jdbc.PgStatement executeInternal PgStatement.java 448]
  [org.postgresql.jdbc.PgStatement execute PgStatement.java 369]
  [org.postgresql.jdbc.PgPreparedStatement executeWithFlags PgPreparedStatement.java 159]
  [org.postgresql.jdbc.PgPreparedStatement execute PgPreparedStatement.java 148]
  [com.zaxxer.hikari.pool.ProxyPreparedStatement execute ProxyPreparedStatement.java 44]
  [com.zaxxer.hikari.pool.HikariProxyPreparedStatement execute HikariProxyPreparedStatement.java -1]
  [next.jdbc.result_set$stmt__GT_result_set invokeStatic result_set.clj 669]
  [next.jdbc.result_set$stmt__GT_result_set invoke result_set.clj 664]
  [next.jdbc.result_set$eval11828$fn__11836 invoke result_set.clj 897]
  [next.jdbc.protocols$eval10723$fn__10754$G__10714__10763 invoke protocols.clj 34]
  [next.jdbc.default_options$eval11019$fn__11024 invoke default_options.clj 31]
  [next.jdbc.protocols$eval10723$fn__10754$G__10714__10763 invoke protocols.clj 34]
  [next.jdbc$execute_BANG_ invokeStatic jdbc.clj 251]
  [next.jdbc$execute_BANG_ invoke jdbc.clj 238]
  [leihs.procurement.resources.budget_period$update_budget_period_BANG_ invokeStatic budget_period.clj 216]
  [leihs.procurement.resources.budget_period$update_budget_period_BANG_ invoke budget_period.clj 210]
  [leihs.procurement.resources.budget_periods$update_budget_periods_BANG_ invokeStatic budget_periods.clj 81]
  [leihs.procurement.resources.budget_periods$update_budget_periods_BANG_ invoke budget_periods.clj 58]
  [leihs.procurement.authorization$wrap_ensure_one_of$fn__39307 invoke authorization.clj 39]
  [leihs.procurement.graphql.resolver$wrap_resolver_with_error$fn__45009 invoke resolver.clj 16]
  [com.walmartlabs.lacinia.schema$wrap_resolver_to_ensure_resolver_result$fn__14023 invoke schema.clj 986]
  [com.walmartlabs.lacinia.executor$invoke_resolver_for_field invokeStatic executor.clj 86]
  [com.walmartlabs.lacinia.executor$invoke_resolver_for_field invoke executor.clj 68]
  [com.walmartlabs.lacinia.executor$resolve_and_select invokeStatic executor.clj 353]
  [com.walmartlabs.lacinia.executor$resolve_and_select invoke executor.clj 234]
  [com.walmartlabs.lacinia.executor$apply_field_selection invokeStatic executor.clj 140]
  [com.walmartlabs.lacinia.executor$apply_field_selection invoke executor.clj 135]
  [com.walmartlabs.lacinia.executor$apply_selection invokeStatic executor.clj 173]
  [com.walmartlabs.lacinia.executor$apply_selection invoke executor.clj 165]
  [com.walmartlabs.lacinia.executor$combine_selection_results_sync$fn__17487 invoke executor.clj 212]
  [com.walmartlabs.lacinia.resolve.ResolverResultImpl on_deliver_BANG_ resolve.clj 135]
  [com.walmartlabs.lacinia.executor$combine_selection_results_sync invokeStatic executor.clj 208]
  [com.walmartlabs.lacinia.executor$combine_selection_results_sync invoke executor.clj 203]
  [com.walmartlabs.lacinia.executor$execute_nested_selections_sync$fn__17494 invoke executor.clj 230]
  [clojure.lang.ArrayChunk reduce ArrayChunk.java 58]
  [clojure.core.protocols$fn__8176 invokeStatic protocols.clj 136]
  [clojure.core.protocols$fn__8176 invoke protocols.clj 124]
  [clojure.core.protocols$fn__8136$G__8131__8145 invoke protocols.clj 19]
  [clojure.core.protocols$seq_reduce invokeStatic protocols.clj 31]
  [clojure.core.protocols$fn__8168 invokeStatic protocols.clj 75]
  [clojure.core.protocols$fn__8168 invoke protocols.clj 75]
  [clojure.core.protocols$fn__8110$G__8105__8123 invoke protocols.clj 13]
  [clojure.core$reduce invokeStatic core.clj 6830]
  [clojure.core$reduce invoke core.clj 6812]
  [com.walmartlabs.lacinia.executor$execute_nested_selections_sync invokeStatic executor.clj 230]
  [com.walmartlabs.lacinia.executor$execute_nested_selections_sync invoke executor.clj 221]
  [com.walmartlabs.lacinia.executor$execute_query$fn__17519 invoke executor.clj 400]
  [clojure.lang.AFn applyToHelper AFn.java 152]
  [clojure.lang.AFn applyTo AFn.java 144]
  [clojure.core$apply invokeStatic core.clj 667]
  [clojure.core$with_bindings_STAR_ invokeStatic core.clj 1977]
  [clojure.core$with_bindings_STAR_ doInvoke core.clj 1977]
  [clojure.lang.RestFn invoke RestFn.java 425]
  [clojure.lang.AFn applyToHelper AFn.java 156]
  [clojure.lang.RestFn applyTo RestFn.java 132]
  [clojure.core$apply invokeStatic core.clj 671]
  [clojure.core$bound_fn_STAR_$fn__5767 doInvoke core.clj 2007]
  [clojure.lang.RestFn invoke RestFn.java 397]
  [com.walmartlabs.lacinia.executor$execute_query$fn__17524 invoke executor.clj 421]
  [clojure.core$binding_conveyor_fn$fn__5772 invoke core.clj 2034]
  [clojure.lang.AFn call AFn.java 18]
  [java.util.concurrent.FutureTask run FutureTask.java 264]
  [java.util.concurrent.ThreadPoolExecutor runWorker ThreadPoolExecutor.java 1128]
  [java.util.concurrent.ThreadPoolExecutor$Worker run ThreadPoolExecutor.java 628]
  [java.lang.Thread run Thread.java 829]]}

>request-grapql _> request {:leihs-user-language {:name Deutsch, :locale de-CH, :default true, :active true}, :authenticated-entity {:email manuel.radl@zhdk.ch, :contracts_count 1, :lastname Radl, :org_id 271682, :scope_read true, :is_admin true, :authentication-method :session, :login mradl, :scope_system_admin_write true, :scope_write true, :firstname Manuel, :scope_admin_write true, :user_session_created_at #time/instant "2023-12-09T07:09:54.188679Z", :id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :user_session_id #uuid "4d6070c4-5989-45bb-a1dc-1ee5409551ae", :scope_system_admin_read true, :access-rights ({:role customer, :inventory_pool_id #uuid "3977012c-ce0e-501f-889b-8715fdb5d83b"} {:role customer, :inventory_pool_id #uuid "5863967f-9804-4909-a9b7-92254616d6b2"} {:role customer, :inventory_pool_id #uuid "5dd25b58-fa56-5095-bd97-2696d92c2fb1"} {:role customer, :inventory_pool_id #uuid "77e88ec8-9ff6-5435-818e-dc902fc631a6"} {:role inventory_manager, :inventory_pool_id #uuid "8bd16d45-056d-5590-bc7f-12849f034351"} {:role inventory_manager, :inventory_pool_id #uuid "a02b8163-9a16-5066-b48e-9eb74cf8b791"} {:role inventory_manager, :inventory_pool_id #uuid "b534b07c-d9bf-4572-840c-0a630b8cd8ed"} {:role customer, :inventory_pool_id #uuid "fc5a841e-36c6-5dc3-8207-1306c1fb89bf"} {:role customer, :inventory_pool_id #uuid "ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}), :user_id #uuid "a786135f-c159-4618-9dd3-0012ebb3d500", :is_system_admin true, :external_sign_out_url nil, :language_locale de-CH, :inventory_pool_roles_count 9, :scope_admin_read true}, :cookies {leihs-anti-csrf-token {:value dc7e186c-6046-4dce-9a37-5d14ea14e0e1}, leihs-user-session {:value 9c7d0f0a-d4f8-419f-843b-2642a9e25659}}, :remote-addr 127.0.0.1, :start-time 216278610304125, :params {}, :settings {:email_sending_enabled false, :sessions_max_lifetime_secs 432000, :smtp_default_from_address noreply@zhdk.ch, :public_image_caching_enabled true, :sessions_force_secure false, :deliver_received_order_notifications false, :external_base_url http://localhost:3200, :sessions_force_uniqueness false, :email_signature Das ZHdK-Ausleihe-Team}, :tx-next #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.pool.HikariProxyConnection 0x42d54c10 HikariProxyConnection@1121274896 wrapping org.postgresql.jdbc.PgConnection@14849d46], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x61e4316f next.jdbc.result_set$as_unqualified_lower_maps@61e4316f]}}, :query-params-raw {}, :route-params nil, :headers {origin http://localhost:3230, sec-fetch-site same-origin, sec-ch-ua-mobile ?0, host localhost:3230, user-agent Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36, content-type application/json, cookie leihs-anti-csrf-token=dc7e186c-6046-4dce-9a37-5d14ea14e0e1; leihs-user-session=9c7d0f0a-d4f8-419f-843b-2642a9e25659, content-length 2427, sec-ch-ua "Google Chrome";v="119", "Chromium";v="119", "Not?A_Brand";v="24", sec-ch-ua-platform "macOS", referer http://localhost:3230/procure/admin/budget-periods, connection keep-alive, pragma no-cache, x-csrf-token dc7e186c-6046-4dce-9a37-5d14ea14e0e1, accept application/json, accept-language de-DE,de;q=0.9,en-US;q=0.8,en;q=0.7, sec-fetch-dest empty, accept-encoding gzip, deflate, br, sec-fetch-mode cors, cache-control no-cache}, :async-channel #object[org.httpkit.server.AsyncChannel 0x3a2aa62d /127.0.0.1:3230<->/127.0.0.1:54417], :server-port 3230, :params-raw {}, :tx {:datasource #object[com.zaxxer.hikari.HikariDataSource 0x691cb6c4 HikariDataSource (db-pool)], :connection #object[com.zaxxer.hikari.pool.HikariProxyConnection 0xff906a HikariProxyConnection@16748650 wrapping org.postgresql.jdbc.PgConnection@3639b62d], :level 2, :rollback #object[clojure.lang.Atom 0x4a1de6a4 {:status :ready, :val false}]}, :content-length 2427, :form-params {}, :websocket? false, :query-params {}, :content-type application/json, :form-params-raw {}, :character-encoding utf8, :uri /procure/graphql, :server-name localhost, :handler-key :graphql, :query-string nil, :body {:operationName updateBudgetPeriods, :variables {:budgetPeriods [{:id aba0576e-d65f-5fe0-aa80-89ce226ec9b1, :name 2017, :inspection_start_date 2016-11-04 01:00:00.0, :end_date 2017-01-22 01:00:00.0} {:id 4f367b79-76cf-5f12-ab7b-535a7430e6da, :name 2016, :inspection_start_date 2016-11-01 01:00:00.0, :end_date 2017-01-30 01:00:00.0} {:id c2c5f618-7e05-5e43-a2b1-ec7f9172335d, :name 2018, :inspection_start_date 2017-11-04 01:00:00.0, :end_date 2017-12-31 01:00:00.0} {:id 9fb023db-725d-5881-8838-bae3e970ffd0, :name 2019, :inspection_start_date 2018-11-10 01:00:00.0, :end_date 2018-12-31 01:00:00.0} {:id 3b7eab1e-c8b5-512b-9146-91cc295be955, :name 2020, :inspection_start_date 2019-11-09 12:00:00.0, :end_date 2019-12-31 01:00:00.0} {:id 24171a61-aec6-428e-b7ed-7461b3795454, :name 2021, :inspection_start_date 2020-10-26 12:00:00.0, :end_date 2020-12-31 12:00:00.0} {:id 76b66d78-bfe0-4c54-8c92-edbf467af784, :name 2022, :inspection_start_date 2021-10-29 12:00:00.0, :end_date 2021-12-31 12:00:00.0} {:id 951ac476-4f92-4ff9-9f64-26fc8f8b61c5, :name 2023, :inspection_start_date 2022-11-01 01:00:00.0, :end_date 2022-12-31 12:00:00.0} {:id e5d2ae4b-566f-4d6d-aed9-d6a8353eda7f, :name 2024, :inspection_start_date 2023-10-01 12:00:00.0, :end_date 2023-12-31 01:00:00.0} {:id 1173b482-b9e6-46b4-a5e3-0b021c860e9b, :name 2025, :inspection_start_date 2024-11-04 01:00:00.0, :end_date 2024-12-31 01:00:00.0} {:id 6b689ed8-8148-485a-b1ca-86c1c739503e, :name 2026, :inspection_start_date 2025-11-03 01:00:00.0, :end_date 2025-12-31 01:00:00.0} {:id dfdd0798-6462-46fc-995f-a7d7233f30fd, :name 2027, :inspection_start_date 2026-11-02 01:00:00.0, :end_date 2026-12-31 01:00:00.0} {:id 1a1dab20-c661-4204-a913-28065d570f7c, :name 2028, :inspection_start_date 2027-11-01 01:00:00.0, :end_date 2027-12-31 01:00:00.0} {:name 2030, :inspection_start_date 2023-12-09T07:59:39.580Z, :end_date 2023-12-09T07:59:39.580Z}]}, :query mutation updateBudgetPeriods($budgetPeriods: [BudgetPeriodInput]) {
  budget_periods(input_data: $budgetPeriods) {
    ...AdminBudgetPeriodProps
    __typename
  }
}

fragment AdminBudgetPeriodProps on BudgetPeriod {
  id
  name
  inspection_start_date
  end_date
  can_delete
  total_price_cents_new_requests
  total_price_cents_inspected_requests
  __typename
}
}, :graphql-schema #CompiledSchema<>, :handler #object[leihs.procurement.graphql$handler 0x362b488d leihs.procurement.graphql$handler@362b488d], :multipart-params {}, :scheme :http, :request-method :post, :accept {:mime :json, :charset nil, :encoding nil, :language nil}}

>request-c-grapql _> request (json) {"leihs-user-language":{"name":"Deutsch","locale":"de-CH","default":true,"active":true},"authenticated-entity":{"email":"manuel.radl@zhdk.ch","contracts_count":1,"lastname":"Radl","org_id":"271682","scope_read":true,"is_admin":true,"authentication-method":"session","login":"mradl","scope_system_admin_write":true,"scope_write":true,"firstname":"Manuel","scope_admin_write":true,"user_session_created_at":"2023-12-09T07:09:54.188679Z","id":"a786135f-c159-4618-9dd3-0012ebb3d500","user_session_id":"4d6070c4-5989-45bb-a1dc-1ee5409551ae","scope_system_admin_read":true,"access-rights":[{"role":"customer","inventory_pool_id":"3977012c-ce0e-501f-889b-8715fdb5d83b"},{"role":"customer","inventory_pool_id":"5863967f-9804-4909-a9b7-92254616d6b2"},{"role":"customer","inventory_pool_id":"5dd25b58-fa56-5095-bd97-2696d92c2fb1"},{"role":"customer","inventory_pool_id":"77e88ec8-9ff6-5435-818e-dc902fc631a6"},{"role":"inventory_manager","inventory_pool_id":"8bd16d45-056d-5590-bc7f-12849f034351"},{"role":"inventory_manager","inventory_pool_id":"a02b8163-9a16-5066-b48e-9eb74cf8b791"},{"role":"inventory_manager","inventory_pool_id":"b534b07c-d9bf-4572-840c-0a630b8cd8ed"},{"role":"customer","inventory_pool_id":"fc5a841e-36c6-5dc3-8207-1306c1fb89bf"},{"role":"customer","inventory_pool_id":"ffaa3aea-2a1f-4d6a-bdfc-f3be93699750"}],"user_id":"a786135f-c159-4618-9dd3-0012ebb3d500","is_system_admin":true,"external_sign_out_url":null,"language_locale":"de-CH","inventory_pool_roles_count":9,"scope_admin_read":true},"cookies":{"leihs-anti-csrf-token":{"value":"dc7e186c-6046-4dce-9a37-5d14ea14e0e1"},"leihs-user-session":{"value":"9c7d0f0a-d4f8-419f-843b-2642a9e25659"}},"remote-addr":"127.0.0.1","start-time":216278610304125,"params":{},"settings":{"email_sending_enabled":false,"sessions_max_lifetime_secs":432000,"smtp_default_from_address":"noreply@zhdk.ch","public_image_caching_enabled":true,"sessions_force_secure":false,"deliver_received_order_notifications":false,"external_base_url":"http:\/\/localhost:3200","sessions_force_uniqueness":false,"email_signature":"Das ZHdK-Ausleihe-Team"},"query-params-raw":{},"route-params":null,"headers":{"origin":"http:\/\/localhost:3230","sec-fetch-site":"same-origin","sec-ch-ua-mobile":"?0","host":"localhost:3230","user-agent":"Mozilla\/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit\/537.36 (KHTML, like Gecko) Chrome\/119.0.0.0 Safari\/537.36","content-type":"application\/json","cookie":"leihs-anti-csrf-token=dc7e186c-6046-4dce-9a37-5d14ea14e0e1; leihs-user-session=9c7d0f0a-d4f8-419f-843b-2642a9e25659","content-length":"2427","sec-ch-ua":"\"Google Chrome\";v=\"119\", \"Chromium\";v=\"119\", \"Not?A_Brand\";v=\"24\"","sec-ch-ua-platform":"\"macOS\"","referer":"http:\/\/localhost:3230\/procure\/admin\/budget-periods","connection":"keep-alive","pragma":"no-cache","x-csrf-token":"dc7e186c-6046-4dce-9a37-5d14ea14e0e1","accept":"application\/json","accept-language":"de-DE,de;q=0.9,en-US;q=0.8,en;q=0.7","sec-fetch-dest":"empty","accept-encoding":"gzip, deflate, br","sec-fetch-mode":"cors","cache-control":"no-cache"},"server-port":3230,"params-raw":{},"content-length":2427,"form-params":{},"websocket?":false,"query-params":{},"content-type":"application\/json","form-params-raw":{},"character-encoding":"utf8","uri":"\/procure\/graphql","server-name":"localhost","handler-key":"graphql","query-string":null,"body":{"operationName":"updateBudgetPeriods","variables":{"budgetPeriods":[{"id":"aba0576e-d65f-5fe0-aa80-89ce226ec9b1","name":"2017","inspection_start_date":"2016-11-04 01:00:00.0","end_date":"2017-01-22 01:00:00.0"},{"id":"4f367b79-76cf-5f12-ab7b-535a7430e6da","name":"2016","inspection_start_date":"2016-11-01 01:00:00.0","end_date":"2017-01-30 01:00:00.0"},{"id":"c2c5f618-7e05-5e43-a2b1-ec7f9172335d","name":"2018","inspection_start_date":"2017-11-04 01:00:00.0","end_date":"2017-12-31 01:00:00.0"},{"id":"9fb023db-725d-5881-8838-bae3e970ffd0","name":"2019","inspection_start_date":"2018-11-10 01:00:00.0","end_date":"2018-12-31 01:00:00.0"},{"id":"3b7eab1e-c8b5-512b-9146-91cc295be955","name":"2020","inspection_start_date":"2019-11-09 12:00:00.0","end_date":"2019-12-31 01:00:00.0"},{"id":"24171a61-aec6-428e-b7ed-7461b3795454","name":"2021","inspection_start_date":"2020-10-26 12:00:00.0","end_date":"2020-12-31 12:00:00.0"},{"id":"76b66d78-bfe0-4c54-8c92-edbf467af784","name":"2022","inspection_start_date":"2021-10-29 12:00:00.0","end_date":"2021-12-31 12:00:00.0"},{"id":"951ac476-4f92-4ff9-9f64-26fc8f8b61c5","name":"2023","inspection_start_date":"2022-11-01 01:00:00.0","end_date":"2022-12-31 12:00:00.0"},{"id":"e5d2ae4b-566f-4d6d-aed9-d6a8353eda7f","name":"2024","inspection_start_date":"2023-10-01 12:00:00.0","end_date":"2023-12-31 01:00:00.0"},{"id":"1173b482-b9e6-46b4-a5e3-0b021c860e9b","name":"2025","inspection_start_date":"2024-11-04 01:00:00.0","end_date":"2024-12-31 01:00:00.0"},{"id":"6b689ed8-8148-485a-b1ca-86c1c739503e","name":"2026","inspection_start_date":"2025-11-03 01:00:00.0","end_date":"2025-12-31 01:00:00.0"},{"id":"dfdd0798-6462-46fc-995f-a7d7233f30fd","name":"2027","inspection_start_date":"2026-11-02 01:00:00.0","end_date":"2026-12-31 01:00:00.0"},{"id":"1a1dab20-c661-4204-a913-28065d570f7c","name":"2028","inspection_start_date":"2027-11-01 01:00:00.0","end_date":"2027-12-31 01:00:00.0"},{"name":"2030","inspection_start_date":"2023-12-09T07:59:39.580Z","end_date":"2023-12-09T07:59:39.580Z"}]},"query":"mutation updateBudgetPeriods($budgetPeriods: [BudgetPeriodInput]) {\n  budget_periods(input_data: $budgetPeriods) {\n    ...AdminBudgetPeriodProps\n    __typename\n  }\n}\n\nfragment AdminBudgetPeriodProps on BudgetPeriod {\n  id\n  name\n  inspection_start_date\n  end_date\n  can_delete\n  total_price_cents_new_requests\n  total_price_cents_inspected_requests\n  __typename\n}\n"},"multipart-params":{},"scheme":"http","request-method":"post","accept":{"mime":"json","charset":null,"encoding":null,"language":null}}

>request-grapql _> result => {:data #ordered/map ([:budget_periods nil]), :errors ({:message ERROR: null value in column "inspection_start_date" of relation "procurement_budget_periods" violates not-null constraint
  Detail: Failing row contains (aba0576e-d65f-5fe0-aa80-89ce226ec9b1, 2017, null, null, 2016-03-30 11:05:04, 2016-03-30 11:05:04)., :locations [{:line 2, :column 3}], :path [:budget_periods], :extensions {:exception PSQLException, :arguments {:input_data $budgetPeriods}}})}
2023-12-09T07:59:45.975Z NX-41294 DEBUG [leihs.procurement.graphql:86] - result => {:data #ordered/map ([:budget_periods nil]), :errors ({:message "ERROR: null value in column \"inspection_start_date\" of relation \"procurement_budget_periods\" violates not-null constraint\n  Detail: Failing row contains (aba0576e-d65f-5fe0-aa80-89ce226ec9b1, 2017, null, null, 2016-03-30 11:05:04, 2016-03-30 11:05:04).", :locations [{:line 2, :column 3}], :path [:budget_periods], :extensions {:exception "PSQLException", :arguments {:input_data $budgetPeriods}}})}
2023-12-09T07:59:45.975Z NX-41294 DEBUG [leihs.procurement.graphql:87] - {:data #ordered/map ([:budget_periods nil]), :errors ({:message "ERROR: null value in column \"inspection_start_date\" of relation \"procurement_budget_periods\" violates not-null constraint\n  Detail: Failing row contains (aba0576e-d65f-5fe0-aa80-89ce226ec9b1, 2017, null, null, 2016-03-30 11:05:04, 2016-03-30 11:05:04).", :locations [{:line 2, :column 3}], :path [:budget_periods], :extensions {:exception "PSQLException", :arguments {:input_data $budgetPeriods}}})}

>o> ERROR 4pure-handler, result=> {:data #ordered/map ([:budget_periods nil]), :errors ({:message ERROR: null value in column "inspection_start_date" of relation "procurement_budget_periods" violates not-null constraint
  Detail: Failing row contains (aba0576e-d65f-5fe0-aa80-89ce226ec9b1, 2017, null, null, 2016-03-30 11:05:04, 2016-03-30 11:05:04)., :locations [{:line 2, :column 3}], :path [:budget_periods], :extensions {:exception PSQLException, :arguments {:input_data $budgetPeriods}}})}
