# java_leihs-procure-server env check via asdf v0.13.1
# java_leihs-procure-server env skipped update; touch .tool-versions or remove /var/folders/jl/49spzkdd2v3cdz37fgmp0ddr6cj76v/T/asdf_cache_java_leihs-procure-server to force update
# clojure_leihs-procure-server env check via asdf v0.13.1
# clojure_leihs-procure-server env skipped update; touch .tool-versions or remove /var/folders/jl/49spzkdd2v3cdz37fgmp0ddr6cj76v/T/asdf_cache_clojure_leihs-procure-server to force update
Warning: environ value /Users/mradl/.asdf/installs/java/zulu-11.60.19 for key :java-home has been overwritten with /Users/mradl/.asdf/installs/java/zulu-11.60.19/zulu-11.jdk/Contents/Home
2023-11-27T15:29:05.673Z NX-41294 WARN [leihs.core.release:13] - Failed to read releases.yml, returning bogus value 
2023-11-27T15:29:06.255Z NX-41294 INFO [leihs.core.logging:36] - initializing logging  {:min-level [[#{"leihs.procurement.resources.*" "leihs.procurement.permissions.*" "leihs.procurement.authorization"} :debug] [#{"com.zaxxer.hikari.*" "leihs.*"} :info] [#{"*"} :warn]], :log-level nil}
2023-11-27T15:29:06.262Z NX-41294 INFO [leihs.core.logging:38] - initialized logging  {:min-level [[#{"leihs.procurement.resources.*" "leihs.procurement.permissions.*" "leihs.procurement.authorization"} :debug] [#{"com.zaxxer.hikari.*" "leihs.*"} :info] [#{"*"} :warn]], :ns-filter #{"*"}, :middleware [], :timestamp-opts {:pattern :iso8601, :locale :jvm-default, :timezone :utc}, :output-fn #object[taoensso.timbre$default_output_fn 0x2a50676f "taoensso.timbre$default_output_fn@2a50676f"], :appenders {:println {:enabled? true, :fn #object[taoensso.timbre.appenders.core$println_appender$fn__3459 0x28382154 "taoensso.timbre.appenders.core$println_appender$fn__3459@28382154"]}}, :_init-config {:loaded-from-source :default, :compile-time-config {:min-level nil, :ns-pattern "*"}}, :log-level nil}
2023-11-27T15:29:06.265Z NX-41294 INFO [leihs.procurement.main:50] - main ("--dev-mode" "true" "--repl" "true" "run" "--db-port" "5415" "--db-name" "leihs_test")
2023-11-27T15:29:06.277Z NX-41294 INFO [leihs.core.repl:62] - init {:dev-mode true, :repl true, :repl-bind "localhost", :repl-port 60842, :repl-port-file ".nrepl-port"}
2023-11-27T15:29:06.279Z NX-41294 INFO [leihs.core.repl:70] - starting nREPL server  60842 localhost
2023-11-27T15:29:06.305Z NX-41294 INFO [leihs.core.repl:75] - started nREPL server 
2023-11-27T15:29:06.309Z NX-41294 INFO [leihs.procurement.run:326] - Invoking run with options:  {:db-host localhost, :db-max-pool-size 16, :db-min-pool-size 2, :db-name leihs_test, :db-password leihs, :db-port 5415, :db-user leihs, :dev-mode true, :http-host localhost, :http-max-threads 8, :http-min-threads 1, :http-port 3230, :http-queue-capacity 640, :http-thread-keep-alive-seconds 10, :http-worker-prefix leihs-service-http-worker-, :pid-file nil, :repl true, :repl-bind localhost, :repl-port 60842, :repl-port-file .nrepl-port}
2023-11-27T15:29:06.310Z NX-41294 INFO [leihs.core.shutdown:20] - PID 9338
2023-11-27T15:29:06.342Z NX-41294 INFO [leihs.core.shutdown:29] - Registering SIGTERM handler for shutdown.
2023-11-27T15:29:06.400Z NX-41294 INFO [leihs.core.graphql:17] - Initialized graphQL schema.
2023-11-27T15:29:06.401Z NX-41294 INFO [leihs.core.db:220] - Initializing db  {:db-name "leihs_test", :db-port 5415, :db-host "localhost", :db-user "leihs", :db-password "leihs", :db-min-pool-size 2, :db-max-pool-size 16}
2023-11-27T15:29:06.408Z NX-41294 INFO [com.zaxxer.hikari.HikariDataSource:80] - db-pool - Starting...
2023-11-27T15:29:06.489Z NX-41294 INFO [com.zaxxer.hikari.pool.HikariPool:565] - db-pool - Added connection org.postgresql.jdbc.PgConnection@5c63df20
2023-11-27T15:29:06.495Z NX-41294 INFO [com.zaxxer.hikari.HikariDataSource:82] - db-pool - Start completed.
2023-11-27T15:29:06.495Z NX-41294 INFO [leihs.core.db:222] - Initialized db  {:datasource #object[com.zaxxer.hikari.HikariDataSource 0x7c23224a "HikariDataSource (db-pool)"]}
2023-11-27T15:29:06.496Z NX-41294 INFO [leihs.core.db:223] - Initializing ds-next  {:db-name "leihs_test", :db-port 5415, :db-host "localhost", :db-user "leihs", :db-password "leihs", :db-min-pool-size 2, :db-max-pool-size 16}
2023-11-27T15:29:06.511Z NX-41294 INFO [com.zaxxer.hikari.HikariDataSource:110] - HikariPool-1 - Starting...
2023-11-27T15:29:06.519Z NX-41294 INFO [com.zaxxer.hikari.pool.HikariPool:565] - HikariPool-1 - Added connection org.postgresql.jdbc.PgConnection@3db6b394
2023-11-27T15:29:06.520Z NX-41294 INFO [com.zaxxer.hikari.HikariDataSource:123] - HikariPool-1 - Start completed.
2023-11-27T15:29:06.525Z NX-41294 INFO [leihs.core.db:225] - Initialized ds-next  #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x218bdce7 "HikariDataSource (HikariPool-1)"], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x590187be "next.jdbc.result_set$as_unqualified_lower_maps@590187be"]}}
2023-11-27T15:29:06.531Z NX-41294 INFO [leihs.core.http-server:101] - starting http-server  {:port 3230, :ip "localhost", :pool {:queue #object[java.util.concurrent.ArrayBlockingQueue 0x19b06274 "[]"], :pool #object[java.util.concurrent.ThreadPoolExecutor 0x1dbc0bc6 "java.util.concurrent.ThreadPoolExecutor@1dbc0bc6[Running, pool size = 0, active threads = 0, queued tasks = 0, completed tasks = 0]"]}}
2023-11-27T15:29:06.542Z NX-41294 INFO [leihs.core.http-server:104] - started http-server 
>>> authenticate::skip= true  handler-key= :sign-in
>>> authenticate::authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-27T14:41:24.329670Z", :id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :user_session_id #uuid "be18f683-80fa-4f6d-bff0-d2bb3b22d776", :scope_system_admin_read false, :access-rights (), :user_id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}

>> authorize >

>> authorize::handler > #object[leihs.core.locale$wrap$fn__44325 0x62051b04 leihs.core.locale$wrap$fn__44325@62051b04]

>> authorize::request > {:authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-27T14:41:24.329670Z", :id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :user_session_id #uuid "be18f683-80fa-4f6d-bff0-d2bb3b22d776", :scope_system_admin_read false, :access-rights (), :user_id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}, :cookies {Idea-d8c89f6f {:value 5d06a449-7aaa-4285-b65a-53c2ae3cb299}, leihs-anti-csrf-token {:value 65184e75-5146-4915-8494-09445d034d15}, leihs-user-session {:value c1c03935-ed33-4a3a-badb-740dd0e0ea6d}}, :remote-addr 127.0.0.1, :start-time 5927240199791, :params {:return-to /procure}, :settings {:email_sending_enabled false, :sessions_max_lifetime_secs 432000, :smtp_default_from_address your.lending.desk@example.com, :public_image_caching_enabled true, :sessions_force_secure false, :deliver_received_order_notifications false, :external_base_url nil, :sessions_force_uniqueness false, :email_signature Cheers,}, :tx-next #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x218bdce7 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x590187be next.jdbc.result_set$as_unqualified_lower_maps@590187be]}}, :query-params-raw {:return-to /procure}, :route-params nil, :headers {sec-fetch-site none, sec-ch-ua-mobile ?0, host localhost:3230, user-agent Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36, cookie Idea-d8c89f6f=5d06a449-7aaa-4285-b65a-53c2ae3cb299; leihs-anti-csrf-token=65184e75-5146-4915-8494-09445d034d15; leihs-user-session=c1c03935-ed33-4a3a-badb-740dd0e0ea6d, sec-fetch-user ?1, sec-ch-ua "Google Chrome";v="119", "Chromium";v="119", "Not?A_Brand";v="24", sec-ch-ua-platform "macOS", connection keep-alive, upgrade-insecure-requests 1, pragma no-cache, accept text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7, accept-language de-DE,de;q=0.9,en-US;q=0.8,en;q=0.7, sec-fetch-dest document, accept-encoding gzip, deflate, br, sec-fetch-mode navigate, cache-control no-cache}, :async-channel #object[org.httpkit.server.AsyncChannel 0x3d4ae4a5 /127.0.0.1:3230<->/127.0.0.1:62030], :server-port 3230, :params-raw {:return-to /procure}, :tx {:datasource #object[com.zaxxer.hikari.HikariDataSource 0x7c23224a HikariDataSource (db-pool)]}, :content-length 0, :form-params {}, :websocket? false, :query-params {:return-to /procure}, :content-type nil, :form-params-raw {}, :character-encoding utf8, :uri /sign-in, :server-name localhost, :handler-key :sign-in, :query-string return-to=%2Fprocure, :body nil, :graphql-schema #CompiledSchema<>, :handler #object[compojure.core$routes$fn__27950 0x237f4683 compojure.core$routes$fn__27950@237f4683], :multipart-params {}, :scheme :http, :request-method :get, :accept {:mime :html, :charset nil, :encoding nil, :language nil}}

>> authorize::handler-key >> :sign-in
2023-11-27T15:29:18.683Z NX-41294 DEBUG [leihs.procurement.authorization:135] - (skip? (:handler-key request)) => true
2023-11-27T15:29:18.694Z NX-41294 DEBUG [leihs.procurement.authorization:150] - (authorize handler request) => {:status 302, :headers {"Location" "/procure"}, :body ""}
>>> authenticate::skip= nil  handler-key= :procurement
>>> authenticate::authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-27T14:41:24.329670Z", :id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :user_session_id #uuid "be18f683-80fa-4f6d-bff0-d2bb3b22d776", :scope_system_admin_read false, :access-rights (), :user_id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}

>> authorize >

>> authorize::handler > #object[leihs.core.locale$wrap$fn__44325 0x62051b04 leihs.core.locale$wrap$fn__44325@62051b04]

>> authorize::request > {:authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-27T14:41:24.329670Z", :id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :user_session_id #uuid "be18f683-80fa-4f6d-bff0-d2bb3b22d776", :scope_system_admin_read false, :access-rights (), :user_id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}, :cookies {Idea-d8c89f6f {:value 5d06a449-7aaa-4285-b65a-53c2ae3cb299}, leihs-anti-csrf-token {:value 65184e75-5146-4915-8494-09445d034d15}, leihs-user-session {:value c1c03935-ed33-4a3a-badb-740dd0e0ea6d}}, :remote-addr 127.0.0.1, :start-time 5927375194750, :params {}, :settings {:email_sending_enabled false, :sessions_max_lifetime_secs 432000, :smtp_default_from_address your.lending.desk@example.com, :public_image_caching_enabled true, :sessions_force_secure false, :deliver_received_order_notifications false, :external_base_url nil, :sessions_force_uniqueness false, :email_signature Cheers,}, :tx-next #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x218bdce7 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x590187be next.jdbc.result_set$as_unqualified_lower_maps@590187be]}}, :query-params-raw {}, :route-params nil, :headers {sec-fetch-site none, sec-ch-ua-mobile ?0, host localhost:3230, user-agent Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36, cookie Idea-d8c89f6f=5d06a449-7aaa-4285-b65a-53c2ae3cb299; leihs-anti-csrf-token=65184e75-5146-4915-8494-09445d034d15; leihs-user-session=c1c03935-ed33-4a3a-badb-740dd0e0ea6d, sec-fetch-user ?1, sec-ch-ua "Google Chrome";v="119", "Chromium";v="119", "Not?A_Brand";v="24", sec-ch-ua-platform "macOS", connection keep-alive, upgrade-insecure-requests 1, pragma no-cache, accept text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7, accept-language de-DE,de;q=0.9,en-US;q=0.8,en;q=0.7, sec-fetch-dest document, accept-encoding gzip, deflate, br, sec-fetch-mode navigate, cache-control no-cache}, :async-channel #object[org.httpkit.server.AsyncChannel 0x2dd17754 /127.0.0.1:3230<->/127.0.0.1:62030], :server-port 3230, :params-raw {}, :tx {:datasource #object[com.zaxxer.hikari.HikariDataSource 0x7c23224a HikariDataSource (db-pool)]}, :content-length 0, :form-params {}, :websocket? false, :query-params {}, :content-type nil, :form-params-raw {}, :character-encoding utf8, :uri /procure, :server-name localhost, :handler-key :procurement, :query-string nil, :body nil, :graphql-schema #CompiledSchema<>, :handler #object[leihs.procurement.backend.html$not_found_handler 0x23169c9e leihs.procurement.backend.html$not_found_handler@23169c9e], :multipart-params {}, :scheme :http, :request-method :get, :accept {:mime :html, :charset nil, :encoding nil, :language nil}}

>> authorize::handler-key >> :procurement
2023-11-27T15:29:18.716Z NX-41294 DEBUG [leihs.procurement.authorization:135] - (skip? (:handler-key request)) => nil
2023-11-27T15:29:18.718Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-27T15:29:18.721Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = ?)) AS result " #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-27T15:29:18.725Z NX-41294 DEBUG [leihs.procurement.permissions.user:52] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_viewers) (sql/merge-where [:= :procurement_category_viewers.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_viewers.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = ?)) AS result " #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-27T15:29:18.727Z NX-41294 DEBUG [leihs.procurement.permissions.user:72] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_requesters_organizations) (sql/where [:= :procurement_requesters_organizations.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = ?)) AS result " #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-27T15:29:18.729Z NX-41294 DEBUG [leihs.procurement.authorization:136] - (->> [user-perms/admin? user-perms/inspector? user-perms/viewer? user-perms/requester?] (map (fn* [p1__39355#] (p1__39355# (:tx request) (:authenticated-entity request)))) (some true?)) => true
2023-11-27T15:29:18.733Z NX-41294 DEBUG [leihs.procurement.authorization:150] - (authorize handler request) => {:status 404, :headers {"Content-Length" "2299", "Last-Modified" "Mon, 27 Nov 2023 13:52:32 GMT", "Content-Type" "text/html"}, :body #object[java.io.File 0x2fc4ac99 "/Users/mradl/repos/leihs/procure/server/resources/public/procure/client/index.html"]}
>>> authenticate::skip= nil  handler-key= :graphql
>>> authenticate::authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-27T14:41:24.329670Z", :id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :user_session_id #uuid "be18f683-80fa-4f6d-bff0-d2bb3b22d776", :scope_system_admin_read false, :access-rights (), :user_id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}

>> authorize >

>> authorize::handler > #object[leihs.core.locale$wrap$fn__44325 0x62051b04 leihs.core.locale$wrap$fn__44325@62051b04]

>> authorize::request > {:authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-27T14:41:24.329670Z", :id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :user_session_id #uuid "be18f683-80fa-4f6d-bff0-d2bb3b22d776", :scope_system_admin_read false, :access-rights (), :user_id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}, :cookies {Idea-d8c89f6f {:value 5d06a449-7aaa-4285-b65a-53c2ae3cb299}, leihs-anti-csrf-token {:value 65184e75-5146-4915-8494-09445d034d15}, leihs-user-session {:value c1c03935-ed33-4a3a-badb-740dd0e0ea6d}}, :remote-addr 127.0.0.1, :start-time 5927743683250, :params {}, :settings {:email_sending_enabled false, :sessions_max_lifetime_secs 432000, :smtp_default_from_address your.lending.desk@example.com, :public_image_caching_enabled true, :sessions_force_secure false, :deliver_received_order_notifications false, :external_base_url nil, :sessions_force_uniqueness false, :email_signature Cheers,}, :tx-next #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x218bdce7 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x590187be next.jdbc.result_set$as_unqualified_lower_maps@590187be]}}, :query-params-raw {}, :route-params nil, :headers {origin http://localhost:3230, sec-fetch-site same-origin, sec-ch-ua-mobile ?0, host localhost:3230, user-agent Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36, content-type application/json, cookie Idea-d8c89f6f=5d06a449-7aaa-4285-b65a-53c2ae3cb299; leihs-anti-csrf-token=65184e75-5146-4915-8494-09445d034d15; leihs-user-session=c1c03935-ed33-4a3a-badb-740dd0e0ea6d, content-length 502, sec-ch-ua "Google Chrome";v="119", "Chromium";v="119", "Not?A_Brand";v="24", sec-ch-ua-platform "macOS", referer http://localhost:3230/procure, connection keep-alive, pragma no-cache, x-csrf-token 65184e75-5146-4915-8494-09445d034d15, accept application/json, accept-language de-DE,de;q=0.9,en-US;q=0.8,en;q=0.7, sec-fetch-dest empty, accept-encoding gzip, deflate, br, sec-fetch-mode cors, cache-control no-cache}, :async-channel #object[org.httpkit.server.AsyncChannel 0xd634923 /127.0.0.1:3230<->/127.0.0.1:62030], :server-port 3230, :params-raw {}, :tx {:datasource #object[com.zaxxer.hikari.HikariDataSource 0x7c23224a HikariDataSource (db-pool)]}, :content-length 502, :form-params {}, :websocket? false, :query-params {}, :content-type application/json, :form-params-raw {}, :character-encoding utf8, :uri /procure/graphql, :server-name localhost, :handler-key :graphql, :query-string nil, :body {:operationName me, :variables {}, :query query me {
  current_user {
    navbarProps
    user {
      id
      firstname
      lastname
      permissions {
        isAdmin
        isRequester
        isInspectorForCategories {
          id
          __typename
        }
        isViewerForCategories {
          id
          __typename
        }
        __typename
      }
      __typename
    }
    __typename
  }
  settings {
    contact_url
    __typename
  }
}
}, :graphql-schema #CompiledSchema<>, :handler #object[leihs.procurement.graphql$handler 0x3910051f leihs.procurement.graphql$handler@3910051f], :multipart-params {}, :scheme :http, :request-method :post, :accept {:mime :json, :charset nil, :encoding nil, :language nil}}

>> authorize::handler-key >> :graphql
2023-11-27T15:29:19.133Z NX-41294 DEBUG [leihs.procurement.authorization:135] - (skip? (:handler-key request)) => nil
2023-11-27T15:29:19.134Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-27T15:29:19.135Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = ?)) AS result " #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-27T15:29:19.136Z NX-41294 DEBUG [leihs.procurement.permissions.user:52] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_viewers) (sql/merge-where [:= :procurement_category_viewers.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_viewers.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = ?)) AS result " #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-27T15:29:19.137Z NX-41294 DEBUG [leihs.procurement.permissions.user:72] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_requesters_organizations) (sql/where [:= :procurement_requesters_organizations.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = ?)) AS result " #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-27T15:29:19.138Z NX-41294 DEBUG [leihs.procurement.authorization:136] - (->> [user-perms/admin? user-perms/inspector? user-perms/viewer? user-perms/requester?] (map (fn* [p1__39355#] (p1__39355# (:tx request) (:authenticated-entity request)))) (some true?)) => true

>>>exec-query::variables {}
2023-11-27T15:29:19.198Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-27T15:29:19.199Z NX-41294 DEBUG [leihs.procurement.permissions.user:72] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_requesters_organizations) (sql/where [:= :procurement_requesters_organizations.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = ?)) AS result " #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]

>>>pure-handler {:data #ordered/map ([:current_user #ordered/map ([:navbarProps {"csrfToken":{"value":"65184e75-5146-4915-8494-09445d034d15","name":"csrf-token"},"config":{"appTitle":"leihs","appColor":"gray","me":{"user":{"id":"e68ca036-dced-4666-b9e9-a6b55119f013","firstname":"Procurement","lastname":"Admin","login":null,"email":"jimmie@goyette.com"}},"subApps":{"borrow":false,"admin":false,"procure":false,"manage":[]},"locales":[{"name":"English (UK)","locale":"en-GB","active":true,"isDefault":true,"isSelected":true},{"name":"English (US)","locale":"en-US","active":true,"isDefault":false,"isSelected":false},{"name":"Deutsch","locale":"de-CH","active":true,"isDefault":false,"isSelected":false},{"name":"Züritüütsch","locale":"gsw-CH","active":true,"isDefault":false,"isSelected":false}]}}] [:user #ordered/map ([:id e68ca036-dced-4666-b9e9-a6b55119f013] [:firstname Procurement] [:lastname Admin] [:permissions #ordered/map ([:isAdmin true] [:isRequester false] [:isInspectorForCategories []] [:isViewerForCategories []] [:__typename :UserPermissions])] [:__typename :User])] [:__typename :CurrentUser])] [:settings #ordered/map ([:contact_url http://hartmann.io/rolf] [:__typename :ProcurementSettings])])}
2023-11-27T15:29:19.220Z NX-41294 DEBUG [leihs.procurement.authorization:150] - (authorize handler request) => {:body {:data #ordered/map ([:current_user #ordered/map ([:navbarProps "{\"csrfToken\":{\"value\":\"65184e75-5146-4915-8494-09445d034d15\",\"name\":\"csrf-token\"},\"config\":{\"appTitle\":\"leihs\",\"appColor\":\"gray\",\"me\":{\"user\":{\"id\":\"e68ca036-dced-4666-b9e9-a6b55119f013\",\"firstname\":\"Procurement\",\"lastname\":\"Admin\",\"login\":null,\"email\":\"jimmie@goyette.com\"}},\"subApps\":{\"borrow\":false,\"admin\":false,\"procure\":false,\"manage\":[]},\"locales\":[{\"name\":\"English (UK)\",\"locale\":\"en-GB\",\"active\":true,\"isDefault\":true,\"isSelected\":true},{\"name\":\"English (US)\",\"locale\":\"en-US\",\"active\":true,\"isDefault\":false,\"isSelected\":false},{\"name\":\"Deutsch\",\"locale\":\"de-CH\",\"active\":true,\"isDefault\":false,\"isSelected\":false},{\"name\":\"Züritüütsch\",\"locale\":\"gsw-CH\",\"active\":true,\"isDefault\":false,\"isSelected\":false}]}}"] [:user #ordered/map ([:id "e68ca036-dced-4666-b9e9-a6b55119f013"] [:firstname "Procurement"] [:lastname "Admin"] [:permissions #ordered/map ([:isAdmin true] [:isRequester false] [:isInspectorForCategories []] [:isViewerForCategories []] [:__typename :UserPermissions])] [:__typename :User])] [:__typename :CurrentUser])] [:settings #ordered/map ([:contact_url "http://hartmann.io/rolf"] [:__typename :ProcurementSettings])])}}
>>> authenticate::skip= nil  handler-key= :graphql
>>> authenticate::authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-27T14:41:24.329670Z", :id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :user_session_id #uuid "be18f683-80fa-4f6d-bff0-d2bb3b22d776", :scope_system_admin_read false, :access-rights (), :user_id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}

>> authorize >

>> authorize::handler > #object[leihs.core.locale$wrap$fn__44325 0x62051b04 leihs.core.locale$wrap$fn__44325@62051b04]

>> authorize::request > {:authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-27T14:41:24.329670Z", :id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :user_session_id #uuid "be18f683-80fa-4f6d-bff0-d2bb3b22d776", :scope_system_admin_read false, :access-rights (), :user_id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}, :cookies {Idea-d8c89f6f {:value 5d06a449-7aaa-4285-b65a-53c2ae3cb299}, leihs-anti-csrf-token {:value 65184e75-5146-4915-8494-09445d034d15}, leihs-user-session {:value c1c03935-ed33-4a3a-badb-740dd0e0ea6d}}, :remote-addr 127.0.0.1, :start-time 5927922881416, :params {}, :settings {:email_sending_enabled false, :sessions_max_lifetime_secs 432000, :smtp_default_from_address your.lending.desk@example.com, :public_image_caching_enabled true, :sessions_force_secure false, :deliver_received_order_notifications false, :external_base_url nil, :sessions_force_uniqueness false, :email_signature Cheers,}, :tx-next #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x218bdce7 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x590187be next.jdbc.result_set$as_unqualified_lower_maps@590187be]}}, :query-params-raw {}, :route-params nil, :headers {origin http://localhost:3230, sec-fetch-site same-origin, sec-ch-ua-mobile ?0, host localhost:3230, user-agent Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36, content-type application/json, cookie Idea-d8c89f6f=5d06a449-7aaa-4285-b65a-53c2ae3cb299; leihs-anti-csrf-token=65184e75-5146-4915-8494-09445d034d15; leihs-user-session=c1c03935-ed33-4a3a-badb-740dd0e0ea6d, content-length 502, sec-ch-ua "Google Chrome";v="119", "Chromium";v="119", "Not?A_Brand";v="24", sec-ch-ua-platform "macOS", referer http://localhost:3230/procure/requests, connection keep-alive, pragma no-cache, x-csrf-token 65184e75-5146-4915-8494-09445d034d15, accept application/json, accept-language de-DE,de;q=0.9,en-US;q=0.8,en;q=0.7, sec-fetch-dest empty, accept-encoding gzip, deflate, br, sec-fetch-mode cors, cache-control no-cache}, :async-channel #object[org.httpkit.server.AsyncChannel 0x5295db71 /127.0.0.1:3230<->/127.0.0.1:62039], :server-port 3230, :params-raw {}, :tx {:datasource #object[com.zaxxer.hikari.HikariDataSource 0x7c23224a HikariDataSource (db-pool)]}, :content-length 502, :form-params {}, :websocket? false, :query-params {}, :content-type application/json, :form-params-raw {}, :character-encoding utf8, :uri /procure/graphql, :server-name localhost, :handler-key :graphql, :query-string nil, :body {:operationName me, :variables {}, :query query me {
  current_user {
    navbarProps
    user {
      id
      firstname
      lastname
      permissions {
        isAdmin
        isRequester
        isInspectorForCategories {
          id
          __typename
        }
        isViewerForCategories {
          id
          __typename
        }
        __typename
      }
      __typename
    }
    __typename
  }
  settings {
    contact_url
    __typename
  }
}
}, :graphql-schema #CompiledSchema<>, :handler #object[leihs.procurement.graphql$handler 0x3910051f leihs.procurement.graphql$handler@3910051f], :multipart-params {}, :scheme :http, :request-method :post, :accept {:mime :json, :charset nil, :encoding nil, :language nil}}

>> authorize::handler-key >> :graphql
2023-11-27T15:29:19.269Z NX-41294 DEBUG [leihs.procurement.authorization:135] - (skip? (:handler-key request)) => nil
2023-11-27T15:29:19.270Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-27T15:29:19.272Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = ?)) AS result " #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-27T15:29:19.274Z NX-41294 DEBUG [leihs.procurement.permissions.user:52] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_viewers) (sql/merge-where [:= :procurement_category_viewers.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_viewers.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = ?)) AS result " #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-27T15:29:19.276Z NX-41294 DEBUG [leihs.procurement.permissions.user:72] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_requesters_organizations) (sql/where [:= :procurement_requesters_organizations.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = ?)) AS result " #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-27T15:29:19.277Z NX-41294 DEBUG [leihs.procurement.authorization:136] - (->> [user-perms/admin? user-perms/inspector? user-perms/viewer? user-perms/requester?] (map (fn* [p1__39355#] (p1__39355# (:tx request) (:authenticated-entity request)))) (some true?)) => true

>>>exec-query::variables {}
>>> authenticate::skip= nil  handler-key= :graphql
>>> authenticate::authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-27T14:41:24.329670Z", :id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :user_session_id #uuid "be18f683-80fa-4f6d-bff0-d2bb3b22d776", :scope_system_admin_read false, :access-rights (), :user_id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}

>> authorize >

>> authorize::handler > #object[leihs.core.locale$wrap$fn__44325 0x62051b04 leihs.core.locale$wrap$fn__44325@62051b04]

>> authorize::request > {:authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-27T14:41:24.329670Z", :id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :user_session_id #uuid "be18f683-80fa-4f6d-bff0-d2bb3b22d776", :scope_system_admin_read false, :access-rights (), :user_id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}, :cookies {Idea-d8c89f6f {:value 5d06a449-7aaa-4285-b65a-53c2ae3cb299}, leihs-anti-csrf-token {:value 65184e75-5146-4915-8494-09445d034d15}, leihs-user-session {:value c1c03935-ed33-4a3a-badb-740dd0e0ea6d}}, :remote-addr 127.0.0.1, :start-time 5927922630583, :params {}, :settings {:email_sending_enabled false, :sessions_max_lifetime_secs 432000, :smtp_default_from_address your.lending.desk@example.com, :public_image_caching_enabled true, :sessions_force_secure false, :deliver_received_order_notifications false, :external_base_url nil, :sessions_force_uniqueness false, :email_signature Cheers,}, :tx-next #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x218bdce7 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x590187be next.jdbc.result_set$as_unqualified_lower_maps@590187be]}}, :query-params-raw {}, :route-params nil, :headers {origin http://localhost:3230, sec-fetch-site same-origin, sec-ch-ua-mobile ?0, host localhost:3230, user-agent Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36, content-type application/json, cookie Idea-d8c89f6f=5d06a449-7aaa-4285-b65a-53c2ae3cb299; leihs-anti-csrf-token=65184e75-5146-4915-8494-09445d034d15; leihs-user-session=c1c03935-ed33-4a3a-badb-740dd0e0ea6d, content-length 534, sec-ch-ua "Google Chrome";v="119", "Chromium";v="119", "Not?A_Brand";v="24", sec-ch-ua-platform "macOS", referer http://localhost:3230/procure/requests, connection keep-alive, pragma no-cache, x-csrf-token 65184e75-5146-4915-8494-09445d034d15, accept application/json, accept-language de-DE,de;q=0.9,en-US;q=0.8,en;q=0.7, sec-fetch-dest empty, accept-encoding gzip, deflate, br, sec-fetch-mode cors, cache-control no-cache}, :async-channel #object[org.httpkit.server.AsyncChannel 0x1dd746a3 /127.0.0.1:3230<->/127.0.0.1:62031], :server-port 3230, :params-raw {}, :tx {:datasource #object[com.zaxxer.hikari.HikariDataSource 0x7c23224a HikariDataSource (db-pool)]}, :content-length 534, :form-params {}, :websocket? false, :query-params {}, :content-type application/json, :form-params-raw {}, :character-encoding utf8, :uri /procure/graphql, :server-name localhost, :handler-key :graphql, :query-string nil, :body {:operationName RequestFilters, :variables {}, :query query RequestFilters {
  budget_periods {
    id
    name
    inspection_start_date
    end_date
    __typename
  }
  main_categories {
    id
    name
    categories {
      id
      name
      __typename
    }
    __typename
  }
  organizations(root_only: true) {
    ...OrgProps
    organizations {
      ...OrgProps
      __typename
    }
    __typename
  }
}

fragment OrgProps on Organization {
  id
  name
  shortname
  __typename
}
}, :graphql-schema #CompiledSchema<>, :handler #object[leihs.procurement.graphql$handler 0x3910051f leihs.procurement.graphql$handler@3910051f], :multipart-params {}, :scheme :http, :request-method :post, :accept {:mime :json, :charset nil, :encoding nil, :language nil}}

>> authorize::handler-key >> :graphql
2023-11-27T15:29:19.291Z NX-41294 DEBUG [leihs.procurement.authorization:135] - (skip? (:handler-key request)) => nil
2023-11-27T15:29:19.292Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
>>> authenticate::skip= nil  handler-key= :graphql
>>> authenticate::authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-27T14:41:24.329670Z", :id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :user_session_id #uuid "be18f683-80fa-4f6d-bff0-d2bb3b22d776", :scope_system_admin_read false, :access-rights (), :user_id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}

>> authorize >

>> authorize::handler > #object[leihs.core.locale$wrap$fn__44325 0x62051b04 leihs.core.locale$wrap$fn__44325@62051b04]

>> authorize::request > {:authenticated-entity {:email jimmie@goyette.com, :contracts_count 0, :lastname Admin, :org_id nil, :scope_read true, :is_admin false, :authentication-method :session, :login nil, :scope_system_admin_write false, :scope_write true, :firstname Procurement, :scope_admin_write false, :user_session_created_at #time/instant "2023-11-27T14:41:24.329670Z", :id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :user_session_id #uuid "be18f683-80fa-4f6d-bff0-d2bb3b22d776", :scope_system_admin_read false, :access-rights (), :user_id #uuid "e68ca036-dced-4666-b9e9-a6b55119f013", :is_system_admin false, :external_sign_out_url nil, :language_locale nil, :inventory_pool_roles_count 0, :scope_admin_read false}, :cookies {Idea-d8c89f6f {:value 5d06a449-7aaa-4285-b65a-53c2ae3cb299}, leihs-anti-csrf-token {:value 65184e75-5146-4915-8494-09445d034d15}, leihs-user-session {:value c1c03935-ed33-4a3a-badb-740dd0e0ea6d}}, :remote-addr 127.0.0.1, :start-time 5927922404500, :params {}, :settings {:email_sending_enabled false, :sessions_max_lifetime_secs 432000, :smtp_default_from_address your.lending.desk@example.com, :public_image_caching_enabled true, :sessions_force_secure false, :deliver_received_order_notifications false, :external_base_url nil, :sessions_force_uniqueness false, :email_signature Cheers,}, :tx-next #next.jdbc.default_options.DefaultOptions{:connectable #object[com.zaxxer.hikari.HikariDataSource 0x218bdce7 HikariDataSource (HikariPool-1)], :options {:builder-fn #object[next.jdbc.result_set$as_unqualified_lower_maps 0x590187be next.jdbc.result_set$as_unqualified_lower_maps@590187be]}}, :query-params-raw {}, :route-params nil, :headers {origin http://localhost:3230, sec-fetch-site same-origin, sec-ch-ua-mobile ?0, host localhost:3230, user-agent Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36, content-type application/json, cookie Idea-d8c89f6f=5d06a449-7aaa-4285-b65a-53c2ae3cb299; leihs-anti-csrf-token=65184e75-5146-4915-8494-09445d034d15; leihs-user-session=c1c03935-ed33-4a3a-badb-740dd0e0ea6d, content-length 4019, sec-ch-ua "Google Chrome";v="119", "Chromium";v="119", "Not?A_Brand";v="24", sec-ch-ua-platform "macOS", referer http://localhost:3230/procure/requests, connection keep-alive, pragma no-cache, x-csrf-token 65184e75-5146-4915-8494-09445d034d15, accept application/json, accept-language de-DE,de;q=0.9,en-US;q=0.8,en;q=0.7, sec-fetch-dest empty, accept-encoding gzip, deflate, br, sec-fetch-mode cors, cache-control no-cache}, :async-channel #object[org.httpkit.server.AsyncChannel 0x34cee26d /127.0.0.1:3230<->/127.0.0.1:62030], :server-port 3230, :params-raw {}, :tx {:datasource #object[com.zaxxer.hikari.HikariDataSource 0x7c23224a HikariDataSource (db-pool)]}, :content-length 4019, :form-params {}, :websocket? false, :query-params {}, :content-type application/json, :form-params-raw {}, :character-encoding utf8, :uri /procure/graphql, :server-name localhost, :handler-key :graphql, :query-string nil, :body {:operationName RequestsIndexFiltered, :variables {:inspector_priority [LOW MEDIUM HIGH MANDATORY], :onlyOwnRequests false, :state [NEW APPROVED PARTIALLY_APPROVED DENIED], :order_status [NOT_PROCESSED IN_PROGRESS PROCURED ALTERNATIVE_PROCURED NOT_PROCURED], :search nil, :organizations [fb664326-a8ef-4556-af02-07d3127cd9ec], :categories [7d5ba731-edd9-41ba-8773-7337d24c2327], :priority [NORMAL HIGH], :budgetPeriods [8b8fe440-cae5-4bf9-8048-d0ec2399faa1]}, :query query RequestsIndexFiltered($budgetPeriods: [ID!], $categories: [ID!], $search: String, $state: [State!], $order_status: [OrderStatus], $organizations: [ID!], $priority: [Priority!], $inspector_priority: [InspectorPriority!], $onlyOwnRequests: Boolean) {
  dashboard(budget_period_id: $budgetPeriods, category_id: $categories, search: $search, state: $state, order_status: $order_status, organization_id: $organizations, priority: $priority, inspector_priority: $inspector_priority, requested_by_auth_user: $onlyOwnRequests) {
    cacheKey
    total_count
    budget_periods {
      id
      cacheKey
      name
      inspection_start_date
      end_date
      total_price_cents
      main_categories {
        id
        cacheKey
        name
        image_url
        total_price_cents
        categories {
          id
          cacheKey
          name
          total_price_cents
          requests {
            ...RequestFieldsForIndex
            total_price_cents
            actionPermissions {
              edit
              __typename
            }
            __typename
          }
          __typename
        }
        __typename
      }
      __typename
    }
    __typename
  }
}

fragment RequestFieldsForIndex on Request {
  id
  short_id
  user {
    value {
      id
      firstname
      lastname
      __typename
    }
    __typename
  }
  category {
    read
    write
    required
    value {
      id
      name
      main_category {
        id
        name
        __typename
      }
      __typename
    }
    __typename
  }
  budget_period {
    read
    write
    required
    value {
      name
      id
      __typename
    }
    __typename
  }
  article_name {
    value
    __typename
  }
  model {
    value {
      id
      product
      version
      __typename
    }
    __typename
  }
  receiver {
    value
    __typename
  }
  organization {
    value {
      id
      name
      shortname
      department {
        id
        name
        __typename
      }
      __typename
    }
    __typename
  }
  price_cents {
    value
    __typename
  }
  price_currency {
    value
    __typename
  }
  requested_quantity {
    read
    value
    __typename
  }
  approved_quantity {
    read
    value
    __typename
  }
  order_quantity {
    read
    value
    __typename
  }
  replacement {
    value
    __typename
  }
  priority {
    value
    __typename
  }
  state
  article_number {
    value
    __typename
  }
  supplier {
    value {
      name
      __typename
    }
    __typename
  }
  supplier_name {
    value
    __typename
  }
  receiver {
    value
    __typename
  }
  room {
    value {
      id
      name
      building {
        id
        name
        __typename
      }
      __typename
    }
    __typename
  }
  motivation {
    value
    __typename
  }
  inspection_comment {
    value
    __typename
  }
  inspector_priority {
    value
    __typename
  }
  accounting_type {
    value
    __typename
  }
  cost_center {
    value
    __typename
  }
  general_ledger_account {
    value
    __typename
  }
  procurement_account {
    value
    __typename
  }
  internal_order_number {
    value
    __typename
  }
  order_status {
    value
    __typename
  }
  order_comment {
    value
    __typename
  }
  __typename
}
}, :graphql-schema #CompiledSchema<>, :handler #object[leihs.procurement.graphql$handler 0x3910051f leihs.procurement.graphql$handler@3910051f], :multipart-params {}, :scheme :http, :request-method :post, :accept {:mime :json, :charset nil, :encoding nil, :language nil}}

>> authorize::handler-key >> :graphql
2023-11-27T15:29:19.294Z NX-41294 DEBUG [leihs.procurement.authorization:135] - (skip? (:handler-key request)) => nil
2023-11-27T15:29:19.294Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = ?)) AS result " #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-27T15:29:19.294Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-27T15:29:19.295Z NX-41294 DEBUG [leihs.procurement.permissions.user:52] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_viewers) (sql/merge-where [:= :procurement_category_viewers.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_viewers.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = ?)) AS result " #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-27T15:29:19.295Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = ?)) AS result " #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-27T15:29:19.296Z NX-41294 DEBUG [leihs.procurement.permissions.user:72] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_requesters_organizations) (sql/where [:= :procurement_requesters_organizations.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = ?)) AS result " #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-27T15:29:19.296Z NX-41294 DEBUG [leihs.procurement.permissions.user:52] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_viewers) (sql/merge-where [:= :procurement_category_viewers.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_viewers.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = ?)) AS result " #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-27T15:29:19.297Z NX-41294 DEBUG [leihs.procurement.authorization:136] - (->> [user-perms/admin? user-perms/inspector? user-perms/viewer? user-perms/requester?] (map (fn* [p1__39355#] (p1__39355# (:tx request) (:authenticated-entity request)))) (some true?)) => true
2023-11-27T15:29:19.297Z NX-41294 DEBUG [leihs.procurement.permissions.user:72] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_requesters_organizations) (sql/where [:= :procurement_requesters_organizations.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = ?)) AS result " #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-27T15:29:19.298Z NX-41294 DEBUG [leihs.procurement.authorization:136] - (->> [user-perms/admin? user-perms/inspector? user-perms/viewer? user-perms/requester?] (map (fn* [p1__39355#] (p1__39355# (:tx request) (:authenticated-entity request)))) (some true?)) => true
2023-11-27T15:29:19.303Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-27T15:29:19.304Z NX-41294 DEBUG [leihs.procurement.permissions.user:72] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_requesters_organizations) (sql/where [:= :procurement_requesters_organizations.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = ?)) AS result " #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]

>>>exec-query::variables {}

>>>pure-handler {:data #ordered/map ([:current_user #ordered/map ([:navbarProps {"csrfToken":{"value":"65184e75-5146-4915-8494-09445d034d15","name":"csrf-token"},"config":{"appTitle":"leihs","appColor":"gray","me":{"user":{"id":"e68ca036-dced-4666-b9e9-a6b55119f013","firstname":"Procurement","lastname":"Admin","login":null,"email":"jimmie@goyette.com"}},"subApps":{"borrow":false,"admin":false,"procure":false,"manage":[]},"locales":[{"name":"English (UK)","locale":"en-GB","active":true,"isDefault":true,"isSelected":true},{"name":"English (US)","locale":"en-US","active":true,"isDefault":false,"isSelected":false},{"name":"Deutsch","locale":"de-CH","active":true,"isDefault":false,"isSelected":false},{"name":"Züritüütsch","locale":"gsw-CH","active":true,"isDefault":false,"isSelected":false}]}}] [:user #ordered/map ([:id e68ca036-dced-4666-b9e9-a6b55119f013] [:firstname Procurement] [:lastname Admin] [:permissions #ordered/map ([:isAdmin true] [:isRequester false] [:isInspectorForCategories []] [:isViewerForCategories []] [:__typename :UserPermissions])] [:__typename :User])] [:__typename :CurrentUser])] [:settings #ordered/map ([:contact_url http://hartmann.io/rolf] [:__typename :ProcurementSettings])])}
2023-11-27T15:29:19.307Z NX-41294 DEBUG [leihs.procurement.authorization:150] - (authorize handler request) => {:body {:data #ordered/map ([:current_user #ordered/map ([:navbarProps "{\"csrfToken\":{\"value\":\"65184e75-5146-4915-8494-09445d034d15\",\"name\":\"csrf-token\"},\"config\":{\"appTitle\":\"leihs\",\"appColor\":\"gray\",\"me\":{\"user\":{\"id\":\"e68ca036-dced-4666-b9e9-a6b55119f013\",\"firstname\":\"Procurement\",\"lastname\":\"Admin\",\"login\":null,\"email\":\"jimmie@goyette.com\"}},\"subApps\":{\"borrow\":false,\"admin\":false,\"procure\":false,\"manage\":[]},\"locales\":[{\"name\":\"English (UK)\",\"locale\":\"en-GB\",\"active\":true,\"isDefault\":true,\"isSelected\":true},{\"name\":\"English (US)\",\"locale\":\"en-US\",\"active\":true,\"isDefault\":false,\"isSelected\":false},{\"name\":\"Deutsch\",\"locale\":\"de-CH\",\"active\":true,\"isDefault\":false,\"isSelected\":false},{\"name\":\"Züritüütsch\",\"locale\":\"gsw-CH\",\"active\":true,\"isDefault\":false,\"isSelected\":false}]}}"] [:user #ordered/map ([:id "e68ca036-dced-4666-b9e9-a6b55119f013"] [:firstname "Procurement"] [:lastname "Admin"] [:permissions #ordered/map ([:isAdmin true] [:isRequester false] [:isInspectorForCategories []] [:isViewerForCategories []] [:__typename :UserPermissions])] [:__typename :User])] [:__typename :CurrentUser])] [:settings #ordered/map ([:contact_url "http://hartmann.io/rolf"] [:__typename :ProcurementSettings])])}}

>>>exec-query::variables {:inspector_priority [LOW MEDIUM HIGH MANDATORY], :onlyOwnRequests false, :state [NEW APPROVED PARTIALLY_APPROVED DENIED], :order_status [NOT_PROCESSED IN_PROGRESS PROCURED ALTERNATIVE_PROCURED NOT_PROCURED], :search nil, :organizations [fb664326-a8ef-4556-af02-07d3127cd9ec], :categories [7d5ba731-edd9-41ba-8773-7337d24c2327], :priority [NORMAL HIGH], :budgetPeriods [8b8fe440-cae5-4bf9-8048-d0ec2399faa1]}
>>>get-dashboard
>>args {:inspector_priority [:LOW :MEDIUM :HIGH :MANDATORY], :organization_id [fb664326-a8ef-4556-af02-07d3127cd9ec], :requested_by_auth_user false, :state [:NEW :APPROVED :PARTIALLY_APPROVED :DENIED], :order_status [:NOT_PROCESSED :IN_PROGRESS :PROCURED :ALTERNATIVE_PROCURED :NOT_PROCURED], :search nil, :priority [:NORMAL :HIGH], :budget_period_id [8b8fe440-cae5-4bf9-8048-d0ec2399faa1], :category_id [7d5ba731-edd9-41ba-8773-7337d24c2327]}
>>value nil
>>mainCatsSql [SELECT procurement_main_categories.* FROM procurement_main_categories  ORDER BY procurement_main_categories.name ASC]

>>>pure-handler {:data #ordered/map ([:budget_periods [#ordered/map ([:id 8b8fe440-cae5-4bf9-8048-d0ec2399faa1] [:name Budget-Period-Past] [:inspection_start_date 2023-08-23T22:00:00Z] [:end_date 2023-11-22T23:00:00Z] [:__typename :BudgetPeriod])]] [:main_categories [#ordered/map ([:id d2907cbd-98d0-48b7-ab9a-f06803e5cabb] [:name Main Category MC1] [:categories [#ordered/map ([:id 7d5ba731-edd9-41ba-8773-7337d24c2327] [:name Category C1] [:__typename :Category])]] [:__typename :MainCategory])]] [:organizations [#ordered/map ([:id d6f9842f-4a7f-45ed-8ac5-c708cd6f8ca9] [:name Home, Jewelry & Computers] [:shortname nil] [:__typename :Organization] [:organizations [#ordered/map ([:id fb664326-a8ef-4556-af02-07d3127cd9ec] [:name Beauty & Kids] [:shortname nil] [:__typename :Organization])]])]])}
>>mainCats ({:id #uuid "d2907cbd-98d0-48b7-ab9a-f06803e5cabb", :name Main Category MC1})
2023-11-27T15:29:19.333Z NX-41294 DEBUG [leihs.procurement.authorization:150] - (authorize handler request) => {:body {:data #ordered/map ([:budget_periods [#ordered/map ([:id "8b8fe440-cae5-4bf9-8048-d0ec2399faa1"] [:name "Budget-Period-Past"] [:inspection_start_date "2023-08-23T22:00:00Z"] [:end_date "2023-11-22T23:00:00Z"] [:__typename :BudgetPeriod])]] [:main_categories [#ordered/map ([:id "d2907cbd-98d0-48b7-ab9a-f06803e5cabb"] [:name "Main Category MC1"] [:categories [#ordered/map ([:id "7d5ba731-edd9-41ba-8773-7337d24c2327"] [:name "Category C1"] [:__typename :Category])]] [:__typename :MainCategory])]] [:organizations [#ordered/map ([:id "d6f9842f-4a7f-45ed-8ac5-c708cd6f8ca9"] [:name "Home, Jewelry & Computers"] [:shortname nil] [:__typename :Organization] [:organizations [#ordered/map ([:id "fb664326-a8ef-4556-af02-07d3127cd9ec"] [:name "Beauty & Kids"] [:shortname nil] [:__typename :Organization])]])]])}}
>>resultA0-bps-original ({:id #uuid "8b8fe440-cae5-4bf9-8048-d0ec2399faa1", :name Budget-Period-Past, :inspection_start_date #time/instant "2023-08-23T22:00:00Z", :end_date #time/instant "2023-11-22T23:00:00Z", :created_at #time/instant "2023-11-24T19:25:51.605131Z", :updated_at #time/instant "2023-11-24T19:25:51.605131Z"})
>>queryA1 [SELECT procurement_budget_periods.* FROM procurement_budget_periods  WHERE (procurement_budget_periods.id in (?)) ORDER BY end_date DESC 8b8fe440-cae5-4bf9-8048-d0ec2399faa1]
>>resultA1 ({:id #uuid "8b8fe440-cae5-4bf9-8048-d0ec2399faa1", :name Budget-Period-Past, :inspection_start_date #time/instant "2023-08-23T22:00:00Z", :end_date #time/instant "2023-11-22T23:00:00Z", :created_at #time/instant "2023-11-24T19:25:51.605131Z", :updated_at #time/instant "2023-11-24T19:25:51.605131Z"})
>>resultA1-2 ({:id #uuid "8b8fe440-cae5-4bf9-8048-d0ec2399faa1", :name Budget-Period-Past, :inspection_start_date #time/instant "2023-08-23T22:00:00Z", :end_date #time/instant "2023-11-22T23:00:00Z", :created_at #time/instant "2023-11-24T19:25:51.605131Z", :updated_at #time/instant "2023-11-24T19:25:51.605131Z"})
>>requestsB2-triggerError {:inspector_priority [:LOW :MEDIUM :HIGH :MANDATORY], :organization_id [fb664326-a8ef-4556-af02-07d3127cd9ec], :requested_by_auth_user false, :state [:NEW :APPROVED :PARTIALLY_APPROVED :DENIED], :order_status [:NOT_PROCESSED :IN_PROGRESS :PROCURED :ALTERNATIVE_PROCURED :NOT_PROCURED], :search nil, :priority [:NORMAL :HIGH], :budget_period_id [8b8fe440-cae5-4bf9-8048-d0ec2399faa1], :category_id [7d5ba731-edd9-41ba-8773-7337d24c2327]} nil
2023-11-27T15:29:19.341Z NX-41294 DEBUG [leihs.procurement.resources.requests:102] - arguments => {:inspector_priority [:LOW :MEDIUM :HIGH :MANDATORY], :organization_id ["fb664326-a8ef-4556-af02-07d3127cd9ec"], :requested_by_auth_user false, :state [:NEW :APPROVED :PARTIALLY_APPROVED :DENIED], :order_status [:NOT_PROCESSED :IN_PROGRESS :PROCURED :ALTERNATIVE_PROCURED :NOT_PROCURED], :search nil, :priority [:NORMAL :HIGH], :budget_period_id ["8b8fe440-cae5-4bf9-8048-d0ec2399faa1"], :category_id ["7d5ba731-edd9-41ba-8773-7337d24c2327"]}
2023-11-27T15:29:19.341Z NX-41294 DEBUG [leihs.procurement.resources.requests:103] - value => nil
>get-requests>> ???
>o> 1-After requests-query-map:
2023-11-27T15:29:19.343Z NX-41294 DEBUG [leihs.procurement.permissions.user:52] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_viewers) (sql/merge-where [:= :procurement_category_viewers.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_viewers.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = ?)) AS result " #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-27T15:29:19.344Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = ?)) AS result " #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-27T15:29:19.345Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-27T15:29:19.346Z NX-41294 DEBUG [leihs.procurement.permissions.user:85] - (->> [viewer? inspector? admin?] (map (fn* [p1__39296#] (p1__39296# tx auth-entity))) (some true?)) => true
>o> state-sql #sql/call [:case [:= :procurement_requests.approved_quantity nil] NEW [:>= :procurement_requests.approved_quantity :procurement_requests.requested_quantity] APPROVED [:and [:< :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:> :procurement_requests.approved_quantity 0]] PARTIALLY_APPROVED [:= :procurement_requests.approved_quantity 0] DENIED]
>o> class honeysql.types.SqlCall
>o> state-sql _> formatted [CASE WHEN procurement_requests.approved_quantity IS NULL THEN ? WHEN procurement_requests.approved_quantity >= procurement_requests.requested_quantity THEN ? WHEN (procurement_requests.approved_quantity < procurement_requests.requested_quantity AND procurement_requests.approved_quantity > ?) THEN ? WHEN procurement_requests.approved_quantity = ? THEN ? END NEW APPROVED 0 PARTIALLY_APPROVED 0 DENIED]
2023-11-27T15:29:19.348Z NX-41294 DEBUG [leihs.procurement.resources.request:142] - result => #sql/call [:case [:= :procurement_requests.approved_quantity nil] "NEW" [:>= :procurement_requests.approved_quantity :procurement_requests.requested_quantity] "APPROVED" [:and [:< :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:> :procurement_requests.approved_quantity 0]] "PARTIALLY_APPROVED" [:= :procurement_requests.approved_quantity 0] "DENIED"]
2023-11-27T15:29:19.348Z NX-41294 DEBUG [leihs.procurement.resources.request:166] - (-> requests-base-query (sql/merge-select [(state-sql advanced-user?) :state]) (sql/merge-join :procurement_budget_periods [:= :procurement_budget_periods.id :procurement_requests.budget_period_id])) => {:select (#sql/raw "DISTINCT ON (procurement_requests.id, concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))) procurement_requests.*" [#sql/call [:case [:= :procurement_requests.approved_quantity nil] "NEW" [:>= :procurement_requests.approved_quantity :procurement_requests.requested_quantity] "APPROVED" [:and [:< :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:> :procurement_requests.approved_quantity 0]] "PARTIALLY_APPROVED" [:= :procurement_requests.approved_quantity 0] "DENIED"] :state]), :from (:procurement_requests), :left-join (:models [:= :models.id :procurement_requests.model_id]), :order-by (#sql/raw "concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))"), :join (:procurement_budget_periods [:= :procurement_budget_periods.id :procurement_requests.budget_period_id])}
>o> 2-After apply-scope: {:select (#sql/raw DISTINCT ON (procurement_requests.id, concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))) procurement_requests.* [#sql/call [:case [:= :procurement_requests.approved_quantity nil] NEW [:>= :procurement_requests.approved_quantity :procurement_requests.requested_quantity] APPROVED [:and [:< :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:> :procurement_requests.approved_quantity 0]] PARTIALLY_APPROVED [:= :procurement_requests.approved_quantity 0] DENIED] :state] [#sql/call [:row_to_json :procurement_budget_periods_2] :budget_period] #sql/raw row_to_json(procurement_categories)::jsonb || jsonb_build_object('main_category', row_to_json(procurement_main_categories)) AS category [#sql/call [:row_to_json :models] :model] #sql/raw row_to_json(procurement_organizations)::jsonb || jsonb_build_object('department', row_to_json(procurement_departments)) AS organization [#sql/call [:row_to_json :procurement_templates] :template] #sql/raw row_to_json(rooms)::jsonb || jsonb_build_object('building', row_to_json(buildings)) AS room [#sql/call [:row_to_json :suppliers] :supplier] [#sql/call [:row_to_json :users] :user]), :from (:procurement_requests), :left-join (:models [:= :models.id :procurement_requests.model_id] :procurement_templates [:= :procurement_templates.id :procurement_requests.template_id] :suppliers [:= :suppliers.id :procurement_requests.supplier_id] :users [:= :users.id :procurement_requests.user_id]), :order-by (#sql/raw concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))), :join (:procurement_budget_periods [:= :procurement_budget_periods.id :procurement_requests.budget_period_id] [{:select (:* [#sql/call [:> :current_date :end_date] :is_past]), :from (:procurement_budget_periods)} :procurement_budget_periods_2] [:= :procurement_budget_periods_2.id :procurement_requests.budget_period_id] :procurement_categories [:= :procurement_categories.id :procurement_requests.category_id] :procurement_main_categories [:= :procurement_main_categories.id :procurement_categories.main_category_id] :procurement_organizations [:= :procurement_organizations.id :procurement_requests.organization_id] [:procurement_organizations :procurement_departments] [:= :procurement_departments.id :procurement_organizations.parent_id] :rooms [:= :rooms.id :procurement_requests.room_id] :buildings [:= :buildings.id :rooms.building_id]), :where [:and [:in :procurement_requests.category_id [7d5ba731-edd9-41ba-8773-7337d24c2327]] [:in :procurement_requests.budget_period_id [8b8fe440-cae5-4bf9-8048-d0ec2399faa1]] [:in :procurement_requests.organization_id [fb664326-a8ef-4556-af02-07d3127cd9ec]] [:in :procurement_requests.priority (normal high)] [:in :procurement_requests.inspector_priority (low medium high mandatory)] [:or [:= :procurement_requests.approved_quantity nil] [:>= :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:and [:< :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:> :procurement_requests.approved_quantity 0]] [:= :procurement_requests.approved_quantity 0]] [:in :procurement_requests.order_status (#sql/call [:cast not_processed :order_status_enum] #sql/call [:cast in_progress :order_status_enum] #sql/call [:cast procured :order_status_enum] #sql/call [:cast alternative_procured :order_status_enum] #sql/call [:cast not_procured :order_status_enum])]]}
2023-11-27T15:29:19.351Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
>o> 3-After sql-format: {:select (#sql/raw DISTINCT ON (procurement_requests.id, concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))) procurement_requests.* [#sql/call [:case [:= :procurement_requests.approved_quantity nil] NEW [:>= :procurement_requests.approved_quantity :procurement_requests.requested_quantity] APPROVED [:and [:< :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:> :procurement_requests.approved_quantity 0]] PARTIALLY_APPROVED [:= :procurement_requests.approved_quantity 0] DENIED] :state] [#sql/call [:row_to_json :procurement_budget_periods_2] :budget_period] #sql/raw row_to_json(procurement_categories)::jsonb || jsonb_build_object('main_category', row_to_json(procurement_main_categories)) AS category [#sql/call [:row_to_json :models] :model] #sql/raw row_to_json(procurement_organizations)::jsonb || jsonb_build_object('department', row_to_json(procurement_departments)) AS organization [#sql/call [:row_to_json :procurement_templates] :template] #sql/raw row_to_json(rooms)::jsonb || jsonb_build_object('building', row_to_json(buildings)) AS room [#sql/call [:row_to_json :suppliers] :supplier] [#sql/call [:row_to_json :users] :user]), :from (:procurement_requests), :left-join (:models [:= :models.id :procurement_requests.model_id] :procurement_templates [:= :procurement_templates.id :procurement_requests.template_id] :suppliers [:= :suppliers.id :procurement_requests.supplier_id] :users [:= :users.id :procurement_requests.user_id]), :order-by (#sql/raw concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))), :join (:procurement_budget_periods [:= :procurement_budget_periods.id :procurement_requests.budget_period_id] [{:select (:* [#sql/call [:> :current_date :end_date] :is_past]), :from (:procurement_budget_periods)} :procurement_budget_periods_2] [:= :procurement_budget_periods_2.id :procurement_requests.budget_period_id] :procurement_categories [:= :procurement_categories.id :procurement_requests.category_id] :procurement_main_categories [:= :procurement_main_categories.id :procurement_categories.main_category_id] :procurement_organizations [:= :procurement_organizations.id :procurement_requests.organization_id] [:procurement_organizations :procurement_departments] [:= :procurement_departments.id :procurement_organizations.parent_id] :rooms [:= :rooms.id :procurement_requests.room_id] :buildings [:= :buildings.id :rooms.building_id]), :where [:and [:in :procurement_requests.category_id [7d5ba731-edd9-41ba-8773-7337d24c2327]] [:in :procurement_requests.budget_period_id [8b8fe440-cae5-4bf9-8048-d0ec2399faa1]] [:in :procurement_requests.organization_id [fb664326-a8ef-4556-af02-07d3127cd9ec]] [:in :procurement_requests.priority (normal high)] [:in :procurement_requests.inspector_priority (low medium high mandatory)] [:or [:= :procurement_requests.approved_quantity nil] [:>= :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:and [:< :procurement_requests.approved_quantity :procurement_requests.requested_quantity] [:> :procurement_requests.approved_quantity 0]] [:= :procurement_requests.approved_quantity 0]] [:in :procurement_requests.order_status (#sql/call [:cast not_processed :order_status_enum] #sql/call [:cast in_progress :order_status_enum] #sql/call [:cast procured :order_status_enum] #sql/call [:cast alternative_procured :order_status_enum] #sql/call [:cast not_procured :order_status_enum])]]}
2023-11-27T15:29:19.354Z NX-41294 DEBUG [leihs.procurement.resources.requests:129] - query => ["SELECT DISTINCT ON (procurement_requests.id, concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))) procurement_requests.*, CASE WHEN procurement_requests.approved_quantity IS NULL THEN ? WHEN procurement_requests.approved_quantity >= procurement_requests.requested_quantity THEN ? WHEN (procurement_requests.approved_quantity < procurement_requests.requested_quantity AND procurement_requests.approved_quantity > ?) THEN ? WHEN procurement_requests.approved_quantity = ? THEN ? END AS state, row_to_json(procurement_budget_periods_2) AS budget_period, row_to_json(procurement_categories)::jsonb || jsonb_build_object('main_category', row_to_json(procurement_main_categories)) AS category, row_to_json(models) AS model, row_to_json(procurement_organizations)::jsonb || jsonb_build_object('department', row_to_json(procurement_departments)) AS organization, row_to_json(procurement_templates) AS template, row_to_json(rooms)::jsonb || jsonb_build_object('building', row_to_json(buildings)) AS room, row_to_json(suppliers) AS supplier, row_to_json(users) AS user FROM procurement_requests INNER JOIN procurement_budget_periods ON procurement_budget_periods.id = procurement_requests.budget_period_id INNER JOIN (SELECT *, current_date > end_date AS is_past FROM procurement_budget_periods) procurement_budget_periods_2 ON procurement_budget_periods_2.id = procurement_requests.budget_period_id INNER JOIN procurement_categories ON procurement_categories.id = procurement_requests.category_id INNER JOIN procurement_main_categories ON procurement_main_categories.id = procurement_categories.main_category_id INNER JOIN procurement_organizations ON procurement_organizations.id = procurement_requests.organization_id INNER JOIN procurement_organizations procurement_departments ON procurement_departments.id = procurement_organizations.parent_id INNER JOIN rooms ON rooms.id = procurement_requests.room_id INNER JOIN buildings ON buildings.id = rooms.building_id LEFT JOIN models ON models.id = procurement_requests.model_id LEFT JOIN procurement_templates ON procurement_templates.id = procurement_requests.template_id LEFT JOIN suppliers ON suppliers.id = procurement_requests.supplier_id LEFT JOIN users ON users.id = procurement_requests.user_id WHERE ((procurement_requests.category_id in (?)) AND (procurement_requests.budget_period_id in (?)) AND (procurement_requests.organization_id in (?)) AND (procurement_requests.priority in (?, ?)) AND (procurement_requests.inspector_priority in (?, ?, ?, ?)) AND (procurement_requests.approved_quantity IS NULL OR procurement_requests.approved_quantity >= procurement_requests.requested_quantity OR (procurement_requests.approved_quantity < procurement_requests.requested_quantity AND procurement_requests.approved_quantity > ?) OR procurement_requests.approved_quantity = ?) AND (procurement_requests.order_status in (CAST(? AS order_status_enum), CAST(? AS order_status_enum), CAST(? AS order_status_enum), CAST(? AS order_status_enum), CAST(? AS order_status_enum)))) ORDER BY concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))" "NEW" "APPROVED" 0 "PARTIALLY_APPROVED" 0 "DENIED" "7d5ba731-edd9-41ba-8773-7337d24c2327" "8b8fe440-cae5-4bf9-8048-d0ec2399faa1" "fb664326-a8ef-4556-af02-07d3127cd9ec" "normal" "high" "low" "medium" "high" "mandatory" 0 0 "not_processed" "in_progress" "procured" "alternative_procured" "not_procured"]
2023-11-27T15:29:19.355Z NX-41294 DEBUG [leihs.procurement.resources.requests:131] - query => ["SELECT DISTINCT ON (procurement_requests.id, concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))) procurement_requests.*, CASE WHEN procurement_requests.approved_quantity IS NULL THEN ? WHEN procurement_requests.approved_quantity >= procurement_requests.requested_quantity THEN ? WHEN (procurement_requests.approved_quantity < procurement_requests.requested_quantity AND procurement_requests.approved_quantity > ?) THEN ? WHEN procurement_requests.approved_quantity = ? THEN ? END AS state, row_to_json(procurement_budget_periods_2) AS budget_period, row_to_json(procurement_categories)::jsonb || jsonb_build_object('main_category', row_to_json(procurement_main_categories)) AS category, row_to_json(models) AS model, row_to_json(procurement_organizations)::jsonb || jsonb_build_object('department', row_to_json(procurement_departments)) AS organization, row_to_json(procurement_templates) AS template, row_to_json(rooms)::jsonb || jsonb_build_object('building', row_to_json(buildings)) AS room, row_to_json(suppliers) AS supplier, row_to_json(users) AS user FROM procurement_requests INNER JOIN procurement_budget_periods ON procurement_budget_periods.id = procurement_requests.budget_period_id INNER JOIN (SELECT *, current_date > end_date AS is_past FROM procurement_budget_periods) procurement_budget_periods_2 ON procurement_budget_periods_2.id = procurement_requests.budget_period_id INNER JOIN procurement_categories ON procurement_categories.id = procurement_requests.category_id INNER JOIN procurement_main_categories ON procurement_main_categories.id = procurement_categories.main_category_id INNER JOIN procurement_organizations ON procurement_organizations.id = procurement_requests.organization_id INNER JOIN procurement_organizations procurement_departments ON procurement_departments.id = procurement_organizations.parent_id INNER JOIN rooms ON rooms.id = procurement_requests.room_id INNER JOIN buildings ON buildings.id = rooms.building_id LEFT JOIN models ON models.id = procurement_requests.model_id LEFT JOIN procurement_templates ON procurement_templates.id = procurement_requests.template_id LEFT JOIN suppliers ON suppliers.id = procurement_requests.supplier_id LEFT JOIN users ON users.id = procurement_requests.user_id WHERE ((procurement_requests.category_id in (?)) AND (procurement_requests.budget_period_id in (?)) AND (procurement_requests.organization_id in (?)) AND (procurement_requests.priority in (?, ?)) AND (procurement_requests.inspector_priority in (?, ?, ?, ?)) AND (procurement_requests.approved_quantity IS NULL OR procurement_requests.approved_quantity >= procurement_requests.requested_quantity OR (procurement_requests.approved_quantity < procurement_requests.requested_quantity AND procurement_requests.approved_quantity > ?) OR procurement_requests.approved_quantity = ?) AND (procurement_requests.order_status in (CAST(? AS order_status_enum), CAST(? AS order_status_enum), CAST(? AS order_status_enum), CAST(? AS order_status_enum), CAST(? AS order_status_enum)))) ORDER BY concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))" "NEW" "APPROVED" 0 "PARTIALLY_APPROVED" 0 "DENIED" "7d5ba731-edd9-41ba-8773-7337d24c2327" "8b8fe440-cae5-4bf9-8048-d0ec2399faa1" "fb664326-a8ef-4556-af02-07d3127cd9ec" "normal" "high" "low" "medium" "high" "mandatory" 0 0 "not_processed" "in_progress" "procured" "alternative_procured" "not_procured"]
>>broken-query [SELECT DISTINCT ON (procurement_requests.id, concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, '')))) procurement_requests.*, CASE WHEN procurement_requests.approved_quantity IS NULL THEN ? WHEN procurement_requests.approved_quantity >= procurement_requests.requested_quantity THEN ? WHEN (procurement_requests.approved_quantity < procurement_requests.requested_quantity AND procurement_requests.approved_quantity > ?) THEN ? WHEN procurement_requests.approved_quantity = ? THEN ? END AS state, row_to_json(procurement_budget_periods_2) AS budget_period, row_to_json(procurement_categories)::jsonb || jsonb_build_object('main_category', row_to_json(procurement_main_categories)) AS category, row_to_json(models) AS model, row_to_json(procurement_organizations)::jsonb || jsonb_build_object('department', row_to_json(procurement_departments)) AS organization, row_to_json(procurement_templates) AS template, row_to_json(rooms)::jsonb || jsonb_build_object('building', row_to_json(buildings)) AS room, row_to_json(suppliers) AS supplier, row_to_json(users) AS user FROM procurement_requests INNER JOIN procurement_budget_periods ON procurement_budget_periods.id = procurement_requests.budget_period_id INNER JOIN (SELECT *, current_date > end_date AS is_past FROM procurement_budget_periods) procurement_budget_periods_2 ON procurement_budget_periods_2.id = procurement_requests.budget_period_id INNER JOIN procurement_categories ON procurement_categories.id = procurement_requests.category_id INNER JOIN procurement_main_categories ON procurement_main_categories.id = procurement_categories.main_category_id INNER JOIN procurement_organizations ON procurement_organizations.id = procurement_requests.organization_id INNER JOIN procurement_organizations procurement_departments ON procurement_departments.id = procurement_organizations.parent_id INNER JOIN rooms ON rooms.id = procurement_requests.room_id INNER JOIN buildings ON buildings.id = rooms.building_id LEFT JOIN models ON models.id = procurement_requests.model_id LEFT JOIN procurement_templates ON procurement_templates.id = procurement_requests.template_id LEFT JOIN suppliers ON suppliers.id = procurement_requests.supplier_id LEFT JOIN users ON users.id = procurement_requests.user_id WHERE ((procurement_requests.category_id in (?)) AND (procurement_requests.budget_period_id in (?)) AND (procurement_requests.organization_id in (?)) AND (procurement_requests.priority in (?, ?)) AND (procurement_requests.inspector_priority in (?, ?, ?, ?)) AND (procurement_requests.approved_quantity IS NULL OR procurement_requests.approved_quantity >= procurement_requests.requested_quantity OR (procurement_requests.approved_quantity < procurement_requests.requested_quantity AND procurement_requests.approved_quantity > ?) OR procurement_requests.approved_quantity = ?) AND (procurement_requests.order_status in (CAST(? AS order_status_enum), CAST(? AS order_status_enum), CAST(? AS order_status_enum), CAST(? AS order_status_enum), CAST(? AS order_status_enum)))) ORDER BY concat(lower(coalesce(procurement_requests.article_name, '')), lower(coalesce(models.product, '')), lower(coalesce(models.version, ''))) NEW APPROVED 0 PARTIALLY_APPROVED 0 DENIED 7d5ba731-edd9-41ba-8773-7337d24c2327 8b8fe440-cae5-4bf9-8048-d0ec2399faa1 fb664326-a8ef-4556-af02-07d3127cd9ec normal high low medium high mandatory 0 0 not_processed in_progress procured alternative_procured not_procured]
2023-11-27T15:29:19.356Z NX-41294 DEBUG [leihs.procurement.permissions.user:52] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_viewers) (sql/merge-where [:= :procurement_category_viewers.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_viewers.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_viewers WHERE procurement_category_viewers.user_id = ?)) AS result " #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-27T15:29:19.357Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = ?)) AS result " #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-27T15:29:19.374Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => ["SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result " #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-27T15:29:19.375Z NX-41294 DEBUG [leihs.procurement.permissions.user:85] - (->> [viewer? inspector? admin?] (map (fn* [p1__39296#] (p1__39296# tx auth-entity))) (some true?)) => true
>>requestsB2 (2023-11-27T15:29:19.537Z NX-41294 DEBUG [leihs.procurement.permissions.user:72] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_requesters_organizations) (sql/where [:= :procurement_requesters_organizations.user_id (:user_id auth-entity)]))) :result]) sql/format) => [SELECT exists((SELECT TRUE FROM procurement_requesters_organizations WHERE procurement_requesters_organizations.user_id = ?)) AS result  #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-27T15:29:19.538Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => [SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE procurement_category_inspectors.user_id = ?)) AS result  #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-27T15:29:19.539Z NX-41294 DEBUG [leihs.procurement.permissions.user:15] - (-> (sql/select [(sql/call :exists (-> (sql/select true) (sql/from :procurement_admins) (sql/where [:= :procurement_admins.user_id (:user_id auth-entity)]))) :result]) sql/format) => [SELECT exists((SELECT TRUE FROM procurement_admins WHERE procurement_admins.user_id = ?)) AS result  #uuid "e68ca036-dced-4666-b9e9-a6b55119f013"]
2023-11-27T15:29:19.544Z NX-41294 DEBUG [leihs.procurement.permissions.user:31] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_inspectors) (sql/merge-where [:= :procurement_category_inspectors.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_inspectors.category_id c-id]))) :result]) sql/format) => [SELECT exists((SELECT TRUE FROM procurement_category_inspectors WHERE (procurement_category_inspectors.user_id = ? AND procurement_category_inspectors.category_id = ?))) AS result  #uuid "e68ca036-dced-4666-b9e9-a6b55119f013" 7d5ba731-edd9-41ba-8773-7337d24c2327]
2023-11-27T15:29:19.545Z NX-41294 DEBUG [leihs.procurement.permissions.user:52] - (-> (sql/select [(sql/call :exists (cond-> (-> (sql/select true) (sql/from :procurement_category_viewers) (sql/merge-where [:= :procurement_category_viewers.user_id (:user_id auth-entity)])) c-id (sql/merge-where [:= :procurement_category_viewers.category_id c-id]))) :result]) sql/format) => [SELECT exists((SELECT TRUE FROM procurement_category_viewers WHERE (procurement_category_viewers.user_id = ? AND procurement_category_viewers.category_id = ?))) AS result  #uuid "e68ca036-dced-4666-b9e9-a6b55119f013" 7d5ba731-edd9-41ba-8773-7337d24c2327]
{:category {:read true, :write false, :default {:id #uuid "7d5ba731-edd9-41ba-8773-7337d24c2327", :name Category C1, :main_category_id #uuid "d2907cbd-98d0-48b7-ab9a-f06803e5cabb", :general_ledger_account nil, :cost_center nil, :procurement_account nil}, :required true, :value {:id 7d5ba731-edd9-41ba-8773-7337d24c2327, :name Category C1, :cost_center nil, :main_category {:id d2907cbd-98d0-48b7-ab9a-f06803e5cabb, :name Main Category MC1}, :main_category_id d2907cbd-98d0-48b7-ab9a-f06803e5cabb, :procurement_account nil, :general_ledger_account nil}, :request-id #uuid "40284a6b-cf5e-41c1-af6c-dc423894ee11"}, :supplier {:read true, :write false, :default nil, :required false, :value nil, :request-id #uuid "40284a6b-cf5e-41c1-af6c-dc423894ee11"}, :motivation {:read true, :write false, :required true, :value Corporis commodi provident nam., :request-id #uuid "40284a6b-cf5e-41c1-af6c-dc423894ee11"}, :accounting_type {:read true, :write false, :default aquisition, :required true, :value aquisition, :request-id #uuid "40284a6b-cf5e-41c1-af6c-dc423894ee11"}, :actionPermissions {:edit true, :delete false, :moveBudgetPeriod false, :moveCategory false}, :article_number {:read true, :write false, :default nil, :required false, :value nil, :request-id #uuid "40284a6b-cf5e-41c1-af6c-dc423894ee11"}, :inspector_priority {:read true, :write false, :default MEDIUM, :required true, :value :MEDIUM, :request-id #uuid "40284a6b-cf5e-41c1-af6c-dc423894ee11"}, :price_cents {:read true, :write false, :default 0, :required true, :value 0, :request-id #uuid "40284a6b-cf5e-41c1-af6c-dc423894ee11"}, :budget_period {:read true, :write false, :default {:id #uuid "8b8fe440-cae5-4bf9-8048-d0ec2399faa1", :name Budget-Period-Past, :inspection_start_date #time/instant "2023-08-23T22:00:00Z", :end_date #time/instant "2023-11-22T23:00:00Z", :created_at #time/instant "2023-11-24T19:25:51.605131Z", :updated_at #time/instant "2023-11-24T19:25:51.605131Z"}, :required true, :value {:id 8b8fe440-cae5-4bf9-8048-d0ec2399faa1, :name Budget-Period-Past, :inspection_start_date 2023-08-24T00:00:00+02:00, :end_date 2023-11-23T00:00:00+01:00, :created_at 2023-11-24T20:25:51.605131, :updated_at 2023-11-24T20:25:51.605131, :is_past true}, :request-id #uuid "40284a6b-cf5e-41c1-af6c-dc423894ee11"}, :article_name {:read true, :write false, :default nil, :required true, :value Mediocre Aluminum Shoes, :request-id #uuid "40284a6b-cf5e-41c1-af6c-dc423894ee11"}, :replacement {:read true, :write false, :default nil, :required true, :value true, :request-id #uuid "40284a6b-cf5e-41c1-af6c-dc423894ee11"}, :attachments {:read true, :write false, :required false, :value :unqueried, :request-id #uuid "40284a6b-cf5e-41c1-af6c-dc423894ee11"}, :DELETE false, :template {:read true, :write false, :default nil, :required true, :value nil, :request-id #uuid "40284a6b-cf5e-41c1-af6c-dc423894ee11"}, :state :NEW, :organization {:value {:id fb664326-a8ef-4556-af02-07d3127cd9ec, :name Beauty & Kids, :parent_id d6f9842f-4a7f-45ed-8ac5-c708cd6f8ca9, :shortname nil, :department {:id d6f9842f-4a7f-45ed-8ac5-c708cd6f8ca9, :name Home, Jewelry & Computers, :parent_id nil, :shortname nil}}, :read false, :write false, :request-id #uuid "40284a6b-cf5e-41c1-af6c-dc423894ee11"}, :supplier_name {:read true, :write false, :default nil, :required false, :value nil, :request-id #uuid "40284a6b-cf5e-41c1-af6c-dc423894ee11"}, :order_status {:read true, :write true, :default NOT_PROCURED, :required true, :value :NOT_PROCESSED, :request-id #uuid "40284a6b-cf5e-41c1-af6c-dc423894ee11"}, :requested_quantity {:read true, :write false, :required true, :value 1, :request-id #uuid "40284a6b-cf5e-41c1-af6c-dc423894ee11"}, :general_ledger_account {:read true, :write false, :required false, :value nil, :request-id #uuid "40284a6b-cf5e-41c1-af6c-dc423894ee11"}, :updated_at {:value #time/instant "2023-11-24T19:25:51.635215Z", :read false, :write false, :request-id #uuid "40284a6b-cf5e-41c1-af6c-dc423894ee11"}, :priority {:read true, :write false, :default NORMAL, :required true, :value :NORMAL, :request-id #uuid "40284a6b-cf5e-41c1-af6c-dc423894ee11"}, :id #uuid "40284a6b-cf5e-41c1-af6c-dc423894ee11", :total_price_cents 0, :price_currency {:read true, :write false, :default CHF, :required true, :value CHF, :request-id #uuid "40284a6b-cf5e-41c1-af6c-dc423894ee11"}, :procurement_account {:read true, :write false, :value nil, :request-id #uuid "40284a6b-cf5e-41c1-af6c-dc423894ee11"}, :room {:read true, :write false, :default {:id #uuid "b8927fd2-014c-48c2-b095-fa1d5620debe", :name general room, :description nil, :building_id #uuid "abae04c5-d767-425e-acc2-7ce04df645d1", :general true, :building {:id #uuid "abae04c5-d767-425e-acc2-7ce04df645d1", :name general building, :code nil}}, :required true, :value {:id 64bfb152-ea6c-42da-98c6-325afeb462bc, :name reception room, :general false, :building {:id 3eaa2152-ebd3-4b7c-b370-f107fa7b4d7c, :code nil, :name 9594 Beer Extension}, :building_id 3eaa2152-ebd3-4b7c-b370-f107fa7b4d7c, :description nil}, :request-id #uuid "40284a6b-cf5e-41c1-af6c-dc423894ee11"}, :inspection_comment {:read true, :write false, :required false, :value nil, :request-id #uuid "40284a6b-cf5e-41c1-af6c-dc423894ee11"}, :approved_quantity {:read true, :write false, :required false, :value nil, :request-id #uuid "40284a6b-cf5e-41c1-af6c-dc423894ee11"}, :order_quantity {:read true, :write false, :required false, :value nil, :request-id #uuid "40284a6b-cf5e-41c1-af6c-dc423894ee11"}, :cost_center {:read true, :write false, :required false, :value nil, :request-id #uuid "40284a6b-cf5e-41c1-af6c-dc423894ee11"}, :user {:read true, :write false, :required true, :default {:id #uuid "2187a76b-557a-4775-9a1e-778142161819", :firstname Lynsey, :lastname Kertzmann}, :value {:system_admin_protected false, :address nil, :email chanda@ortiz.net, :pool_protected false, :last_sign_in_at nil, :img32_url nil, :account_enabled true, :lastname Kertzmann, :phone nil, :img_digest nil, :org_id nil, :extended_info nil, :secondary_email nil, :city nil, :settings nil, :is_admin false, :organization local, :login nil, :searchable Lynsey Kertzmann chanda@ortiz.net    Kertzmann Lynsey, :updated_at 2023-11-24T20:25:51.614964+01:00, :firstname Lynsey, :zip nil, :id 2187a76b-557a-4775-9a1e-778142161819, :url nil, :password_sign_in_enabled true, :account_disabled_at nil, :is_system_admin false, :badge_id nil, :language_locale nil, :img256_url nil, :country nil, :delegator_user_id nil, :created_at 2023-11-24T20:25:51.614964+01:00, :admin_protected false}, :request-id #uuid "40284a6b-cf5e-41c1-af6c-dc423894ee11"}, :receiver {:read true, :write false, :required false, :value nil, :request-id #uuid "40284a6b-cf5e-41c1-af6c-dc423894ee11"}, :internal_order_number {:read true, :write false, :required false, :value nil, :request-id #uuid "40284a6b-cf5e-41c1-af6c-dc423894ee11"}, :created_at {:value #time/instant "2023-11-24T19:25:51.635215Z", :read false, :write false, :request-id #uuid "40284a6b-cf5e-41c1-af6c-dc423894ee11"}, :order_comment {:read true, :write true, :required false, :value nil, :request-id #uuid "40284a6b-cf5e-41c1-af6c-dc423894ee11"}, :short_id Budget-Period-Past.001, :model {:read true, :write false, :default nil, :required false, :value nil, :request-id #uuid "40284a6b-cf5e-41c1-af6c-dc423894ee11"}})
>>dashboard-cache-keyB2 {:id 1608672852}

>>>pure-handler {:data #ordered/map ([:dashboard #ordered/map ([:cacheKey 1608672852] [:total_count 1] [:budget_periods [#ordered/map ([:id 8b8fe440-cae5-4bf9-8048-d0ec2399faa1] [:cacheKey 1608672852_8b8fe440-cae5-4bf9-8048-d0ec2399faa1] [:name Budget-Period-Past] [:inspection_start_date 2023-08-23T22:00:00Z] [:end_date 2023-11-22T23:00:00Z] [:total_price_cents 0] [:main_categories [#ordered/map ([:id d2907cbd-98d0-48b7-ab9a-f06803e5cabb] [:cacheKey 1608672852_8b8fe440-cae5-4bf9-8048-d0ec2399faa1_d2907cbd-98d0-48b7-ab9a-f06803e5cabb] [:name Main Category MC1] [:image_url nil] [:total_price_cents 0] [:categories [#ordered/map ([:id 7d5ba731-edd9-41ba-8773-7337d24c2327] [:cacheKey 1608672852_8b8fe440-cae5-4bf9-8048-d0ec2399faa1_d2907cbd-98d0-48b7-ab9a-f06803e5cabb_7d5ba731-edd9-41ba-8773-7337d24c2327] [:name Category C1] [:total_price_cents 0] [:requests [#ordered/map ([:id 40284a6b-cf5e-41c1-af6c-dc423894ee11] [:short_id Budget-Period-Past.001] [:user #ordered/map ([:value #ordered/map ([:id 2187a76b-557a-4775-9a1e-778142161819] [:firstname Lynsey] [:lastname Kertzmann] [:__typename :User])] [:__typename :RequestFieldUser])] [:category #ordered/map ([:read true] [:write false] [:required true] [:value #ordered/map ([:id 7d5ba731-edd9-41ba-8773-7337d24c2327] [:name Category C1] [:main_category #ordered/map ([:id d2907cbd-98d0-48b7-ab9a-f06803e5cabb] [:name Main Category MC1] [:__typename :MainCategory])] [:__typename :Category])] [:__typename :RequestFieldCategory])] [:budget_period #ordered/map ([:read true] [:write false] [:required true] [:value #ordered/map ([:name Budget-Period-Past] [:id 8b8fe440-cae5-4bf9-8048-d0ec2399faa1] [:__typename :BudgetPeriod])] [:__typename :RequestFieldBudgetPeriod])] [:article_name #ordered/map ([:value Mediocre Aluminum Shoes] [:__typename :RequestFieldString])] [:model #ordered/map ([:value nil] [:__typename :RequestFieldModel])] [:receiver #ordered/map ([:value nil] [:__typename :RequestFieldString])] [:organization #ordered/map ([:value #ordered/map ([:id fb664326-a8ef-4556-af02-07d3127cd9ec] [:name Beauty & Kids] [:shortname nil] [:department #ordered/map ([:id d6f9842f-4a7f-45ed-8ac5-c708cd6f8ca9] [:name Home, Jewelry & Computers] [:__typename :Organization])] [:__typename :Organization])] [:__typename :RequestFieldOrganization])] [:price_cents #ordered/map ([:value 0] [:__typename :RequestFieldInt])] [:price_currency #ordered/map ([:value CHF] [:__typename :RequestFieldString])] [:requested_quantity #ordered/map ([:read true] [:value 1] [:__typename :RequestFieldInt])] [:approved_quantity #ordered/map ([:read true] [:value nil] [:__typename :RequestFieldInt])] [:order_quantity #ordered/map ([:read true] [:value nil] [:__typename :RequestFieldInt])] [:replacement #ordered/map ([:value true] [:__typename :RequestFieldBoolean])] [:priority #ordered/map ([:value :NORMAL] [:__typename :RequestFieldPriority])] [:state :NEW] [:article_number #ordered/map ([:value nil] [:__typename :RequestFieldString])] [:supplier #ordered/map ([:value nil] [:__typename :RequestFieldSupplier])] [:supplier_name #ordered/map ([:value nil] [:__typename :RequestFieldString])] [:room #ordered/map ([:value #ordered/map ([:id 64bfb152-ea6c-42da-98c6-325afeb462bc] [:name reception room] [:building #ordered/map ([:id 3eaa2152-ebd3-4b7c-b370-f107fa7b4d7c] [:name 9594 Beer Extension] [:__typename :Building])] [:__typename :Room])] [:__typename :RequestFieldRoom])] [:motivation #ordered/map ([:value Corporis commodi provident nam.] [:__typename :RequestFieldString])] [:inspection_comment #ordered/map ([:value nil] [:__typename :RequestFieldString])] [:inspector_priority #ordered/map ([:value :MEDIUM] [:__typename :RequestFieldInspectorPriority])] [:accounting_type #ordered/map ([:value aquisition] [:__typename :RequestFieldString])] [:cost_center #ordered/map ([:value nil] [:__typename :RequestFieldCostCenter])] [:general_ledger_account #ordered/map ([:value nil] [:__typename :RequestFieldGeneralLedgerAccount])] [:procurement_account #ordered/map ([:value nil] [:__typename :RequestFieldProcurementAccount])] [:internal_order_number #ordered/map ([:value nil] [:__typename :RequestFieldString])] [:order_status #ordered/map ([:value :NOT_PROCESSED] [:__typename :RequestFieldOrderStatus])] [:order_comment #ordered/map ([:value nil] [:__typename :RequestFieldString])] [:__typename :Request] [:total_price_cents 0] [:actionPermissions #ordered/map ([:edit true] [:__typename :RequestActionPermissions])])]] [:__typename :Category])]] [:__typename :MainCategory])]] [:__typename :BudgetPeriod])]] [:__typename :Dashboard])])}
2023-11-27T15:29:19.561Z NX-41294 DEBUG [leihs.procurement.authorization:150] - (authorize handler request) => {:body {:data #ordered/map ([:dashboard #ordered/map ([:cacheKey "1608672852"] [:total_count 1] [:budget_periods [#ordered/map ([:id "8b8fe440-cae5-4bf9-8048-d0ec2399faa1"] [:cacheKey "1608672852_8b8fe440-cae5-4bf9-8048-d0ec2399faa1"] [:name "Budget-Period-Past"] [:inspection_start_date "2023-08-23T22:00:00Z"] [:end_date "2023-11-22T23:00:00Z"] [:total_price_cents "0"] [:main_categories [#ordered/map ([:id "d2907cbd-98d0-48b7-ab9a-f06803e5cabb"] [:cacheKey "1608672852_8b8fe440-cae5-4bf9-8048-d0ec2399faa1_d2907cbd-98d0-48b7-ab9a-f06803e5cabb"] [:name "Main Category MC1"] [:image_url nil] [:total_price_cents "0"] [:categories [#ordered/map ([:id "7d5ba731-edd9-41ba-8773-7337d24c2327"] [:cacheKey "1608672852_8b8fe440-cae5-4bf9-8048-d0ec2399faa1_d2907cbd-98d0-48b7-ab9a-f06803e5cabb_7d5ba731-edd9-41ba-8773-7337d24c2327"] [:name "Category C1"] [:total_price_cents "0"] [:requests [#ordered/map ([:id "40284a6b-cf5e-41c1-af6c-dc423894ee11"] [:short_id "Budget-Period-Past.001"] [:user #ordered/map ([:value #ordered/map ([:id "2187a76b-557a-4775-9a1e-778142161819"] [:firstname "Lynsey"] [:lastname "Kertzmann"] [:__typename :User])] [:__typename :RequestFieldUser])] [:category #ordered/map ([:read true] [:write false] [:required true] [:value #ordered/map ([:id "7d5ba731-edd9-41ba-8773-7337d24c2327"] [:name "Category C1"] [:main_category #ordered/map ([:id "d2907cbd-98d0-48b7-ab9a-f06803e5cabb"] [:name "Main Category MC1"] [:__typename :MainCategory])] [:__typename :Category])] [:__typename :RequestFieldCategory])] [:budget_period #ordered/map ([:read true] [:write false] [:required true] [:value #ordered/map ([:name "Budget-Period-Past"] [:id "8b8fe440-cae5-4bf9-8048-d0ec2399faa1"] [:__typename :BudgetPeriod])] [:__typename :RequestFieldBudgetPeriod])] [:article_name #ordered/map ([:value "Mediocre Aluminum Shoes"] [:__typename :RequestFieldString])] [:model #ordered/map ([:value nil] [:__typename :RequestFieldModel])] [:receiver #ordered/map ([:value nil] [:__typename :RequestFieldString])] [:organization #ordered/map ([:value #ordered/map ([:id "fb664326-a8ef-4556-af02-07d3127cd9ec"] [:name "Beauty & Kids"] [:shortname nil] [:department #ordered/map ([:id "d6f9842f-4a7f-45ed-8ac5-c708cd6f8ca9"] [:name "Home, Jewelry & Computers"] [:__typename :Organization])] [:__typename :Organization])] [:__typename :RequestFieldOrganization])] [:price_cents #ordered/map ([:value 0] [:__typename :RequestFieldInt])] [:price_currency #ordered/map ([:value "CHF"] [:__typename :RequestFieldString])] [:requested_quantity #ordered/map ([:read true] [:value 1] [:__typename :RequestFieldInt])] [:approved_quantity #ordered/map ([:read true] [:value nil] [:__typename :RequestFieldInt])] [:order_quantity #ordered/map ([:read true] [:value nil] [:__typename :RequestFieldInt])] [:replacement #ordered/map ([:value true] [:__typename :RequestFieldBoolean])] [:priority #ordered/map ([:value :NORMAL] [:__typename :RequestFieldPriority])] [:state :NEW] [:article_number #ordered/map ([:value nil] [:__typename :RequestFieldString])] [:supplier #ordered/map ([:value nil] [:__typename :RequestFieldSupplier])] [:supplier_name #ordered/map ([:value nil] [:__typename :RequestFieldString])] [:room #ordered/map ([:value #ordered/map ([:id "64bfb152-ea6c-42da-98c6-325afeb462bc"] [:name "reception room"] [:building #ordered/map ([:id "3eaa2152-ebd3-4b7c-b370-f107fa7b4d7c"] [:name "9594 Beer Extension"] [:__typename :Building])] [:__typename :Room])] [:__typename :RequestFieldRoom])] [:motivation #ordered/map ([:value "Corporis commodi provident nam."] [:__typename :RequestFieldString])] [:inspection_comment #ordered/map ([:value nil] [:__typename :RequestFieldString])] [:inspector_priority #ordered/map ([:value :MEDIUM] [:__typename :RequestFieldInspectorPriority])] [:accounting_type #ordered/map ([:value "aquisition"] [:__typename :RequestFieldString])] [:cost_center #ordered/map ([:value nil] [:__typename :RequestFieldCostCenter])] [:general_ledger_account #ordered/map ([:value nil] [:__typename :RequestFieldGeneralLedgerAccount])] [:procurement_account #ordered/map ([:value nil] [:__typename :RequestFieldProcurementAccount])] [:internal_order_number #ordered/map ([:value nil] [:__typename :RequestFieldString])] [:order_status #ordered/map ([:value :NOT_PROCESSED] [:__typename :RequestFieldOrderStatus])] [:order_comment #ordered/map ([:value nil] [:__typename :RequestFieldString])] [:__typename :Request] [:total_price_cents "0"] [:actionPermissions #ordered/map ([:edit true] [:__typename :RequestActionPermissions])])]] [:__typename :Category])]] [:__typename :MainCategory])]] [:__typename :BudgetPeriod])]] [:__typename :Dashboard])])}}
