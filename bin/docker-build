#!/bin/bash
set -exu

# NOTE: this works exactly like `bin/build`, but runs inside a docker container.

PROCURE_IMAGE_NAME="${PROCURE_IMAGE_NAME:-leihs-procure}"
VERSION_NAME="${VERSION_NAME:-dev}"
STAGE="${STAGE:-prod}"
IMAGE_WORKDIR="/leihs/procure"
DIST_DIR="server/target"
tag="${PROCURE_IMAGE_NAME}:${VERSION_NAME}"

PROCURE_DIR="$(dirname ${BASH_SOURCE})/.."
CLIENT_DIR="${PROCURE_DIR}/client"
SERVER_DIR="${PROCURE_DIR}/server"
cd "${PROCURE_DIR}"
echo "PWD: $PWD"

PROCURE_SHORT_TREE_ID="$(git log -n1 --format="%t" HEAD)"
PROCURE_COMMIT_ID="$(git log -n1 --format="%H" HEAD)"

# build shared ui
# * if leihs-ui git tree is not clean, build a dev version
# * if leihs-ui git tree is clean, get the tree id and only build if not present
cd "${CLIENT_DIR}/leihs-ui"
source bin/require-clean-working-tree
if check-clean-working-tree; then
  leihs_ui_tree_id="$(git log -n1 --format="%t" HEAD)"
  test "$leihs_ui_tree_id"
  LEIHS_UI_VERSION="tree-${leihs_ui_tree_id}"
else
  LEIHS_UI_VERSION="dev"
fi
if ! docker image inspect "leihs-ui:${LEIHS_UI_VERSION}"; then
  VERSION_NAME="${LEIHS_UI_VERSION}" bin/docker-build
fi
cd -

docker buildx build \
  --target="$STAGE" \
  --build-arg "WORKDIR=${IMAGE_WORKDIR}" \
  --build-arg "LEIHS_UI_VERSION=${LEIHS_UI_VERSION}" \
  -t "$tag" .

# add more tags based on git state, if the working tree is clean
if check-clean-working-tree; then
  main_tag="${PROCURE_IMAGE_NAME}:tree-${PROCURE_SHORT_TREE_ID}"
  docker image tag "$tag" "$main_tag"
  docker image tag "$tag" "${PROCURE_IMAGE_NAME}:commit-${PROCURE_COMMIT_ID}"
  # print this as the "main" tag
  tag="$main_tag"
fi

# docker image inspect "${tag}"

# extract uberjar from image / copy to host filesystem
rm -rf "${DIST_DIR}" && mkdir -p "${DIST_DIR}"
container_id="$(docker create "$tag")"
docker cp -La "$container_id:${IMAGE_WORKDIR}/${DIST_DIR}/." "${DIST_DIR}/"
docker rm "$container_id"
ls -la "${DIST_DIR}"

echo "${tag}"
