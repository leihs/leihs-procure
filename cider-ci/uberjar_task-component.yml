name: 'Build procure uberjar (Docker)'

include:
  - path: cider-ci/install-ruby_task-component.yml
    submodule: [client/leihs-ui]
  - path: cider-ci/environment_variables.yml

git_options:
  submodules:
    include_match: ^.*$

traits:
  Docker Engine: true

scripts:
  procure-build-uberjar:
    timeout: 60 minutes
    start_when:
      install-ruby-passed: { script_key: install-ruby }
    exclusive_executor_resource: procure-build-uberjar
    body: |
      set -exu
      cd ${LEIHS_PROCURE_DIR}

      # build with docker, prime docker cache
      PROCURE_IMAGE_NAME="$DIST_PROCURE_IMAGE_NAME" \
      VERSION_NAME="$DIST_VERSION_NAME" \
        bin/docker-build

      # build again to prime our own file-based artefact cache
      USE_DOCKER=YES bin/build
